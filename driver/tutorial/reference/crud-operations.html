
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>CRUD Operations &#8212; Ruby MongoDB Driver  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bulk Writes" href="bulk-operations.html" />
    <link rel="prev" title="Working With Data" href="working-with-data.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ruby MongoDB Driver  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../getting-started.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../installation.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="driver-compatibility.html">
     Driver Compatibility
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../support.html">
     Support
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorials.html">
   Tutorials
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/quick-start.html">
     Quick Start
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/common-errors.html">
     Common Errors
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="connection-and-configuration.html">
   Connection &amp; Configuration
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="create-client.html">
     Creating a Client
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="authentication.html">
     Authentication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="monitoring.html">
     Monitoring
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="user-management.html">
     User Management
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="working-with-data.html">
   Working With Data
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     CRUD Operations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="bulk-operations.html">
     Bulk Writes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="projection.html">
     Projection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="aggregation.html">
     Aggregation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="map-reduce.html">
     Map-Reduce
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="text-search.html">
     Text Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="geospatial-search.html">
     Geospatial Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="query-cache.html">
     Query Cache
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="gridfs.html">
     GridFS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="change-streams.html">
     Change Streams
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sessions.html">
     Sessions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="transactions.html">
     Transactions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="client-side-encryption.html">
     Client-Side Encryption
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="schema-operations.html">
   Schema Operations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="database-tasks.html">
     Databases
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="collection-tasks.html">
     Collections
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="indexing.html">
     Indexing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="collations.html">
     Collations
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://mongodb.com/docs/ruby-driver/master/api/">
   API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../release-notes.html">
   Release Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="additional-resources.html">
   Additional Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contribute.html">
   Contribute to the Driver
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/reference/crud-operations.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.txt</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#key-value-pair-notation">
   Key-value Pair Notation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-documents">
   Creating Documents
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-a-decimal128-number">
     Specify a
     <code class="docutils literal notranslate">
      <span class="pre">
       Decimal128
      </span>
     </code>
     number
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#query-cache">
   Query Cache
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reading">
   Reading
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#legacy-query-syntax">
     Legacy
     <code class="docutils literal notranslate">
      <span class="pre">
       $query
      </span>
     </code>
     Syntax
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#query-options">
     Query Options
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#additional-query-operations">
     Additional Query Operations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tailable-cursors">
     Tailable Cursors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-concern">
     Read Concern
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-preference">
     Read Preference
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mode">
     Mode
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tag-sets">
     Tag sets
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hedge">
     Hedge
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#updating">
   Updating
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#update-options">
     Update Options
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deleting">
   Deleting
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#delete-options">
     Delete Options
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#write-concern">
   Write Concern
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#field-names-with-dots-periods-and-dollar-signs">
   Field Names with Dots/Periods (.) and Dollar Signs ($)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-note-about-the-bson-symbol-type">
   A Note about the BSON Symbol type
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>CRUD Operations</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#key-value-pair-notation">
   Key-value Pair Notation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-documents">
   Creating Documents
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-a-decimal128-number">
     Specify a
     <code class="docutils literal notranslate">
      <span class="pre">
       Decimal128
      </span>
     </code>
     number
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#query-cache">
   Query Cache
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reading">
   Reading
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#legacy-query-syntax">
     Legacy
     <code class="docutils literal notranslate">
      <span class="pre">
       $query
      </span>
     </code>
     Syntax
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#query-options">
     Query Options
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#additional-query-operations">
     Additional Query Operations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tailable-cursors">
     Tailable Cursors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-concern">
     Read Concern
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-preference">
     Read Preference
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mode">
     Mode
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tag-sets">
     Tag sets
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hedge">
     Hedge
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#updating">
   Updating
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#update-options">
     Update Options
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deleting">
   Deleting
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#delete-options">
     Delete Options
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#write-concern">
   Write Concern
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#field-names-with-dots-periods-and-dollar-signs">
   Field Names with Dots/Periods (.) and Dollar Signs ($)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-note-about-the-bson-symbol-type">
   A Note about the BSON Symbol type
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="crud-operations">
<h1>CRUD Operations<a class="headerlink" href="#crud-operations" title="Permalink to this headline">#</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><p><a class="reference internal" href="#key-value-pair-notation" id="id39">Key-value Pair Notation</a></p></li>
<li><p><a class="reference internal" href="#creating-documents" id="id40">Creating Documents</a></p></li>
<li><p><a class="reference internal" href="#query-cache" id="id41">Query Cache</a></p></li>
<li><p><a class="reference internal" href="#reading" id="id42">Reading</a></p></li>
<li><p><a class="reference internal" href="#updating" id="id43">Updating</a></p></li>
<li><p><a class="reference internal" href="#deleting" id="id44">Deleting</a></p></li>
<li><p><a class="reference internal" href="#write-concern" id="id45">Write Concern</a></p></li>
<li><p><a class="reference internal" href="#field-names-with-dots-periods-and-dollar-signs" id="id46">Field Names with Dots/Periods (.) and Dollar Signs ($)</a></p></li>
<li><p><a class="reference internal" href="#a-note-about-the-bson-symbol-type" id="id47">A Note about the BSON Symbol type</a></p></li>
</ul>
</div>
<p>CRUD operations are those which deal with creating, reading, updating,
and deleting documents.</p>
<section id="key-value-pair-notation">
<h2>Key-value Pair Notation<a class="headerlink" href="#key-value-pair-notation" title="Permalink to this headline">#</a></h2>
<p>Key-value pairs appear in many different contexts in the MongoDB Ruby
driver, and there are some quirks of syntax with regard to how they can
be notated which depend on which version of Ruby you’re using.</p>
<p>When constructing a document, the following syntax is acceptable and
correct for Ruby version 1.9 and later:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nb">document</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Harriet&quot;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mf">36</span> <span class="p">}</span>
</pre></div>
</div>
<p>If you’re using Ruby version 2.2 or greater, you can optionally enclose
your keys in quotes.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nb">document</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Harriet&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="o">:</span> <span class="mf">36</span> <span class="p">}</span>
</pre></div>
</div>
<p>If you need to use any MongoDB operator which begins with <code class="docutils literal notranslate"><span class="pre">$</span></code>,
such as <code class="docutils literal notranslate"><span class="pre">$set</span></code>, <code class="docutils literal notranslate"><span class="pre">$gte</span></code>, or <code class="docutils literal notranslate"><span class="pre">$near</span></code>, you must enclose it in
quotes. If you’re using Ruby version 2.2 or greater, you can notate
it as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Harriet&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="ss">age</span><span class="p">:</span> <span class="mi">42</span> <span class="p">}</span> <span class="p">})</span>
</pre></div>
</div>
<p>If you’re using an earlier version of Ruby, use the hashrocket symbol:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Harriet&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="s2">&quot;$set&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">age</span><span class="p">:</span> <span class="mi">42</span> <span class="p">}</span> <span class="p">})</span>
</pre></div>
</div>
<p>Quoted strings and hashrockets for key-value pairs will work with any
version of Ruby:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Harriet&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="s2">&quot;$set&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">age</span><span class="p">:</span> <span class="mi">42</span> <span class="p">}</span> <span class="p">})</span>
</pre></div>
</div>
</section>
<section id="creating-documents">
<h2>Creating Documents<a class="headerlink" href="#creating-documents" title="Permalink to this headline">#</a></h2>
<p>To insert documents into a collection, select a
collection on the client and call <code class="docutils literal notranslate"><span class="pre">insert_one</span></code> or <code class="docutils literal notranslate"><span class="pre">insert_many</span></code>.</p>
<p>Insert operations return a <code class="docutils literal notranslate"><span class="pre">Mongo::Operation::Result</span></code> object which
gives you information about the insert itself.</p>
<p>On MongoDB 2.6 and later, if the insert fails, an exception is
raised, because write commands are used.</p>
<p>On MongoDB 2.4, an exception is only raised if the insert fails and the
<a href="#id1"><span class="problematic" id="id2">:manual:`write concern&lt;/reference/write-concern/&gt;`</span></a> is 1 or higher.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">insert_one</span><span class="p">(</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;FKA Twigs&#39;</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">n</span> <span class="c1"># returns 1, because 1 document was inserted.</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">insert_many</span><span class="p">(</span><span class="o">[</span>
  <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flying Lotus&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Aphex Twin&#39;</span> <span class="p">}</span>
<span class="o">]</span><span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">inserted_count</span> <span class="c1"># returns 2, because 2 documents were inserted.</span>
</pre></div>
</div>
<section id="specify-a-decimal128-number">
<span id="specify-decimal128"></span><h3>Specify a <code class="docutils literal notranslate"><span class="pre">Decimal128</span></code> number<a class="headerlink" href="#specify-a-decimal128-number" title="Permalink to this headline">#</a></h3>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.4.</span></p>
</div>
<p><a href="#id3"><span class="problematic" id="id4">:manual:`Decimal128&lt;/tutorial/model-monetary-data&gt;`</span></a> is a
<span class="xref std std-doc">BSON datatype</span>
that employs 128-bit decimal-based floating-point values capable
of emulating decimal rounding with exact precision. This
functionality is intended for applications that handle
<a href="#id5"><span class="problematic" id="id6">:manual:`monetary data &lt;/tutorial/model-monetary-data&gt;`</span></a>,
such as financial and tax computations.</p>
<p>The following example inserts a value of type <code class="docutils literal notranslate"><span class="pre">Decimal128</span></code> into
the <code class="docutils literal notranslate"><span class="pre">price</span></code> field of a collection named <code class="docutils literal notranslate"><span class="pre">inventory</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>

<span class="n">price</span> <span class="o">=</span> <span class="no">BSON</span><span class="o">::</span><span class="no">Decimal128</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;428.79&quot;</span><span class="p">)</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:inventory</span><span class="o">].</span><span class="n">insert_one</span><span class="p">({</span> <span class="s2">&quot;_id&quot;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="s2">&quot;item&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;26 inch monitor&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;price&quot;</span> <span class="o">=&gt;</span> <span class="n">price</span> <span class="p">})</span>
</pre></div>
</div>
<p>The above operation produces the following document:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="mf">1</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span> <span class="o">:</span> <span class="s2">&quot;26 inch monitor&quot;</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span> <span class="o">:</span> <span class="nx">NumberDecimal</span><span class="p">(</span><span class="s2">&quot;428.79&quot;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
<p>You can also create a <code class="docutils literal notranslate"><span class="pre">Decimal128</span></code> object from a Ruby <code class="docutils literal notranslate"><span class="pre">BigDecimal</span></code>
object, or with <code class="docutils literal notranslate"><span class="pre">Decimal128.from_string()</span></code>.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">big_decimal</span> <span class="o">=</span> <span class="no">BigDecimal</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">428</span><span class="o">.</span><span class="mi">79</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">price</span> <span class="o">=</span> <span class="no">BSON</span><span class="o">::</span><span class="no">Decimal128</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">big_decimal</span><span class="p">)</span>
<span class="c1"># =&gt; BSON::Decimal128(&#39;428.79&#39;)</span>

<span class="n">price</span> <span class="o">=</span> <span class="no">BSON</span><span class="o">::</span><span class="no">Decimal128</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s2">&quot;428.79&quot;</span><span class="p">)</span>
<span class="c1"># =&gt; BSON::Decimal128(&#39;428.79&#39;)</span>
</pre></div>
</div>
</section>
</section>
<section id="query-cache">
<h2>Query Cache<a class="headerlink" href="#query-cache" title="Permalink to this headline">#</a></h2>
<p>The Ruby driver provides a query cache. When enabled, the query cache will
save the results of find and aggregation queries and return those saved results
when the same queries are performed again.</p>
<p>To read more about the query cache, visit the
<a class="reference internal" href="query-cache.html#id1"><span class="std std-ref">query cache tutorial</span></a>.</p>
</section>
<section id="reading">
<h2>Reading<a class="headerlink" href="#reading" title="Permalink to this headline">#</a></h2>
<p>The Ruby driver provides a fluent interface for queries using the <code class="docutils literal notranslate"><span class="pre">find</span></code>
method on the collection. Various options are available
to the <code class="docutils literal notranslate"><span class="pre">find</span></code> method.</p>
<p>The query is lazily executed against the server only when iterating the
results - at that point the query is dispatched and a <code class="docutils literal notranslate"><span class="pre">Mongo::Cursor</span></code> is
returned.</p>
<p>To find all documents for a given filter, call <code class="docutils literal notranslate"><span class="pre">find</span></code> with the
query:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>

<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flying Lotus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="c1">#=&gt; Yields a BSON::Document.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>To query nested documents, specify the keys in nested order using dot
notation.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;records.releaseYear&quot;</span><span class="p">:</span> <span class="mi">2008</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="c1">#=&gt; Yields a BSON::Document.</span>
<span class="k">end</span>
</pre></div>
</div>
<section id="legacy-query-syntax">
<h3>Legacy <code class="docutils literal notranslate"><span class="pre">$query</span></code> Syntax<a class="headerlink" href="#legacy-query-syntax" title="Permalink to this headline">#</a></h3>
<p><em>This usage is deprecated.</em></p>
<p>The <code class="docutils literal notranslate"><span class="pre">find</span></code> method allows providing the query and the options using the
legacy <code class="docutils literal notranslate"><span class="pre">$query</span></code> syntax in the first parameter:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:&#39;$query&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Mr. Smith&#39;</span><span class="p">})</span>
<span class="c1"># Equivalent to:</span>
<span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Mr. Smith&#39;</span><span class="p">)</span>

<span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:&#39;$query&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Mr. Smith&#39;</span><span class="p">},</span> <span class="ss">:&#39;$sort&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">age</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="c1"># Equivalent to:</span>
<span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Mr. Smith&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="ss">age</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>When the query is executed against MongoDB 3.2 or newer, the driver will
use the protocol appropriate for the server version in question, automatically
converting the query as needed to either a find command or an OP_MSG payload.</p>
</section>
<section id="query-options">
<span id="id7"></span><h3>Query Options<a class="headerlink" href="#query-options" title="Permalink to this headline">#</a></h3>
<p>To add options to a query, chain the appropriate methods after the
<code class="docutils literal notranslate"><span class="pre">find</span></code> method. Note that the underlying object, the <code class="docutils literal notranslate"><span class="pre">Mongo::Collection::View</span></code>,
is immutable and a new object will be returned after each method call.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>

<span class="n">documents</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flying Lotus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">documents</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="c1">#=&gt; Yields a BSON::Document.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The following is a full list of the available options that can be added
when querying and their corresponding methods as examples.</p>
<table class="colwidths-given table">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">allow_disk_use</span></code></p></td>
<td><p>When set to true, the server can write temporary data to disk while
executing the find operation. This option is only available on MongoDB
server versions 4.4 and newer.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">allow_partial_results</span></code></p></td>
<td><p>For use with sharded clusters. If a shard is down, allows the query
to return results from the shards that are up, potentially only getting
a portion of the results.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">batch_size(Integer)</span></code></p></td>
<td><p>Specifies the size of each batch of documents the cursor will return on
each <code class="docutils literal notranslate"><span class="pre">GETMORE</span></code> operation.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">comment(String)</span></code></p></td>
<td><p>Adds a comment to the query.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">explain(**opts)</span></code></p></td>
<td><p>Returns the query plan for the query. Pass the <a href="#id8"><span class="problematic" id="id9">:manual:`explain options
&lt;/reference/command/explain/&gt;`</span></a> via the keyword arguments using symbol
keys.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># All server versions - default explain behavior</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">explain</span>

<span class="c1"># MongoDB 3.0 and newer</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="ss">verbosity</span><span class="p">:</span> <span class="ss">:query_planner</span><span class="p">)</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="ss">verbosity</span><span class="p">:</span> <span class="ss">:execution_stats</span><span class="p">)</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="ss">verbosity</span><span class="p">:</span> <span class="ss">:all_plans_execution</span><span class="p">)</span>

<span class="c1"># Alternative syntax using camel case</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="ss">verbosity</span><span class="p">:</span> <span class="s2">&quot;queryPlanner&quot;</span><span class="p">)</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="ss">verbosity</span><span class="p">:</span> <span class="s2">&quot;executionStats&quot;</span><span class="p">)</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="ss">verbosity</span><span class="p">:</span> <span class="s2">&quot;allPlansExecution&quot;</span><span class="p">)</span>

<span class="c1"># MongoDB 2.6</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="ss">verbose</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</pre></div>
</div>
<p>The explain operation supports <code class="docutils literal notranslate"><span class="pre">:session</span></code> and <code class="docutils literal notranslate"><span class="pre">:read</span></code>
(for read preference) options. To specify these options for a single
explain operation, they must be given to the <code class="docutils literal notranslate"><span class="pre">find</span></code> method as
follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">({},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">explain</span>

<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">({},</span> <span class="ss">read</span><span class="p">:</span> <span class="p">{</span><span class="ss">mode</span><span class="p">:</span> <span class="ss">:secondary_preferred</span><span class="p">})</span><span class="o">.</span><span class="n">explain</span>
</pre></div>
</div>
<p>If the read preference option is specified on the client or on the
collection, it will be passed to the explain operation:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="p">,</span> <span class="ss">read</span><span class="p">:</span> <span class="p">{</span><span class="ss">mode</span><span class="p">:</span> <span class="ss">:secondary_preferred</span><span class="p">}</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">explain</span>
</pre></div>
</div>
<p>Note that the session option is not accepted when creating a collection
object.</p>
<p>The explain command does not support passing the read concern option.
If the read concern is specifed on the client or collection level, or
if the read concern is specified as a find option, it will NOT be passed
by the driver to the explain command.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The information returned by the server for the <code class="docutils literal notranslate"><span class="pre">explain</span></code> command
varies with server version and deployment topology. The driver’s
<code class="docutils literal notranslate"><span class="pre">explain</span></code> method returns whatever the server provided.</p>
<p><strong>The return value of ``explain`` method is not part of the driver’s
public API and depends on the server version and deployment topology.</strong></p>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">hint(Hash)</span></code></p></td>
<td><p>Provides the query with an
<a href="#id10"><span class="problematic" id="id11">:manual:`index hint&lt;/reference/method/cursor.hint/&gt;`</span></a> to use.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">let(Hash)</span></code></p></td>
<td><p>Mapping of <a href="#id12"><span class="problematic" id="id13">:manual:`variables&lt;/reference/command/find/#std-label-find-let-syntax&gt;`</span></a>
to use in the query.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">limit(Integer)</span></code></p></td>
<td><p>Limits the number of returned documents to the provided value.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">max_scan(Integer)</span></code></p></td>
<td><p>Sets the maximum number of documents to scan if a full collection scan
would be performed. Deprecated as of MongoDB server version 4.0.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">max_time_ms(Integer)</span></code></p></td>
<td><p>The maximum amount of time to allow the query to run, in milliseconds.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">no_cursor_timeout</span></code></p></td>
<td><p>MongoDB automatically closes inactive cursors after a period of 10
minutes. Call this for cursors to remain open indefinitely on the server.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">projection(Hash)</span></code></p></td>
<td><p>Specifies the fields to include or exclude from the results.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">projection</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">read(Hash)</span></code></p></td>
<td><p>Changes the read preference for this query only.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="ss">:mode</span> <span class="o">=&gt;</span> <span class="ss">:secondary_preferred</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">session(Session)</span></code></p></td>
<td><p>The session to use.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">show_disk_loc(Boolean)</span></code></p></td>
<td><p>Tells the results to also include the location of the documents on disk.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">skip(Integer)</span></code></p></td>
<td><p>Skip the provided number of documents in the results.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">snapshot</span></code></p></td>
<td><p>Execute the query in snapshot mode. Deprecated as of MongoDB server version 4.0.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">sort(Hash)</span></code></p></td>
<td><p>Specifies sort criteria for the query.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="additional-query-operations">
<h3>Additional Query Operations<a class="headerlink" href="#additional-query-operations" title="Permalink to this headline">#</a></h3>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">count_documents</span></code></dt><dd><p>Get the total number of documents matching a filter, or the total number
of documents in a collection.</p>
</dd>
</dl>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>

<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flying Lotus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count_documents</span>
</pre></div>
</div>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">estimated_document_count</span></code></dt><dd><p>Get an approximate number of documents in the collection.</p>
<p>Note that unlike <code class="docutils literal notranslate"><span class="pre">count_documents</span></code>, <code class="docutils literal notranslate"><span class="pre">estimated_document_count</span></code> does not
accept a filter.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">count</span></code> server command is used to implement <code class="docutils literal notranslate"><span class="pre">estimated_document_count</span></code>.
More information can be found via <a class="reference external" href="https://www.mongodb.com/docs/manual/reference/command/count/#behavior">Count: Behavior</a>.</p>
<p>Due to an oversight in MongoDB versions 5.0.0-5.0.7, the <code class="docutils literal notranslate"><span class="pre">count</span></code> command,
which <code class="docutils literal notranslate"><span class="pre">estimated_document_count</span></code> uses in its implementation, was not
included in v1 of the Stable API. Therefore, users of the Stable API with
<code class="docutils literal notranslate"><span class="pre">estimated_document_count</span></code> are recommended to upgrade their server version to
5.0.8+ or set <code class="docutils literal notranslate"><span class="pre">api_strict:</span> <span class="pre">false</span></code> to avoid encountering errors.</p>
</dd>
</dl>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>

<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">estimated_document_count</span>
</pre></div>
</div>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">count</span></code></dt><dd><p>Get an approximate number of documents matching a filter, or an approximate
number of documents in the collection.</p>
<p><em>Deprecated:</em> The <code class="docutils literal notranslate"><span class="pre">count</span></code> method is deprecated and does not work in
transactions. Please use <code class="docutils literal notranslate"><span class="pre">count_documents</span></code> to obtain an exact count of
documents potentially matching a filter or <code class="docutils literal notranslate"><span class="pre">estimated_document_count</span></code>
to obtain an approximate number of documents in the collection.</p>
</dd>
</dl>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>

<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flying Lotus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">distinct</span></code></dt><dd><p>Filters out documents with duplicate values. Equivalent to the SQL
<code class="docutils literal notranslate"><span class="pre">distinct</span></code> clause.</p>
</dd>
</dl>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>

<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="ss">:name</span> <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="tailable-cursors">
<h3>Tailable Cursors<a class="headerlink" href="#tailable-cursors" title="Permalink to this headline">#</a></h3>
<p>For capped collections you may use a <a href="#id14"><span class="problematic" id="id15">:manual:`tailable cursor
&lt;/core/tailable-cursors/&gt;`</span></a> that remains open
after the client exhausts the results in the initial cursor. The
following code example shows how a tailable cursor might be used:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">drop</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="p">,</span> <span class="ss">capped</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">512</span><span class="o">].</span><span class="n">create</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">insert_many</span><span class="p">(</span><span class="o">[</span>
  <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flying Lotus&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Aphex Twin&#39;</span> <span class="p">}</span>
<span class="o">]</span><span class="p">)</span>

<span class="n">enum</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">({},</span> <span class="ss">cursor_type</span><span class="p">:</span> <span class="ss">:tailable_await</span><span class="p">)</span><span class="o">.</span><span class="n">to_enum</span>

<span class="k">while</span> <span class="kp">true</span>
  <span class="n">doc</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">next</span>
  <span class="c1"># do something</span>
  <span class="nb">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="read-concern">
<h3>Read Concern<a class="headerlink" href="#read-concern" title="Permalink to this headline">#</a></h3>
<p>Read concern can be <a class="reference internal" href="create-client.html#client-options"><span class="std std-ref">set on the client</span></a>
or on the collection:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;localhost:14420&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span>
  <span class="ss">read_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">level</span><span class="p">:</span> <span class="ss">:local</span><span class="p">})</span>

<span class="n">client</span><span class="o">[</span><span class="s1">&#39;collection&#39;</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">to_a</span>

<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="ss">read_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">level</span><span class="p">:</span> <span class="ss">:majority</span><span class="p">}</span><span class="o">]</span>

<span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="o">.</span><span class="n">to_a</span>
</pre></div>
</div>
<p>The driver does not currently support setting read concern on an individual
query.</p>
<p>Read concern can be specified when <a class="reference internal" href="transactions.html#using-transactions"><span class="std std-ref">starting a transaction</span></a>. When a transaction is active, <a href="#id16"><span class="problematic" id="id17">:manual:`any read concern
specified on the client or on the collection is ignored
&lt;/core/transactions/#transactions-and-read-concern&gt;`</span></a>.</p>
<p>When using the generic command helper, the read concern can be specified as
part of the command:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="ss">collstats</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="ss">readConcern</span><span class="p">:</span> <span class="p">{</span><span class="ss">level</span><span class="p">:</span> <span class="ss">:majority</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="read-preference">
<span id="id18"></span><h3>Read Preference<a class="headerlink" href="#read-preference" title="Permalink to this headline">#</a></h3>
<p>Read preference determines the candidate <a href="#id19"><span class="problematic" id="id20">:manual:`replica set&lt;/replication/&gt;`</span></a>
members to which a query or command can be sent. They consist of a <strong>mode</strong>
specified as a symbol, an array of hashes known as <strong>tag_sets</strong>,
the <code class="docutils literal notranslate"><span class="pre">hedge</span></code> option, which is a Hash specifying hedged read behavior, and two
timing options: <strong>local_threshold</strong> and <strong>server_selection_timeout</strong>.</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">local_threshold</span></code></dt><dd><p>Defines the upper limit in seconds of the latency window
between the nearest server and suitable servers to which an operation may be sent.
The default is 15 milliseconds, or 0.015 seconds.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">server_selection_timeout</span></code></dt><dd><p>Defines how long to block for server selection
before throwing an exception. The default is 30,000 milliseconds, or 30 seconds.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Read preference does not apply to Standalone deployments. When a client
is connected to a Standalone deployment, any application-specified read
preference is ignored.</p>
</div>
<p>For more information on the algorithm used to select a server, please
refer to the <a class="reference external" href="https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.rst">Server Selection documentation, available on GitHub</a>.</p>
<p>Read preference can be set as an option on the client or passed an
option when a command is run on a database:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set read preference on a client, used for all operations</span>
<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span>
                           <span class="ss">read</span><span class="p">:</span> <span class="p">{</span> <span class="ss">mode</span><span class="p">:</span> <span class="ss">:secondary</span><span class="p">,</span>
                                   <span class="ss">tag_sets</span><span class="p">:</span> <span class="o">[</span> <span class="p">{</span> <span class="s1">&#39;dc&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;nyc&#39;</span> <span class="p">}</span> <span class="o">]</span>
                                  <span class="p">}</span> <span class="p">)</span>

<span class="c1"># Set read preference for a given command</span>
<span class="n">client</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">command</span><span class="p">(</span> <span class="p">{</span> <span class="ss">collstats</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span> <span class="p">},</span> <span class="ss">read</span><span class="p">:</span> <span class="p">{</span> <span class="ss">mode</span><span class="p">:</span> <span class="n">secondary</span><span class="p">,</span>
                                                     <span class="ss">tag_sets</span><span class="p">:</span> <span class="o">[</span> <span class="p">{</span> <span class="s1">&#39;dc&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;nyc&#39;</span> <span class="p">}</span> <span class="o">]</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>Read preference can also be set for specific operations on a collection
using the <code class="docutils literal notranslate"><span class="pre">with</span></code> method:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">]</span>
<span class="n">artists</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:read</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:mode</span> <span class="o">=&gt;</span> <span class="ss">:primary_preferred</span> <span class="p">})</span><span class="o">.</span><span class="n">find</span><span class="o">.</span><span class="n">to_a</span>
</pre></div>
</div>
</section>
<section id="mode">
<h3>Mode<a class="headerlink" href="#mode" title="Permalink to this headline">#</a></h3>
<p>There are five possible read preference modes: <code class="docutils literal notranslate"><span class="pre">:primary</span></code>, <code class="docutils literal notranslate"><span class="pre">:secondary</span></code>,
<code class="docutils literal notranslate"><span class="pre">:primary_preferred</span></code>, <code class="docutils literal notranslate"><span class="pre">:secondary_preferred</span></code> and``:nearest``.
Please see the <a href="#id21"><span class="problematic" id="id22">:manual:`read preference documentation in the MongoDB Manual
&lt;/core/read-preference/&gt;`</span></a> for an explanation of the modes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When a client is directly connected to a server using the <code class="docutils literal notranslate"><span class="pre">:direct_connection</span></code>
Ruby option or the <code class="docutils literal notranslate"><span class="pre">directConnection</span></code> URI option, read preference mode
is automatically set to <code class="docutils literal notranslate"><span class="pre">:primary_preferred</span></code> to permit read operations
against secondaries. If the application specified a <code class="docutils literal notranslate"><span class="pre">:primary</span></code> read
preference mode, the mode is automatically converted to <code class="docutils literal notranslate"><span class="pre">:primary_preferred</span></code>.
If another read preference mode is specified, it is passed to the server
unchanged.</p>
</div>
</section>
<section id="tag-sets">
<h3>Tag sets<a class="headerlink" href="#tag-sets" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">tag_sets</span></code> parameter is an ordered list of tag sets used to
restrict the eligibility of servers for selection, such as for data
center awareness. Please see the <a href="#id23"><span class="problematic" id="id24">:manual:`read preference documentation in
the MongoDB Manual &lt;/core/read-preference/&gt;`</span></a> for an explanation of tag sets.</p>
<p>A read preference tag set (T) matches a server tag set (S) – or
equivalently a server tag set (S) matches a read preference tag set
(T) — if T is a subset of S.</p>
<p>For example, the read preference tag set <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">dc:</span> <span class="pre">'ny',</span> <span class="pre">rack:</span> <span class="pre">2</span> <span class="pre">}</span></code>
matches a secondary server with tag set <code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">dc:</span> <span class="pre">'ny',</span> <span class="pre">rack:</span> <span class="pre">2,</span> <span class="pre">size:</span> <span class="pre">'large'</span> <span class="pre">}</span></code>.</p>
<p>A tag set that is an empty document matches any server, because
the empty tag set is a subset of any tag set. This means the default
<code class="docutils literal notranslate"><span class="pre">tag_sets</span></code> parameter <code class="docutils literal notranslate"><span class="pre">[{}]</span></code> matches all servers.</p>
</section>
<section id="hedge">
<h3>Hedge<a class="headerlink" href="#hedge" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">hedge</span></code> parameter is a Hash that specifies whether the server should use
hedged reads. With hedged reads, sharded clusters can route read operations to
two replica set members and return results from the first respondent.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">hedge</span></code> option may only be specified on non-primary read preferences. It
must be provided as Hash with the key <code class="docutils literal notranslate"><span class="pre">enabled</span></code> set to <code class="docutils literal notranslate"><span class="pre">true</span></code> or <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span>
  <span class="ss">read</span><span class="p">:</span> <span class="p">{</span> <span class="ss">mode</span><span class="p">:</span> <span class="ss">:secondary</span><span class="p">,</span> <span class="ss">hedge</span><span class="p">:</span> <span class="p">{</span> <span class="ss">enabled</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
<p>See the <a href="#id25"><span class="problematic" id="id26">:manual:`MongoDB Manual &lt;/core/read-preference-hedge-option&gt;`</span></a> for
more information about hedged reads.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">hedge</span></code> option is only available on MongoDB server versions 4.4 and newer.
Attempting to use this option on older server versions will result in an error.</p>
</div>
</section>
</section>
<section id="updating">
<span id="id27"></span><h2>Updating<a class="headerlink" href="#updating" title="Permalink to this headline">#</a></h2>
<p>Updating documents is possible by executing a single or
multiple update, or by using the <code class="docutils literal notranslate"><span class="pre">$findAndModify</span></code> command.</p>
<p><code class="docutils literal notranslate"><span class="pre">update_one</span></code></p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">]</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Goldie&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span><span class="s2">&quot;$inc&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:plays</span> <span class="o">=&gt;</span>  <span class="mi">1</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">n</span> <span class="c1"># Returns 1.</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Goldie&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="s2">&quot;$inc&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:plays</span> <span class="o">=&gt;</span>  <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">n</span> <span class="c1"># Returns 1.</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">update_many</span></code></p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:label</span> <span class="o">=&gt;</span> <span class="s1">&#39;Hospital&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span> <span class="s2">&quot;$inc&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:plays</span> <span class="o">=&gt;</span>  <span class="mi">1</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">modified_count</span> <span class="c1"># Returns the number of documents that were updated.</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span> <span class="p">{</span> <span class="ss">:label</span> <span class="o">=&gt;</span> <span class="s1">&#39;Hospital&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="s2">&quot;$inc&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:plays</span> <span class="o">=&gt;</span>  <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">modified_count</span> <span class="c1"># Returns the number of documents that were updated.</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">replace_one</span></code></p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Aphex Twin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace_one</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Richard James&#39;</span><span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">modified_count</span> <span class="c1"># Returns 1.</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">replace_one</span><span class="p">(</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Aphex Twin&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Richard James&#39;</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">modified_count</span> <span class="c1"># Returns 1.</span>
</pre></div>
</div>
<p>To update documents and return a document via <code class="docutils literal notranslate"><span class="pre">$findAndModify</span></code>, use one of
the three provided helpers: <code class="docutils literal notranslate"><span class="pre">find_one_and_delete</span></code>, <code class="docutils literal notranslate"><span class="pre">find_one_and_replace</span></code>,
or <code class="docutils literal notranslate"><span class="pre">find_one_and_update</span></code>. You can opt to return the document before or after
the modification occurs.</p>
<p><code class="docutils literal notranslate"><span class="pre">find_one_and_delete</span></code></p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">]</span>

<span class="n">artists</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José James&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find_one_and_delete</span> <span class="c1"># Returns the document.</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">find_one_and_replace</span></code></p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">doc</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José James&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find_one_and_replace</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José&#39;</span><span class="p">)</span>
<span class="n">doc</span> <span class="c1"># Return the document before the update.</span>

<span class="n">doc</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find_one_and_replace</span><span class="p">({</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José James&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José&#39;</span> <span class="p">})</span>
<span class="n">doc</span> <span class="c1"># Return the document before the update.</span>

<span class="n">doc</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José James&#39;</span><span class="p">)</span><span class="o">.</span>
  <span class="n">find_one_and_replace</span><span class="p">(</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José&#39;</span> <span class="p">},</span> <span class="ss">:return_document</span> <span class="o">=&gt;</span> <span class="ss">:after</span> <span class="p">)</span>
<span class="n">doc</span> <span class="c1"># Return the document after the update.</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">find_one_and_update</span></code></p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">doc</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José James&#39;</span><span class="p">)</span><span class="o">.</span>
  <span class="n">find_one_and_update</span><span class="p">(</span> <span class="s1">&#39;$set&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José&#39;</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">doc</span> <span class="c1"># Return the document before the update.</span>

<span class="n">doc</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find_one_and_update</span><span class="p">(</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José James&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="s1">&#39;$set&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;José&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">doc</span> <span class="c1"># Return the document before the update.</span>
</pre></div>
</div>
<section id="update-options">
<h3>Update Options<a class="headerlink" href="#update-options" title="Permalink to this headline">#</a></h3>
<p>To add options to an update command, specify them as key-value pairs in the options
Hash argument.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">]</span>

<span class="n">artists</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">create_one</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Force the server to use the name index to perform this operation</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
  <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Goldie&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="s2">&quot;$inc&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:plays</span> <span class="o">=&gt;</span>  <span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">hint</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">n</span> <span class="c1"># Returns 1.</span>
</pre></div>
</div>
<p>The following is a list of the options that can be added to update operations,
including <code class="docutils literal notranslate"><span class="pre">update_one</span></code>, <code class="docutils literal notranslate"><span class="pre">update_many</span></code>, <code class="docutils literal notranslate"><span class="pre">replace_one</span></code>,
<code class="docutils literal notranslate"><span class="pre">find_one_and_delete</span></code>, <code class="docutils literal notranslate"><span class="pre">find_one_and_update</span></code>, and <code class="docutils literal notranslate"><span class="pre">find_one_and_replace</span></code>.</p>
<table class="colwidths-given table">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">array_filters</span></code></p></td>
<td><p>An Array of filter documents that determine which array elements to modify
for an update operation on an array field.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">bypass_document_validation</span></code></p></td>
<td><p>Whether to skip document-level validation before writing the document.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">collation</span></code></p></td>
<td><p>Specifies a set of rules to use when comparing strings complying with the
conventions of a particular language.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">hint</span></code></p></td>
<td><p>The index to use for this operation. May be specified as a Hash
(e.g. { _id: 1 }) or as a String (e.g. “_id_”). Supported on MongoDB
server versions 4.2 and newer for <code class="docutils literal notranslate"><span class="pre">update_one</span></code>, <code class="docutils literal notranslate"><span class="pre">update_many</span></code>, and
<code class="docutils literal notranslate"><span class="pre">replace_one</span></code> commands, and on server versions 4.4 and newer for
<code class="docutils literal notranslate"><span class="pre">find_one_and_delete</span></code>, <code class="docutils literal notranslate"><span class="pre">find_one_and_update</span></code>, and <code class="docutils literal notranslate"><span class="pre">find_one_and_replace</span></code>
commands.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">let(Hash)</span></code></p></td>
<td><p>Mapping of <a href="#id28"><span class="problematic" id="id29">:manual:`variables&lt;/reference/command/update/#std-label-update-let-syntax&gt;`</span></a>
to use for this operation.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">projection</span></code></p></td>
<td><p>The fields to exclude or include in the operation result (only available
on <code class="docutils literal notranslate"><span class="pre">find_one_and_delete</span></code>, <code class="docutils literal notranslate"><span class="pre">find_one_and_replace</span></code>, and
<code class="docutils literal notranslate"><span class="pre">find_one_and_update</span></code> commands).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">return_document</span></code></p></td>
<td><p>A symbol specifying whether to return the updated document as it was before or
after the update. Potential values are <code class="docutils literal notranslate"><span class="pre">:before</span></code> or <code class="docutils literal notranslate"><span class="pre">:after</span></code>.
(Only available on <code class="docutils literal notranslate"><span class="pre">find_one_and_update</span></code> and <code class="docutils literal notranslate"><span class="pre">find_one_and_replace</span></code> commands).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">sort</span></code></p></td>
<td><p>How to sort the results of a find and modify command. Specified as a Hash
key-value pair, where the key is the name of the field to sort by, and
the value is either 1 or -1, specifying a sort in ascending or descending
order (only available on <code class="docutils literal notranslate"><span class="pre">find_one_and_delete</span></code>, <code class="docutils literal notranslate"><span class="pre">find_one_and_replace</span></code>,
and <code class="docutils literal notranslate"><span class="pre">find_one_and_update</span></code> commands).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">session</span></code></p></td>
<td><p>The session to use for this operation.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">upsert</span></code></p></td>
<td><p>Whether to upsert if the document doesn’t exist. Cannot be used on
<code class="docutils literal notranslate"><span class="pre">find_one_and_delete</span></code> operation.</p></td>
</tr>
</tbody>
</table>
<p>For more information about update options, see the MongoDB server documentation
on the following commands:</p>
<ul class="simple">
<li><p><a href="#id30"><span class="problematic" id="id31">:manual:`update &lt;/reference/command/update&gt;`</span></a></p></li>
<li><p><a href="#id32"><span class="problematic" id="id33">:manual:`findAndModify &lt;/reference/command/findAndModify&gt;`</span></a></p></li>
</ul>
</section>
</section>
<section id="deleting">
<h2>Deleting<a class="headerlink" href="#deleting" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">delete_one</span></code></p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">]</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Björk&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete_one</span>
<span class="n">result</span><span class="o">.</span><span class="n">deleted_count</span> <span class="c1"># Returns 1.</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Björk&#39;</span><span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">deleted_count</span> <span class="c1"># Returns 1.</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">delete_many</span></code></p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:label</span> <span class="o">=&gt;</span> <span class="s1">&#39;Mute&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete_many</span>
<span class="n">result</span><span class="o">.</span><span class="n">deleted_count</span> <span class="c1"># Returns the number deleted.</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">delete_many</span><span class="p">(</span><span class="ss">:label</span> <span class="o">=&gt;</span> <span class="s1">&#39;Mute&#39;</span><span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">deleted_count</span> <span class="c1"># Returns the number deleted.</span>
</pre></div>
</div>
<section id="delete-options">
<h3>Delete Options<a class="headerlink" href="#delete-options" title="Permalink to this headline">#</a></h3>
<p>To add options to a delete command, specify them as key-value pairs in the
options Hash argument.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">]</span>

<span class="n">artists</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">create_one</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Force the server to use the name index to perform this operation</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Björk&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span><span class="ss">hint</span><span class="p">:</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="n">result</span><span class="o">.</span><span class="n">deleted_count</span> <span class="c1"># Returns 1.</span>
</pre></div>
</div>
<p>The following is a full list of the available options that can be added
to <code class="docutils literal notranslate"><span class="pre">delete_one</span></code> and <code class="docutils literal notranslate"><span class="pre">delete_many</span></code> operations.</p>
<table class="colwidths-given table">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">collation</span></code></p></td>
<td><p>Specifies a set of rules to use when comparing strings complying with the
conventions of a particular language.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">hint</span></code></p></td>
<td><p>The index to use for this operation. May be specified as a Hash
(e.g. { _id: 1 }) or as a String (e.g. “_id_”). Supported on MongoDB
server versions 4.4 and newer.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">let(Hash)</span></code></p></td>
<td><p>Mapping of <a href="#id34"><span class="problematic" id="id35">:manual:`variables&lt;/reference/command/delete/#std-label-delete-let-syntax&gt;`</span></a>
to use for this operation.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">session</span></code></p></td>
<td><p>The session to use for this operation.</p></td>
</tr>
</tbody>
</table>
<p>For more information about update options, see the MongoDB server documentation
on the <a href="#id36"><span class="problematic" id="id37">:manual:`delete command. &lt;/reference/command/delete&gt;`</span></a></p>
</section>
</section>
<section id="write-concern">
<span id="id38"></span><h2>Write Concern<a class="headerlink" href="#write-concern" title="Permalink to this headline">#</a></h2>
<p>All write operations in MongoDB are executed with a write concern which is
the level of acknowledgment requested from MongoDB for the particular write.
More information about write concerns in general is available in the
<a class="reference external" href="https://mongodb.com/docs/manual/reference/write-concern/">MongoDB manual</a>.</p>
<p>The Ruby driver supports specifying write concern on client, collection,
session (for transactions on that session), transaction, GridFS bucket
and write stream levels, as well as when manually issuing commands via
<code class="docutils literal notranslate"><span class="pre">Database#command</span></code>.</p>
<p>As of driver version 2.10, all driver objects accepting write concerns do so
through the <code class="docutils literal notranslate"><span class="pre">:write_concern</span></code> option, which should be given a hash with
the write concern options. Usage of the <code class="docutils literal notranslate"><span class="pre">:write</span></code> option is deprecated.
In driver versions 2.9 and below, client, collection and GridFS objects
took write concern options in the <code class="docutils literal notranslate"><span class="pre">:write</span></code> option with session and
transaction objects employing the <code class="docutils literal notranslate"><span class="pre">:write_concern</span></code> option.</p>
<p>Below are some examples of passing write concerns to client and collection
objects. The <code class="docutils literal notranslate"><span class="pre">:write_concern</span></code> option can be provided when constructing
new client and collection objects,  or to the <code class="docutils literal notranslate"><span class="pre">#with</span></code> methods.</p>
<p>GridFS examples are provided on the <a class="reference internal" href="gridfs.html#gridfs"><span class="std std-ref">GridFS</span></a> page.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span>
  <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="n">alt_client</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="ss">:majority</span><span class="p">})</span>

<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="p">,</span> <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">]</span>
<span class="n">alt_collection</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="ss">:majority</span><span class="p">})</span>

<span class="c1"># Uses w: 3</span>
<span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">})</span>
<span class="c1"># Uses w: :majority</span>
<span class="n">alt_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Driver versions 2.9 and earlier accepted write concerns on client and collection
level via the <code class="docutils literal notranslate"><span class="pre">:write</span></code> option. This usage continues to be supported for
backwards compatibility, but is deprecated:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span>
  <span class="ss">write</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="n">alt_client</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">write</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="ss">:majority</span><span class="p">})</span>

<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="p">,</span> <span class="ss">write</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">]</span>
<span class="n">alt_collection</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">write</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="ss">:majority</span><span class="p">})</span>
</pre></div>
</div>
<p>If both <code class="docutils literal notranslate"><span class="pre">:write</span></code> and <code class="docutils literal notranslate"><span class="pre">:write_concern</span></code> options are provided, their
values must be identical or an exception will be raised:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># OK</span>
<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span>
  <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="ss">write</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>

<span class="c1"># Error</span>
<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span>
  <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="ss">write</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="ss">:majority</span><span class="p">})</span>
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">#with</span></code> methods are used to alter the options on a client or collection,
the last provided option wins in case of naming differences:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span>
  <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="n">alt_client</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">write</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>

<span class="n">alt_client</span><span class="o">.</span><span class="n">options</span><span class="o">[</span><span class="ss">:write</span><span class="o">]</span>
<span class="c1"># =&gt; {&quot;w&quot;=&gt;3}</span>

<span class="n">alt_client</span><span class="o">.</span><span class="n">options</span><span class="o">[</span><span class="ss">:write_concern</span><span class="o">]</span>
<span class="c1"># =&gt; nil</span>
</pre></div>
</div>
<p>When using transactions, write concern is only sent to the server in
<code class="docutils literal notranslate"><span class="pre">commit_transaction</span></code> and <code class="docutils literal notranslate"><span class="pre">abort_transaction</span></code> operations
per the <a class="reference external" href="https://github.com/mongodb/specifications/blob/master/source/transactions/transactions.rst#writeconcern">transactions specification</a>.
Write concern may be set via the <code class="docutils literal notranslate"><span class="pre">:write_concern</span></code> option in a
<code class="docutils literal notranslate"><span class="pre">with_transaction</span></code> or <code class="docutils literal notranslate"><span class="pre">start_transaction</span></code> call, or via
<code class="docutils literal notranslate"><span class="pre">default_transaction_options</span></code> option on a session object.
If neither of these is set, write concern of the client is used; note
that transactions ignore write concerns of collections that are involved
in their operations. Note that when setting the write concern as a
transaction option, the <code class="docutils literal notranslate"><span class="pre">:write</span></code> option is not recognized by any
driver version.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span>
  <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="p">,</span> <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="ss">:majority</span><span class="p">}</span><span class="o">]</span>


<span class="n">session</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span>
<span class="n">session</span><span class="o">.</span><span class="n">with_transaction</span> <span class="k">do</span>
  <span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="nb">test</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>

  <span class="c1"># Uses w: 2 when committing</span>
<span class="k">end</span>


<span class="n">session</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span><span class="p">(</span><span class="ss">default_transaction_options</span><span class="p">:</span>
  <span class="p">{</span><span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">with_transaction</span> <span class="k">do</span>
  <span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="nb">test</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>

  <span class="c1"># Uses w: 3 when committing</span>
<span class="k">end</span>


<span class="n">session</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span>
<span class="n">session</span><span class="o">.</span><span class="n">with_transaction</span><span class="p">(</span><span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span> <span class="k">do</span>
  <span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="nb">test</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>

  <span class="c1"># Uses w: 3 when committing</span>
<span class="k">end</span>
</pre></div>
</div>
<p>When write concerns are inherited, inheritance applies to the entire
write concern hash rather than individual elements. For example, <code class="docutils literal notranslate"><span class="pre">j:</span> <span class="pre">true</span></code>
is not inherited in the following case:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span>
  <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">j</span><span class="p">:</span> <span class="kp">true</span><span class="p">})</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="p">,</span> <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span><span class="o">]</span>

<span class="n">collection</span><span class="o">.</span><span class="n">write_concern</span><span class="o">.</span><span class="n">options</span>
<span class="c1"># =&gt; #&lt;Mongo::WriteConcern::Acknowledged:0x47289650367880 options={:w=&gt;2}&gt;</span>
</pre></div>
</div>
<p>Although CRUD operations accept an options hash, they currently do not
recognize the <code class="docutils literal notranslate"><span class="pre">:write_concern</span></code> option:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span>
  <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="p">,</span> <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="ss">:majority</span><span class="p">}</span><span class="o">]</span>

<span class="c1"># Still uses w: :majority</span>
<span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">},</span> <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</pre></div>
</div>
<p>The easiest workaround for this is to use <code class="docutils literal notranslate"><span class="pre">#with</span></code> to obtain a new collection
instance with the desired write concern:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uses w: 1</span>
<span class="n">collection</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Write concern can also be manually specified in <code class="docutils literal notranslate"><span class="pre">Database#command</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="ss">create</span><span class="p">:</span> <span class="s1">&#39;foo-collection&#39;</span><span class="p">,</span> <span class="ss">writeConcern</span><span class="p">:</span> <span class="p">{</span><span class="ss">w</span><span class="p">:</span> <span class="ss">:majority</span><span class="p">})</span>
</pre></div>
</div>
<p>Note that writeConcern here is part of the operation rather than options,
and the syntax is the camel case one that MongoDB server recognizes, not the
underscore one that Ruby driver uses.</p>
</section>
<section id="field-names-with-dots-periods-and-dollar-signs">
<h2>Field Names with Dots/Periods (.) and Dollar Signs ($)<a class="headerlink" href="#field-names-with-dots-periods-and-dollar-signs" title="Permalink to this headline">#</a></h2>
<p>Starting in Mongo Ruby Driver version 2.18.0, the ability to work with fields
that begin with dollar signs ($) and fields with dots/periods (.) in them is available.
In Driver version 2.17.0 and earlier, any attempt to work with dotted or dollared
fields would result in an <code class="docutils literal notranslate"><span class="pre">IllegalKey</span></code> error being raised. See the MongoDB docs
on <a class="reference external" href="https://www.mongodb.com/docs/manual/core/dot-dollar-considerations/">Field Names with Periods (.) and Dollar Signs ($)</a>
for more information on working with these types of fields.</p>
</section>
<section id="a-note-about-the-bson-symbol-type">
<h2>A Note about the BSON Symbol type<a class="headerlink" href="#a-note-about-the-bson-symbol-type" title="Permalink to this headline">#</a></h2>
<p>Because the BSON specification deprecated the BSON symbol type, the <cite>bson</cite> gem
will serialize Ruby symbols into BSON strings when used on its own. However, in
order to maintain backwards compatibility with older datasets, the Ruby driver
overrides this behavior to serialize Ruby symbols as BSON symbols. This is
necessary to be able to specify queries for documents which contain BSON
symbols as fields. Despite this, new documents with symbol type fields should
<em>not</em> be stored in the database; instead, use string fields.</p>
<p>To override default behavior and configure the driver to encode symbol values
as strings, include the following code snippet in your project:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Symbol</span>
  <span class="k">def</span> <span class="nf">bson_type</span>
    <span class="no">BSON</span><span class="o">::</span><span class="nb">String</span><span class="o">::</span><span class="no">BSON_TYPE</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="working-with-data.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Working With Data</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="bulk-operations.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Bulk Writes</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
      &copy; Copyright 2021, MongoDB.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
  <link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css' /><title>Monitoring &mdash; MongoDB Ruby Driver Manual upcoming</title><link rel="shortcut icon" href="https://media.mongodb.org/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index" />

  <meta name="release" content="upcoming"/>
  <meta name="version" content="master"/>
  <meta name="DC.Source" content="https://github.com/mongodb/docs-ruby/blob/master/source/reference/monitoring.txt"/>
  <meta property="og:image" content="http://s3.amazonaws.com/info-mongodb-com/_com_assets/cms/mongodb-for-giant-ideas-bbab5c3cf8.png">
  <meta property="og:image:secure_url" content="https://webassets.mongodb.com/_com_assets/cms/mongodb-for-giant-ideas-bbab5c3cf8.png">
    <link rel="canonical" href="https://docs.mongodb.com/docs-ruby/current/reference/monitoring/" />
  
   <link rel="stylesheet" href="../_static/mongodb-docs.css" type="text/css" />
   <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
   <link rel="stylesheet" href="../_static/css/navbar.min.css?t=nocache" type="text/css" />
    
    <script type="text/javascript" src="../_static/lib/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/lib/bootstrap.js"></script>
    <script type="text/javascript" src="../_static/lib/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/controller.js"></script>
      <link rel="search" type="application/opensearchdescription+xml" href="https://docs.mongodb.com/osd.xml" title="MongoDB Help"/>
<link rel="search" title="Search" href="../search.html" />
<link rel="top" title="MongoDB Ruby Driver Manual" href="../index.html" />
<link rel="up" title="Connection &amp; Configuration" href="connection-and-configuration.html" />
<link rel="next" title="User Management" href="user-management.html" />
<link rel="prev" title="Authentication" href="authentication.html" /></head>
<body data-project="docs-ruby" data-project-title="MongoDB Ruby Driver Manual" data-branch="master" data-enable-marian=1 data-eol="">
  <!-- Google Tag Manager -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-GDFN"
                    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
  {'gtm.start':new Date().getTime(),event:'gtm.js'}
  );var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-GDFN');
  </script>
  <!-- End Google Tag Manager -->
   <script>
     window.googleSearchCx = "014132741538533607290:xl0kbqanc9y"
     window.googleSearchPlaceholder = "Search Ruby Driver"
     window.googleSearchResultsUrl = "http://docs.mongodb.com/ruby-driver/master/search/"
   </script><div class="content" >

   <div id="left-column">
         <aside id="sidebar" class="sidebar">
             
  <div class="sphinxsidebar" id="sphinxsidebar">
    <div id="sphinxsidebarwrapper" class="sphinxsidebarwrapper"><a href="javascript:void(0)" class="closeNav" id="closeNav">Close &times;</a>


<h3>
  <a href="../index.html">MongoDB Ruby Driver Manual</a>
</h3>


    <div class="btn-group version-sidebar">
      
        <button type="button" class="version-button dropdown-toggle" data-toggle="dropdown">
          
          
          master (upcoming)<span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
          
            
            <li class="active">
            
              <a href="#" data-path="ruby-driver/current">
                
                master (upcoming)
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.14">
                
                Version 2.14 (current)
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.13">
                
                Version 2.13
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.12">
                
                Version 2.12
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.11">
                
                Version 2.11
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.10">
                
                Version 2.10
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.9">
                
                Version 2.9
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.8">
                
                Version 2.8
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.7">
                
                Version 2.7
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.6">
                
                Version 2.6
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.5">
                
                Version 2.5
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.4">
                
                Version 2.4
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.3">
                
                Version 2.3
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.2">
                
                Version 2.2
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.0">
                
                Version 2.0
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v1.x">
                
                1.x
              </a>
            </li>
          
        </ul>
      
    </div>


<ul class="current"><li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a><ul><li class="toctree-l2"><a class="reference internal" href="../installation.html">Installation</a></li><li class="toctree-l2"><a class="reference internal" href="driver-compatibility.html">Driver Compatibility</a></li><li class="toctree-l2"><a class="reference internal" href="../support.html">Support</a></li></ul></li><li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul><li class="toctree-l2"><a class="reference internal" href="../tutorials/quick-start.html">Quick Start</a></li></ul></li><li class="toctree-l1 current"><a class="reference internal" href="connection-and-configuration.html">Connection &amp; Configuration</a><ul class="current"><li class="toctree-l2"><a class="reference internal" href="create-client.html">Creating a Client</a></li><li class="toctree-l2"><a class="reference internal" href="authentication.html">Authentication</a></li><li class="toctree-l2 current"><a class="reference internal current" href="">Monitoring</a></li><li class="toctree-l2"><a class="reference internal" href="user-management.html">User Management</a></li></ul></li><li class="toctree-l1"><a class="reference internal" href="working-with-data.html">Working With Data</a><ul><li class="toctree-l2"><a class="reference internal" href="crud-operations.html">CRUD Operations</a></li><li class="toctree-l2"><a class="reference internal" href="bulk-operations.html">Bulk Writes</a></li><li class="toctree-l2"><a class="reference internal" href="projection.html">Projection</a></li><li class="toctree-l2"><a class="reference internal" href="aggregation.html">Aggregation</a></li><li class="toctree-l2"><a class="reference internal" href="text-search.html">Text Search</a></li><li class="toctree-l2"><a class="reference internal" href="geospatial-search.html">Geospatial Search</a></li><li class="toctree-l2"><a class="reference internal" href="query-cache.html">Query Cache</a></li><li class="toctree-l2"><a class="reference internal" href="gridfs.html">GridFS</a></li><li class="toctree-l2"><a class="reference internal" href="change-streams.html">Change Streams</a></li><li class="toctree-l2"><a class="reference internal" href="sessions.html">Sessions</a></li><li class="toctree-l2"><a class="reference internal" href="transactions.html">Transactions</a></li><li class="toctree-l2"><a class="reference internal" href="client-side-encryption.html">Client-Side Encryption</a></li></ul></li><li class="toctree-l1"><a class="reference internal" href="schema-operations.html">Schema Operations</a><ul><li class="toctree-l2"><a class="reference internal" href="database-tasks.html">Databases</a></li><li class="toctree-l2"><a class="reference internal" href="collection-tasks.html">Collections</a></li><li class="toctree-l2"><a class="reference internal" href="indexing.html">Indexing</a></li><li class="toctree-l2"><a class="reference internal" href="collations.html">Collations</a></li></ul></li><li class="toctree-l1"><a class="reference internal" href="../bson-tutorials.html">BSON</a><ul><li class="toctree-l2"><a class="reference internal" href="../tutorials/bson-v4.html">BSON 4.x Tutorial</a></li><li class="toctree-l2"><a class="reference internal" href="../tutorials/bson-v3.html">BSON 3.x Tutorial</a></li></ul></li><li class="toctree-l1"><a class="reference external" href="https://docs.mongodb.com/ruby-driver/master/api/">API</a></li><li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release Notes</a></li><li class="toctree-l1"><a class="reference internal" href="additional-resources.html">Additional Resources</a></li><li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contribute to the Driver</a></li></ul>
    </div>
  </div>
           
         </aside>

   </div>

    <div id="main-column" class="main-column">

    <span id="showNav" class="showNav">Navigation</span>

      
      
        <div class="document">
            <div class="documentwrapper"><div class="bodywrapper">
              <div class="body" data-pagename="reference/monitoring">

                
  <div class="bc">
    
      <ul>
          <li><a href="connection-and-configuration.html">Connection &amp; Configuration</a><span class="bcpoint"> > </span></li>
            <li>Monitoring</li> 
      </ul>
    
    
  </div>
                
                  <div class="section" id="monitoring">
<h1>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><a class="reference internal" href="#command-monitoring" id="id3">Command Monitoring</a></li>
<li><a class="reference internal" href="#server-discovery-and-monitoring" id="id4">Server Discovery And Monitoring</a></li>
<li><a class="reference internal" href="#server-heartbeats" id="id5">Server Heartbeats</a></li>
<li><a class="reference internal" href="#connection-pool-and-connection-monitoring" id="id6">Connection Pool And Connection Monitoring</a></li>
<li><a class="reference internal" href="#disabling-monitoring" id="id7">Disabling Monitoring</a></li>
</ul>
</div>
<p>The driver allows the application to be notified when certain events happen.
These events are organized into the following categories:</p>
<ul class="simple">
<li>Command monitoring</li>
<li>Topology lifecycle</li>
<li>Server lifecycle</li>
<li>Server heartbeats</li>
<li>Connection pools and connections</li>
</ul>
<p>Topology and server events are part of Server Discovery and Monitoring (SDAM).</p>
<div class="section" id="command-monitoring">
<span id="id1"></span><h2>Command Monitoring<a class="headerlink" href="#command-monitoring" title="Permalink to this headline">¶</a></h2>
<p>All user-initiated commands that are sent to the server publish events that
can be subscribed to for fine grained information. The monitoring API
publishes a guaranteed start event for each command, then either a succeeded
or a failed event. A subscriber must implement 3 methods: <code class="docutils literal notranslate"><span class="pre">started</span></code>,
<code class="docutils literal notranslate"><span class="pre">succeeded</span></code>, and <code class="docutils literal notranslate"><span class="pre">failed</span></code>, each which takes a single parameter for
the event. The following is an example logging subscriber based on a
logging subscriber used internally by the driver:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CommandLogSubscriber</span>
  <span class="kp">include</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Loggable</span>

  <span class="k">def</span> <span class="nf">started</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">prefix</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="si">}</span><span class="s2"> | STARTED | </span><span class="si">#{</span><span class="n">format_command</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">command</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">succeeded</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">prefix</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="si">}</span><span class="s2"> | SUCCEEDED | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">duration</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">failed</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">prefix</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="si">}</span><span class="s2"> | FAILED | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">duration</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">logger</span>
    <span class="no">Mongo</span><span class="o">::</span><span class="no">Logger</span><span class="o">.</span><span class="n">logger</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">format_command</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">begin</span>
      <span class="n">args</span><span class="o">.</span><span class="n">inspect</span>
    <span class="k">rescue</span> <span class="no">Exception</span>
      <span class="s1">&#39;&lt;Unable to inspect arguments&gt;&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">format_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">format</span><span class="p">(</span><span class="s2">&quot;COMMAND | %s&quot;</span><span class="o">.</span><span class="n">freeze</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">prefix</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">database_name</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">command_name</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>To register a custom subscriber, you can do so globally for
all clients or on a per-client basis:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">subscriber</span> <span class="o">=</span> <span class="no">CommandLogSubscriber</span><span class="o">.</span><span class="n">new</span>

<span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">Global</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">COMMAND</span><span class="p">,</span> <span class="n">subscriber</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span> <span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">COMMAND</span><span class="p">,</span> <span class="n">subscriber</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<p>Sample output:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-none notranslate"><div class="highlight"><pre><span></span>D, [2018-09-23T13:47:31.258020 #4692] DEBUG -- : COMMAND | 127.0.0.1:27027 | test.ismaster | STARTED | {&quot;ismaster&quot;=&gt;1, &quot;$readPreference&quot;=&gt;{&quot;mode&quot;=&gt;&quot;primary&quot;}, &quot;lsid&quot;=&gt;{&quot;id&quot;=&gt;&lt;BSON::Binary:0x47111693353080 type=uuid data=0x730341e880dc40a2...&gt;}}
D, [2018-09-23T13:47:31.259145 #4692] DEBUG -- : COMMAND | 127.0.0.1:27027 | test.ismaster | SUCCEEDED | 0.000791175s
</pre></div>
</div>
</div>
</div>
<div class="section" id="server-discovery-and-monitoring">
<span id="sdam"></span><h2>Server Discovery And Monitoring<a class="headerlink" href="#server-discovery-and-monitoring" title="Permalink to this headline">¶</a></h2>
<p>The Ruby driver implements <a class="reference external" href="https://github.com/mongodb/specifications/tree/master/source/server-discovery-and-monitoring">Server Discovery And Monitoring (SDAM) specification</a>.
and makes the following events available to the application:</p>
<ul class="simple">
<li>Topology opening</li>
<li>Server opening</li>
<li>Server description changed</li>
<li>Topology changed</li>
<li>Server closed</li>
<li>Topology closed</li>
<li>Heartbeat events (covered below in a separate section)</li>
</ul>
<p>For all events other than the heartbeat events, the <code class="docutils literal notranslate"><span class="pre">succeeded</span></code> method
will be called on each event subscriber with the event as the sole argument.
Available data for events varies, therefore to log the events a separate
class is needed for each event type. A simple SDAM logging subscriber
can look like the following:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SDAMLogSubscriber</span>
  <span class="kp">include</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Loggable</span>

  <span class="k">def</span> <span class="nf">succeeded</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">log_debug</span><span class="p">(</span><span class="n">format_event</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">logger</span>
    <span class="no">Mongo</span><span class="o">::</span><span class="no">Logger</span><span class="o">.</span><span class="n">logger</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">format_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">format</span><span class="p">(</span><span class="s2">&quot;SDAM | %s&quot;</span><span class="o">.</span><span class="n">freeze</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TopologyOpeningLogSubscriber</span> <span class="o">&lt;</span> <span class="no">SDAMLogSubscriber</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">format_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="s2">&quot;Topology type &#39;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">display_name</span><span class="si">}</span><span class="s2">&#39; initializing.&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ServerOpeningLogSubscriber</span> <span class="o">&lt;</span> <span class="no">SDAMLogSubscriber</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">format_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="s2">&quot;Server </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s2"> initializing.&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ServerDescriptionChangedLogSubscriber</span> <span class="o">&lt;</span> <span class="no">SDAMLogSubscriber</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">format_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="s2">&quot;Server description for </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s2"> changed from &quot;</span> <span class="o">+</span>
    <span class="s2">&quot;&#39;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">previous_description</span><span class="o">.</span><span class="n">server_type</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">new_description</span><span class="o">.</span><span class="n">server_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TopologyChangedLogSubscriber</span> <span class="o">&lt;</span> <span class="no">SDAMLogSubscriber</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">format_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">previous_topology</span> <span class="o">!=</span> <span class="n">event</span><span class="o">.</span><span class="n">new_topology</span>
      <span class="s2">&quot;Topology type &#39;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">previous_topology</span><span class="o">.</span><span class="n">display_name</span><span class="si">}</span><span class="s2">&#39; changed to &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;type &#39;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">new_topology</span><span class="o">.</span><span class="n">display_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
    <span class="k">else</span>
      <span class="s2">&quot;There was a change in the members of the &#39;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">new_topology</span><span class="o">.</span><span class="n">display_name</span><span class="si">}</span><span class="s2">&#39; &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;topology.&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ServerClosedLogSubscriber</span> <span class="o">&lt;</span> <span class="no">SDAMLogSubscriber</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">format_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="s2">&quot;Server </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s2"> connection closed.&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TopologyClosedLogSubscriber</span> <span class="o">&lt;</span> <span class="no">SDAMLogSubscriber</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">format_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="s2">&quot;Topology type &#39;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">display_name</span><span class="si">}</span><span class="s2">&#39; closed.&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>To subscribe to SDAM events globally:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">topology_opening_subscriber</span> <span class="o">=</span> <span class="no">TopologyOpeningLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">server_opening_subscriber</span> <span class="o">=</span> <span class="no">ServerOpeningLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">server_description_changed_subscriber</span> <span class="o">=</span> <span class="no">ServerDescriptionChangedLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">topology_changed_subscriber</span> <span class="o">=</span> <span class="no">TopologyChangedLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">server_closed_subscriber</span> <span class="o">=</span> <span class="no">ServerClosedLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">topology_closed_subscriber</span> <span class="o">=</span> <span class="no">TopologyClosedLogSubscriber</span><span class="o">.</span><span class="n">new</span>

<span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">Global</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">TOPOLOGY_OPENING</span><span class="p">,</span>
  <span class="n">topology_opening_subscriber</span><span class="p">)</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">Global</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">SERVER_OPENING</span><span class="p">,</span>
  <span class="n">server_opening_subscriber</span><span class="p">)</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">Global</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">SERVER_DESCRIPTION_CHANGED</span><span class="p">,</span>
  <span class="n">server_description_changed_subscriber</span><span class="p">)</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">Global</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">TOPOLOGY_CHANGED</span><span class="p">,</span>
  <span class="n">topology_changed_subscriber</span><span class="p">)</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">Global</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">SERVER_CLOSED</span><span class="p">,</span>
  <span class="n">server_closed_subscriber</span><span class="p">)</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">Global</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">TOPOLOGY_CLOSED</span><span class="p">,</span>
  <span class="n">topology_closed_subscriber</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Subscribing to SDAM events for a single client is a little more involved
since the events may be published during the client’s construction:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">topology_opening_subscriber</span> <span class="o">=</span> <span class="no">TopologyOpeningLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">server_opening_subscriber</span> <span class="o">=</span> <span class="no">ServerOpeningLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">server_description_changed_subscriber</span> <span class="o">=</span> <span class="no">ServerDescriptionChangedLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">topology_changed_subscriber</span> <span class="o">=</span> <span class="no">TopologyChangedLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">server_closed_subscriber</span> <span class="o">=</span> <span class="no">ServerClosedLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">topology_closed_subscriber</span> <span class="o">=</span> <span class="no">TopologyClosedLogSubscriber</span><span class="o">.</span><span class="n">new</span>

<span class="n">sdam_proc</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
  <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">TOPOLOGY_OPENING</span><span class="p">,</span>
    <span class="n">topology_opening_subscriber</span><span class="p">)</span>
  <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">SERVER_OPENING</span><span class="p">,</span>
    <span class="n">server_opening_subscriber</span><span class="p">)</span>
  <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">SERVER_DESCRIPTION_CHANGED</span><span class="p">,</span>
    <span class="n">server_description_changed_subscriber</span><span class="p">)</span>
  <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">TOPOLOGY_CHANGED</span><span class="p">,</span>
    <span class="n">topology_changed_subscriber</span><span class="p">)</span>
  <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">SERVER_CLOSED</span><span class="p">,</span>
    <span class="n">server_closed_subscriber</span><span class="p">)</span>
  <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">TOPOLOGY_CLOSED</span><span class="p">,</span>
    <span class="n">topology_closed_subscriber</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;127.0.0.1:27017&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
  <span class="ss">sdam_proc</span><span class="p">:</span> <span class="n">sdam_proc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Sample output:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-none notranslate"><div class="highlight"><pre><span></span>D, [2018-10-09T13:58:03.489461 #22079] DEBUG -- : SDAM | Topology type &#39;Unknown&#39; initializing.
D, [2018-10-09T13:58:03.489699 #22079] DEBUG -- : SDAM | Server 127.0.0.1:27100 initializing.
D, [2018-10-09T13:58:03.491384 #22079] DEBUG -- : SDAM | Server description for 127.0.0.1:27100 changed from &#39;unknown&#39; to &#39;unknown&#39;.
D, [2018-10-09T13:58:03.491642 #22079] DEBUG -- : SDAM | Server localhost:27100 initializing.
D, [2018-10-09T13:58:03.493199 #22079] DEBUG -- : SDAM | Server description for localhost:27100 changed from &#39;unknown&#39; to &#39;primary&#39;.
D, [2018-10-09T13:58:03.493473 #22079] DEBUG -- : SDAM | Server localhost:27101 initializing.
D, [2018-10-09T13:58:03.494874 #22079] DEBUG -- : SDAM | Server description for localhost:27101 changed from &#39;unknown&#39; to &#39;secondary&#39;.
D, [2018-10-09T13:58:03.495139 #22079] DEBUG -- : SDAM | Server localhost:27102 initializing.
D, [2018-10-09T13:58:03.496504 #22079] DEBUG -- : SDAM | Server description for localhost:27102 changed from &#39;unknown&#39; to &#39;secondary&#39;.
D, [2018-10-09T13:58:03.496777 #22079] DEBUG -- : SDAM | Topology type &#39;Unknown&#39; changed to type &#39;ReplicaSetNoPrimary&#39;.
D, [2018-10-09T13:58:03.497306 #22079] DEBUG -- : SDAM | Server 127.0.0.1:27100 connection closed.
D, [2018-10-09T13:58:03.497606 #22079] DEBUG -- : SDAM | Topology type &#39;ReplicaSetNoPrimary&#39; changed to type &#39;ReplicaSetWithPrimary&#39;.

# client.close

D, [2018-10-09T13:58:05.342057 #22079] DEBUG -- : SDAM | Server localhost:27100 connection closed.
D, [2018-10-09T13:58:05.342299 #22079] DEBUG -- : SDAM | Server localhost:27101 connection closed.
D, [2018-10-09T13:58:05.342565 #22079] DEBUG -- : SDAM | Server localhost:27102 connection closed.
D, [2018-10-09T13:58:05.342693 #22079] DEBUG -- : SDAM | Topology type &#39;ReplicaSetWithPrimary&#39; closed.
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">:sdam_proc</span></code> client option applies only to the client during whose
construction it is given. When certain client options are changed via the
<code class="docutils literal notranslate"><span class="pre">Client#with</span></code> call, a new cluster may be created by the driver with
a default set of event subscribers. If this happens, the provided
<code class="docutils literal notranslate"><span class="pre">:sdam_proc</span></code> is not called and the application may miss events.</p>
</div>
</div>
<div class="section" id="server-heartbeats">
<span id="id2"></span><h2>Server Heartbeats<a class="headerlink" href="#server-heartbeats" title="Permalink to this headline">¶</a></h2>
<p>The application can be notified of each server heartbeat by subscribing
to SERVER_HEARTBEAT topic. A server heartbeat listener must implement
three methods: <cite>started</cite>, <cite>succeeded</cite> and <cite>failed</cite>. Each heartbeat invokes
the <cite>started</cite> method on the listener, and then either <cite>succeeded</cite> or <cite>failed</cite>
method depending on the outcome of the heartbeat.</p>
<p>All heartbeat events contain the address of the server that the heartbeat
was sent to. Succeeded and failed events contain the round trip time for
the ismaster command. Failed event also contains the exception instance that
was raised during ismaster command execution. Please review the API
documentation for ServerHeartbeatStarted, ServerHeartbeatSucceeded and
ServerHeartbeatFailed for event attribute details.</p>
<p>The following is an example logging heartbeat event subscriber:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HeartbeatLogSubscriber</span>
  <span class="kp">include</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Loggable</span>

  <span class="k">def</span> <span class="nf">started</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s2"> | STARTED&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">succeeded</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s2"> | SUCCEEDED | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">duration</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">failed</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">address</span><span class="si">}</span><span class="s2"> | FAILED | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">duration</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">logger</span>
    <span class="no">Mongo</span><span class="o">::</span><span class="no">Logger</span><span class="o">.</span><span class="n">logger</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">format_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">format</span><span class="p">(</span><span class="s2">&quot;HEARTBEAT | %s&quot;</span><span class="o">.</span><span class="n">freeze</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>Similarly to command events, the application can subscribe to heartbeat
events globally or for a specific client:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">subscriber</span> <span class="o">=</span> <span class="no">HeartbeatLogSubscriber</span><span class="o">.</span><span class="n">new</span>

<span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">Global</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">SERVER_HEARTBEAT</span><span class="p">,</span> <span class="n">subscriber</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span> <span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">SERVER_HEARTBEAT</span><span class="p">,</span> <span class="n">subscriber</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<p>Sample output:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-none notranslate"><div class="highlight"><pre><span></span>D, [2018-09-23T13:44:10.707018 #1739] DEBUG -- : HEARTBEAT | 127.0.0.1:27027 | STARTED
D, [2018-09-23T13:44:10.707778 #1739] DEBUG -- : HEARTBEAT | 127.0.0.1:27027 | SUCCEEDED | 0.000772381s
</pre></div>
</div>
</div>
<div class="section" id="heartbeat-event-intervals">
<h3>Heartbeat Event Intervals<a class="headerlink" href="#heartbeat-event-intervals" title="Permalink to this headline">¶</a></h3>
<p>When connected to MongoDB 4.2 and earlier servers, Ruby driver by default
issues heartbeats every <code class="docutils literal notranslate"><span class="pre">:heartbeat_frequency</span></code> (Ruby client option) seconds,
and heartbeats are non-overlapping (the succeeded event for a heartbeat is
guaranteed to be published before the started event for the next heartbeat is
published). When connected to MongoDB 4.4 and later servers, the driver uses
multiple monitoring threads and a more complex heartbeat protocol designed
to detect changes in server state quicker; as a result, heartbeat event
intervals can be more irregular and heartbeat events can overlap. Specifically,
an <em>awaited heartbeat</em> can start or finish while a <em>non-awaited heartbeat</em>
is in progress, and vice versa. Use the <code class="docutils literal notranslate"><span class="pre">ServerHeartbeatStarted#awaited?</span></code>,
<code class="docutils literal notranslate"><span class="pre">ServerHeartbeatSucceeded#awaited?</span></code> and <code class="docutils literal notranslate"><span class="pre">ServerHeartbeatFailed#awaited?</span></code>
methods to distinguish between non-awaited and awaited heartbeats.</p>
<p>When a client is attempting to perform an operation and it does not have a
suitable server, the deployment is scanned more frequently - each server can
be polled up to every 500 milliseconds. It is also possible for the application
to request a manual scan of a particular server; the driver enforces the
500 millisecond minimum interval between scans.</p>
</div>
</div>
<div class="section" id="connection-pool-and-connection-monitoring">
<h2>Connection Pool And Connection Monitoring<a class="headerlink" href="#connection-pool-and-connection-monitoring" title="Permalink to this headline">¶</a></h2>
<p>Each client maintains a connection pool for each server in the deployment that
it is aware of, and publishes events for both connection pools and individual
connections. To subscribe to these events, define a subscriber class implementing
the method <code class="docutils literal notranslate"><span class="pre">pubished</span></code> which takes a single parameter for the event that
is being published. Note that future versions of the driver may introduce
additional events published through this mechanism.</p>
<p>The following events are currently implemented by the driver, following
the <a class="reference external" href="https://github.com/mongodb/specifications/blob/master/source/connection-monitoring-and-pooling/connection-monitoring-and-pooling.rst">CMAP specification</a>:</p>
<ul class="simple">
<li>PoolCreated</li>
<li>PoolCleared</li>
<li>PoolClosed</li>
<li>ConnectionCreated</li>
<li>ConnectionReady</li>
<li>ConnectionClosed</li>
<li>ConnectionCheckOutStarted</li>
<li>ConnectionCheckOutFailed</li>
<li>ConnectionCheckOutSucceeded</li>
<li>ConnectionCheckedIn</li>
</ul>
<p>The driver provides a logging subscriber which may be used to log all
connection pool and connection-related events. This subscriber is not enabled
by default because it will create log entries for each operation performed
by the application. To enable this subscriber globally or per client:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">Global</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
  <span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">CONNECTION_POOL</span><span class="p">,</span>
  <span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">CmapLogSubscriber</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span> <span class="p">)</span>
<span class="n">subscriber</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">CmapLogSubscriber</span><span class="o">.</span><span class="n">new</span>
<span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Monitoring</span><span class="o">::</span><span class="no">CONNECTION_POOL</span><span class="p">,</span> <span class="n">subscriber</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<p>Sample output:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-none notranslate"><div class="highlight"><pre><span></span>D, [2019-05-06T17:23:21.595412 #8576] DEBUG -- : MONGODB | EVENT: #&lt;PoolCreated address=127.0.0.1:27741 options={...}&gt;
D, [2019-05-06T17:23:21.595584 #8576] DEBUG -- : MONGODB | EVENT: #&lt;PoolCleared address=127.0.0.1:27741&gt;
D, [2019-05-06T17:23:21.603549 #8576] DEBUG -- : MONGODB | EVENT: #&lt;PoolCreated address=localhost:27741 options={...}&gt;
D, [2019-05-06T17:23:21.603616 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionCheckOutStarted address=localhost:27741&gt;
D, [2019-05-06T17:23:21.603684 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionCreated address=localhost:27741 connection_id=1&gt;
D, [2019-05-06T17:23:21.604079 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionCheckedOut address=localhost:27741 connection_id=1&gt;
D, [2019-05-06T17:23:21.605759 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionReady address=localhost:27741 connection_id=1&gt;
D, [2019-05-06T17:23:21.605784 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionCheckedIn address=localhost:27741 connection_id=1&gt;
D, [2019-05-06T17:23:21.605817 #8576] DEBUG -- : MONGODB | EVENT: #&lt;PoolCleared address=localhost:27741&gt;
D, [2019-05-06T17:23:21.605852 #8576] DEBUG -- : MONGODB | EVENT: #&lt;ConnectionClosed address=localhost:27741 connection_id=1 reason=stale&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="disabling-monitoring">
<h2>Disabling Monitoring<a class="headerlink" href="#disabling-monitoring" title="Permalink to this headline">¶</a></h2>
<p>To turn off monitoring, set the client monitoring option to <code class="docutils literal notranslate"><span class="pre">false</span></code>:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="ss">:monitoring</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>

                
    <div id="btnv">
      <span class="btn-arrow-left">&larr; &nbsp;</span>
      <a class="btn-prev-text" href="authentication.html" title="Previous Section: Authentication"><span>Authentication</span></a>
      <a class="btn-next-text" href="user-management.html" title="Next Section: User Management"><span>User Management</span></a>
      <span class="btn-arrow-right">&nbsp;&rarr;</span>
    </div>
                  <div class="footer">
                    <div class="copyright">
                      <p>&copy; MongoDB, Inc 2008-present. MongoDB, Mongo, and the leaf logo are registered trademarks of MongoDB, Inc.</p>
                    </div>
                  </div>
              </div></div>
            </div>
        </div>
    </div>
    <div class="right-column">
      <div class="wrapper"> 
            <div class="social">
               <a class="slack-icon" href="https://slackpass.io/mongo-db?jmp=docs" title="https://slackpass.io/mongo-db?jmp=docs"><i class="fab fa-slack" aria-hidden="true"></i></a>
               <a class="twitter-icon" href="https://twitter.com/MongoDB" title="https://twitter.com/MongoDB"><i class="fab fa-twitter-square"></i></a>
               <a class="youtube-icon" href="https://www.youtube.com/user/MongoDB" title="https://www.youtube.com/user/MongoDB"><i class="fab fa-youtube-square"></i></a>
               <a class="facebook-icon" href="https://www.facebook.com/mongodb" title="https://www.facebook.com/mongodb"><i class="fab fa-facebook-square"></i></a>
               <a class="stack-overflow-icon" href="https://stackoverflow.com/tags/mongodb/info" title="https://stackoverflow.com/tags/mongodb/info"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a>
            </div>
        

      </div>
    </div>
    
    <div class="clearfix"></div>
  </div>
<div id="navbar" data-navprops='{"links": [{"url": "https://docs.mongodb.com/manual/","text": "Server"},{"url": "https://docs.mongodb.com/ecosystem/drivers/","text": "Drivers","active": true},{"url": "https://docs.mongodb.com/cloud/","text": "Cloud"},{"url": "https://docs.mongodb.com/tools/","text": "Tools"},{"url": "https://docs.mongodb.com/guides/","text": "Guides"}]}'></div>

  <script src="../_static/navbar.min.js"></script>

  

  <script type="text/javascript">
  // Bootstrap array of links that should trigger a full page reload
  window.docsExcludedNav = ['/bson-tutorials', '/mongoid-tutorials'];
  </script></body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
  <link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css' /><title>Query Cache &mdash; Ruby Driver Manual upcoming</title><link rel="shortcut icon" href="https://media.mongodb.org/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index" />

  <meta name="release" content="upcoming"/>
  <meta name="version" content="master"/>
  <meta name="DC.Source" content="https://github.com/mongodb/docs-ruby/blob/master/source/reference/query-cache.txt"/>
  <meta property="og:image" content="http://s3.amazonaws.com/info-mongodb-com/_com_assets/cms/mongodb-for-giant-ideas-bbab5c3cf8.png">
  <meta property="og:image:secure_url" content="https://webassets.mongodb.com/_com_assets/cms/mongodb-for-giant-ideas-bbab5c3cf8.png">
    <link rel="canonical" href="https://docs.mongodb.com/docs-ruby/current/reference/query-cache/" />
  
   <link rel="stylesheet" href="../_static/mongodb-docs.css" type="text/css" />
   <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
   <link rel="stylesheet" href="../_static/css/navbar.min.css?t=nocache" type="text/css" />
    
    <script type="text/javascript" src="../_static/lib/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/lib/bootstrap.js"></script>
    <script type="text/javascript" src="../_static/lib/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/controller.js"></script>
      <link rel="search" type="application/opensearchdescription+xml" href="https://docs.mongodb.com/osd.xml" title="MongoDB Help"/>
<!-- <link rel="index" title="Index" href="../genindex.html" /> -->
<link rel="search" title="Search" href="../search.html" />
<link rel="top" title="Ruby Driver Manual" href="../index.html" /></head>
<body data-project="docs-ruby" data-project-title="Ruby Driver Manual" data-branch="master" data-enable-marian=1 data-eol="">
  <!-- Google Tag Manager -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-GDFN"
                    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
  {'gtm.start':new Date().getTime(),event:'gtm.js'}
  );var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-GDFN');
  </script>
  <!-- End Google Tag Manager -->
   <script>
     window.googleSearchCx = "014132741538533607290:xl0kbqanc9y"
     window.googleSearchPlaceholder = "Search Ruby Driver"
     window.googleSearchResultsUrl = "http://docs.mongodb.com/ruby-driver/master/search/"
   </script><div class="content" >

   <div id="left-column">
         <aside id="sidebar" class="sidebar">
             
  <div class="sphinxsidebar" id="sphinxsidebar">
    <div id="sphinxsidebarwrapper" class="sphinxsidebarwrapper"><a href="javascript:void(0)" class="closeNav" id="closeNav">Close &times;</a>


<h3>
  <a href="../index.html">Ruby Driver Manual</a>
</h3>


    <div class="btn-group version-sidebar">
      
        <button type="button" class="version-button dropdown-toggle" data-toggle="dropdown">
          
          
          master (upcoming)<span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
          
            
            <li class="active">
            
              <a href="#" data-path="ruby-driver/current">
                
                master (upcoming)
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.14">
                
                Version 2.14 (current)
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.13">
                
                Version 2.13
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.12">
                
                Version 2.12
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.11">
                
                Version 2.11
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.10">
                
                Version 2.10
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.9">
                
                Version 2.9
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.8">
                
                Version 2.8
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.7">
                
                Version 2.7
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.6">
                
                Version 2.6
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.5">
                
                Version 2.5
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.4">
                
                Version 2.4
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.3">
                
                Version 2.3
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.2">
                
                Version 2.2
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.0">
                
                Version 2.0
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v1.x">
                
                1.x
              </a>
            </li>
          
        </ul>
      
    </div>


<ul><li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a><ul><li class="toctree-l2"><a class="reference internal" href="../installation.html">Installation</a></li><li class="toctree-l2"><a class="reference internal" href="driver-compatibility.html">Driver Compatibility</a></li><li class="toctree-l2"><a class="reference internal" href="../support.html">Support</a></li></ul></li><li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul><li class="toctree-l2"><a class="reference internal" href="../tutorials/quick-start.html">Quick Start</a></li></ul></li><li class="toctree-l1"><a class="reference internal" href="create-client.html">Creating a Client</a></li><li class="toctree-l1"><a class="reference internal" href="authentication.html">Authentication</a></li><li class="toctree-l1"><a class="reference internal" href="working-with-data.html">Working With Data</a></li><li class="toctree-l1"><a class="reference internal" href="user-management.html">User Management</a></li><li class="toctree-l1"><a class="reference internal" href="collection-tasks.html">Collections</a></li><li class="toctree-l1"><a class="reference internal" href="sessions.html">Sessions</a></li><li class="toctree-l1"><a class="reference internal" href="transactions.html">Transactions</a></li><li class="toctree-l1"><a class="reference internal" href="change-streams.html">Change Streams</a></li><li class="toctree-l1"><a class="reference internal" href="database-tasks.html">Databases</a></li><li class="toctree-l1"><a class="reference internal" href="monitoring.html">Monitoring</a></li><li class="toctree-l1"><a class="reference internal" href="indexing.html">Indexing</a></li><li class="toctree-l1"><a class="reference internal" href="collations.html">Collations</a></li><li class="toctree-l1"><a class="reference internal" href="client-side-encryption.html">Client-Side Encryption</a></li><li class="toctree-l1"><a class="reference internal" href="../bson-tutorials.html">BSON</a><ul><li class="toctree-l2"><a class="reference internal" href="../tutorials/bson-v4.html">BSON 4.x Tutorial</a></li><li class="toctree-l2"><a class="reference internal" href="../tutorials/bson-v3.html">BSON 3.x Tutorial</a></li></ul></li><li class="toctree-l1"><a class="reference external" href="https://docs.mongodb.com/ruby-driver/master/api/">API</a></li><li class="toctree-l1"><a class="reference internal" href="additional-resources.html">Additional Resources</a></li><li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contribute to the Driver</a></li></ul>
    </div>
  </div>
           
         </aside>

   </div>

    <div id="main-column" class="main-column">

    <span id="showNav" class="showNav">Navigation</span>

      
      
        <div class="document">
            <div class="documentwrapper"><div class="bodywrapper">
              <div class="body" data-pagename="reference/query-cache">

                
  <div class="bc">
    
      
    
    
  </div>
                
                  <div class="section" id="query-cache">
<h1>Query Cache<a class="headerlink" href="#query-cache" title="Permalink to this headline">¶</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><a class="reference internal" href="#usage" id="id3">Usage</a></li>
<li><a class="reference internal" href="#query-matching" id="id4">Query Matching</a></li>
<li><a class="reference internal" href="#limits" id="id5">Limits</a></li>
<li><a class="reference internal" href="#cache-invalidation" id="id6">Cache Invalidation</a></li>
<li><a class="reference internal" href="#manual-cache-invalidation" id="id7">Manual Cache Invalidation</a></li>
<li><a class="reference internal" href="#transactions" id="id8">Transactions</a></li>
<li><a class="reference internal" href="#aggregations" id="id9">Aggregations</a></li>
<li><a class="reference internal" href="#system-collections" id="id10">System Collections</a></li>
<li><a class="reference internal" href="#query-cache-middleware" id="id11">Query Cache Middleware</a></li>
</ul>
</div>
<p id="id1">The MongoDB Ruby driver provides a built-in query cache. When enabled, the
query cache saves the results of previously-executed find and aggregation
queries. When those same queries are performed again, the driver returns
the cached reuslts to prevent unnecessary roundtrips to the database.</p>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>The query cache is disabled by default. It can be enabled on the global
scope as well as within the context of a specific block. The driver also
provides a <a class="reference internal" href="#query-cache-middleware"><span class="std std-ref">Rack middleware</span></a> to enable the
query cache automatically for each web request.</p>
<p>To enable the query cache globally:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div>
</div>
</div>
<p>Similarly, to disable it globally:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span>
</pre></div>
</div>
</div>
<p>To enable the query cache within the context of a block:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">cache</span> <span class="k">do</span>
  <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
    <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Flying Lotus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="c1">#=&gt; Queries the database and caches the result</span>

    <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Flying Lotus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="c1">#=&gt; Returns the previously cached result</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>And to disable the query cache in the context of a block:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">uncached</span> <span class="k">do</span>
  <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
    <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Flying Lotus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="c1">#=&gt; Sends the query to the database; does NOT cache the result</span>

    <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Flying Lotus&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="c1">#=&gt; Queries the database again</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>You may check whether the query cache is enabled at any time by calling
<code class="docutils literal notranslate"><span class="pre">Mongo::QueryCache.enabled?</span></code>, which will return <code class="docutils literal notranslate"><span class="pre">true</span></code> or <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
</div>
<div class="section" id="query-matching">
<span id="query-cache-matching"></span><h2>Query Matching<a class="headerlink" href="#query-matching" title="Permalink to this headline">¶</a></h2>
<p>A query is eligible to use cached results if it matches the original query
that produced the cached results. Two queries are considered matching if they
are identical in the following values:</p>
<ul class="simple">
<li>Namespace (the database and collection on which the query was performed)</li>
<li>Selector (for aggregations, the aggregation pipeline stages)</li>
<li>Skip</li>
<li>Sort</li>
<li>Projection</li>
<li>Collation</li>
<li>Read Concern</li>
<li>Read Preference</li>
</ul>
<p>For example, if you perform one query, and then perform a mostly identical query
with a different sort order, those queries will not be considered matching,
and the second query will not use the cached results of the first.</p>
</div>
<div class="section" id="limits">
<h2>Limits<a class="headerlink" href="#limits" title="Permalink to this headline">¶</a></h2>
<p>When performing a query with a limit, the query cache will reuse an existing
cached query with a larger limit if one exists. For example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">cache</span> <span class="k">do</span>
  <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
    <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="ss">genre</span><span class="p">:</span> <span class="s1">&#39;Rock&#39;</span><span class="p">,</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span>
    <span class="c1">#=&gt; Queries the database and caches the result</span>

    <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="ss">genre</span><span class="p">:</span> <span class="s1">&#39;Rock&#39;</span><span class="p">,</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">5</span><span class="p">)</span>
    <span class="c1">#=&gt; Returns the first 5 results from the cached query</span>

    <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="ss">genre</span><span class="p">:</span> <span class="s1">&#39;Rock&#39;</span><span class="p">,</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
    <span class="c1">#=&gt; Queries the database again and replaces the previously cached query results</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="cache-invalidation">
<h2>Cache Invalidation<a class="headerlink" href="#cache-invalidation" title="Permalink to this headline">¶</a></h2>
<p>The query cache is cleared in part or in full on every write operation. Most
write operations will clear the results of any queries were performed on the same
collection that is being written to. Some operations will clear the entire
query cache.</p>
<p>The following operations will clear cached query results on the same database and
collection (including during bulk writes):</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">insert_one</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">update_one</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">replace_one</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">update_many</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">delete_one</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">delete_many</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">find_one_and_delete</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">find_one_and_update</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">find_one_and_replace</span></code></li>
</ul>
<p>The following operations will clear the entire query cache:</p>
<ul class="simple">
<li>aggregation with <code class="docutils literal notranslate"><span class="pre">$merge</span></code> or <code class="docutils literal notranslate"><span class="pre">$out</span></code> pipeline stages</li>
<li><code class="docutils literal notranslate"><span class="pre">commit_transaction</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">abort_transaction</span></code></li>
</ul>
</div>
<div class="section" id="manual-cache-invalidation">
<h2>Manual Cache Invalidation<a class="headerlink" href="#manual-cache-invalidation" title="Permalink to this headline">¶</a></h2>
<p>You may clear the query cache at any time with the following method:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">clear</span>
</pre></div>
</div>
</div>
<p>This will remove all cached query results.</p>
</div>
<div class="section" id="transactions">
<h2>Transactions<a class="headerlink" href="#transactions" title="Permalink to this headline">¶</a></h2>
<p>Queries are cached within the context of a transaction, but the entire
cache will be cleared when the transaction is committed or aborted.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">cache</span> <span class="k">do</span>
  <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span>

    <span class="n">session</span><span class="o">.</span><span class="n">with_transaction</span> <span class="k">do</span>
      <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">insert_one</span><span class="p">({</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Fleet Foxes&#39;</span> <span class="p">},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>

      <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">find</span><span class="p">({},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
      <span class="c1">#=&gt; { name: &#39;Fleet Foxes&#39; }</span>
      <span class="c1">#=&gt; Queries the database and caches the result</span>

      <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">find</span><span class="p">({},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
      <span class="c1">#=&gt; { name: &#39;Fleet Foxes&#39; }</span>
      <span class="c1">#=&gt; Returns the previously cached result</span>

      <span class="n">session</span><span class="o">.</span><span class="n">abort_transaction</span>
    <span class="k">end</span>

    <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">find</span><span class="o">.</span><span class="n">first</span>
    <span class="c1">#=&gt; nil</span>
    <span class="c1"># The query cache was cleared on abort_transaction</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Transactions are often performed with a “snapshot” read concern level. Keep
in mind that a query with a “snapshot” read concern cannot return cached
results from a query without the “snapshot” read concern, so it is possible
that a transaction may not use previously cached queries.</p>
<p class="last">To understand when a query will use a cached result, see the
<a class="reference internal" href="#query-cache-matching"><span class="std std-ref">Query Matching</span></a> section.</p>
</div>
</div>
<div class="section" id="aggregations">
<h2>Aggregations<a class="headerlink" href="#aggregations" title="Permalink to this headline">¶</a></h2>
<p>The query cache also caches the results of aggregation pipelines. For example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">cache</span> <span class="k">do</span>
  <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;music&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
    <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">aggregate</span><span class="p">(</span><span class="o">[</span> <span class="p">{</span> <span class="s1">&#39;$match&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Fleet Foxes&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="c1">#=&gt; Queries the database and caches the result</span>

    <span class="n">client</span><span class="o">[</span><span class="s1">&#39;artists&#39;</span><span class="o">].</span><span class="n">aggregate</span><span class="p">(</span><span class="o">[</span> <span class="p">{</span> <span class="s1">&#39;$match&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Fleet Foxes&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="c1">#=&gt; Returns the previously cached result</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Aggregation results are cleared from the cache during every write operation,
with no exceptions.</p>
</div>
</div>
<div class="section" id="system-collections">
<h2>System Collections<a class="headerlink" href="#system-collections" title="Permalink to this headline">¶</a></h2>
<p>MongoDB stores system information in collections that use the <code class="docutils literal notranslate"><span class="pre">database.system.*</span></code>
namespace pattern. These are called system collections.</p>
<p>Data in system collections can change due to activity not triggered by the
application (such as internal server processes) and as a result of a variety of
database commands issued by the application. Because of the difficulty of
determining when the cached results for system collections should be expired,
queries on system collections bypass the query cache.</p>
<p>You may read more about system collections in the
<a class="reference external" href="https://docs.mongodb.com/manual/reference/system-collections/">MongoDB documentation</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Even when the query cache is enabled, query results from system collections
will not be cached.</p>
</div>
</div>
<div class="section" id="query-cache-middleware">
<span id="id2"></span><h2>Query Cache Middleware<a class="headerlink" href="#query-cache-middleware" title="Permalink to this headline">¶</a></h2>
<p>The driver provides a Rack middleware which enables the query cache for the
duration of each web request. Below is an example of how to enable the
query cache middleware in a Ruby on Rails application:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># config/application.rb</span>

<span class="c1"># Add Mongo::QueryCache::Middleware at the bottom of the middleware stack</span>
<span class="c1"># or before other middleware that queries MongoDB.</span>
<span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">::</span><span class="no">Middleware</span>
</pre></div>
</div>
</div>
<p>Please refer to the <a class="reference external" href="https://guides.rubyonrails.org/rails_on_rack.html#configuring-middleware-stack">Rails on Rack guide</a>
for more information about using Rack middleware in Rails applications.</p>
</div>
</div>

                
    <div id="btnv">
    </div>
                  <div class="footer">
                    <div class="copyright">
                      <p>&copy; MongoDB, Inc 2008-present. MongoDB, Mongo, and the leaf logo are registered trademarks of MongoDB, Inc.</p>
                    </div>
                  </div>
              </div></div>
            </div>
        </div>
    </div>
    <div class="right-column">
      <div class="wrapper"> 
            <div class="social">
               <a class="slack-icon" href="https://slackpass.io/mongo-db?jmp=docs" title="https://slackpass.io/mongo-db?jmp=docs"><i class="fab fa-slack" aria-hidden="true"></i></a>
               <a class="twitter-icon" href="https://twitter.com/MongoDB" title="https://twitter.com/MongoDB"><i class="fab fa-twitter-square"></i></a>
               <a class="youtube-icon" href="https://www.youtube.com/user/MongoDB" title="https://www.youtube.com/user/MongoDB"><i class="fab fa-youtube-square"></i></a>
               <a class="facebook-icon" href="https://www.facebook.com/mongodb" title="https://www.facebook.com/mongodb"><i class="fab fa-facebook-square"></i></a>
               <a class="stack-overflow-icon" href="https://stackoverflow.com/tags/mongodb/info" title="https://stackoverflow.com/tags/mongodb/info"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a>
            </div>
        

      </div>
    </div>
    
    <div class="clearfix"></div>
  </div>
<div id="navbar" data-navprops='{"links": [{"url": "https://docs.mongodb.com/manual/","text": "Server"},{"url": "https://docs.mongodb.com/ecosystem/drivers/","text": "Drivers","active": true},{"url": "https://docs.mongodb.com/cloud/","text": "Cloud"},{"url": "https://docs.mongodb.com/tools/","text": "Tools"},{"url": "https://docs.mongodb.com/guides/","text": "Guides"}]}'></div>

  <script src="../_static/navbar.min.js"></script>

  

  <script type="text/javascript">
  // Bootstrap array of links that should trigger a full page reload
  window.docsExcludedNav = ['/bson-tutorials', '/mongoid-tutorials'];
  </script></body>
</html>
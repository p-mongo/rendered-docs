<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
  <link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css' /><title>Change Streams &mdash; Ruby Driver Manual upcoming</title><link rel="shortcut icon" href="https://media.mongodb.org/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index" />

  <meta name="release" content="upcoming"/>
  <meta name="version" content="master"/>
  <meta name="DC.Source" content="https://github.com/mongodb/docs-ruby/blob/master/source/reference/change-streams.txt"/>
  <meta property="og:image" content="http://s3.amazonaws.com/info-mongodb-com/_com_assets/cms/mongodb-for-giant-ideas-bbab5c3cf8.png">
  <meta property="og:image:secure_url" content="https://webassets.mongodb.com/_com_assets/cms/mongodb-for-giant-ideas-bbab5c3cf8.png">
    <link rel="canonical" href="https://docs.mongodb.com/docs-ruby/current/reference/change-streams/" />
  
   <link rel="stylesheet" href="../_static/mongodb-docs.css" type="text/css" />
   <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
   <link rel="stylesheet" href="../_static/css/navbar.min.css?t=nocache" type="text/css" />
    
    <script type="text/javascript" src="../_static/lib/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/lib/bootstrap.js"></script>
    <script type="text/javascript" src="../_static/lib/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/controller.js"></script>
      <link rel="search" type="application/opensearchdescription+xml" href="https://docs.mongodb.com/osd.xml" title="MongoDB Help"/>
<!-- <link rel="index" title="Index" href="../genindex.html" /> -->
<link rel="search" title="Search" href="../search.html" />
<link rel="top" title="Ruby Driver Manual" href="../index.html" />
<link rel="next" title="Databases" href="database-tasks.html" />
<link rel="prev" title="Transactions" href="transactions.html" /></head>
<body data-project="docs-ruby" data-project-title="Ruby Driver Manual" data-branch="master" data-enable-marian=1 data-eol="">
  <!-- Google Tag Manager -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-GDFN"
                    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
  {'gtm.start':new Date().getTime(),event:'gtm.js'}
  );var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-GDFN');
  </script>
  <!-- End Google Tag Manager -->
   <script>
     window.googleSearchCx = "014132741538533607290:xl0kbqanc9y"
     window.googleSearchPlaceholder = "Search Ruby Driver"
     window.googleSearchResultsUrl = "http://docs.mongodb.com/ruby-driver/master/search/"
   </script><div class="content" >

   <div id="left-column">
         <aside id="sidebar" class="sidebar">
             
  <div class="sphinxsidebar" id="sphinxsidebar">
    <div id="sphinxsidebarwrapper" class="sphinxsidebarwrapper"><a href="javascript:void(0)" class="closeNav" id="closeNav">Close &times;</a>


<h3>
  <a href="../index.html">Ruby Driver Manual</a>
</h3>


    <div class="btn-group version-sidebar">
      
        <button type="button" class="version-button dropdown-toggle" data-toggle="dropdown">
          
          
          master (upcoming)<span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
          
            
            <li class="active">
            
              <a href="#" data-path="ruby-driver/current">
                
                master (upcoming)
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.14">
                
                Version 2.14 (current)
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.13">
                
                Version 2.13
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.12">
                
                Version 2.12
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.11">
                
                Version 2.11
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.10">
                
                Version 2.10
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.9">
                
                Version 2.9
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.8">
                
                Version 2.8
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.7">
                
                Version 2.7
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.6">
                
                Version 2.6
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.5">
                
                Version 2.5
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.4">
                
                Version 2.4
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.3">
                
                Version 2.3
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.2">
                
                Version 2.2
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v2.0">
                
                Version 2.0
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="ruby-driver/v1.x">
                
                1.x
              </a>
            </li>
          
        </ul>
      
    </div>


<ul class="current"><li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a><ul><li class="toctree-l2"><a class="reference internal" href="../installation.html">Installation</a></li><li class="toctree-l2"><a class="reference internal" href="driver-compatibility.html">Driver Compatibility</a></li><li class="toctree-l2"><a class="reference internal" href="../support.html">Support</a></li></ul></li><li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul><li class="toctree-l2"><a class="reference internal" href="../tutorials/quick-start.html">Quick Start</a></li></ul></li><li class="toctree-l1"><a class="reference internal" href="connection-and-configuration.html">Connection &amp; Configuration</a><ul><li class="toctree-l2"><a class="reference internal" href="create-client.html">Creating a Client</a></li><li class="toctree-l2"><a class="reference internal" href="authentication.html">Authentication</a></li></ul></li><li class="toctree-l1"><a class="reference internal" href="working-with-data.html">Working With Data</a><ul><li class="toctree-l2"><a class="reference internal" href="crud-operations.html">CRUD Operations</a></li><li class="toctree-l2"><a class="reference internal" href="bulk-operations.html">Bulk Writes</a></li><li class="toctree-l2"><a class="reference internal" href="projections.html">Projections</a></li><li class="toctree-l2"><a class="reference internal" href="aggregation.html">Aggregation</a></li><li class="toctree-l2"><a class="reference internal" href="text-search.html">Text Search</a></li><li class="toctree-l2"><a class="reference internal" href="geospatial-search.html">Geospatial Search</a></li><li class="toctree-l2"><a class="reference internal" href="gridfs.html">GridFS</a></li><li class="toctree-l2"><a class="reference internal" href="query-cache.html">Query Cache</a></li></ul></li><li class="toctree-l1"><a class="reference internal" href="user-management.html">User Management</a></li><li class="toctree-l1"><a class="reference internal" href="collection-tasks.html">Collections</a></li><li class="toctree-l1"><a class="reference internal" href="sessions.html">Sessions</a></li><li class="toctree-l1"><a class="reference internal" href="transactions.html">Transactions</a></li><li class="toctree-l1 current"><a class="reference internal current" href="">Change Streams</a></li><li class="toctree-l1"><a class="reference internal" href="database-tasks.html">Databases</a></li><li class="toctree-l1"><a class="reference internal" href="monitoring.html">Monitoring</a></li><li class="toctree-l1"><a class="reference internal" href="indexing.html">Indexing</a></li><li class="toctree-l1"><a class="reference internal" href="collations.html">Collations</a></li><li class="toctree-l1"><a class="reference internal" href="client-side-encryption.html">Client-Side Encryption</a></li><li class="toctree-l1"><a class="reference internal" href="../bson-tutorials.html">BSON</a><ul><li class="toctree-l2"><a class="reference internal" href="../tutorials/bson-v4.html">BSON 4.x Tutorial</a></li><li class="toctree-l2"><a class="reference internal" href="../tutorials/bson-v3.html">BSON 3.x Tutorial</a></li></ul></li><li class="toctree-l1"><a class="reference external" href="https://docs.mongodb.com/ruby-driver/master/api/">API</a></li><li class="toctree-l1"><a class="reference internal" href="additional-resources.html">Additional Resources</a></li><li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contribute to the Driver</a></li></ul>
    </div>
  </div>
           
         </aside>

   </div>

    <div id="main-column" class="main-column">

    <span id="showNav" class="showNav">Navigation</span>

      
      
        <div class="document">
            <div class="documentwrapper"><div class="bodywrapper">
              <div class="body" data-pagename="reference/change-streams">

                
  <div class="bc">
    
      
    
    
  </div>
                
                  <div class="section" id="change-streams">
<span id="id1"></span><h1>Change Streams<a class="headerlink" href="#change-streams" title="Permalink to this headline">¶</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><a class="reference internal" href="#watching-for-changes-on-a-collection" id="id2">Watching for Changes on a Collection</a></li>
<li><a class="reference internal" href="#watching-for-changes-on-a-database" id="id3">Watching for Changes on a Database</a></li>
<li><a class="reference internal" href="#watching-for-changes-on-a-cluster" id="id4">Watching for Changes on a Cluster</a></li>
<li><a class="reference internal" href="#closing-a-change-stream" id="id5">Closing a Change Stream</a></li>
<li><a class="reference internal" href="#resuming-a-change-stream" id="id6">Resuming a Change Stream</a></li>
</ul>
</div>
<p>As of version 3.6 of the MongoDB server, a new <code class="docutils literal notranslate"><span class="pre">$changeStream</span></code> pipeline stage
is supported in the aggregation framework. Specifying this stage first in an
aggregation pipeline allows users to request that notifications are sent for all
changes to a particular collection. As of MongoDB 4.0, change streams are
supported on databases and clusters in addition to collections.</p>
<p>The Ruby driver provides an API for
receiving notifications for changes to a particular collection, database
or cluster using this
new pipeline stage. Although you can create a change stream using the pipeline
operator and aggregation framework directly, it is recommended to use the
driver API described below as the driver resumes the change stream one time
if there is a timeout, a network error, a server error indicating that a
failover is taking place or another type of a resumable error.</p>
<p>Change streams on the server require a <code class="docutils literal notranslate"><span class="pre">&quot;majority&quot;</span></code> read concern or no
read concern.</p>
<p>Change streams do not work properly with JRuby because of the issue documented <a class="reference external" href="https://github.com/jruby/jruby/issues/4212">here</a>.
Namely, JRuby eagerly evaluates <code class="docutils literal notranslate"><span class="pre">#next</span></code> on an Enumerator in a background
green thread, therefore calling <code class="docutils literal notranslate"><span class="pre">#next</span></code> on the change stream will cause
getMores to be called in a loop in the background.</p>
<div class="section" id="watching-for-changes-on-a-collection">
<h2>Watching for Changes on a Collection<a class="headerlink" href="#watching-for-changes-on-a-collection" title="Permalink to this headline">¶</a></h2>
<p>A collection change stream is created by calling the <code class="docutils literal notranslate"><span class="pre">#watch</span></code> method on a
collection:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:test</span><span class="o">]</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">watch</span>
<span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">to_enum</span><span class="o">.</span><span class="n">next</span>
<span class="n">process</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>You can also receive the notifications as they become available:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">watch</span>
<span class="n">enum</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">to_enum</span>
<span class="k">while</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">next</span>
  <span class="n">process</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">next</span></code> method blocks and polls the cluster until a change is available.
Use the <code class="docutils literal notranslate"><span class="pre">try_next</span></code> method to iterate a change stream without blocking; this
method will wait up to max_await_time_ms milliseconds for changes from the server,
and if no changes are received it will return nil. If there is a non-resumable
error, both <code class="docutils literal notranslate"><span class="pre">next</span></code> and <code class="docutils literal notranslate"><span class="pre">try_next</span></code> will raise an exception.
See Resuming a Change Stream section below for an example that reads
changes from a collection indefinitely.</p>
<p>The change stream can take filters in the aggregation framework pipeline
operator format:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="o">[</span><span class="p">{</span><span class="s1">&#39;$match&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;operationType&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;$in&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="o">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
                           <span class="p">{</span><span class="s1">&#39;$match&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;fullDocument.n&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;$gte&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
                          <span class="o">]</span><span class="p">)</span>
<span class="n">enum</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">to_enum</span>
<span class="k">while</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">next</span>
  <span class="n">process</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="watching-for-changes-on-a-database">
<h2>Watching for Changes on a Database<a class="headerlink" href="#watching-for-changes-on-a-database" title="Permalink to this headline">¶</a></h2>
<p>A database change stream notifies on changes on any collection within the
database as well as database-wide events, such as the database being dropped.</p>
<p>A database change stream is created by calling the <code class="docutils literal notranslate"><span class="pre">#watch</span></code> method on a
database object:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">database</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">database</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">watch</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:test</span><span class="o">].</span><span class="n">insert_one</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">to_enum</span><span class="o">.</span><span class="n">next</span>
<span class="n">process</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="watching-for-changes-on-a-cluster">
<h2>Watching for Changes on a Cluster<a class="headerlink" href="#watching-for-changes-on-a-cluster" title="Permalink to this headline">¶</a></h2>
<p>A cluster change stream notifies on changes on any collection, any database
within the cluster as well as cluster-wide events.</p>
<p>A cluster change stream is created by calling the <code class="docutils literal notranslate"><span class="pre">#watch</span></code> method on a
client object (not the cluster object):</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">watch</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:test</span><span class="o">].</span><span class="n">insert_one</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">to_enum</span><span class="o">.</span><span class="n">next</span>
<span class="n">process</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="closing-a-change-stream">
<h2>Closing a Change Stream<a class="headerlink" href="#closing-a-change-stream" title="Permalink to this headline">¶</a></h2>
<p>You can close a change stream by calling its <code class="docutils literal notranslate"><span class="pre">#close</span></code> method:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">stream</span><span class="o">.</span><span class="n">close</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="resuming-a-change-stream">
<h2>Resuming a Change Stream<a class="headerlink" href="#resuming-a-change-stream" title="Permalink to this headline">¶</a></h2>
<p>A change stream consists of two types of operations: the initial aggregation
and <code class="docutils literal notranslate"><span class="pre">getMore</span></code> requests to receive the next batch of changes.</p>
<p>The driver will automatically retry each <code class="docutils literal notranslate"><span class="pre">getMore</span></code> operation once on
network errors and when the server returns an error indicating it changed
state (for example, it is no longer the primary). The driver does not retry
the initial aggregation.</p>
<p>In practical terms this means that, for example:</p>
<ul class="simple">
<li>Calling <code class="docutils literal notranslate"><span class="pre">collection.watch</span></code> will fail if the cluster does not have
enough available nodes to satisfy the <code class="docutils literal notranslate"><span class="pre">&quot;majority&quot;</span></code> read preference.</li>
<li>Once <code class="docutils literal notranslate"><span class="pre">collection.watch</span></code> successfully returns, if the cluster subsequently
experiences an election or loses a node, but heals quickly enough,
change stream reads via <code class="docutils literal notranslate"><span class="pre">next</span></code> or <code class="docutils literal notranslate"><span class="pre">each</span></code> methods will continue
transparently to the application.</li>
</ul>
<p>To indefinitely and reliably watch for changes without losing any changes or
processing a change more than once, the application must track the resume
token for the change stream and restart the change stream when it experiences
extended error conditions that cause the driver’s automatic resume to also
fail. The following code snippet shows an example of iterating a change stream
indefinitely, retrieving the resume token using the <code class="docutils literal notranslate"><span class="pre">resume_token</span></code> change
stream method and restarting the change stream using the <code class="docutils literal notranslate"><span class="pre">:resume_after</span></code>
option on all MongoDB or network errors:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">token</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="kp">loop</span> <span class="k">do</span>
  <span class="k">begin</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="o">[]</span><span class="p">,</span> <span class="ss">resume_after</span><span class="p">:</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">enum</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">to_enum</span>
    <span class="k">while</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">next</span>
      <span class="n">process</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
      <span class="n">token</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">resume_token</span>
    <span class="k">end</span>
  <span class="k">rescue</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Error</span>
    <span class="nb">sleep</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>The above iteration is blocking at the <code class="docutils literal notranslate"><span class="pre">enum.next</span></code> call, and does not
permit resuming processing in the event the Ruby process running this code
is terminated. The driver also provides the <code class="docutils literal notranslate"><span class="pre">try_next</span></code> method which returns
<code class="docutils literal notranslate"><span class="pre">nil</span></code> (after a small waiting period) instead of blocking indefinitely when
there are no changes in the change stream. Using the <code class="docutils literal notranslate"><span class="pre">try_next</span></code> method,
the resume token may be persisted after each <code class="docutils literal notranslate"><span class="pre">getMore</span></code> request, even when
a particular request does not return any changes, such that the resume token
remains at the top of the oplog and the application has an opportunity to
persist it should the process handling changes terminates:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">token</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="kp">loop</span> <span class="k">do</span>
  <span class="k">begin</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="o">[]</span><span class="p">,</span> <span class="ss">resume_after</span><span class="p">:</span> <span class="n">token</span><span class="p">)</span>
    <span class="n">enum</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">to_enum</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">try_next</span>
    <span class="k">if</span> <span class="n">doc</span>
      <span class="n">process</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">resume_token</span>
    <span class="c1"># Persist +token+ to support resuming processing upon process restart</span>
  <span class="k">rescue</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Error</span>
    <span class="nb">sleep</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>Note that the resume token should be retrieved from the change stream after
every <code class="docutils literal notranslate"><span class="pre">try_next</span></code> call, even if the call returned no document.</p>
<p>The resume token is also provided in the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field of each change stream
document. Reading the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field is not recommended because it may be
projected out by the application, and because using only the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field
would not advance the resume token when a <code class="docutils literal notranslate"><span class="pre">getMore</span></code> returns no documents.</p>
</div>
</div>

                
    <div id="btnv">
      <span class="btn-arrow-left">&larr; &nbsp;</span>
      <a class="btn-prev-text" href="transactions.html" title="Previous Section: Transactions"><span>Transactions</span></a>
      <a class="btn-next-text" href="database-tasks.html" title="Next Section: Databases"><span>Databases</span></a>
      <span class="btn-arrow-right">&nbsp;&rarr;</span>
    </div>
                  <div class="footer">
                    <div class="copyright">
                      <p>&copy; MongoDB, Inc 2008-present. MongoDB, Mongo, and the leaf logo are registered trademarks of MongoDB, Inc.</p>
                    </div>
                  </div>
              </div></div>
            </div>
        </div>
    </div>
    <div class="right-column">
      <div class="wrapper"> 
            <div class="social">
               <a class="slack-icon" href="https://slackpass.io/mongo-db?jmp=docs" title="https://slackpass.io/mongo-db?jmp=docs"><i class="fab fa-slack" aria-hidden="true"></i></a>
               <a class="twitter-icon" href="https://twitter.com/MongoDB" title="https://twitter.com/MongoDB"><i class="fab fa-twitter-square"></i></a>
               <a class="youtube-icon" href="https://www.youtube.com/user/MongoDB" title="https://www.youtube.com/user/MongoDB"><i class="fab fa-youtube-square"></i></a>
               <a class="facebook-icon" href="https://www.facebook.com/mongodb" title="https://www.facebook.com/mongodb"><i class="fab fa-facebook-square"></i></a>
               <a class="stack-overflow-icon" href="https://stackoverflow.com/tags/mongodb/info" title="https://stackoverflow.com/tags/mongodb/info"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a>
            </div>
        

      </div>
    </div>
    
    <div class="clearfix"></div>
  </div>
<div id="navbar" data-navprops='{"links": [{"url": "https://docs.mongodb.com/manual/","text": "Server"},{"url": "https://docs.mongodb.com/ecosystem/drivers/","text": "Drivers","active": true},{"url": "https://docs.mongodb.com/cloud/","text": "Cloud"},{"url": "https://docs.mongodb.com/tools/","text": "Tools"},{"url": "https://docs.mongodb.com/guides/","text": "Guides"}]}'></div>

  <script src="../_static/navbar.min.js"></script>

  

  <script type="text/javascript">
  // Bootstrap array of links that should trigger a full page reload
  window.docsExcludedNav = ['/bson-tutorials', '/mongoid-tutorials'];
  </script></body>
</html>

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Creating a Client &#8212; Ruby MongoDB Driver  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Authentication" href="authentication.html" />
    <link rel="prev" title="Connection &amp; Configuration" href="connection-and-configuration.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ruby MongoDB Driver  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../getting-started.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../installation.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="driver-compatibility.html">
     Driver Compatibility
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../support.html">
     Support
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorials.html">
   Tutorials
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/quick-start.html">
     Quick Start
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/common-errors.html">
     Common Errors
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="connection-and-configuration.html">
   Connection &amp; Configuration
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Creating a Client
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="authentication.html">
     Authentication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="monitoring.html">
     Monitoring
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="user-management.html">
     User Management
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="working-with-data.html">
   Working With Data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="crud-operations.html">
     CRUD Operations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="bulk-operations.html">
     Bulk Writes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="projection.html">
     Projection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="aggregation.html">
     Aggregation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="map-reduce.html">
     Map-Reduce
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="text-search.html">
     Text Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="geospatial-search.html">
     Geospatial Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="query-cache.html">
     Query Cache
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="gridfs.html">
     GridFS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="change-streams.html">
     Change Streams
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sessions.html">
     Sessions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="transactions.html">
     Transactions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="client-side-encryption.html">
     Client-Side Encryption
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="schema-operations.html">
   Schema Operations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="database-tasks.html">
     Databases
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="collection-tasks.html">
     Collections
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="indexing.html">
     Indexing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="collations.html">
     Collations
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://mongodb.com/docs/ruby-driver/master/api/">
   API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../release-notes.html">
   Release Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="additional-resources.html">
   Additional Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contribute.html">
   Contribute to the Driver
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/reference/create-client.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.txt</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-mongo-client">
   Using
   <code class="docutils literal notranslate">
    <span class="pre">
     Mongo::Client
    </span>
   </code>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#block-syntax">
     Block Syntax
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#database-selection">
   Database Selection
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#connection-types">
   Connection Types
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#standalone-server-connection">
     Standalone Server Connection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#replica-set-connection">
     Replica Set Connection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sharded-cluster-connection">
     Sharded Cluster Connection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#direct-connection">
     Direct Connection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-balancer-connection">
     Load Balancer Connection
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#srv-uri-notes">
   SRV URI Notes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#client-options">
   Client Options
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ruby-options">
     Ruby Options
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#uri-options">
     URI Options
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#timeout-options">
   Timeout Options
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#server-selection-timeout">
     <code class="docutils literal notranslate">
      <span class="pre">
       server_selection_timeout
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#socket-timeout">
     <code class="docutils literal notranslate">
      <span class="pre">
       socket_timeout
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#connect-timeout">
     <code class="docutils literal notranslate">
      <span class="pre">
       connect_timeout
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#wait-queue-timeout">
       <code class="docutils literal notranslate">
        <span class="pre">
         wait_queue_timeout
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#max-time-ms">
     <code class="docutils literal notranslate">
      <span class="pre">
       max_time_ms
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#wtimeout">
     <code class="docutils literal notranslate">
      <span class="pre">
       wtimeout
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tls-connections">
   TLS Connections
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tls-vs-ssl-option-names">
     TLS vs SSL Option Names
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enable-tls-connections">
     Enable TLS Connections
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-client-tls-certificate">
     Specify Client TLS Certificate
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modifying-sslcontext">
     Modifying
     <code class="docutils literal notranslate">
      <span class="pre">
       SSLContext
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#using-intermediate-certificates">
       Using Intermediate Certificates
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-ca-certificate">
     Specify CA Certificate
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#specifying-multiple-ca-certificates">
       Specifying Multiple CA Certificates
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ocsp-verification">
     OCSP Verification
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ipv4-ipv6-connections">
   IPv4/IPv6 Connections
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tcp-keepalive-configuration">
   TCP Keepalive Configuration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#connection-pooling">
   Connection Pooling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#usage-with-forking-servers">
   Usage with Forking Servers
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reconnecting-client-instances">
     Reconnecting Client Instances
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#troubleshooting">
     Troubleshooting
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#retryable-reads">
   Retryable Reads
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modern-retryable-reads">
     Modern Retryable Reads
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#legacy-retryable-reads">
     Legacy Retryable Reads
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#disabling-retryable-reads">
     Disabling Retryable Reads
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#retryable-writes">
   Retryable Writes
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modern-retryable-writes">
     Modern Retryable Writes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#legacy-retryable-writes">
     Legacy Retryable Writes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#disabling-retryable-writes">
     Disabling Retryable Writes
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logging">
   Logging
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-the-logger-level">
     Changing the Logger Level
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#truncation">
     Truncation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compression">
   Compression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#server-api-parameters">
   Server API Parameters
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#development-configuration">
   Development Configuration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#production-configuration">
   Production Configuration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#feature-flags">
   Feature Flags
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Creating a Client</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-mongo-client">
   Using
   <code class="docutils literal notranslate">
    <span class="pre">
     Mongo::Client
    </span>
   </code>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#block-syntax">
     Block Syntax
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#database-selection">
   Database Selection
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#connection-types">
   Connection Types
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#standalone-server-connection">
     Standalone Server Connection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#replica-set-connection">
     Replica Set Connection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sharded-cluster-connection">
     Sharded Cluster Connection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#direct-connection">
     Direct Connection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-balancer-connection">
     Load Balancer Connection
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#srv-uri-notes">
   SRV URI Notes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#client-options">
   Client Options
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ruby-options">
     Ruby Options
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#uri-options">
     URI Options
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#timeout-options">
   Timeout Options
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#server-selection-timeout">
     <code class="docutils literal notranslate">
      <span class="pre">
       server_selection_timeout
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#socket-timeout">
     <code class="docutils literal notranslate">
      <span class="pre">
       socket_timeout
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#connect-timeout">
     <code class="docutils literal notranslate">
      <span class="pre">
       connect_timeout
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#wait-queue-timeout">
       <code class="docutils literal notranslate">
        <span class="pre">
         wait_queue_timeout
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#max-time-ms">
     <code class="docutils literal notranslate">
      <span class="pre">
       max_time_ms
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#wtimeout">
     <code class="docutils literal notranslate">
      <span class="pre">
       wtimeout
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tls-connections">
   TLS Connections
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tls-vs-ssl-option-names">
     TLS vs SSL Option Names
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enable-tls-connections">
     Enable TLS Connections
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-client-tls-certificate">
     Specify Client TLS Certificate
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modifying-sslcontext">
     Modifying
     <code class="docutils literal notranslate">
      <span class="pre">
       SSLContext
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#using-intermediate-certificates">
       Using Intermediate Certificates
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-ca-certificate">
     Specify CA Certificate
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#specifying-multiple-ca-certificates">
       Specifying Multiple CA Certificates
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ocsp-verification">
     OCSP Verification
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ipv4-ipv6-connections">
   IPv4/IPv6 Connections
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tcp-keepalive-configuration">
   TCP Keepalive Configuration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#connection-pooling">
   Connection Pooling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#usage-with-forking-servers">
   Usage with Forking Servers
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reconnecting-client-instances">
     Reconnecting Client Instances
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#troubleshooting">
     Troubleshooting
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#retryable-reads">
   Retryable Reads
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modern-retryable-reads">
     Modern Retryable Reads
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#legacy-retryable-reads">
     Legacy Retryable Reads
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#disabling-retryable-reads">
     Disabling Retryable Reads
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#retryable-writes">
   Retryable Writes
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modern-retryable-writes">
     Modern Retryable Writes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#legacy-retryable-writes">
     Legacy Retryable Writes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#disabling-retryable-writes">
     Disabling Retryable Writes
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logging">
   Logging
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-the-logger-level">
     Changing the Logger Level
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#truncation">
     Truncation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compression">
   Compression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#server-api-parameters">
   Server API Parameters
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#development-configuration">
   Development Configuration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#production-configuration">
   Production Configuration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#feature-flags">
   Feature Flags
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="creating-a-client">
<h1>Creating a Client<a class="headerlink" href="#creating-a-client" title="Permalink to this headline">#</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><p><a class="reference internal" href="#using-mongo-client" id="id31">Using <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code></a></p>
<ul>
<li><p><a class="reference internal" href="#block-syntax" id="id32">Block Syntax</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#database-selection" id="id33">Database Selection</a></p></li>
<li><p><a class="reference internal" href="#connection-types" id="id34">Connection Types</a></p>
<ul>
<li><p><a class="reference internal" href="#standalone-server-connection" id="id35">Standalone Server Connection</a></p></li>
<li><p><a class="reference internal" href="#replica-set-connection" id="id36">Replica Set Connection</a></p></li>
<li><p><a class="reference internal" href="#sharded-cluster-connection" id="id37">Sharded Cluster Connection</a></p></li>
<li><p><a class="reference internal" href="#direct-connection" id="id38">Direct Connection</a></p></li>
<li><p><a class="reference internal" href="#load-balancer-connection" id="id39">Load Balancer Connection</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#srv-uri-notes" id="id40">SRV URI Notes</a></p></li>
<li><p><a class="reference internal" href="#client-options" id="id41">Client Options</a></p>
<ul>
<li><p><a class="reference internal" href="#ruby-options" id="id42">Ruby Options</a></p></li>
<li><p><a class="reference internal" href="#uri-options" id="id43">URI Options</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#timeout-options" id="id44">Timeout Options</a></p>
<ul>
<li><p><a class="reference internal" href="#server-selection-timeout" id="id45"><code class="docutils literal notranslate"><span class="pre">server_selection_timeout</span></code></a></p></li>
<li><p><a class="reference internal" href="#socket-timeout" id="id46"><code class="docutils literal notranslate"><span class="pre">socket_timeout</span></code></a></p></li>
<li><p><a class="reference internal" href="#connect-timeout" id="id47"><code class="docutils literal notranslate"><span class="pre">connect_timeout</span></code></a></p></li>
<li><p><a class="reference internal" href="#max-time-ms" id="id48"><code class="docutils literal notranslate"><span class="pre">max_time_ms</span></code></a></p></li>
<li><p><a class="reference internal" href="#wtimeout" id="id49"><code class="docutils literal notranslate"><span class="pre">wtimeout</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#tls-connections" id="id50">TLS Connections</a></p>
<ul>
<li><p><a class="reference internal" href="#tls-vs-ssl-option-names" id="id51">TLS vs SSL Option Names</a></p></li>
<li><p><a class="reference internal" href="#enable-tls-connections" id="id52">Enable TLS Connections</a></p></li>
<li><p><a class="reference internal" href="#specify-client-tls-certificate" id="id53">Specify Client TLS Certificate</a></p></li>
<li><p><a class="reference internal" href="#modifying-sslcontext" id="id54">Modifying <code class="docutils literal notranslate"><span class="pre">SSLContext</span></code></a></p></li>
<li><p><a class="reference internal" href="#specify-ca-certificate" id="id55">Specify CA Certificate</a></p></li>
<li><p><a class="reference internal" href="#ocsp-verification" id="id56">OCSP Verification</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ipv4-ipv6-connections" id="id57">IPv4/IPv6 Connections</a></p></li>
<li><p><a class="reference internal" href="#tcp-keepalive-configuration" id="id58">TCP Keepalive Configuration</a></p></li>
<li><p><a class="reference internal" href="#connection-pooling" id="id59">Connection Pooling</a></p></li>
<li><p><a class="reference internal" href="#usage-with-forking-servers" id="id60">Usage with Forking Servers</a></p>
<ul>
<li><p><a class="reference internal" href="#reconnecting-client-instances" id="id61">Reconnecting Client Instances</a></p></li>
<li><p><a class="reference internal" href="#troubleshooting" id="id62">Troubleshooting</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#retryable-reads" id="id63">Retryable Reads</a></p>
<ul>
<li><p><a class="reference internal" href="#modern-retryable-reads" id="id64">Modern Retryable Reads</a></p></li>
<li><p><a class="reference internal" href="#legacy-retryable-reads" id="id65">Legacy Retryable Reads</a></p></li>
<li><p><a class="reference internal" href="#disabling-retryable-reads" id="id66">Disabling Retryable Reads</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#retryable-writes" id="id67">Retryable Writes</a></p>
<ul>
<li><p><a class="reference internal" href="#modern-retryable-writes" id="id68">Modern Retryable Writes</a></p></li>
<li><p><a class="reference internal" href="#legacy-retryable-writes" id="id69">Legacy Retryable Writes</a></p></li>
<li><p><a class="reference internal" href="#disabling-retryable-writes" id="id70">Disabling Retryable Writes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#logging" id="id71">Logging</a></p>
<ul>
<li><p><a class="reference internal" href="#changing-the-logger-level" id="id72">Changing the Logger Level</a></p></li>
<li><p><a class="reference internal" href="#truncation" id="id73">Truncation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#compression" id="id74">Compression</a></p></li>
<li><p><a class="reference internal" href="#server-api-parameters" id="id75">Server API Parameters</a></p></li>
<li><p><a class="reference internal" href="#development-configuration" id="id76">Development Configuration</a></p></li>
<li><p><a class="reference internal" href="#production-configuration" id="id77">Production Configuration</a></p></li>
<li><p><a class="reference internal" href="#feature-flags" id="id78">Feature Flags</a></p></li>
</ul>
</div>
<section id="using-mongo-client">
<h2>Using <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code><a class="headerlink" href="#using-mongo-client" title="Permalink to this headline">#</a></h2>
<p>To connect to a MongoDB deployment, create a <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code> object.
Provide a list of hosts and options or a <a href="#id1"><span class="problematic" id="id2">:manual:`connection string URI
&lt;/reference/connection-string/&gt;`</span></a> to the``Mongo::Client`` constructor.
The clientâ€™s selected database defaults to <code class="docutils literal notranslate"><span class="pre">admin</span></code>.</p>
<p>By default, the driver will automatically detect the topology used by the
deployment and connect appropriately.</p>
<p>To connect to a local standalone MongoDB deployment, specify the host and
port of the server. In most cases you would also specify the database name
to connect to; if no database name is specified, the client will use the
<code class="docutils literal notranslate"><span class="pre">admin</span></code> database:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">)</span>

<span class="c1"># Or using the URI syntax:</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb://127.0.0.1:27017/mydb&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The hostname <code class="docutils literal notranslate"><span class="pre">localhost</span></code> is treated specially by the driver and will
be resolved to IPv4 addresses only.</p>
</div>
<p>To <a class="reference external" href="https://docs.atlas.mongodb.com/driver-connection/">connect to MongoDB Atlas</a>,
specify the Atlas deployment URI:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb+srv://username:myRealPassword@cluster0.mongodb.net/mydb?w=majority&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The driver will discover all nodes in the cluster and connect to them as
needed.</p>
<section id="block-syntax">
<h3>Block Syntax<a class="headerlink" href="#block-syntax" title="Permalink to this headline">#</a></h3>
<p>Another way to create a Mongo::Client object is to use the block syntax:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
  <span class="c1"># work with the client</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Note that when creating a client using this syntax, the client is automatically closed after the block finishes executing.</p>
</section>
</section>
<section id="database-selection">
<h2>Database Selection<a class="headerlink" href="#database-selection" title="Permalink to this headline">#</a></h2>
<p>By default, the client will connect to the <code class="docutils literal notranslate"><span class="pre">admin</span></code> database.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">admin</span></code> database is a special database in MongoDB often used for
administrative tasks and storing administrative data such as users and
roles (although users and roles may also be defined in other databases).
In a sharded cluster, the <code class="docutils literal notranslate"><span class="pre">admin</span></code> database
<a href="#id3"><span class="problematic" id="id4">:manual:`exists on the config servers &lt;/core/sharded-cluster-config-servers/#read-and-write-operations-on-config-servers&gt;`</span></a>
rather than the shard servers. Although it is possible to use the <code class="docutils literal notranslate"><span class="pre">admin</span></code>
database for ordinary operations (such as storing application data), this
is not recommended and the application should explicitly specify the
database it wishes to use.</p>
<p>The database can be specified during <code class="docutils literal notranslate"><span class="pre">Client</span></code> construction:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using Ruby client options:</span>
<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;localhost&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">)</span>

<span class="c1"># Using a MongoDB URI:</span>
<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;mongodb://localhost/mydb&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Given a <code class="docutils literal notranslate"><span class="pre">Client</span></code> instance, the <code class="docutils literal notranslate"><span class="pre">use</span></code> method can be invoked to obtain a
new <code class="docutils literal notranslate"><span class="pre">Client</span></code> instance configured with the specified database:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;localhost&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">)</span>

<span class="n">admin_client</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>

<span class="c1"># Issue an administrative command</span>
<span class="n">admin_client</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="ss">replSetGetConfig</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">documents</span><span class="o">.</span><span class="n">first</span>
</pre></div>
</div>
<p>There are other special databases in MongoDB which should be only used for
their stated purposes:</p>
<ul class="simple">
<li><p>The <a href="#id5"><span class="problematic" id="id6">:manual:`config &lt;/reference/config-database/&gt;`</span></a> database.</p></li>
<li><p>The <a href="#id7"><span class="problematic" id="id8">:manual:`local &lt;/reference/local-database/&gt;`</span></a> database.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">$external</span></code> database, which is used with <a class="reference internal" href="authentication.html#plain"><span class="std std-ref">PLAIN</span></a>,
<a class="reference internal" href="authentication.html#kerberos"><span class="std std-ref">Kerberos</span></a> and <a class="reference internal" href="authentication.html#x-509"><span class="std std-ref">X.509</span></a> authentication
mechanisms.</p></li>
</ul>
</section>
<section id="connection-types">
<h2>Connection Types<a class="headerlink" href="#connection-types" title="Permalink to this headline">#</a></h2>
<p>The driver will, by default, discover the type of deployment it is instructed
to connect to (except for load-balanced deployments)
and behave in the manner that matches the deployment type.
The subsections below describe how the driver behaves in each of the deployment
types as well as how to force particular behavior, bypassing automatic
deployment type detection.</p>
<p>Note that the detection of deployment type happens when the driver receives
the first reply from any of the servers it is instructed to connect to
(unless the load-balancing mode is requested, see below). The driver will
remain in the discovered or configured topology even if the underlying
deployment is replaced by one of a different type. In particular, when
replacing a replica set with a sharded cluster at the same address
the client instance must be recreated (such as by restarting the application)
for it to communicate with the sharded cluster.</p>
<p>Automatic discovery of load-balanced deployments is currently not supported.
Load-balanced deployments will be treated as deployments of their underlying
type, which would generally be sharded clusters. The driver will fail to
correctly operate when treating a load-balanced deployment as a sharded
cluster, therefore when the deployment is a load-balanced one the client
must be explicitly configured to <a class="reference internal" href="#load-balancer-connection"><span class="std std-ref">connect to a load balancer</span></a>.</p>
<section id="standalone-server-connection">
<h3>Standalone Server Connection<a class="headerlink" href="#standalone-server-connection" title="Permalink to this headline">#</a></h3>
<p>If the deployment is a single server, also known as a standalone deployment,
all operations will be directed to the specified server.</p>
<p>If the server is shut down and replaced by a replica set node, the driver
will continue sending all operations to that node, even if the node is or
becomes a secondary.</p>
<p>To force a standalone connection, see the <a class="reference internal" href="#direct-connection"><span class="std std-ref">direct connection</span></a> section below.</p>
</section>
<section id="replica-set-connection">
<span id="connect-replica-set"></span><h3>Replica Set Connection<a class="headerlink" href="#replica-set-connection" title="Permalink to this headline">#</a></h3>
<p>When connecting to a <a href="#id9"><span class="problematic" id="id10">:manual:`replica set&lt;/replication/&gt;`</span></a>, it is sufficient
to pass the address of any node in the replica set to the driver.
The node does not have to be the primary and it may be a hidden node.
The driver will then automatically discover the remaining nodes.</p>
<p>However, it is recommended to specify all nodes that are part of the
replica set, so that in the event of one or more nodes being unavailable
(for example, due to maintenance or reconfiguration) the driver can still
connect to the replica set.</p>
<p>Replica set connection examples:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">)</span>

<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1:27018&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">)</span>

<span class="c1"># Or using the URI syntax:</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb://127.0.0.1:27017,127.0.0.1:27018/mydb&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To make the driver verify the replica set name upon connection, pass it using
the <code class="docutils literal notranslate"><span class="pre">replica_set</span></code> Ruby option or the <code class="docutils literal notranslate"><span class="pre">replicaSet</span></code> URI option:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1:27018&#39;</span> <span class="o">]</span><span class="p">,</span>
  <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">,</span> <span class="ss">replica_set</span><span class="p">:</span> <span class="s1">&#39;myapp&#39;</span><span class="p">)</span>

<span class="c1"># Or using the URI syntax:</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb://127.0.0.1:27017,127.0.0.1:27018/mydb?replicaSet=myapp&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If the deployment is not a replica set or uses a different replica set name,
all operations will fail (until the expected replica set is returned by
the servers).</p>
<p>It is also possible to force a replica set connection without specifying
the replica set name. Doing so is generally unnecessary and is deprecated:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1:27018&#39;</span> <span class="o">]</span><span class="p">,</span>
  <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">,</span> <span class="ss">connect</span><span class="p">:</span> <span class="ss">:replica_set</span><span class="p">)</span>

<span class="c1"># Or using the URI syntax:</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb://127.0.0.1:27017,127.0.0.1:27018/mydb?connect=replica_set&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To connect to a MongoDB Atlas cluster which is deployed as a replica set,
connect to the URI:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb+srv://username:myRealPassword@cluster0.mongodb.net/test?w=majority&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Please review the <a class="reference internal" href="#srv-uri-notes"><span class="std std-ref">SRV URI notes</span></a> if using SRV URIs.</p>
</section>
<section id="sharded-cluster-connection">
<span id="connect-sharded-cluster"></span><h3>Sharded Cluster Connection<a class="headerlink" href="#sharded-cluster-connection" title="Permalink to this headline">#</a></h3>
<p>To connect to a <a href="#id11"><span class="problematic" id="id12">:manual:`sharded cluster&lt;/sharding/&gt;`</span></a> deployment, specify
the addresses of the <code class="docutils literal notranslate"><span class="pre">mongos</span></code> routers:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;1.2.3.4:27017&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3.5:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">)</span>

<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb://1.2.3.4:27017,1.2.3.5:27017/mydb&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that unlike a replica set connection, you may choose to connect to a
subset of the <code class="docutils literal notranslate"><span class="pre">mongos</span></code> routers that exist in the deployment. The driver
will monitor each router and will use the ones that are available
(i.e., the driver will generally handle individual routers becoming
unavailable due to failures or maintenance). When specifying the list of
routers explicitly, the driver will not discover remaining routers that
may be configured and will not attempt to connect to them.</p>
<p>The driver will automatically balance the operation load among the routers
it is aware of.</p>
<p>To connect to a MongoDB Atlas cluster which is deployed as a sharded cluster,
connect to the URI:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb+srv://username:myRealPassword@cluster0.mongodb.net/test?w=majority&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>When the driver connects to a sharded cluster via an SRV URI, it will
periodically poll the SRV records of the address specified in the URI
for changes and will automatically add and remove the <code class="docutils literal notranslate"><span class="pre">mongos</span></code> hosts
to/from its list of servers as they are added and removed to/from the
sharded cluster.</p>
<p>To force a sharded cluster connection, use the <code class="docutils literal notranslate"><span class="pre">connect:</span> <span class="pre">:sharded</span></code>
option. Doing so is generally unnecessary and is deprecated:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1:27018&#39;</span> <span class="o">]</span><span class="p">,</span>
  <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">,</span> <span class="ss">connect</span><span class="p">:</span> <span class="ss">:sharded</span><span class="p">)</span>

<span class="c1"># Or using the URI syntax:</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb://127.0.0.1:27017,127.0.0.1:27018/mydb?connect=sharded&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Please review the <a class="reference internal" href="#srv-uri-notes"><span class="std std-ref">SRV URI notes</span></a> if using SRV URIs.</p>
</section>
<section id="direct-connection">
<span id="id13"></span><h3>Direct Connection<a class="headerlink" href="#direct-connection" title="Permalink to this headline">#</a></h3>
<p>To disable the deployment type discovery and force all operations to be
performed on a particular server, specify the <code class="docutils literal notranslate"><span class="pre">direct_connection</span></code> option:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;1.2.3.4:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">,</span> <span class="ss">direct_connection</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>

<span class="c1"># Or using the URI syntax:</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb://1.2.3.4:27017/mydb?directConnection=true&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively, the deprecated <code class="docutils literal notranslate"><span class="pre">connect:</span> <span class="pre">:direct</span></code> option is equivalent:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;1.2.3.4:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">,</span> <span class="ss">connect</span><span class="p">:</span> <span class="ss">:direct</span><span class="p">)</span>

<span class="c1"># Or using the URI syntax:</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb://1.2.3.4:27017/mydb?connect=direct&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The direct connection mode is most useful for performing operations on a
particular replica set node, although it also permits the underlying server
to change type (e.g. from a replica set node to a <code class="docutils literal notranslate"><span class="pre">mongos</span></code> router, or vice
versa).</p>
</section>
<section id="load-balancer-connection">
<span id="id14"></span><h3>Load Balancer Connection<a class="headerlink" href="#load-balancer-connection" title="Permalink to this headline">#</a></h3>
<p>Unlike other deployment types, the driver does not currently automatically
detect a load-balanced deployment.</p>
<p>To connect to a load balancer, specify the <code class="docutils literal notranslate"><span class="pre">load_balanced:</span> <span class="pre">true</span></code> Ruby option
or the <code class="docutils literal notranslate"><span class="pre">loadBalanced=true</span></code> URI option:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;1.2.3.4:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">,</span> <span class="ss">load_balanced</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>

<span class="c1"># Or using the URI syntax:</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb://1.2.3.4:27017/mydb?loadBalanced=true&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>When using these options, if the specified server is not a load balancer,
the client will fail all operations (until the server becomes a load balancer).</p>
<p>To treat the server as a load balancer even if it doesnâ€™t identify as such,
use the <code class="docutils literal notranslate"><span class="pre">connect:</span> <span class="pre">:load_balanced</span></code> Ruby option or the <code class="docutils literal notranslate"><span class="pre">connect=load_balanced</span></code>
URI option:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;1.2.3.4:27017&#39;</span> <span class="o">]</span><span class="p">,</span>
  <span class="ss">database</span><span class="p">:</span> <span class="s1">&#39;mydb&#39;</span><span class="p">,</span> <span class="ss">load_balanced</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">connect</span><span class="p">:</span> <span class="ss">:load_balanced</span><span class="p">)</span>

<span class="c1"># Or using the URI syntax:</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb://1.2.3.4:27017/mydb?loadBalanced=true&amp;connect=load_balanced&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="srv-uri-notes">
<span id="id15"></span><h2>SRV URI Notes<a class="headerlink" href="#srv-uri-notes" title="Permalink to this headline">#</a></h2>
<p>When the driver connects to a
<a href="#id16"><span class="problematic" id="id17">:manual:`mongodb+srv protocol &lt;reference/connection-string/#dns-seedlist-connection-format&gt;`</span></a>
URI, keep in mind the following:</p>
<ol class="arabic">
<li><p>SRV URI lookup is performed synchronously when the client is constructed.
If this lookup fails for any reason, client construction will fail with an
exception. When a client is constructed with a list of hosts, the driver
will attempt to contact and monitor those hosts for as long as the client
object exists. If one of these hosts does not resolve initially but becomes
resolvable later, the driver will be able to establish a connection to such
a host when it becomes available. The initial SRV URI lookup must succeed
on the first attempt; subsequent host lookups will be retried by the driver
as needed.</p></li>
<li><p>The driver looks up URI options in the DNS TXT records corresponding to the
SRV records. These options can be overridden by URI options specified in the
URI and by Ruby options, in this order.</p></li>
<li><p>Because the URI options are retrieved in a separate DNS query from the
SRV lookup, in environments with unreliable network connectivity
the URI option query may fail when the SRV lookup succeeds. Such a failure
would cause the driver to use the wrong auth source leading to
authentication failures. This can be worked around by explicitly specifying
the auth source:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;mongodb+srv://username:myRealPassword@cluster0.mongodb.net/test?w=majority&amp;authSource=admin&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>If the topology of the constructed <code class="docutils literal notranslate"><span class="pre">Client</span></code> object is unknown or a
sharded cluster, the driver will begin monitoring the specified SRV DNS
records for changes and will automatically update the list of servers in the
cluster. The updates will stop if the topology becomes a single or a replica
set.</p></li>
</ol>
</section>
<section id="client-options">
<span id="id18"></span><h2>Client Options<a class="headerlink" href="#client-options" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code>â€™s constructor accepts a number of options configuring the
behavior of the driver. The options can be provided in the options hash as
Ruby options, in the URI as URI options, or both. If both a Ruby option and
the analogous URI option are provided, the Ruby option takes precedence.</p>
<section id="ruby-options">
<h3>Ruby Options<a class="headerlink" href="#ruby-options" title="Permalink to this headline">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The options passed directly should be symbols.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unless otherwise specified, Ruby options that deal with times are given in
seconds.</p>
</div>
<table class="colwidths-given table">
<colgroup>
<col style="width: 28%" />
<col style="width: 44%" />
<col style="width: 11%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:app_name</span></code></p></td>
<td><p>Application name that is printed to the mongod logs upon establishing a connection
in server versions &gt;= 3.4.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:auth_mech</span></code></p></td>
<td><p>Specifies the authenticaion mechanism to use. Can be one of:
<code class="docutils literal notranslate"><span class="pre">:gssapi</span></code>, <code class="docutils literal notranslate"><span class="pre">:mongodb_cr</span></code>, <code class="docutils literal notranslate"><span class="pre">:mongodb_x509</span></code>, <code class="docutils literal notranslate"><span class="pre">:plain</span></code>,
<code class="docutils literal notranslate"><span class="pre">:scram</span></code>, <code class="docutils literal notranslate"><span class="pre">:scram256</span></code>. GSSAPI (Kerberos) authentication
<a class="reference internal" href="authentication.html#kerberos"><span class="std std-ref">requires additional dependencies</span></a>.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Symbol</span></code></p></td>
<td><p>If user credentials are not supplied, <code class="docutils literal notranslate"><span class="pre">nil</span></code>. If user credentials
are supplied, the default depends on server version.
MongoDB 4.0 and later: <code class="docutils literal notranslate"><span class="pre">:scram256</span></code> if user credentials correspond
to a user which supports SCRAM-SHA-256 authentication, otherwise
<code class="docutils literal notranslate"><span class="pre">:scram</span></code>.
MongoDB 3.0-3.6: <code class="docutils literal notranslate"><span class="pre">:scram</span></code>.
MongoDB 2.6: <code class="docutils literal notranslate"><span class="pre">:mongodb_cr</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:auth_mech_properties</span></code></p></td>
<td><p>Provides additional authentication mechanism properties.</p>
<p>The keys in properties are interpreted case-insensitively.
When the client is created, keys are lowercased.</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Hash</span></code></p></td>
<td><p>When using the GSSAPI authentication mechanism, the default properties
are <code class="docutils literal notranslate"><span class="pre">{service_name:</span> <span class="pre">&quot;mongodb&quot;}</span></code>. Otherwise the default is nil.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:auth_source</span></code></p></td>
<td><p>Specifies the authentication source.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>For MongoDB 2.6 and later: <strong>admin</strong> if credentials are
supplied, otherwise the current database</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:auto_encryption_options</span></code></p></td>
<td><p>A <code class="docutils literal notranslate"><span class="pre">Hash</span></code> of options for configuring automatic encryption.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">:key_vault_client</span></code> - A client connected to the MongoDB instance
storing the encryption data keys (<code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code>, defaults to the
top-level client instance).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:key_vault_namespace</span></code> - The namespace of the key vault collection
in the format <code class="docutils literal notranslate"><span class="pre">&quot;database.collection&quot;</span></code> (<code class="docutils literal notranslate"><span class="pre">String</span></code>, required).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:kms_providers</span></code> - Key management service configuration information.
One or both of the keys <code class="docutils literal notranslate"><span class="pre">:local</span></code> and <code class="docutils literal notranslate"><span class="pre">:aws</span></code> must be specified
(<code class="docutils literal notranslate"><span class="pre">Hash</span></code>, required). See the â€œThe <code class="docutils literal notranslate"><span class="pre">kms_providers</span></code> option`` section of the
<a class="reference internal" href="client-side-encryption.html#client-side-encryption"><span class="std std-ref">Client-Side Encryption tutorial</span></a> for more
information about this option.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:schema_map</span></code> - The JSONSchema for one or more collections specifying
which fields should be encrypted (<code class="docutils literal notranslate"><span class="pre">Hash</span></code>, optional, defaults to <code class="docutils literal notranslate"><span class="pre">nil</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:bypass_auto_encryption</span></code> - Whether to skip automatic encryption when
performing database operations (<code class="docutils literal notranslate"><span class="pre">Boolean</span></code>, defaults to <code class="docutils literal notranslate"><span class="pre">false</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:extra_options</span></code> - Options related to spawning mongocryptd (<code class="docutils literal notranslate"><span class="pre">Hash</span></code>,
optional, defaults to <code class="docutils literal notranslate"><span class="pre">nil</span></code>).</p></li>
</ul>
<p>For more information about formatting these options, see the
â€œAuto-Encryption Optionsâ€ section of the <a class="reference internal" href="client-side-encryption.html#client-side-encryption"><span class="std std-ref">Client-Side Encryption tutorial</span></a>.</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Hash</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:bg_error_backtrace</span></code></p></td>
<td><p>Experimental. Controls whether and how backtraces are logged when
errors occur in background threads. If <code class="docutils literal notranslate"><span class="pre">true</span></code>, the driver will log
complete backtraces. If set to a positive integer, the driver will
log up to that many backtrace lines. If set to <code class="docutils literal notranslate"><span class="pre">false</span></code> or <code class="docutils literal notranslate"><span class="pre">nil</span></code>,
no backtraces will be logged. Other values are an error.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">false</span></code>, <code class="docutils literal notranslate"><span class="pre">nil</span></code>, <code class="docutils literal notranslate"><span class="pre">Integer</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:compressors</span></code></p></td>
<td><p>A list of potential compressors to use, in order of preference.
Please see below for details on how the driver implements compression.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;String&gt;</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:connect</span></code></p></td>
<td><p><strong>Deprecated.</strong> Disables deployment topology discovery normally
performed by the dirver and forces the cluster topology to a specific
type. Valid values are <code class="docutils literal notranslate"><span class="pre">:direct</span></code>, <code class="docutils literal notranslate"><span class="pre">:load_balanced</span></code>,
<code class="docutils literal notranslate"><span class="pre">:replica_set</span></code> or <code class="docutils literal notranslate"><span class="pre">:sharded</span></code>. If <code class="docutils literal notranslate"><span class="pre">:load_balanced</span></code> is used,
the client will behave as if it is connected to a load balancer
regardless of whether the server(s) it connects to advertise themselves
as load balancers.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Symbol</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:connect_timeout</span></code></p></td>
<td><p>The number of seconds to wait to establish a socket connection
before raising an exception. This timeout is also used for SRV DNS
record resolution. <code class="docutils literal notranslate"><span class="pre">nil</span></code> and <code class="docutils literal notranslate"><span class="pre">0</span></code> mean no timeout.
Client creation will fail with an error if an invalid timeout value
is passed (such as a negative value or a non-numeric value).</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Float</span></code></p></td>
<td><p>10</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:database</span></code></p></td>
<td><p>The name of the database to connect to.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>admin</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:direct_connection</span></code></p></td>
<td><p>Connect directly to the specified host, do not discover deployment
topology.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p>false</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:heartbeat_frequency</span></code></p></td>
<td><p>The number of seconds for the server monitors to refresh
server states asynchronously.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Float</span></code></p></td>
<td><p>10</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:id_generator</span></code></p></td>
<td><p>A custom object to generate ids for documents. Must respond to #generate.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:load_balanced</span></code></p></td>
<td><p>Whether to expect to connect to a load balancer.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p>false</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:local_threshold</span></code></p></td>
<td><p>Specifies the maximum latency in seconds between the nearest
server and the servers that can be available for selection to operate on.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Float</span></code></p></td>
<td><p>0.015</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:logger</span></code></p></td>
<td><p>A custom logger.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Logger</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:max_idle_time</span></code></p></td>
<td><p>The maximum time, in seconds, that a connection can be idle before it
is closed by the connection pool.</p>
<p><em>Warning:</em> when connected to a load balancer, the driver uses existing
connections for iterating cursors (which includes change streams)
and executing transactions. Setting an idle time via this option may
cause the driver to close connections that are needed for subsequent
operations, causing those operations to fail.</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Integer</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:max_pool_size</span></code></p></td>
<td><p>The maximum size of the connection pool for each server.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Integer</span></code></p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:max_read_retries</span></code></p></td>
<td><p>The maximum number of read retries, when legacy read retries are used.
Set to 0 to disable legacy read retries.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Integer</span></code></p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:max_write_retries</span></code></p></td>
<td><p>The maximum number of write retries, when legacy write retries are used.
Set to 0 to disable legacy write retries.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Integer</span></code></p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:min_pool_size</span></code></p></td>
<td><p>The minimum number of connections in the connection pool for each
server. The driver will establish connections in the background until
the pool contains this many connections.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Integer</span></code></p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:monitoring</span></code></p></td>
<td><p>The monitoring object.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Object</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:password</span></code></p></td>
<td><p>The password of the user to authenticate with.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:platform</span></code></p></td>
<td><p>Platform information to include in the metadata printed to the mongod logs upon establishing a
connection in server versions &gt;= 3.4.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:read</span></code></p></td>
<td><p>Specifies the read preference mode and tag sets for selecting servers
as a <code class="docutils literal notranslate"><span class="pre">Hash</span></code>. Allowed Keys in the hash are <code class="docutils literal notranslate"><span class="pre">:mode</span></code>, <code class="docutils literal notranslate"><span class="pre">:tag_sets</span></code> and
<code class="docutils literal notranslate"><span class="pre">:max_staleness</span></code>.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="ss">read</span><span class="p">:</span>
  <span class="p">{</span> <span class="ss">mode</span><span class="p">:</span> <span class="ss">:secondary</span><span class="p">,</span>
    <span class="ss">tag_sets</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;data_center&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;berlin&quot;</span> <span class="o">]</span><span class="p">,</span>
    <span class="ss">max_staleness</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If tag sets are provided, they must be an array of hashes. A server
satisfies the read preference if its tags match any one hash in the
provided tag sets.</p>
<p>Each tag set must be a hash, and will be converted internally to
a <code class="docutils literal notranslate"><span class="pre">BSON::Document</span></code> instance prior to being used for server selection.
Hash keys can be strings or symbols. The keys are case sensitive.
Hash values must be strings, and are matched exactly against the values
in the replica set configuration.</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Hash</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">:mode</span> <span class="pre">=&gt;</span> <span class="pre">:primary</span> <span class="pre">}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:read_concern</span></code></p></td>
<td><p>Specifies the read concern options. The only valid key is <code class="docutils literal notranslate"><span class="pre">level</span></code>,
for which the valid values are <code class="docutils literal notranslate"><span class="pre">:local</span></code>, <code class="docutils literal notranslate"><span class="pre">:majority</span></code>, and
<code class="docutils literal notranslate"><span class="pre">:snapshot</span></code>.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Hash</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:read_retry_interval</span></code></p></td>
<td><p>The interval, in seconds, in which reads on a mongos are retried.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Integer</span></code></p></td>
<td><p>5</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:replica_set</span></code></p></td>
<td><p>When connecting to a replica set, this is the name of the set to
filter servers by.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:retry_writes</span></code></p></td>
<td><p>If a single-statement write operation fails from a network error, the driver automatically retries it once
when connected to server versions 3.6+.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:sdam_proc</span></code></p></td>
<td><p>Since the client begins monitoring the deployment in background as
soon as it is constructed, constructing a client and then subscribing
to <a class="reference external" href="sdam">SDAM</a> events in a separate statement may result in the
subscriber not receiving some of the SDAM events. The <code class="docutils literal notranslate"><span class="pre">:sdam_proc</span></code>
option permits adding event subscribers on the client being constructed
before any SDAM events are published.</p>
<p>Pass a <code class="docutils literal notranslate"><span class="pre">Proc</span></code> which will be called with the <code class="docutils literal notranslate"><span class="pre">Client</span></code> as the argument
after the clientâ€™s event subscription mechanism has been initialized
but before any of the servers are added to the client. Use this
<code class="docutils literal notranslate"><span class="pre">Proc</span></code> to set up SDAM event subscribers on the client.</p>
<p>Note: the client is not fully constructed when the <code class="docutils literal notranslate"><span class="pre">Proc</span></code> provided in
<code class="docutils literal notranslate"><span class="pre">:sdam_proc</span> <span class="pre">is</span> <span class="pre">invoked,</span> <span class="pre">in</span> <span class="pre">particular</span> <span class="pre">the</span> <span class="pre">cluster</span> <span class="pre">is</span> <span class="pre">nil</span> <span class="pre">at</span> <span class="pre">this</span> <span class="pre">time.</span>
<span class="pre">``:sdam_proc</span></code> procedure should limit itself to calling
<code class="docutils literal notranslate"><span class="pre">Client#subscribe</span></code> and <code class="docutils literal notranslate"><span class="pre">Client#unsubscribe</span></code> methods on on the
passed client only.</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Proc</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:server_api</span></code></p></td>
<td><p>The server API version requested.
This is a hash with the following allowed items:
- <code class="docutils literal notranslate"><span class="pre">:version</span></code> (String)
- <code class="docutils literal notranslate"><span class="pre">:strict</span></code> (true or false)
- <code class="docutils literal notranslate"><span class="pre">:deprecation_errors</span></code> (true or false)</p>
<p>Note that the server API version can only be specified as a Ruby option,
not as a URI option, and it cannot be overridden for database and
collection objects.</p>
<p>If server API version is changed on a client (such as via the <code class="docutils literal notranslate"><span class="pre">with</span></code>
call), the entire API version hash is replaced with the new specification
(the old and the new individual fields are NOT merged).</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Hash</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:server_selection_timeout</span></code></p></td>
<td><p>The number of seconds to wait for an appropriate server to
be selected for an operation to be executed before raising an exception.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Float</span></code></p></td>
<td><p>30</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:socket_timeout</span></code></p></td>
<td><p>The number of seconds to wait for an operation to execute on a
socket before raising an exception. <code class="docutils literal notranslate"><span class="pre">nil</span></code> and <code class="docutils literal notranslate"><span class="pre">0</span></code> mean no timeout.
Client creation will fail with an error if an invalid timeout value
is passed (such as a negative value or a non-numeric value).</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Float</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:srv_max_hosts</span></code></p></td>
<td><p>The maximum number of mongoses that the driver will communicate with
for sharded topologies. If this option is set to 0, there will
be no maximum number of mongoses. If the given URI resolves
to more hosts than <code class="docutils literal notranslate"><span class="pre">:srv_max_hosts</span></code>, the client will ramdomly
choose an <code class="docutils literal notranslate"><span class="pre">:srv_max_hosts</span></code> sized subset of hosts. Note that the
hosts that the driver ignores during client construction will never
be used. If the hosts chosen by the driver become unavailable, the
client will quit working completely, even though the deployment has
other functional mongoses.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Integer</span></code></p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:srv_service_name</span></code></p></td>
<td><p>The service name to use in the SRV DNS query.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>mongodb</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl</span></code></p></td>
<td><p>Tell the client to connect to the servers via TLS.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p>false</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert</span></code></p></td>
<td><p>The file path containing concatenated certificate authority certificates
used to validate certs passed from the other end of the connection.
One of <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert</span></code>, <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_string</span></code> or <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_object</span></code>
(in order of priority) is required for <code class="docutils literal notranslate"><span class="pre">:ssl_verify</span></code>.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_object</span></code></p></td>
<td><p>An array of OpenSSL::X509::Certificate representing the certificate
authority certificates used to validate certs passed from the other end
of the connection. One of <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert</span></code>, <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_string</span></code> or
<code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_object</span></code> (in order of priority) is required for <code class="docutils literal notranslate"><span class="pre">:ssl_verify</span></code>.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;</span> <span class="pre">OpenSSL::X509::Certificate</span> <span class="pre">&gt;</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_string</span></code></p></td>
<td><p>A string containing concatenated certificate authority certificates
used to validate certs passed from the other end of the connection.
One of <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert</span></code>, <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_string</span></code> or <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_object</span></code>
(in order of priority) is required for <code class="docutils literal notranslate"><span class="pre">:ssl_verify</span></code>.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_cert</span></code></p></td>
<td><p>Path to the client certificate file used to identify the application to
the MongoDB servers. The file may also contain the certificateâ€™s private
key; if so, the private key is ignored by this option. The file may
also contain intermediate certificates forming the certificate chain
from the client certificate to the CA certificate; any intermediate
certificates will be parsed by the driver and provided to the OpenSSL
context in <code class="docutils literal notranslate"><span class="pre">extra_chain_cert</span></code> attribute. If intermediate certificates
are provided, they must follow the client certificate which must be
the first certificate in the file.</p>
<p>This option, if present, takes precedence over <code class="docutils literal notranslate"><span class="pre">:ssl_cert_string</span></code> and
<code class="docutils literal notranslate"><span class="pre">:ssl_cert_object</span></code> options.</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_cert_object</span></code></p></td>
<td><p>The OpenSSL::X509::Certificate used to identify the application to
the MongoDB servers. Only one certificate may be passed through this
option.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">OpenSSL::X509::Certificate</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_cert_string</span></code></p></td>
<td><p>A string containing the PEM-encoded certificate used to identify the
application to the MongoDB servers. The string may also contain the
certificateâ€™s private key; if so, the private key is ignored by this
option. The string may also contain intermediate certificates forming
the certificate chain from the client certificate to the CA certificate;
any intermediate certificates will be parsed by the driver and provided
to the OpenSSL context in <code class="docutils literal notranslate"><span class="pre">extra_chain_cert</span></code> attribute. If intermediate
certificates are provided, they must follow the client certificate which
must be the first certificatet in the string.</p>
<p>This option, if present, takes precedence over the <code class="docutils literal notranslate"><span class="pre">:ssl_cert_object</span></code>
option.</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_key</span></code></p></td>
<td><p>The private keyfile used to identify the connection against MongoDB. Note that even if the key is stored in
the same file as the certificate, both need to be explicitly specified. This option, if present, takes
precedence over the values of :ssl_key_string and :ssl_key_object.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_key_object</span></code></p></td>
<td><p>The private key used to identify the connection against MongoDB.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">OpenSSL::PKey</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_key_pass_phrase</span></code></p></td>
<td><p>A passphrase for the private key.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_key_string</span></code></p></td>
<td><p>A string containing the PEM-encoded private key used to identify the
connection against MongoDB. This parameter, if present, takes precedence
over the value of option :ssl_key_object.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_verify</span></code></p></td>
<td><p>Whether to perform peer certificate, hostname and OCSP endpoint
validation. Note that the decision of whether to validate certificates
will be overridden if <code class="docutils literal notranslate"><span class="pre">:ssl_verify_certificate</span></code> is set, the decision
of whether to validate hostnames will be overridden if
<code class="docutils literal notranslate"><span class="pre">:ssl_verify_hostname</span></code> is set and the decision of whether to validate
OCSP endpoint will be overridden if <code class="docutils literal notranslate"><span class="pre">:ssl_verify_ocsp_endpoint</span></code> is set.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_verify_certificate</span></code></p></td>
<td><p>Whether to perform peer certificate validation. This setting overrides
the <code class="docutils literal notranslate"><span class="pre">:ssl_verify</span></code> setting with respect to whether certificate
validation is performed.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_verify_hostname</span></code></p></td>
<td><p>Whether to perform peer hostname validation. This setting overrides
the <code class="docutils literal notranslate"><span class="pre">:ssl_verify</span></code> setting with respect to whether hostname validation
is performed.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:ssl_verify_ocsp_endpoint</span></code></p></td>
<td><p>Whether to validate server-supplied certificate against the OCSP
endpoint specified in the certificate, if the OCSP endpoint is specified
in the certificate. This setting overrides :ssl_verify with respect to
whether OCSP endpoint validation is performed.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:truncate_logs</span></code></p></td>
<td><p>Whether to truncate the logs at the default 250 characters.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Boolean</span></code></p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:user</span></code></p></td>
<td><p>The name of the user to authenticate with.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">String</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:wait_queue_timeout</span></code></p></td>
<td><p>The number of seconds to wait for a connection in the connection
pool to become available.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Float</span></code></p></td>
<td><p>10</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:wrapping_libraries</span></code></p></td>
<td><p>Information about libraries such as ODMs that are wrapping the driver.
Specify the lower level libraries first. Allowed hash keys: :name,
:version, :platform. Example: <code class="docutils literal notranslate"><span class="pre">[name:</span> <span class="pre">'Mongoid',</span> <span class="pre">version:</span> <span class="pre">'7.1.2']</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Array&lt;Hash&gt;</span></code></p></td>
<td><p>none</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:write</span></code></p></td>
<td><p>Deprecated. Equivalent to <code class="docutils literal notranslate"><span class="pre">:write_concern</span></code> option. If both <code class="docutils literal notranslate"><span class="pre">:write</span></code>
and <code class="docutils literal notranslate"><span class="pre">:write_concern</span></code> are specified, their values must be identical.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Hash</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">w:</span> <span class="pre">1</span> <span class="pre">}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">:write_concern</span></code></p></td>
<td><p>Specifies write concern options as a <code class="docutils literal notranslate"><span class="pre">Hash</span></code>.
Keys in the hash can be <code class="docutils literal notranslate"><span class="pre">:w</span></code>, <code class="docutils literal notranslate"><span class="pre">:wtimeout</span></code>, <code class="docutils literal notranslate"><span class="pre">:j</span></code>, <code class="docutils literal notranslate"><span class="pre">:fsync</span></code>.
Note that <code class="docutils literal notranslate"><span class="pre">:wtimeout</span></code> is specified in milliseconds, not seconds.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="ss">write_concern</span><span class="p">:</span> <span class="p">{</span> <span class="ss">w</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Hash</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">w:</span> <span class="pre">1</span> <span class="pre">}</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">:zlib_compression_level</span></code></p></td>
<td><p>The Zlib compression level to use, if using compression. See Rubyâ€™s Zlib module for valid levels.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Integer</span></code></p></td>
<td><p>none</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Ruby driver does not implement certificate revocation list (CRL)
checking.</p>
</div>
</section>
<section id="uri-options">
<h3>URI Options<a class="headerlink" href="#uri-options" title="Permalink to this headline">#</a></h3>
<p>Since the URI options are required to be in camel case, which is not the Ruby
standard, the following table shows URI options and their corresponding Ruby
options.</p>
<p>URI options are explained in detail in the <a href="#id19"><span class="problematic" id="id20">:manual:`Connection URI reference
&lt;/reference/connection-string/&gt;`</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Options that are set in <strong>milliseconds</strong> in the URI are
represented as a <code class="docutils literal notranslate"><span class="pre">float</span></code> in Ruby and the units are <strong>seconds</strong>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Ruby driver only fails connections when it receives a definitive signed
response indicating that the serverâ€™s certificate has been revoked.
Because of this, the driver does not recognize the
<code class="docutils literal notranslate"><span class="pre">tlsDisableCertificateRevocationCheck</span></code> URI option. If this option is
provided in a URI, it will be ignored.</p>
</div>
</section>
</section>
<section id="timeout-options">
<h2>Timeout Options<a class="headerlink" href="#timeout-options" title="Permalink to this headline">#</a></h2>
<section id="server-selection-timeout">
<h3><code class="docutils literal notranslate"><span class="pre">server_selection_timeout</span></code><a class="headerlink" href="#server-selection-timeout" title="Permalink to this headline">#</a></h3>
<p>When executing an operation, the number of seconds to wait for the driver
to find an appropriate server to send an operation to. Defaults to 30.</p>
<p>A value of 0 means no timeout.</p>
<p>When an invalid value (e.g. a negative value or a non-numeric value) is passed
via the URI option, the invalid input is ignored with a warning. When an
invalid value is passed directly to Client via a Ruby option, Client
construction fails with an error.</p>
<p>In replica set deployments, this timeout should be set to exceed the typical
<a href="#id21"><span class="problematic" id="id22">:manual:`replica set election times &lt;/core/replica-set-elections/&gt;`</span></a>
in order for the driver to transparently handle primary changes. This timeout
also allows the application and the database to be started simultaneously;
the application will wait up to this much time for the database to become
available.</p>
<p>If the application server is behind a reverse proxy, server selection timeout
should be lower than the request timeout configured on the reverse proxy (for
example, this applies to deployments on Heroku which has a fixed 30 second
timeout in the routing layer). In development this value can be lowered to
provide quicker failure when the server is not running.</p>
</section>
<section id="socket-timeout">
<h3><code class="docutils literal notranslate"><span class="pre">socket_timeout</span></code><a class="headerlink" href="#socket-timeout" title="Permalink to this headline">#</a></h3>
<p>The number of seconds to wait for a socket read or write to complete on
regular (non-monitoring) connections. Default is no timeout.</p>
<p>A value of 0 means no timeout.</p>
<p>When an invalid value (e.g. a negative value or a non-numeric value) is passed
via the URI option, the invalid input is ignored with a warning. When an
invalid value is passed directly to Client via a Ruby option, Client
construction fails with an error.</p>
<p>This timeout should take into account both network latency and operation
duration. For example, setting this timeout to 5 seconds will abort queries
taking more than 5 seconds to execute on the server with <code class="docutils literal notranslate"><span class="pre">Mongo::Error::SocketTimeoutError</span></code>.</p>
<p>Note that even though by default there is no socket timeout set, the
operating system may still time out read operations depending on its
configuration. The keepalive settings are intended to detect broken network
connections (as opposed to aborting operations simply because they take a
long time to execute).</p>
<p>Note that if an operation is timed out by the driver due to exceeding the
<code class="docutils literal notranslate"><span class="pre">socket_timeout</span></code> value, it is not aborted on the server. For this reason
it is recommended to use <code class="docutils literal notranslate"><span class="pre">max_time_ms</span></code> option for potentially long running
operations, as this will abort their execution on the server.</p>
<p>This option does not apply to monitoring connections.</p>
</section>
<section id="connect-timeout">
<h3><code class="docutils literal notranslate"><span class="pre">connect_timeout</span></code><a class="headerlink" href="#connect-timeout" title="Permalink to this headline">#</a></h3>
<p>The number of seconds to wait for a socket connection to be established to
a server. Defaults to 10.</p>
<p>This timeout is also used as both connect timeout and socket timeout for
monitoring connections.</p>
<p>When using a <code class="docutils literal notranslate"><span class="pre">mongodb+srv://</span></code> URI, this timeout is also used for SRV and TXT
DNS lookups. Note that the timeout applies per lookup; due to DNS suffix search
lists, multiple lookups may be performed as part of a single name resolution.</p>
<section id="wait-queue-timeout">
<h4><code class="docutils literal notranslate"><span class="pre">wait_queue_timeout</span></code><a class="headerlink" href="#wait-queue-timeout" title="Permalink to this headline">#</a></h4>
<p>The number of seconds to wait for a connection in the connection pool to
become available. Defaults to 10.</p>
<p>As of driver version 2.11, this timeout should be set to a value at least
as large as <code class="docutils literal notranslate"><span class="pre">connect_timeout</span></code> because connection pool now fully establishes
connections prior to returning them, which may require several network
round trips.</p>
</section>
</section>
<section id="max-time-ms">
<h3><code class="docutils literal notranslate"><span class="pre">max_time_ms</span></code><a class="headerlink" href="#max-time-ms" title="Permalink to this headline">#</a></h3>
<p>Specified as an option on a particular operation, the number of milliseconds
to allow the operation to execute for on the server. Not set by default.</p>
<p>Consider using this option instead of a <code class="docutils literal notranslate"><span class="pre">socket_timeout</span></code> for potentially
long running operations to be interrupted on the server when they take too
long.</p>
</section>
<section id="wtimeout">
<h3><code class="docutils literal notranslate"><span class="pre">wtimeout</span></code><a class="headerlink" href="#wtimeout" title="Permalink to this headline">#</a></h3>
<p>The number of milliseconds to wait for a write to be acknowledged by the
number of servers specified in the write concern. Not set by default, which
instructs the server to apply its default. This option can be set globally
on the client or passed to individual operations under <code class="docutils literal notranslate"><span class="pre">:write_concern</span></code>.</p>
</section>
</section>
<section id="tls-connections">
<h2>TLS Connections<a class="headerlink" href="#tls-connections" title="Permalink to this headline">#</a></h2>
<p>To connect to the MongoDB deployment using TLS:</p>
<ul class="simple">
<li><p>Enable TLS connections in <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code>.</p></li>
<li><p>Specify the client TLS certificate.</p></li>
<li><p>Specify the CA certificate to verify the serverâ€™s TLS certificate.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using JRuby, ECDSA certificates are not currently supported.</p>
</div>
<section id="tls-vs-ssl-option-names">
<h3>TLS vs SSL Option Names<a class="headerlink" href="#tls-vs-ssl-option-names" title="Permalink to this headline">#</a></h3>
<p>All MongoDB server versions supported by the Ruby driver (2.6 and higher)
only implement TLS. 2.6 and higher servers do not use SSL.</p>
<p>For historical reasons, the Ruby option names pertaining to TLS configuration
use the <code class="docutils literal notranslate"><span class="pre">ssl</span></code> rather than the <code class="docutils literal notranslate"><span class="pre">tls</span></code> prefix. The next major version of
the Ruby driver (3.0) will use the <code class="docutils literal notranslate"><span class="pre">tls</span></code> prefix for Ruby option names.</p>
<p>The URI option names use the <code class="docutils literal notranslate"><span class="pre">tls</span></code> prefix, with one exception: there is
a <code class="docutils literal notranslate"><span class="pre">ssl</span></code> URI option that is deprecated and equivalent to the <code class="docutils literal notranslate"><span class="pre">tls</span></code> URI
option.</p>
</section>
<section id="enable-tls-connections">
<h3>Enable TLS Connections<a class="headerlink" href="#enable-tls-connections" title="Permalink to this headline">#</a></h3>
<p>TLS must be explicitly requested on the client side when the deployment
requires TLS connections - there is currently no automatic detection of
whether the deployment requires TLS.</p>
<p>To request TLS connections, specify the following client options when
constructing a <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code>:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">:ssl</span></code> Ruby option.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">tls</span></code> URI option.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ssl</span></code> URI option (deprecated).</p></li>
</ul>
</section>
<section id="specify-client-tls-certificate">
<h3>Specify Client TLS Certificate<a class="headerlink" href="#specify-client-tls-certificate" title="Permalink to this headline">#</a></h3>
<p>By default, MongoDB server will attempt to verify the connecting clientsâ€™
TLS certificates, which requires the clients to specify their TLS certificates
when connecting. This can be accomplished via:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">:ssl_cert</span></code>/<code class="docutils literal notranslate"><span class="pre">:ssl_cert_object</span></code>/<code class="docutils literal notranslate"><span class="pre">:ssl_cert_string</span></code> and
<code class="docutils literal notranslate"><span class="pre">:ssl_key</span></code>/<code class="docutils literal notranslate"><span class="pre">:ssl_key_object</span></code>/<code class="docutils literal notranslate"><span class="pre">:ssl_key_string</span></code>/<code class="docutils literal notranslate"><span class="pre">:ssl_key_pass_phrase</span></code>
Ruby options.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">tlsCertificateKeyFile</span></code> URI option.</p></li>
</ul>
<p>When using the Ruby options, the client TLS certificate and the corresponding
private key may be provided separately. For example, if the certificate is
stored in <code class="docutils literal notranslate"><span class="pre">client.crt</span></code> and the private key is stored in <code class="docutils literal notranslate"><span class="pre">client.key</span></code>,
a <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code> may be constructed as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s2">&quot;localhost:27017&quot;</span><span class="o">]</span><span class="p">,</span>
  <span class="ss">ssl</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
  <span class="ss">ssl_cert</span><span class="p">:</span> <span class="s1">&#39;path/to/client.crt&#39;</span><span class="p">,</span>
  <span class="ss">ssl_key</span><span class="p">:</span> <span class="s1">&#39;path/to/client.key&#39;</span><span class="p">,</span>
  <span class="ss">ssl_ca_cert</span><span class="p">:</span> <span class="s1">&#39;path/to/ca.crt&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ssl_cert</span></code>, <code class="docutils literal notranslate"><span class="pre">ssl_cert_string</span></code>, <code class="docutils literal notranslate"><span class="pre">ssl_key</span></code> and <code class="docutils literal notranslate"><span class="pre">ssl_key_string</span></code> Ruby
options also permit the certificate and the key to be provided in the same
file or string, respectively. The files containing both certificate and
private key frequently have the <code class="docutils literal notranslate"><span class="pre">.pem</span></code> extension. When both certificate
and the private key are provided in the same file or string, both the
certifcate and the key options must be utilized, as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s2">&quot;localhost:27017&quot;</span><span class="o">]</span><span class="p">,</span>
  <span class="ss">ssl</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
  <span class="ss">ssl_cert</span><span class="p">:</span> <span class="s1">&#39;path/to/client.pem&#39;</span><span class="p">,</span>
  <span class="ss">ssl_key</span><span class="p">:</span> <span class="s1">&#39;path/to/client.pem&#39;</span><span class="p">,</span>
  <span class="ss">ssl_ca_cert</span><span class="p">:</span> <span class="s1">&#39;path/to/ca.crt&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>When using the URI option, the certificate and the key must be stored in a
file and both must be stored in the same file. Example usage:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="s2">&quot;mongodb://localhost:27017/?tls=true&amp;tlsCertificateKeyFile=path%2fto%2fclient.pem&amp;tlsCertificateKeyFile=path%2fto%2fca.crt&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>URI option values must be properly URI escaped. This applies, for example, to
slashes in the paths.</p>
</div>
</section>
<section id="modifying-sslcontext">
<span id="modifying-tls-context"></span><h3>Modifying <code class="docutils literal notranslate"><span class="pre">SSLContext</span></code><a class="headerlink" href="#modifying-sslcontext" title="Permalink to this headline">#</a></h3>
<p>It may be desirable to further configure TLS options in the driver, for example
by enabling or disabling certain ciphers. Currently, the Ruby driver does not
provide a way to do this when initializing a <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code>.</p>
<p>However, the Ruby driver provides a way to set global â€œTLS context hooksâ€ â€“
these are user-provided <code class="docutils literal notranslate"><span class="pre">Proc``s</span> <span class="pre">that</span> <span class="pre">will</span> <span class="pre">be</span> <span class="pre">invoked</span> <span class="pre">before</span> <span class="pre">any</span> <span class="pre">TLS</span> <span class="pre">socket</span>
<span class="pre">connection</span> <span class="pre">and</span> <span class="pre">can</span> <span class="pre">be</span> <span class="pre">used</span> <span class="pre">to</span> <span class="pre">modify</span> <span class="pre">the</span> <span class="pre">underlying</span> <span class="pre">``OpenSSL::SSL::SSLContext</span></code>
object used by the socket.</p>
<p>To set the TLS context hooks, add <code class="docutils literal notranslate"><span class="pre">Proc``s</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">``Mongo.tls_context_hooks</span></code>
array. This should be done before creating any Mongo::Client instances.
For example, in a Rails application this code could be placed in an initializer.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">.</span><span class="n">tls_context_hooks</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
  <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">context</span><span class="o">|</span>
    <span class="n">context</span><span class="o">.</span><span class="n">ciphers</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;AES256-SHA&quot;</span><span class="o">]</span>
  <span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Only the AES256-SHA cipher will be enabled from this point forward</span>
</pre></div>
</div>
<p>Every <code class="docutils literal notranslate"><span class="pre">Proc</span></code> in <code class="docutils literal notranslate"><span class="pre">Mongo.tls_context_hooks</span></code> will be passed an
<code class="docutils literal notranslate"><span class="pre">OpenSSL::SSL::SSLContext</span></code> object as its sole argument. These <code class="docutils literal notranslate"><span class="pre">Proc``s</span> <span class="pre">will</span>
<span class="pre">be</span> <span class="pre">executed</span> <span class="pre">sequentially</span> <span class="pre">during</span> <span class="pre">the</span> <span class="pre">creation</span> <span class="pre">of</span> <span class="pre">every</span> <span class="pre">``Mongo::Socket::SSL</span></code> object.</p>
<p>It is possible to assign the entire array of hooks calling <code class="docutils literal notranslate"><span class="pre">Mongo.tls_context_hooks=</span></code>,
but doing so will remove any previously assigned hooks. It is recommended to use
the <code class="docutils literal notranslate"><span class="pre">Array#push</span></code> or <code class="docutils literal notranslate"><span class="pre">Array#unshift</span></code> methods to add new hooks.</p>
<p>It is also possible to remove hooks from <code class="docutils literal notranslate"><span class="pre">Mongo.tls_context_hooks</span></code> by storing
a reference to the Procs somewhere else in the application, and then using
<code class="docutils literal notranslate"><span class="pre">Array#delete_if</span></code> to remove the desired hooks.</p>
<p>..warning</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TLS context hooks are global and will affect every instance of ``Mongo::Client``.
Any library that allows applications to enable these hooks should expose methods to
modify the hooks (which can be called by the application) rather than
automatically enabling the hooks when the library is loaded.
</pre></div>
</div>
<p>Further information on configuring MongoDB server for TLS is available in the
<a href="#id23"><span class="problematic" id="id24">:manual:`MongoDB manual &lt;/tutorial/configure-ssl/&gt;`</span></a>.</p>
<section id="using-intermediate-certificates">
<h4>Using Intermediate Certificates<a class="headerlink" href="#using-intermediate-certificates" title="Permalink to this headline">#</a></h4>
<p>It is possible to use certificate chains for both the client and the server
certificates. When using chains, the certificate authority parameter should
be configured to contain the trusted root certificates only; the intermediate
certificates, if any, should be provided in the server or client certificates
by concatenating them after the leaf server and client certificates, respectively.</p>
<p><code class="docutils literal notranslate"><span class="pre">:ssl_cert</span></code> and <code class="docutils literal notranslate"><span class="pre">:ssl_cert_string</span></code> Ruby options, as well as
<code class="docutils literal notranslate"><span class="pre">tlsCertificateKeyFile</span></code> URI option, support certificate chains.
<code class="docutils literal notranslate"><span class="pre">:ssl_cert_object</span></code> Ruby option, which takes an instance of
<code class="docutils literal notranslate"><span class="pre">OpenSSL::X509::Certificate</span></code>, does not support certificate chains.</p>
<p>The Ruby driver performs strict X.509 certificate verification, which requires
that both of the following fields are set in the intermediate certificate(s):</p>
<ul class="simple">
<li><p>X509v3 Basic Constraints: CA: TRUE â€“ Can sign certificates</p></li>
<li><p>X509v3 Key Usage: Key Cert Sign â€“ Can sign certificates</p></li>
</ul>
<p>More information about these flags can be found <a class="reference external" href="https://stackoverflow.com/questions/5795256/what-is-the-difference-between-the-x-509-v3-extensions-basic-constraints-and-key">in this Stack Overflow question</a>.</p>
<p>It is a common pitfall to concatenate intermediate certificates to the root
CA certificates passed in <code class="docutils literal notranslate"><span class="pre">tlsCAFile</span></code> / <code class="docutils literal notranslate"><span class="pre">ssl_ca_cert</span></code> options. By doing
so, the intermediate certificates are elevated to trusted status and are
themselves not verified against the actual CA root. More information on this
issue is available <a class="reference external" href="https://mail.python.org/pipermail/cryptography-dev/2016-August/000676.html">in this mailing list post</a>.</p>
</section>
</section>
<section id="specify-ca-certificate">
<h3>Specify CA Certificate<a class="headerlink" href="#specify-ca-certificate" title="Permalink to this headline">#</a></h3>
<p>The driver will attempt to verify the serverâ€™s TLS certificate by default, and
will abort the connection if this verification fails. By default, the driver
will use the default system root certificate store as the trust anchor.
To specify the CA certificate that the serverâ€™s certificate is signed with,
use:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert</span></code>/<code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_string</span></code>/<code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_object</span></code>
Ruby options</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">tlsCAFile</span></code> URI option.</p></li>
</ul>
<p>If any of these options are given, the serverâ€™s certificate will be verified
only against the specified CA certificate and the default system root
certificate store will not be used.</p>
<p>To not perform server TLS certificate verification, which is not
recommended, specify the <code class="docutils literal notranslate"><span class="pre">ssl_verify:</span> <span class="pre">false</span></code> Ruby option or the
<code class="docutils literal notranslate"><span class="pre">tlsInsecure=true</span></code> URI option.</p>
<section id="specifying-multiple-ca-certificates">
<h4>Specifying Multiple CA Certificates<a class="headerlink" href="#specifying-multiple-ca-certificates" title="Permalink to this headline">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert</span></code> Ruby option and <code class="docutils literal notranslate"><span class="pre">tlsCAFile</span></code> URI option can be used with
a file containing multiple certificates. All certificates thus referenced
will become trust anchors.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_object</span></code> option takes an array of certificates, and thus
can also be used to add multiple certificates as certificate authorities.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">:ssl_ca_cert_string</span></code> option supports specifying only one CA certificate.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Intermediate certificates must not be provided in files specified by the
CA certificate options. Doing so would elevate the intermediate certificates
to the status of root certificates, rather than verifying intermediate
certificates against the root certificates.</p>
<p>If intermediate certificates need to be used, specify them as part of the
client or server TLS certificate files.</p>
</div>
</section>
</section>
<section id="ocsp-verification">
<span id="id25"></span><h3>OCSP Verification<a class="headerlink" href="#ocsp-verification" title="Permalink to this headline">#</a></h3>
<p>If the certificate provided by the server contains an OCSP endpoint URI,
the driver will issue an OCSP request to the specified endpoint to verify the
validity of the certificate.</p>
<p>The OCSP endpoint check may be disabled by setting the
<code class="docutils literal notranslate"><span class="pre">:ssl_verify_ocsp_endpoint</span></code> Ruby option to <code class="docutils literal notranslate"><span class="pre">false</span></code> or by setting the
<code class="docutils literal notranslate"><span class="pre">tlsDisableOCSPEndpointCheck</span></code> URI option to <code class="docutils literal notranslate"><span class="pre">true</span></code> when creating a client.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>OCSP endpoint checking is not currently performed when running on JRuby,
since JRuby does not correctly expose the OCSP endpoint URI.</p>
</div>
</section>
</section>
<section id="ipv4-ipv6-connections">
<h2>IPv4/IPv6 Connections<a class="headerlink" href="#ipv4-ipv6-connections" title="Permalink to this headline">#</a></h2>
<p>When a client is constructed with <code class="docutils literal notranslate"><span class="pre">localhost</span></code> as the host name, it will
attempt an IPv4 connection only (i.e. if <code class="docutils literal notranslate"><span class="pre">localhost</span></code> resolves to
<code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code> and <code class="docutils literal notranslate"><span class="pre">::1</span></code>, the driver will only try to connect to
<code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code>).</p>
<p>When a client is constructed with hostnames other than <code class="docutils literal notranslate"><span class="pre">localhost</span></code>, it will
attempt both IPv4 and IPv6 connections depending on the addresses that the
hostnames resolve to. The driver respects the order in which <code class="docutils literal notranslate"><span class="pre">getaddrinfo</span></code>
returns the addresses, and will attempt to connect to them sequentially.
The first successful connection will be used.</p>
<p>The driver does not currently implement the Happy Eyeballs algorithm.</p>
</section>
<section id="tcp-keepalive-configuration">
<h2>TCP Keepalive Configuration<a class="headerlink" href="#tcp-keepalive-configuration" title="Permalink to this headline">#</a></h2>
<p>Where allowed by system configuration and the Ruby language runtime,
the driver enables TCP keepalive and, for each of the keepalive parameters
listed below, sets the value of the respective parameter to the specified
value if the system value can be determined and is higher than the
listed driver value:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tcp_keepalive_time</span></code>: 120 seconds</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tcp_keepalive_intvl</span></code>: 10 seconds</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tcp_keepalive_cnt</span></code>: 9 probes</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As of JRuby 9.2.14.0, JRuby does not implement the APIs required to
set the keepalive parameters. When using JRuby, the driver will not be
able to set the keepalive parameters and the system configuration will
be in effect.</p>
</div>
<p>To use lower values, or to change the parameters in environments like JRuby
that do not expose the required APIs, please adjust the parameters at the
system level as described in the <a class="reference external" href="https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.rst#serverselectiontimeoutms">MongoDB Diagnostics FAQ keepalive section</a>.</p>
</section>
<section id="connection-pooling">
<h2>Connection Pooling<a class="headerlink" href="#connection-pooling" title="Permalink to this headline">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code> instances have a connection pool per server that the client
is connected to. The pool creates connections on demand to support concurrent
MongoDB operations issued by the application. There is no thread-affinity
for connections.</p>
<p>The client instance opens one additional connection per known server
for monitoring the serverâ€™s state.</p>
<p>The size of each connection pool is capped at <code class="docutils literal notranslate"><span class="pre">max_pool_size</span></code>, which defaults
to 5. When a thread in the application begins an operation on MongoDB, it tries
to retrieve a connection from the pool to send that operation on. If there
are some connections available in the pool, it checks out a connection from
the pool and uses it for the operation. If there are no connections available
and the size of the pool is less than the <code class="docutils literal notranslate"><span class="pre">max_pool_size</span></code>, a new connection
will be created. If all connections are in use and the pool has reached its
maximum size, the thread waits for a connection to be returned to the pool by
another thread.</p>
<p>The number of seconds the thread will wait for a connection to become available
is configurable. This setting, called <code class="docutils literal notranslate"><span class="pre">wait_queue_timeout</span></code>, is defined in
seconds. If this timeout is reached, a <code class="docutils literal notranslate"><span class="pre">Timeout::Error</span></code> is raised. The
default is 1 second.</p>
<p>As of driver version 2.11, the driver eagerly creates connections up to
<code class="docutils literal notranslate"><span class="pre">min_pool_size</span></code> setting. Prior to driver version 2.11, the driver always
created connections on demand. In all versions of the driver, once a connection
is established, it will be kept in the pool by the driver as long as the pool
size does not exceed <code class="docutils literal notranslate"><span class="pre">min_pool_size</span></code>.</p>
<p>Note that, if <code class="docutils literal notranslate"><span class="pre">min_pool_size</span></code> is set to a value greater than zero, the
driver will establish that many connections to secondaries in replica set
deployments even if the application does not perform secondary reads. The
purpose of these connections is to provide faster failover when the primary
changes.</p>
<p>Here is an example of estimating the number of connections a multi-threaded
application will open: A client connected to a 3-node replica set opens 3
monitoring sockets. It also opens as many sockets as needed to support a
multi-threaded applicationâ€™s concurrent operations on each server, up to
<code class="docutils literal notranslate"><span class="pre">max_pool_size</span></code>. If the application only uses the primary (the default),
then only the primary connection pool grows and the total connections is at
most 8 (5 connections for the primary pool + 3 monitoring connections).
If the application uses a read preference to query the secondaries, their
pools also grow and the total connections can reach 18 (5 + 5 + 5 + 3).</p>
<p>The default configuration for a <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code> works for most applications:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s2">&quot;localhost:27017&quot;</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
<p>Create this client <strong>once</strong> for each process, and reuse it for all operations.
It is a common mistake to create a new client for each request, which is very
inefficient and not what the client was designed for.</p>
<p>To support extremely high numbers of concurrent MongoDB operations within one
process, increase <code class="docutils literal notranslate"><span class="pre">max_pool_size</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s2">&quot;localhost:27017&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">max_pool_size</span><span class="p">:</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
<p>Any number of threads are allowed to wait for connections to become available,
and they can wait the default (1 second) or the <code class="docutils literal notranslate"><span class="pre">wait_queue_timeout</span></code> setting:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s2">&quot;localhost:27017&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">wait_queue_timeout</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">#close</span></code> is called on a client by any thread, all connections are closed:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">close</span>
</pre></div>
</div>
<p>Note that when creating a client using the <a class="reference external" href="#block-syntax">block syntax</a> described above, the client is automatically closed after the block finishes executing.</p>
</section>
<section id="usage-with-forking-servers">
<span id="forking"></span><h2>Usage with Forking Servers<a class="headerlink" href="#usage-with-forking-servers" title="Permalink to this headline">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Applications using Mongoid should follow <a class="reference external" href="https://mongodb.com/docs/mongoid/current/tutorials/mongoid-configuration/#usage-with-forking-servers">Mongoidâ€™s forking guidance</a>.
The guidance and sample code below is provided for applications using the
Ruby driver directly.</p>
</div>
<p>When using the Mongo Ruby driver in a Web application with a forking web server
such as Unicorn, Puma or Passenger, or when the application otherwise forks,
each process should generally each have their own <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code> instances.
This is because:</p>
<ol class="arabic simple">
<li><p>The background threads remain in the parent process and are not transfered
to the child process.</p></li>
<li><p>File descriptors like network sockets are shared between parent and
child processes.</p></li>
</ol>
<p>The driver attempts to detect client use from forked processes and
reestablish network connections when such use is detected, alleviating
the issue of file descriptor sharing.</p>
<p>If both parent and child processes need to perform MongoDB operations,
it is recommended for each of the processes to create their own
<code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code> instances. Specifically, the child process should create
its own client instance and not use any of the instances that were created
in the parent.</p>
<p>If the parent continues to perform MongoDB operations using an already
established client instance after forking children, this client instance will
continue to operate normally as long as no child uses it in any way.
The child processes will not inherit any of the monitoring threads, and
will not perform background operations on the client instance.</p>
<p>If the parent does not need to perform MongoDB operation after forking
children (which is what typically happens in web applications), the parent
should close all of the client instances it created to free up connections
and cease background monitoring:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">reconnect</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the parent process performs operations on the Mongo client and does not
close it, the parent process will continue consuming a connection slot
in the cluster and will continue monitoring the cluster for as long as the
parent remains alive.</p>
</div>
<section id="reconnecting-client-instances">
<h3>Reconnecting Client Instances<a class="headerlink" href="#reconnecting-client-instances" title="Permalink to this headline">#</a></h3>
<p>When the Ruby driver is used in a web application, it is recommended to not
create any <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code> instances in the management processes (prior to
the workers being forked), and instead only create client instances in the
workers.</p>
<p>It is possible, although not recommended, to use the same <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code>
instances in parent and child processes. In order to do so, the instance
must be closed and reconnected in the child process so that the background
threads can be recreated:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">close</span>
<span class="n">client</span><span class="o">.</span><span class="n">reconnect</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This pattern should be used with Ruby driver version 2.6.2 or higher.
Previous driver versions did not recreate monitoring threads when
reconnecting.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When closing and reconnecting the client instance in the child,
due to file descriptor sharing, the parent process may experience network
and monitoring errors.</p>
</div>
<p>Web servers generally provide hooks that can be used by applications to
perform actions when the worker processes are forked. The recommended hooks
to use are:</p>
<ul class="simple">
<li><p>For <a class="reference external" href="https://puma.io/puma/">Puma</a>, <code class="docutils literal notranslate"><span class="pre">before_fork</span></code> to close clients in the
parent process and <code class="docutils literal notranslate"><span class="pre">on_worker_boot</span></code> to reconnect in the child processes.</p></li>
<li><p>For <a class="reference external" href="https://yhbt.net/unicorn/Unicorn/Configurator.html">Unicorn</a>,
<code class="docutils literal notranslate"><span class="pre">before_fork</span></code> to close clients in the parent process and
<code class="docutils literal notranslate"><span class="pre">after_fork</span></code> to reconnect clients in the child processes.</p></li>
<li><p>For <a class="reference external" href="https://www.phusionpassenger.com/library/indepth/ruby/spawn_methods/#unintentional-file-descriptor-sharing">Passenger</a>,
<code class="docutils literal notranslate"><span class="pre">starting_worker_process</span></code> to reconnect clients in the child processes
(Passenger does not appear to have a pre-fork hook).</p></li>
</ul>
<p>This documentation does not provide example code for using the aforementioned
hooks, because there is no standard for client instance management when
using the Ruby driver directly. <a class="reference external" href="https://mongodb.com/docs/mongoid/current/tutorials/mongoid-configuration/#usage-with-forking-servers">Mongoid documentation</a>
however provides examples for closing clients in the parent process and
reconnecting clients in the child processes.</p>
</section>
<section id="troubleshooting">
<h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">#</a></h3>
<p>The clientâ€™s <code class="docutils literal notranslate"><span class="pre">summary</span></code> method returns the current state of the client,
including servers that the client is monitoring and their state. If any of
the servers are not being monitored, this is indicated by the <code class="docutils literal notranslate"><span class="pre">NO-MONITORING</span></code>
flag.</p>
<p>A normally operating client will produce a summary similar to the following:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">summary</span>
<span class="o">=&gt;</span> <span class="s2">&quot;#&lt;Client cluster=#&lt;Cluster</span>
<span class="s2">  topology=ReplicaSetWithPrimary[localhost:14420,localhost:14421,localhost:14422,localhost:14423,name=ruby-driver-rs,v=1,e=7fffffff000000000000001f]</span>
<span class="s2">  servers=[#&lt;Server address=localhost:14420 PRIMARY replica_set=ruby-driver-rs pool=#&lt;ConnectionPool size=0 (0-5) used=0 avail=0 pending=0&gt;&gt;,</span>
<span class="s2">    #&lt;Server address=localhost:14421 SECONDARY replica_set=ruby-driver-rs pool=#&lt;ConnectionPool size=0 (0-5) used=0 avail=0 pending=0&gt;&gt;,</span>
<span class="s2">    #&lt;Server address=localhost:14422 SECONDARY replica_set=ruby-driver-rs pool=#&lt;ConnectionPool size=0 (0-5) used=0 avail=0 pending=0&gt;&gt;,</span>
<span class="s2">    #&lt;Server address=localhost:14423 ARBITER replica_set=ruby-driver-rs&gt;]&gt;&gt;&quot;</span>
</pre></div>
</div>
<p>A client that is missing background threads will produce a summary similar to
the following:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">summary</span>
<span class="o">=&gt;</span> <span class="s2">&quot;#&lt;Client cluster=#&lt;Cluster</span>
<span class="s2">  topology=ReplicaSetWithPrimary[localhost:14420,localhost:14421,localhost:14422,localhost:14423,name=ruby-driver-rs,v=1,e=7fffffff000000000000001f]</span>
<span class="s2">  servers=[#&lt;Server address=localhost:14420 PRIMARY replica_set=ruby-driver-rs NO-MONITORING pool=#&lt;ConnectionPool size=0 (0-5) used=0 avail=0 pending=0&gt;&gt;,</span>
<span class="s2">    #&lt;Server address=localhost:14421 SECONDARY replica_set=ruby-driver-rs NO-MONITORING pool=#&lt;ConnectionPool size=0 (0-5) used=0 avail=0 pending=0&gt;&gt;,</span>
<span class="s2">    #&lt;Server address=localhost:14422 SECONDARY replica_set=ruby-driver-rs NO-MONITORING pool=#&lt;ConnectionPool size=0 (0-5) used=0 avail=0 pending=0&gt;&gt;,</span>
<span class="s2">    #&lt;Server address=localhost:14423 ARBITER replica_set=ruby-driver-rs&gt;]&gt;&gt;&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="retryable-reads">
<h2>Retryable Reads<a class="headerlink" href="#retryable-reads" title="Permalink to this headline">#</a></h2>
<p>The driver implements two mechanisms for retrying reads: modern and legacy.
As of driver version 2.9.0, the modern mechanism is used by default, and the
legacy mechanism is deprecated.</p>
<section id="modern-retryable-reads">
<h3>Modern Retryable Reads<a class="headerlink" href="#modern-retryable-reads" title="Permalink to this headline">#</a></h3>
<p>When the modern mechanism is used, read operations are retried once in the
event of a network error, a â€œnot masterâ€ error, or a â€œnode is recoveringâ€ error.
The following operations are covered:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Collection.html#find-instance_method">Collection#find</a>
and related methods</p></li>
<li><p><a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Collection.html#aggregate-instance_method">Collection#aggregate</a></p></li>
<li><p><a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Collection.html#count-instance_method">Collection#count</a>,
<a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Collection.html#count_documents-instance_method">Collection#count_documents</a></p></li>
<li><p>Change stream helpers: <a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Collection.html#watch-instance_method">Collection#watch</a>,
<a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Database.html#watch-instance_method">Database#watch</a>,
<a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Client.html#watch-instance_method">Client#watch</a></p></li>
<li><p>Enumeration commands: <a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Client.html#list_mongo_databases-instance_method">Client#list_mongo_databases</a>,
<a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Client.html#list_databases-instance_method">Client#list_databases</a>,
<a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Client.html#database_names-instance_method">Client#database_names</a>,
<a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Database.html#collection_names-instance_method">Database#collection_names</a>,
<a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Database.html#collections-instance_method">Database#collections</a>,
<a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Database.html#list_collections-instance_method">Database#list_collections</a>,
<a class="reference external" href="http://api.mongodb.com/ruby/current/Mongo/Collection.html#indexes-instance_method">Collection#indexes</a></p></li>
</ul>
<p>When an operation returns a cursor, only the initial read command can be retried.
<code class="docutils literal notranslate"><span class="pre">getMore</span></code> operations on cursors are not retried by driver version 2.9.0 or
newer. Additionally, when a read operation is retried, a new server for the
operation is selected; this may result in the retry being sent to a different
server from the one which received the first read.</p>
<p>The behavior of modern retryable reads is covered in detail by the
<a class="reference external" href="https://github.com/mongodb/specifications/blob/master/source/retryable-reads/retryable-reads.rst">retryable reads specification</a>.</p>
<p>Note that the modern retryable reads can only be used with MongoDB 3.6 and
higher servers. When used with MongoDB 3.4 and lower servers, Ruby driver
version 2.9.0 and higher will not retry reads by default - the application
must explicitly request legacy retryable reads by setting the
<code class="docutils literal notranslate"><span class="pre">retry_reads:</span> <span class="pre">false</span></code> client option or using <code class="docutils literal notranslate"><span class="pre">retryReads=false</span></code> URI option.</p>
</section>
<section id="legacy-retryable-reads">
<h3>Legacy Retryable Reads<a class="headerlink" href="#legacy-retryable-reads" title="Permalink to this headline">#</a></h3>
<p>The legacy read retry behavior of the Ruby driver is available by setting the
<code class="docutils literal notranslate"><span class="pre">retry_reads:</span> <span class="pre">false</span></code> client option or passing the <code class="docutils literal notranslate"><span class="pre">retryReads=false</span></code> URI
option to the client.</p>
<p>When using legacy read retry behavior, the number of retries can be set
by specifying the <code class="docutils literal notranslate"><span class="pre">max_read_retries</span></code> client option. When using driver version
2.9.0 or higher, the set of operations which would be retried with legacy
retryable reads is identical to the one described above for modern retryable
reads. In older driver versions the behavior of legacy retryable writes was
different in that some of the operations were not retried.</p>
<p>As of driver version 2.9.0, legacy read retries perform server selection prior
to retrying the operation, as modern retriable writes do. In older driver
versions read retries would be sent to the same server which the initial read
was sent to.</p>
</section>
<section id="disabling-retryable-reads">
<h3>Disabling Retryable Reads<a class="headerlink" href="#disabling-retryable-reads" title="Permalink to this headline">#</a></h3>
<p>To disable all read retries, set the following client options:
<code class="docutils literal notranslate"><span class="pre">retry_reads:</span> <span class="pre">false,</span> <span class="pre">max_read_retries:</span> <span class="pre">0</span></code>.</p>
</section>
</section>
<section id="retryable-writes">
<h2>Retryable Writes<a class="headerlink" href="#retryable-writes" title="Permalink to this headline">#</a></h2>
<p>The driver implements two mechanisms for retrying writes: modern and legacy.
As of driver version 2.9.0, the modern mechanism is used by default on servers
that support it, and the legacy mechanism is deprecated and disabled by default
on all server versions.</p>
<p>The following write methods used in day-to-day operations on collections
are subject to write retries:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">collection#insert_one</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection#update_one</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection#delete_one</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection#replace_one</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection#find_one_and_update</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection#find_one_and_replace</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection#find_one_and_delete</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collection#bulk_write</span></code> (for all single statement ops, i.e. not for <code class="docutils literal notranslate"><span class="pre">update_many</span></code> or <code class="docutils literal notranslate"><span class="pre">delete_many</span></code>)</p></li>
</ul>
<section id="modern-retryable-writes">
<h3>Modern Retryable Writes<a class="headerlink" href="#modern-retryable-writes" title="Permalink to this headline">#</a></h3>
<p>The modern mechanism will retry failing writes once when the driver is
connected to a MongoDB 3.6 or higher replica set or a sharded cluster,
because they require an oplog on the serer. Modern mechanism will not retry
writes when the driver is connected to a standalone MongoDB server or
server versions 3.4 or older.</p>
<p>The following errors will cause writes to be retried:</p>
<ul class="simple">
<li><p>Network errors including timeouts</p></li>
<li><p>â€œnot masterâ€ errors</p></li>
<li><p>â€œnode is recoveringâ€ errors</p></li>
</ul>
<p>Prior to retrying the write the driver will perform server selection,
since the server that the original write was sent to is likely no longer
usable.</p>
</section>
<section id="legacy-retryable-writes">
<h3>Legacy Retryable Writes<a class="headerlink" href="#legacy-retryable-writes" title="Permalink to this headline">#</a></h3>
<p>If modern retryable writes mechanism is disabled by setting the client
option <code class="docutils literal notranslate"><span class="pre">retry_writes:</span> <span class="pre">false</span></code> or by using the <code class="docutils literal notranslate"><span class="pre">retryWrites=false</span></code>
URI option, the driver will utilize the legacy retryable writes mechanism.
The legacy mechanism retries writes on the same operations as the modern
mechanism. By default the legacy mechanism retries once, like the modern
mechanism does; to change the number of retries, set <code class="docutils literal notranslate"><span class="pre">:max_write_retries</span></code>
client option.</p>
<p>The difference between legacy and modern retry mechanisms is that the
legacy mechanism retries writes for a different set
of errors compared to the modern mechanism, and specifically does not
retry writes when a network timeout is encountered.</p>
</section>
<section id="disabling-retryable-writes">
<h3>Disabling Retryable Writes<a class="headerlink" href="#disabling-retryable-writes" title="Permalink to this headline">#</a></h3>
<p>To disable all write retries, set the following client options:
<code class="docutils literal notranslate"><span class="pre">retry_writes:</span> <span class="pre">false,</span> <span class="pre">max_write_retries:</span> <span class="pre">0</span></code>.</p>
</section>
</section>
<section id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">#</a></h2>
<p>You can either use the default global driver logger or set your own. To set your own:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Logger</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">other_logger</span>
</pre></div>
</div>
<p>See the <a class="reference external" href="http://ruby-doc.org/stdlib-2.2.0/libdoc/logger/rdoc/Logger.html">Ruby Logger documentation</a>
for more information on the default logger API and available levels.</p>
<section id="changing-the-logger-level">
<h3>Changing the Logger Level<a class="headerlink" href="#changing-the-logger-level" title="Permalink to this headline">#</a></h3>
<p>To change the logger level:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">::</span><span class="no">WARN</span>
</pre></div>
</div>
<p>For more control, a logger can be passed to a client for per-client control over logging.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">my_logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
<span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="ss">:logger</span> <span class="o">=&gt;</span> <span class="n">my_logger</span> <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="truncation">
<h3>Truncation<a class="headerlink" href="#truncation" title="Permalink to this headline">#</a></h3>
<p>The default logging truncates logs at 250 characters by default. To turn this off pass an
option to the client instance.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span> <span class="s1">&#39;127.0.0.1:27017&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="ss">:truncate_logs</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="compression">
<span id="id27"></span><h2>Compression<a class="headerlink" href="#compression" title="Permalink to this headline">#</a></h2>
<p>To use wire protocol compression, at least one compressor must be explicitly
requested using either the <code class="docutils literal notranslate"><span class="pre">:compressors</span></code> Ruby option or the <code class="docutils literal notranslate"><span class="pre">compressors</span></code>
URI option. If no compressors are explicitly requested, the driver will not
use compression, even if the required dependencies for one or more compressors
are present on the system.</p>
<p>The driver chooses the first compressor of the ones requested that is also
supported by the server. The driver currently supports <code class="docutils literal notranslate"><span class="pre">zstd</span></code>, <code class="docutils literal notranslate"><span class="pre">snappy</span></code> and
<code class="docutils literal notranslate"><span class="pre">zlib</span></code> compressors. <code class="docutils literal notranslate"><span class="pre">zstd</span></code> compressor is recommended as it produces
the highest compression at the same CPU consumption compared to the other
compressors. For maximum server compatibility all three compressors can be
specified, e.g. as <code class="docutils literal notranslate"><span class="pre">compressors:</span> <span class="pre">[&quot;zstd&quot;,</span> <span class="pre">&quot;snappy&quot;,</span> <span class="pre">&quot;zlib&quot;]</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">zstd</span></code> compressor requires the
<a class="reference external" href="https://rubygems.org/gems/zstd-ruby">zstd-ruby</a> library to be installed.
<code class="docutils literal notranslate"><span class="pre">snappy</span></code> compressor requires the
<a class="reference external" href="https://rubygems.org/gems/snappy">snappy</a> library to be installed.
If <code class="docutils literal notranslate"><span class="pre">zstd</span></code> or <code class="docutils literal notranslate"><span class="pre">snappy</span></code> compression is requested, and the respective
library is not loadable, the driver will raise an error during
<code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code> creation. <code class="docutils literal notranslate"><span class="pre">zlib</span></code> compression requires the <code class="docutils literal notranslate"><span class="pre">zlib</span></code>
standard library extension to be present.</p>
<p>The server support for various compressors is as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">zstd</span></code> requires and is enabled by default in MongoDB 4.2 or higher.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">snappy</span></code> requires MongoDB 3.4 or higher and is enabled by default in
MongoDB 3.6 or higher.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">zlib</span></code> requires MongoDB 3.6 or higher and is enabled by default in
MongoDB 4.2 and higher.</p></li>
</ul>
</section>
<section id="server-api-parameters">
<span id="id28"></span><h2>Server API Parameters<a class="headerlink" href="#server-api-parameters" title="Permalink to this headline">#</a></h2>
<p>Starting with MongoDB 5.0, applications can request that the server behaves
in accordance with a particular server API version.</p>
<p>Server API parameters can be specified via the <code class="docutils literal notranslate"><span class="pre">:server_api</span></code> option to
<code class="docutils literal notranslate"><span class="pre">Client</span></code>. These parameters cannot be provided via a URI.</p>
<p>Currently the only defined API version is <code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code>. It can be requested
as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;localhost&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">server_api</span><span class="p">:</span> <span class="p">{</span><span class="ss">version</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">})</span>
</pre></div>
</div>
<p>MongoDB server defines API versions as string values. For convenience, if the
API version is provided as an integer, the Ruby driver will stringify it and
send it to the server as a string:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;localhost&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">server_api</span><span class="p">:</span> <span class="p">{</span><span class="ss">version</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</pre></div>
</div>
<p>Note that the server may define API versions that are not stringified integers.
Applications must not assume that all legal API versions can be expressed
as integers.</p>
<p>When a particular API version is requested, operations which are part of that
API version behave as specified in that API version. Operations which are not
part of the specified API version behave as they would had the API version
not been specified at all. Operations whose behavior is subject to the
configured API version are commands including command arguments, queries,
aggregation pipeline stages and arguments.</p>
<p>Applications may request that the server rejects all operations which are not
part of the specified API version by setting the <code class="docutils literal notranslate"><span class="pre">:strict</span></code> option:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;localhost&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">server_api</span><span class="p">:</span> <span class="p">{</span><span class="ss">version</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="ss">strict</span><span class="p">:</span> <span class="kp">true</span><span class="p">})</span>
</pre></div>
</div>
<p>For example, since the <code class="docutils literal notranslate"><span class="pre">:tailable</span></code> option is not part of the server API
version 1, the following query would fail:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;localhost&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">server_api</span><span class="p">:</span> <span class="p">{</span><span class="ss">version</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="ss">strict</span><span class="p">:</span> <span class="kp">true</span><span class="p">})</span>
<span class="n">client</span><span class="o">[</span><span class="s1">&#39;collection&#39;</span><span class="o">].</span><span class="n">find</span><span class="p">({},</span> <span class="ss">tailable</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
<span class="c1"># =&gt; Mongo::Error::OperationFailure (BSON field &#39;FindCommand.tailable&#39; is not allowed with apiStrict:true. (323) (on localhost:27017, modern retry, attempt 1))</span>
</pre></div>
</div>
<p>Applications may request that the server rejects all operations which are
deprecated in the specified API version by setting the <code class="docutils literal notranslate"><span class="pre">:deprecation_errors</span></code>
option:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;localhost&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">server_api</span><span class="p">:</span> <span class="p">{</span><span class="ss">version</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="ss">deprecation_errors</span><span class="p">:</span> <span class="kp">true</span><span class="p">})</span>
</pre></div>
</div>
<p>Note that, as of this writing, there are no deprecated operations in API
version <code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code>.</p>
<p>If the server API parameters have been defined on a <code class="docutils literal notranslate"><span class="pre">Client</span></code> object,
they will be sent by the client as part of each <a class="footnote-reference brackets" href="#id30" id="id29">*</a> executed operation.</p>
<dl class="footnote brackets">
<dt class="label" id="id30"><span class="brackets"><a class="fn-backref" href="#id29">*</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">getMore</span></code> commands and commands in transactions do not accept
API parameters, thus the driver will not send them in these cases.</p>
</dd>
</dl>
<p>MongoDB servers prior to 5.0 do not recognize the API parameters, and will
produce a variety of errors should the application configure them.
The Ruby driver will send the API parameters to all MongoDB 3.6 and newer
servers, but the API parameters should only be configured when the application
is communicating with MongoDB 5.0 or newer servers. The API parameters
cannot be sent to MongoDB 3.4 and older servers that use the legacy wire
protocol; if an application configures the API parameters and connects to
MongoDB 3.4 or older servers, the driver will produce an error on every
operation.</p>
<p>The <a class="reference internal" href="database-tasks.html#arbitrary-commands"><span class="std std-ref">command helper</span></a> permits the application to
send manually constructed commands to the server. If the client is not
configured with server API parameters, the command helper may be used to
issue commands with API parameters:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">command</span><span class="p">(</span>
  <span class="ss">ping</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="ss">apiVersion</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
  <span class="ss">apiStrict</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
  <span class="ss">apiDeprecationErrors</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If the client is configured with server API parameters, the command helper
may not be used to issue commands with server API parameters. This includes the
case when the server API parameters provided to the client and to the
command helper are identical. If a client is constructed with server API
parameters, to send different API parameters (or none at all) a new client
must be constructed, either from scratch or using the <code class="docutils literal notranslate"><span class="pre">with</span></code> method.</p>
<p>The server API parameters may only be specified on the client level.
They may not be specified on the database, collection, session, transaction
or individual operation level.</p>
</section>
<section id="development-configuration">
<h2>Development Configuration<a class="headerlink" href="#development-configuration" title="Permalink to this headline">#</a></h2>
<p>Driverâ€™s default configuration is suitable for production deployment.
In development, some settings can be adjusted to provide a better developer
experience.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">:server_selection_timeout</span></code>: set this to a low value (e.g., <code class="docutils literal notranslate"><span class="pre">1</span></code>)
if your MongoDB server is running locally and you start it manually. A low
server selection timeout will cause the driver to fail quickly when there is
no server running.</p></li>
</ul>
</section>
<section id="production-configuration">
<h2>Production Configuration<a class="headerlink" href="#production-configuration" title="Permalink to this headline">#</a></h2>
<p>Please consider the following when deploying an application using the Ruby
driver in production:</p>
<ul class="simple">
<li><p>As of driver version 2.11, the <code class="docutils literal notranslate"><span class="pre">:min_pool_size</span></code> client option is completely
respected - the driver will create that many connections to each server
identified as a standalone, primary or secondary. In previous driver versions
the driver created connections on demand. Applications using <code class="docutils literal notranslate"><span class="pre">:min_pool_size</span></code>
will see an increase in the number of idle connections to all servers as of
driver version 2.11, and especially to secondaries in replica set deployments
and to nodes in sharded clusters.</p></li>
<li><p>If the application is reverse proxied to by another web server or a load
balancer, <code class="docutils literal notranslate"><span class="pre">server_selection_timeout</span></code> should generally be set to a lower
value than the reverse proxyâ€™s read timeout. For exampe, <a class="reference external" href="https://devcenter.heroku.com/articles/request-timeout">Heroku request timeout</a> is 30 seconds and
is not configurable; if deploying a Ruby application using MongoDB to Heroku,
consider lowering server selection timeout to 20 or 15 seconds.</p></li>
</ul>
</section>
<section id="feature-flags">
<h2>Feature Flags<a class="headerlink" href="#feature-flags" title="Permalink to this headline">#</a></h2>
<p>The following is a list of feature flags that the Mongo Ruby Driver provides:</p>
<table class="colwidths-given table">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Flag</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">validate_update_replace</span></code></p></td>
<td><p>Validates that there are no atomic operators (those that start with $)
in the root of a replacement document, and that there are only atomic
operators at the root of an update document. If this feature flag is on,
an error will be raised on an invalid update or replacement document,
if not, a warning will be output to the logs. (default: false)</p></td>
</tr>
</tbody>
</table>
<p>These feature flags can be set directly on the <code class="docutils literal notranslate"><span class="pre">Mongo</span></code> module or using
the <code class="docutils literal notranslate"><span class="pre">options</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mongo</span><span class="o">.</span><span class="n">validate_update_replace</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">Mongo</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="n">validate_update_replace</span><span class="p">:</span> <span class="n">true</span> <span class="p">}</span>
</pre></div>
</div>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="connection-and-configuration.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Connection &amp; Configuration</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="authentication.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Authentication</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
      &copy; Copyright 2021, MongoDB.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Sessions &#8212; Ruby MongoDB Driver  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Transactions" href="transactions.html" />
    <link rel="prev" title="Change Streams" href="change-streams.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ruby MongoDB Driver  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../getting-started.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../installation.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="driver-compatibility.html">
     Driver Compatibility
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../support.html">
     Support
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorials.html">
   Tutorials
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/quick-start.html">
     Quick Start
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/common-errors.html">
     Common Errors
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="connection-and-configuration.html">
   Connection &amp; Configuration
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="create-client.html">
     Creating a Client
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="authentication.html">
     Authentication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="monitoring.html">
     Monitoring
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="user-management.html">
     User Management
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="working-with-data.html">
   Working With Data
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="crud-operations.html">
     CRUD Operations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="bulk-operations.html">
     Bulk Writes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="projection.html">
     Projection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="aggregation.html">
     Aggregation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="map-reduce.html">
     Map-Reduce
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="text-search.html">
     Text Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="geospatial-search.html">
     Geospatial Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="query-cache.html">
     Query Cache
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="gridfs.html">
     GridFS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="change-streams.html">
     Change Streams
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Sessions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="transactions.html">
     Transactions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="client-side-encryption.html">
     Client-Side Encryption
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="schema-operations.html">
   Schema Operations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="database-tasks.html">
     Databases
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="collection-tasks.html">
     Collections
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="indexing.html">
     Indexing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="collations.html">
     Collations
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://mongodb.com/docs/ruby-driver/master/api/">
   API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../release-notes.html">
   Release Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="additional-resources.html">
   Additional Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contribute.html">
   Contribute to the Driver
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/reference/sessions.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.txt</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-session-from-a-mongo-client">
   Creating a session from a
   <code class="docutils literal notranslate">
    <span class="pre">
     Mongo::Client
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-a-session">
   Using a session
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#alternative-way-to-create-a-session">
   Alternative way to create a session
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#unacknowledged-writes">
   Unacknowledged Writes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#causal-consistency">
   Causal Consistency
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#end-a-session">
   End a session
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Sessions</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-session-from-a-mongo-client">
   Creating a session from a
   <code class="docutils literal notranslate">
    <span class="pre">
     Mongo::Client
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-a-session">
   Using a session
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#alternative-way-to-create-a-session">
   Alternative way to create a session
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#unacknowledged-writes">
   Unacknowledged Writes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#causal-consistency">
   Causal Consistency
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#end-a-session">
   End a session
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="sessions">
<span id="id1"></span><h1>Sessions<a class="headerlink" href="#sessions" title="Permalink to this headline">#</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><p><a class="reference internal" href="#creating-a-session-from-a-mongo-client" id="id3">Creating a session from a <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code></a></p></li>
<li><p><a class="reference internal" href="#using-a-session" id="id4">Using a session</a></p></li>
<li><p><a class="reference internal" href="#alternative-way-to-create-a-session" id="id5">Alternative way to create a session</a></p></li>
<li><p><a class="reference internal" href="#unacknowledged-writes" id="id6">Unacknowledged Writes</a></p></li>
<li><p><a class="reference internal" href="#causal-consistency" id="id7">Causal Consistency</a></p></li>
<li><p><a class="reference internal" href="#end-a-session" id="id8">End a session</a></p></li>
</ul>
</div>
<p>Version 3.6 of the MongoDB server introduces the concept of logical sessions for clients.
A session is an abstract concept that represents a set of sequential operations executed
by an application that are related in some way. A session object can be created via a <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code>
and passed to operation methods that should be executed in the context of that session.</p>
<p>Please note that session objects are not thread safe. They must only be used by one thread at a time.</p>
<section id="creating-a-session-from-a-mongo-client">
<span id="create-session"></span><h2>Creating a session from a <code class="docutils literal notranslate"><span class="pre">Mongo::Client</span></code><a class="headerlink" href="#creating-a-session-from-a-mongo-client" title="Permalink to this headline">#</a></h2>
<p>A session can be created by calling the <code class="docutils literal notranslate"><span class="pre">start_session</span></code> method on a client and passing it a block:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">start_session</span> <span class="k">do</span> <span class="o">|</span><span class="n">session</span><span class="o">|</span>
  <span class="c1"># work with the session</span>
<span class="k">end</span>
</pre></div>
</div>
<p>When using the block form, the session will be automatically ended by the driver after the block finishes executing.</p>
<p>It is valid to call <code class="docutils literal notranslate"><span class="pre">start_session</span></code> with no options set. This will result in a
session that has no effect on the operations performed in the context of that session,
other than to include a session ID in commands sent to the server. Please see the API docs for all supported
session options.</p>
<p>An error will be thrown if the driver is connected to a deployment that does not support sessions and the
<code class="docutils literal notranslate"><span class="pre">start_session</span></code> method is called.</p>
<p>Note that server sessions are discarded server-side if not used for a certain period of time.
Be aware that if the application calls <code class="docutils literal notranslate"><span class="pre">#start_session</span></code> on a client and waits more than 1 minute to use
the session, it risks getting errors due to the session going stale before it is used.</p>
</section>
<section id="using-a-session">
<h2>Using a session<a class="headerlink" href="#using-a-session" title="Permalink to this headline">#</a></h2>
<p>A session object can be passed to most driver methods so that the operation can be executed in the
context of that session. Please see the API docs for which methods support a session argument.</p>
<p>Create a session and execute an insert, then a find using that session:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">start_session</span> <span class="k">do</span> <span class="o">|</span><span class="n">session</span><span class="o">|</span>
  <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">insert_one</span><span class="p">({</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;FKA Twigs&#39;</span> <span class="p">},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>
  <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">({</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;FKA Twigs&#39;</span> <span class="p">},</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="k">end</span>
</pre></div>
</div>
<p>If you like to call methods on a <code class="docutils literal notranslate"><span class="pre">Mongo::Collection::View</span></code> in the context of a particular session, you can create the
<code class="docutils literal notranslate"><span class="pre">Mongo::Collection::View</span></code> with the session and then call methods on it:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">start_session</span><span class="p">(</span><span class="ss">causal_consistency</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">session</span><span class="o">|</span>
  <span class="n">view</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">({</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;FKA Twigs&#39;</span> <span class="p">},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>
  <span class="n">view</span><span class="o">.</span><span class="n">count</span> <span class="c1"># will use the session</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You can also pass the session option to the methods directly. This session will override any session associated with
the <code class="docutils literal notranslate"><span class="pre">Mongo::Collection::View</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">start_session</span> <span class="k">do</span> <span class="o">|</span><span class="n">session</span><span class="o">|</span>
  <span class="n">client</span><span class="o">.</span><span class="n">start_session</span> <span class="k">do</span> <span class="o">|</span><span class="n">second_session</span><span class="o">|</span>
    <span class="n">view</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">({</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;FKA Twigs&#39;</span> <span class="p">},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="ss">session</span><span class="p">:</span> <span class="n">second_session</span><span class="p">)</span> <span class="c1"># will use the second_session</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="alternative-way-to-create-a-session">
<h2>Alternative way to create a session<a class="headerlink" href="#alternative-way-to-create-a-session" title="Permalink to this headline">#</a></h2>
<p>A session can be created by calling the <code class="docutils literal notranslate"><span class="pre">start_session</span></code> method on a client:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span>
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">start_session</span></code> is used without passing a block to it, the driver does not automatically clean up the session which can result in an accumulation of sessions on the server. Use <a class="reference external" href="#end-a-session">end_session</a> to manually end the session created. The server will automatically clean up old sessions after a timeout but the application should end sessions when the sessions are no longer needed.</p>
</section>
<section id="unacknowledged-writes">
<h2>Unacknowledged Writes<a class="headerlink" href="#unacknowledged-writes" title="Permalink to this headline">#</a></h2>
<p>Unacknowledged writes are only allowed outside the session mechanism; if an explicit session is supplied for an
unacknowledged write, the driver will not send the session id with the operation. Similarly, the driver will not use
an implicit session for an unacknowledged write.</p>
</section>
<section id="causal-consistency">
<h2>Causal Consistency<a class="headerlink" href="#causal-consistency" title="Permalink to this headline">#</a></h2>
<p>A causally consistent session will let you read your writes and guarantee monotonically increasing
reads from secondaries.
To create a causally consistent session, set the <code class="docutils literal notranslate"><span class="pre">causal_consistency</span></code> option to true:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_session</span><span class="p">(</span><span class="ss">causal_consistency</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>

<span class="c1"># The update message goes to the primary.</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">]</span>
<span class="n">collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span> <span class="s1">&#39;_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="s1">&#39;$set&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;x&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>

<span class="c1"># Read your write, even when reading from a secondary!</span>
<span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span> <span class="s1">&#39;_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>

<span class="c1"># This query returns data at least as new as the previous query,</span>
<span class="c1"># even if it chooses a different secondary.</span>
<span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span> <span class="s1">&#39;_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="p">},</span> <span class="ss">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</pre></div>
</div>
<p>Since unacknowledged writes don’t receive a response from the server (or don’t wait for a response), the driver
has no way of keeping track of where the unacknowledged write is in logical time. Therefore, causally
consistent reads are not causally consistent with unacknowledged writes.</p>
<p>Note that if you set the causal_consistency option to nil as in <code class="docutils literal notranslate"><span class="pre">(causal_consistency:</span> <span class="pre">nil)</span></code>, it will be interpreted
as false.</p>
</section>
<section id="end-a-session">
<span id="id2"></span><h2>End a session<a class="headerlink" href="#end-a-session" title="Permalink to this headline">#</a></h2>
<p>To end a session, call the <code class="docutils literal notranslate"><span class="pre">end_session</span></code> method:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">end_session</span>
</pre></div>
</div>
<p>The Ruby driver will then add the id for the corresponding server session to a pool for reuse.
When a client is closed, the driver will send a command to the server to end all sessions it has cached
in its server session pool. You may see this command in your logs when a client is closed.</p>
<p>Note that when using the <a class="reference external" href="#creating-a-session-from-a-mongo-client">block syntax</a> for <code class="docutils literal notranslate"><span class="pre">start_session</span></code> the session is automatically ended after
the block finishes executing.</p>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="change-streams.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Change Streams</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="transactions.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Transactions</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
      &copy; Copyright 2021, MongoDB.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Mongo::Retryable
  
    &mdash; mongo-2.12.0.rc0
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Mongo::Retryable";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (R)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span>
     &raquo; 
    <span class="title">Retryable</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Mongo::Retryable
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  
  <dl>
    <dt>Included in:</dt>
    <dd><span class='object_link'><a href="Cluster/CursorReaper.html" title="Mongo::Cluster::CursorReaper (class)">Cluster::CursorReaper</a></span>, <span class='object_link'><a href="Collection.html" title="Mongo::Collection (class)">Collection</a></span>, <span class='object_link'><a href="Collection/View/Aggregation.html" title="Mongo::Collection::View::Aggregation (class)">Collection::View::Aggregation</a></span>, <span class='object_link'><a href="Collection/View/MapReduce.html" title="Mongo::Collection::View::MapReduce (class)">Collection::View::MapReduce</a></span>, <span class='object_link'><a href="Cursor.html" title="Mongo::Cursor (class)">Cursor</a></span>, <span class='object_link'><a href="Database.html" title="Mongo::Database (class)">Database</a></span>, <span class='object_link'><a href="Database/View.html" title="Mongo::Database::View (class)">Database::View</a></span>, <span class='object_link'><a href="Index/View.html" title="Mongo::Index::View (class)">Index::View</a></span>, <span class='object_link'><a href="Server/Connection.html" title="Mongo::Server::Connection (class)">Server::Connection</a></span>, <span class='object_link'><a href="Server/Monitor/Connection.html" title="Mongo::Server::Monitor::Connection (class)">Server::Monitor::Connection</a></span>, <span class='object_link'><a href="Session.html" title="Mongo::Session (class)">Session</a></span></dd>
  </dl>
  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/mongo/retryable.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Defines basic behavior around retrying operations.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.1.0</p>
</div>
      
    </li>
  
</ul>

</div>






  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#legacy_write_with_retry-instance_method" title="#legacy_write_with_retry (instance method)">#<strong>legacy_write_with_retry</strong>(server = nil, session = nil) {|server| ... } &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Implements legacy write retrying functionality by yielding to the passed block one or more times.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#nro_write_with_retry-instance_method" title="#nro_write_with_retry (instance method)">#<strong>nro_write_with_retry</strong>(session, write_concern) {|server| ... } &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Retryable writes wrapper for operations not supporting modern retryable writes.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#read_with_one_retry-instance_method" title="#read_with_one_retry (instance method)">#<strong>read_with_one_retry</strong>(options = nil) { ... } &#x21d2; Result </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Execute a read operation with a single retry on network errors.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#read_with_retry-instance_method" title="#read_with_retry (instance method)">#<strong>read_with_retry</strong>(session = nil, server_selector = nil, &amp;block)  &#x21d2; Result </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Execute a read operation with retrying.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#read_with_retry_cursor-instance_method" title="#read_with_retry_cursor (instance method)">#<strong>read_with_retry_cursor</strong>(session, server_selector, view, &amp;block)  &#x21d2; Cursor </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Execute a read operation returning a cursor with retrying.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#write_with_retry-instance_method" title="#write_with_retry (instance method)">#<strong>write_with_retry</strong>(session, write_concern, ending_transaction = false, &amp;block) {|server, txn_num| ... } &#x21d2; Result </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Implements write retrying functionality by yielding to the passed block one or more times.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="legacy_write_with_retry-instance_method">
  
    #<strong>legacy_write_with_retry</strong>(server = nil, session = nil) {|server| ... } &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Implements legacy write retrying functionality by yielding to the passed block one or more times.</p>

<p>This method is used for operations which are not supported by modern retryable writes, such as delete_many and update_many.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>server</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Server.html" title="Mongo::Server (class)">Server</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The server which should be used for the operation. If not provided, the current primary will be retrieved from the cluster.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>session</span>
      
      
        <span class='type'>(<tt>nil | <span class='object_link'><a href="Session.html" title="Mongo::Session (class)">Session</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Optional session to use with the operation.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Yield Parameters:</p>
<ul class="yieldparam">
  
    <li>
      
        <span class='name'>server</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Server.html" title="Mongo::Server (class)">Server</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The server to which the write should be sent.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.1.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/retryable.rb', line 285</span>

<span class='kw'>def</span> <span class='id identifier rubyid_legacy_write_with_retry'>legacy_write_with_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># This is the pre-session retry logic, and is not subject to
</span>  <span class='comment'># current retryable write specifications.
</span>  <span class='comment'># In particular it does not retry on SocketError and SocketTimeoutError.
</span>  <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='id identifier rubyid_server'>server</span> <span class='op'>||=</span> <span class='id identifier rubyid_select_server'>select_server</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span></span><span class='period'>.</span><span class='id identifier rubyid_primary'><span class='object_link'><a href="ServerSelector.html#primary-instance_method" title="Mongo::ServerSelector#primary (method)">primary</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='rparen'>)</span>
    <span class='kw'>yield</span> <span class='id identifier rubyid_server'>server</span>
  <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_add_note'>add_note</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>legacy retry</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_add_note'>add_note</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attempt </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_attempt'>attempt</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_attempt'>attempt</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_max_write_retries'>max_write_retries</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_write_retryable?'>write_retryable?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_in_transaction?'>in_transaction?</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_log_retry'>log_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Legacy write retry</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_scan!'>scan!</span><span class='lparen'>(</span><span class='kw'>false</span><span class='rparen'>)</span>
      <span class='kw'>retry</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="nro_write_with_retry-instance_method">
  
    #<strong>nro_write_with_retry</strong>(session, write_concern) {|server| ... } &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Retryable writes wrapper for operations not supporting modern retryable writes.</p>

<p>If the driver is configured to use modern retryable writes, this method yields to the passed block exactly once, thus not retrying any writes.</p>

<p>If the driver is configured to use legacy retryable writes, this method delegates to legacy_write_with_retry which performs write retries using legacy logic.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>session</span>
      
      
        <span class='type'>(<tt>nil | <span class='object_link'><a href="Session.html" title="Mongo::Session (class)">Session</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Optional session to use with the operation.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>write_concern</span>
      
      
        <span class='type'>(<tt>nil | Hash | <span class='object_link'><a href="WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">WriteConcern::Base</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The write concern.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Yield Parameters:</p>
<ul class="yieldparam">
  
    <li>
      
        <span class='name'>server</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Server.html" title="Mongo::Server (class)">Server</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The server to which the write should be sent.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.1.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


257
258
259
260
261
262
263
264
265
266
267
268
269</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/retryable.rb', line 257</span>

<span class='kw'>def</span> <span class='id identifier rubyid_nro_write_with_retry'>nro_write_with_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_write_concern'>write_concern</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:retry_writes</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_select_server'>select_server</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span></span><span class='period'>.</span><span class='id identifier rubyid_primary'><span class='object_link'><a href="ServerSelector.html#primary-instance_method" title="Mongo::ServerSelector#primary (method)">primary</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='kw'>yield</span> <span class='id identifier rubyid_server'>server</span>
    <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_add_note'>add_note</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>retries disabled</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_legacy_write_with_retry'>legacy_write_with_retry</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="read_with_one_retry-instance_method">
  
    #<strong>read_with_one_retry</strong>(options = nil) { ... } &#x21d2; <tt>Result</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>This only retries read operations on socket errors.</p>
</div>
  </div>


<p>Execute a read operation with a single retry on network errors.</p>

<p>This method is used by the driver for some of the internal housekeeping operations. Application-requested reads should use read_with_retry rather than this method.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Execute the read.</p>
</div></p>
      
      <pre class="example code"><code>read_with_one_retry do
  ...
end</code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Options.</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <p class="tag_title">Options Hash (<tt>options</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:retry_message</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Message to log when retrying.</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>Calls the provided block with no arguments</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Result</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The result of the operation.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.2.6</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


154
155
156
157
158
159
160</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/retryable.rb', line 154</span>

<span class='kw'>def</span> <span class='id identifier rubyid_read_with_one_retry'>read_with_one_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>yield</span>
<span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_retry_message'>retry_message</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:retry_message</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_log_retry'>log_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='id identifier rubyid_retry_message'>retry_message</span><span class='rparen'>)</span>
  <span class='kw'>yield</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="read_with_retry-instance_method">
  
    #<strong>read_with_retry</strong>(session = nil, server_selector = nil, &amp;block)  &#x21d2; <tt>Result</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Execute a read operation with retrying.</p>

<p>This method performs server selection for the specified server selector and yields to the provided block, which should execute the initial query operation and return its result. The block will be passed the server selected for the operation. If the block raises an exception, and this exception corresponds to a read retryable error, and read retries are enabled for the client, this method will perform server selection again and yield to the block again (with potentially a different server). If the block returns successfully, the result of the block is returned.</p>

<p>If modern retry reads are on (which is the default), the initial read operation will be retried once. If legacy retry reads are on, the initial read operation will be retried zero or more times depending on the :max_read_retries client setting, the default for which is 1. To disable read retries, turn off modern read retries by setting retry_reads: false and set :max_read_retries to 0 on the client.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Execute the read.</p>
</div></p>
      
      <pre class="example code"><code>read_with_retry(session, server_selector) do |server|
  ...
end</code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>session</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Session.html" title="Mongo::Session (class)">Mongo::Session</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The session that the operation is being run on.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>server_selector</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="ServerSelector/Selectable.html" title="Mongo::ServerSelector::Selectable (module)">Mongo::ServerSelector::Selectable</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Server selector for the operation.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>block</span>
      
      
        <span class='type'>(<tt>Proc</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The block to execute.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Result</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The result of the operation.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.1.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/retryable.rb', line 99</span>

<span class='kw'>def</span> <span class='id identifier rubyid_read_with_retry'>read_with_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>    <span class='comment'># Older versions of Mongoid call read_with_retry without arguments.
</span>    <span class='comment'># This is already not correct in a MongoDB 3.6+ environment with
</span>    <span class='comment'># sessions. For compatibility we emulate the legacy driver behavior
</span>    <span class='comment'># here but upgrading Mongoid is strongly recommended.
</span>
    <span class='kw'>unless</span> <span class='gvar'>$_mongo_read_with_retry_warned</span>
      <span class='gvar'>$_mongo_read_with_retry_warned</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='const'><span class='object_link'><a href="Logger.html" title="Mongo::Logger (class)">Logger</a></span></span><span class='period'>.</span><span class='id identifier rubyid_logger'><span class='object_link'><a href="Logger.html#logger-class_method" title="Mongo::Logger.logger (method)">logger</a></span></span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Legacy read_with_retry invocation - please update the application and/or its dependencies</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>    <span class='comment'># Since we don&#39;t have a session, we cannot use the modern read retries.
</span>    <span class='comment'># And we need to select a server but we don&#39;t have a server selector.
</span>    <span class='comment'># Use PrimaryPreferred which will work as long as there is a data
</span>    <span class='comment'># bearing node in the cluster; the block may select a different server
</span>    <span class='comment'># which is fine.
</span>
    <span class='id identifier rubyid_server_selector'>server_selector</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span></span><span class='period'>.</span><span class='id identifier rubyid_get'><span class='object_link'><a href="ServerSelector.html#get-instance_method" title="Mongo::ServerSelector#get (method)">get</a></span></span><span class='lparen'>(</span><span class='label'>mode:</span> <span class='symbol'>:primary_preferred</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_legacy_read_with_retry'>legacy_read_with_retry</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_retry_reads?'>retry_reads?</span>
    <span class='id identifier rubyid_modern_read_with_retry'>modern_read_with_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_max_read_retries'>max_read_retries</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='id identifier rubyid_legacy_read_with_retry'>legacy_read_with_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_select_server'>select_server</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='kw'>yield</span> <span class='id identifier rubyid_server'>server</span>
    <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_add_note'>add_note</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>retries disabled</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="read_with_retry_cursor-instance_method">
  
    #<strong>read_with_retry_cursor</strong>(session, server_selector, view, &amp;block)  &#x21d2; <tt><span class='object_link'><a href="Cursor.html" title="Mongo::Cursor (class)">Cursor</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Execute a read operation returning a cursor with retrying.</p>

<p>This method performs server selection for the specified server selector and yields to the provided block, which should execute the initial query operation and return its result. The block will be passed the server selected for the operation. If the block raises an exception, and this exception corresponds to a read retryable error, and read retries are enabled for the client, this method will perform server selection again and yield to the block again (with potentially a different server). If the block returns successfully, the result of the block (which should be a Mongo::Operation::Result) is used to construct a Mongo::Cursor object for the result set. The cursor is then returned.</p>

<p>If modern retry reads are on (which is the default), the initial read operation will be retried once. If legacy retry reads are on, the initial read operation will be retried zero or more times depending on the :max_read_retries client setting, the default for which is 1. To disable read retries, turn off modern read retries by setting retry_reads: false and set :max_read_retries to 0 on the client.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Execute a read returning a cursor.</p>
</div></p>
      
      <pre class="example code"><code>cursor = read_with_retry_cursor(session, server_selector, view) do |server|
  # return a Mongo::Operation::Result
  ...
end</code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>session</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Session.html" title="Mongo::Session (class)">Mongo::Session</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The session that the operation is being run on.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>server_selector</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="ServerSelector/Selectable.html" title="Mongo::ServerSelector::Selectable (module)">Mongo::ServerSelector::Selectable</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Server selector for the operation.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>view</span>
      
      
        <span class='type'>(<tt>CollectionView</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The <code>CollectionView</code> defining the query.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>block</span>
      
      
        <span class='type'>(<tt>Proc</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The block to execute.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Cursor.html" title="Mongo::Cursor (class)">Cursor</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The cursor for the result set.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.1.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


59
60
61
62
63
64</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/retryable.rb', line 59</span>

<span class='kw'>def</span> <span class='id identifier rubyid_read_with_retry_cursor'>read_with_retry_cursor</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='comma'>,</span> <span class='id identifier rubyid_view'>view</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_read_with_retry'>read_with_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_server_selector'>server_selector</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='kw'>yield</span> <span class='id identifier rubyid_server'>server</span>
    <span class='const'><span class='object_link'><a href="Cursor.html" title="Mongo::Cursor (class)">Cursor</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Cursor.html#initialize-instance_method" title="Mongo::Cursor#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_view'>view</span><span class='comma'>,</span> <span class='id identifier rubyid_result'>result</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="write_with_retry-instance_method">
  
    #<strong>write_with_retry</strong>(session, write_concern, ending_transaction = false, &amp;block) {|server, txn_num| ... } &#x21d2; <tt>Result</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>This only retries operations on not master failures, since it is the only case we can be sure a partial write did not already occur.</p>
</div>
  </div>


<p>Implements write retrying functionality by yielding to the passed block one or more times.</p>

<p>If the session is provided (hence, the deployment supports sessions), and modern retry writes are enabled on the client, the modern retry logic is invoked. Otherwise the legacy retry logic is invoked.</p>

<p>If ending_transaction parameter is true, indicating that a transaction is being committed or aborted, the operation is executed exactly once. Note that, since transactions require sessions, this method will raise ArgumentError if ending_transaction is true and session is nil.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Execute the write.</p>
</div></p>
      
      <pre class="example code"><code>write_with_retry do
  ...
end</code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>session</span>
      
      
        <span class='type'>(<tt>nil | <span class='object_link'><a href="Session.html" title="Mongo::Session (class)">Session</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Optional session to use with the operation.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>write_concern</span>
      
      
        <span class='type'>(<tt>nil | Hash | <span class='object_link'><a href="WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">WriteConcern::Base</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The write concern.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>ending_transaction</span>
      
      
        <span class='type'>(<tt>true | false</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>false</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>True if the write operation is abortTransaction or commitTransaction, false otherwise.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>block</span>
      
      
        <span class='type'>(<tt>Proc</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The block to execute.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Yield Parameters:</p>
<ul class="yieldparam">
  
    <li>
      
        <span class='name'>server</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Server.html" title="Mongo::Server (class)">Server</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The server to which the write should be sent.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>txn_num</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Transaction number (NOT the ACID kind).</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Result</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The result of the operation.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.1.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/retryable.rb', line 196</span>

<span class='kw'>def</span> <span class='id identifier rubyid_write_with_retry'>write_with_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_write_concern'>write_concern</span><span class='comma'>,</span> <span class='id identifier rubyid_ending_transaction'>ending_transaction</span> <span class='op'>=</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_ending_transaction'>ending_transaction</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_session'>session</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Cannot end a transaction without a session</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_ending_transaction'>ending_transaction</span> <span class='op'>||</span> <span class='id identifier rubyid_retry_write_allowed?'>retry_write_allowed?</span><span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_write_concern'>write_concern</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_legacy_write_with_retry'>legacy_write_with_retry</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># If we are here, session is not nil. A session being nil would have
</span>  <span class='comment'># failed retry_write_allowed? check.
</span>
  <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_select_server'>select_server</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span></span><span class='period'>.</span><span class='id identifier rubyid_primary'><span class='object_link'><a href="ServerSelector.html#primary-instance_method" title="Mongo::ServerSelector#primary (method)">primary</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='rparen'>)</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_ending_transaction'>ending_transaction</span> <span class='op'>||</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_retry_writes?'>retry_writes?</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_legacy_write_with_retry'>legacy_write_with_retry</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_txn_num'>txn_num</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
    <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_txn_num'>txn_num</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_next_txn_num'>next_txn_num</span>
  <span class='kw'>end</span>
  <span class='kw'>begin</span>
    <span class='kw'>yield</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SocketError.html" title="Mongo::Error::SocketError (class)">SocketError</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SocketTimeoutError.html" title="Mongo::Error::SocketTimeoutError (class)">SocketTimeoutError</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_add_note'>add_note</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>modern retry</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_add_note'>add_note</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attempt 1</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_in_transaction?'>in_transaction?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_ending_transaction'>ending_transaction</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_retry_write'>retry_write</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_add_note'>add_note</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>modern retry</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_add_note'>add_note</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attempt 1</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_unsupported_retryable_write?'>unsupported_retryable_write?</span>
      <span class='id identifier rubyid_raise_unsupported_error'>raise_unsupported_error</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_in_transaction?'>in_transaction?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_ending_transaction'>ending_transaction</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='op'>!</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_write_retryable?'>write_retryable?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_retry_write'>retry_write</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Thu Apr  9 22:11:18 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.24 (ruby-2.7.0).
</div>

    </div>
  </body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Mongo::Session
  
    &mdash; mongo-2.12.0.rc0
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Mongo::Session";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (S)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span>
     &raquo; 
    <span class="title">Session</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Mongo::Session
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Mongo::Session</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  <dl>
      <dt>Extended by:</dt>
      <dd>Forwardable</dd>
  </dl>
  
  
  
  <dl>
      <dt>Includes:</dt>
      <dd><span class='object_link'><a href="ClusterTime/Consumer.html" title="Mongo::ClusterTime::Consumer (module)">ClusterTime::Consumer</a></span>, <span class='object_link'><a href="Loggable.html" title="Mongo::Loggable (module)">Loggable</a></span>, <span class='object_link'><a href="Retryable.html" title="Mongo::Retryable (module)">Retryable</a></span></dd>
  </dl>
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/mongo/session.rb<span class="defines">,<br />
  lib/mongo/session/session_pool.rb,<br /> lib/mongo/session/server_session.rb</span>
</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Session objects are not thread-safe. An application may use a session from only one thread or process at a time.</p>
</div>
  </div>


<p>A logical session representing a set of sequential operations executed by an application that are related in some way.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="Session/ServerSession.html" title="Mongo::Session::ServerSession (class)">ServerSession</a></span>, <span class='object_link'><a href="Session/SessionPool.html" title="Mongo::Session::SessionPool (class)">SessionPool</a></span>
    
  
</p>

  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="MISMATCHED_CLUSTER_ERROR_MSG-constant" class="">MISMATCHED_CLUSTER_ERROR_MSG =
          <div class="docstring">
  <div class="discussion">
    
<p>Error message indicating that the session was retrieved from a client with a different cluster than that of the client through which it is currently being used.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The configuration of the client used to create this session does not match that </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span>
<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>of the client owning this operation. Please only use this session for operations through its parent </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span>
<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>client.</span><span class='tstring_end'>&#39;</span></span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre></dd>
      
        <dt id="SESSION_ENDED_ERROR_MSG-constant" class="">SESSION_ENDED_ERROR_MSG =
          <div class="docstring">
  <div class="discussion">
    
<p>Error message describing that the session cannot be used because it has already been ended.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>This session has ended and cannot be used. Please create a new one.</span><span class='tstring_end'>&#39;</span></span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre></dd>
      
        <dt id="SESSIONS_NOT_SUPPORTED-constant" class="">SESSIONS_NOT_SUPPORTED =
          <div class="docstring">
  <div class="discussion">
    
<p>Error message describing that sessions are not supported by the server version.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Sessions are not supported by the connected servers.</span><span class='tstring_end'>&#39;</span></span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre></dd>
      
        <dt id="NO_TRANSACTION_STATE-constant" class="">NO_TRANSACTION_STATE =
          <div class="docstring">
  <div class="discussion">
    
<p>The state of a session in which the last operation was not related to any transaction or no operations have yet occurred.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div>
        </dt>
        <dd><pre class="code"><span class='symbol'>:no_transaction</span></pre></dd>
      
        <dt id="STARTING_TRANSACTION_STATE-constant" class="">STARTING_TRANSACTION_STATE =
          <div class="docstring">
  <div class="discussion">
    
<p>The state of a session in which a user has initiated a transaction but no operations within the transactions have occurred yet.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div>
        </dt>
        <dd><pre class="code"><span class='symbol'>:starting_transaction</span></pre></dd>
      
        <dt id="TRANSACTION_IN_PROGRESS_STATE-constant" class="">TRANSACTION_IN_PROGRESS_STATE =
          <div class="docstring">
  <div class="discussion">
    
<p>The state of a session in which a transaction has been started and at least one operation has occurred, but the transaction has not yet been committed or aborted.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div>
        </dt>
        <dd><pre class="code"><span class='symbol'>:transaction_in_progress</span></pre></dd>
      
        <dt id="TRANSACTION_COMMITTED_STATE-constant" class="">TRANSACTION_COMMITTED_STATE =
          <div class="docstring">
  <div class="discussion">
    
<p>The state of a session in which the last operation executed was a transaction commit.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div>
        </dt>
        <dd><pre class="code"><span class='symbol'>:transaction_committed</span></pre></dd>
      
        <dt id="TRANSACTION_ABORTED_STATE-constant" class="">TRANSACTION_ABORTED_STATE =
          <div class="docstring">
  <div class="discussion">
    
<p>The state of a session in which the last operation executed was a transaction abort.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div>
        </dt>
        <dd><pre class="code"><span class='symbol'>:transaction_aborted</span></pre></dd>
      
        <dt id="UNLABELED_WRITE_CONCERN_CODES-constant" class="">UNLABELED_WRITE_CONCERN_CODES =
          <div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This constant is part of a private API.</strong>
  You should avoid using this constant if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div>
        </dt>
        <dd><pre class="code"><span class='lbracket'>[</span>
  <span class='int'>79</span><span class='comma'>,</span>  <span class='comment'># UnknownReplWriteConcern
</span>  <span class='int'>100</span><span class='comma'>,</span> <span class='comment'># CannotSatisfyWriteConcern,
</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre></dd>
      
    </dl>
  



  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="Loggable.html" title="Mongo::Loggable (module)">Loggable</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="Loggable.html#PREFIX-constant" title="Mongo::Loggable::PREFIX (constant)">Loggable::PREFIX</a></span></p>


  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#client-instance_method" title="#client (instance method)">#<strong>client</strong>  &#x21d2; Client </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The client through which this session was created.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#operation_time-instance_method" title="#operation_time (instance method)">#<strong>operation_time</strong>  &#x21d2; BSON::Timestamp </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The latest seen operation time for this session.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#options-instance_method" title="#options (instance method)">#<strong>options</strong>  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The options for this session.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#pinned_server-instance_method" title="#pinned_server (instance method)">#<strong>pinned_server</strong>  &#x21d2; Server | nil </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>The server (which should be a mongos) that this session is pinned to, if any.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#recovery_token-instance_method" title="#recovery_token (instance method)">#<strong>recovery_token</strong>  &#x21d2; BSON::Document | nil </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Recovery token for the sharded transaction being executed on this session, if any.</p>
</div></span>
  
</li>

    
  </ul>



  
  
  <h3 class="inherited">Attributes included from <span class='object_link'><a href="ClusterTime/Consumer.html" title="Mongo::ClusterTime::Consumer (module)">ClusterTime::Consumer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ClusterTime/Consumer.html#cluster_time-instance_method" title="Mongo::ClusterTime::Consumer#cluster_time (method)">#cluster_time</a></span></p>


  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#abort_transaction-instance_method" title="#abort_transaction (instance method)">#<strong>abort_transaction</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Abort the currently active transaction without making any changes to the database.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_autocommit!-instance_method" title="#add_autocommit! (instance method)">#<strong>add_autocommit!</strong>(command)  &#x21d2; Hash, BSON::Document </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Add the autocommit field to a command document if applicable.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_start_transaction!-instance_method" title="#add_start_transaction! (instance method)">#<strong>add_start_transaction!</strong>(command)  &#x21d2; Hash, BSON::Document </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Add the startTransaction field to a command document if applicable.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_txn_num!-instance_method" title="#add_txn_num! (instance method)">#<strong>add_txn_num!</strong>(command)  &#x21d2; Hash, BSON::Document </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Add the transaction number to a command document if applicable.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_txn_opts!-instance_method" title="#add_txn_opts! (instance method)">#<strong>add_txn_opts!</strong>(command, read)  &#x21d2; Hash, BSON::Document </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Add the transactions options if applicable.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#advance_operation_time-instance_method" title="#advance_operation_time (instance method)">#<strong>advance_operation_time</strong>(new_operation_time)  &#x21d2; BSON::Timestamp </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Advance the cached operation time for this session.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cluster-instance_method" title="#cluster (instance method)">#<strong>cluster</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#commit_transaction-instance_method" title="#commit_transaction (instance method)">#<strong>commit_transaction</strong>(options = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Commit the currently active transaction on the session.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#committing_transaction%3F-instance_method" title="#committing_transaction? (instance method)">#<strong>committing_transaction?</strong>  &#x21d2; true | false </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Whether the session is currently committing a transaction.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#end_session-instance_method" title="#end_session (instance method)">#<strong>end_session</strong>  &#x21d2; nil </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>End this session.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ended%3F-instance_method" title="#ended? (instance method)">#<strong>ended?</strong>  &#x21d2; true, false </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Whether this session has ended.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#explicit%3F-instance_method" title="#explicit? (instance method)">#<strong>explicit?</strong>  &#x21d2; true, false </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Is this session an explicit one (i.e. user-created).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#implicit%3F-instance_method" title="#implicit? (instance method)">#<strong>implicit?</strong>  &#x21d2; true, false </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Is this session an implicit one (not user-created).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#in_transaction%3F-instance_method" title="#in_transaction? (instance method)">#<strong>in_transaction?</strong>  &#x21d2; true | false </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Whether or not the session is currently in a transaction.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(server_session, client, options = {})  &#x21d2; Session </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Initialize a Session.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#inspect-instance_method" title="#inspect (instance method)">#<strong>inspect</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get a formatted string for use in inspection.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#next_txn_num-instance_method" title="#next_txn_num (instance method)">#<strong>next_txn_num</strong>  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Increment and return the next transaction number.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#pin-instance_method" title="#pin (instance method)">#<strong>pin</strong>(server)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Pins this session to the specified server, which should be a mongos.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process-instance_method" title="#process (instance method)">#<strong>process</strong>(result)  &#x21d2; Operation::Result </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Process a response from the server that used this session.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#retry_reads%3F-instance_method" title="#retry_reads? (instance method)">#<strong>retry_reads?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Whether reads executed with this session can be retried according to the modern retryable reads specification.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#retry_writes%3F-instance_method" title="#retry_writes? (instance method)">#<strong>retry_writes?</strong>  &#x21d2; true, false </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Will writes executed with this session be retried.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#session_id-instance_method" title="#session_id (instance method)">#<strong>session_id</strong>  &#x21d2; BSON::Document </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get the server session id of this session, if the session was not ended.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#start_transaction-instance_method" title="#start_transaction (instance method)">#<strong>start_transaction</strong>(options = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Places subsequent operations in this session into a new transaction.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#starting_transaction%3F-instance_method" title="#starting_transaction? (instance method)">#<strong>starting_transaction?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#suppress_read_write_concern!-instance_method" title="#suppress_read_write_concern! (instance method)">#<strong>suppress_read_write_concern!</strong>(command)  &#x21d2; Hash, BSON::Document </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Remove the read concern and/or write concern from the command if not applicable.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#txn_num-instance_method" title="#txn_num (instance method)">#<strong>txn_num</strong>  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get the current transaction number.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#txn_options-instance_method" title="#txn_options (instance method)">#<strong>txn_options</strong>  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>on this session.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#txn_read_preference-instance_method" title="#txn_read_preference (instance method)">#<strong>txn_read_preference</strong>  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get the read preference the session will use in the currently active transaction.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unpin-instance_method" title="#unpin (instance method)">#<strong>unpin</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Unpins this session from the pinned server, if the session was pinned.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unpin_maybe-instance_method" title="#unpin_maybe (instance method)">#<strong>unpin_maybe</strong>(error)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Unpins this session from the pinned server, if the session was pinned and the specified exception instance and the session&#39;s transaction state require it to be unpinned.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_state!-instance_method" title="#update_state! (instance method)">#<strong>update_state!</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Update the state of the session due to a (non-commit and non-abort) operation being run.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#validate!-instance_method" title="#validate! (instance method)">#<strong>validate!</strong>(client)  &#x21d2; Session </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Validate the session for use by the specified client.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#validate_read_preference!-instance_method" title="#validate_read_preference! (instance method)">#<strong>validate_read_preference!</strong>(command)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Ensure that the read preference of a command primary.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#with_transaction-instance_method" title="#with_transaction (instance method)">#<strong>with_transaction</strong>(options = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Executes the provided block in a transaction, retrying as necessary.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="ClusterTime/Consumer.html" title="Mongo::ClusterTime::Consumer (module)">ClusterTime::Consumer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ClusterTime/Consumer.html#advance_cluster_time-instance_method" title="Mongo::ClusterTime::Consumer#advance_cluster_time (method)">#advance_cluster_time</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="Loggable.html" title="Mongo::Loggable (module)">Loggable</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="Loggable.html#log_debug-instance_method" title="Mongo::Loggable#log_debug (method)">#log_debug</a></span>, <span class='object_link'><a href="Loggable.html#log_error-instance_method" title="Mongo::Loggable#log_error (method)">#log_error</a></span>, <span class='object_link'><a href="Loggable.html#log_fatal-instance_method" title="Mongo::Loggable#log_fatal (method)">#log_fatal</a></span>, <span class='object_link'><a href="Loggable.html#log_info-instance_method" title="Mongo::Loggable#log_info (method)">#log_info</a></span>, <span class='object_link'><a href="Loggable.html#log_warn-instance_method" title="Mongo::Loggable#log_warn (method)">#log_warn</a></span>, <span class='object_link'><a href="Loggable.html#logger-instance_method" title="Mongo::Loggable#logger (method)">#logger</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="Retryable.html" title="Mongo::Retryable (module)">Retryable</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="Retryable.html#legacy_write_with_retry-instance_method" title="Mongo::Retryable#legacy_write_with_retry (method)">#legacy_write_with_retry</a></span>, <span class='object_link'><a href="Retryable.html#nro_write_with_retry-instance_method" title="Mongo::Retryable#nro_write_with_retry (method)">#nro_write_with_retry</a></span>, <span class='object_link'><a href="Retryable.html#read_with_one_retry-instance_method" title="Mongo::Retryable#read_with_one_retry (method)">#read_with_one_retry</a></span>, <span class='object_link'><a href="Retryable.html#read_with_retry-instance_method" title="Mongo::Retryable#read_with_retry (method)">#read_with_retry</a></span>, <span class='object_link'><a href="Retryable.html#read_with_retry_cursor-instance_method" title="Mongo::Retryable#read_with_retry_cursor (method)">#read_with_retry_cursor</a></span>, <span class='object_link'><a href="Retryable.html#write_with_retry-instance_method" title="Mongo::Retryable#write_with_retry (method)">#write_with_retry</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(server_session, client, options = {})  &#x21d2; <tt><span class='object_link'><a href="" title="Mongo::Session (class)">Session</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Applications should use Client#start_session to begin a session.</p>
</div>
  </div>


<p>Initialize a Session.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="" title="Mongo::Session (class)">Session</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_server_session'>server_session</span><span class='comma'>,</span> <span class='id identifier rubyid_client'>client</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>server_session</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Session/ServerSession.html" title="Mongo::Session::ServerSession (class)">ServerSession</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The server session this session is associated with.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>client</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Client.html" title="Mongo::Client (class)">Client</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The client through which this session is created.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The options for this session.</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    
    
    <p class="tag_title">Options Hash (<tt>options</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:causal_consistency</span>
          <span class="type">(<tt>true|false</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Whether to enable causal consistency for this session.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:default_transaction_options</span>
          <span class="type">(<tt>Hash</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Options to pass to start_transaction by default, can contain any of the options that start_transaction accepts.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:implicit</span>
          <span class="type">(<tt>true|false</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>For internal driver use only - specifies whether the session is implicit.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:read_preference</span>
          <span class="type">(<tt>Hash</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The read preference options hash, with the following optional keys:</p>
<ul><li>
<p><strong>:mode</strong> – the read preference as a string or symbol; valid values are <strong>:primary</strong>, <strong>:primary_preferred</strong>, <strong>:secondary</strong>, <strong>:secondary_preferred</strong> and <strong>:nearest</strong>.</p>
</li></ul>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


59
60
61
62
63
64
65
66
67</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 59</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_server_session'>server_session</span><span class='comma'>,</span> <span class='id identifier rubyid_client'>client</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='ivar'>@server_session</span> <span class='op'>=</span> <span class='id identifier rubyid_server_session'>server_session</span>
  <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>

  <span class='ivar'>@client</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_use'>use</span><span class='lparen'>(</span><span class='symbol'>:admin</span><span class='rparen'>)</span>
  <span class='ivar'>@options</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span>
  <span class='ivar'>@cluster_time</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="#NO_TRANSACTION_STATE-constant" title="Mongo::Session::NO_TRANSACTION_STATE (constant)">NO_TRANSACTION_STATE</a></span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="client-instance_method">
  
    #<strong>client</strong>  &#x21d2; <tt><span class='object_link'><a href="Client.html" title="Mongo::Client (class)">Client</a></span></tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns The client through which this session was created.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Client.html" title="Mongo::Client (class)">Client</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The client through which this session was created.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


77
78
79</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 77</span>

<span class='kw'>def</span> <span class='id identifier rubyid_client'>client</span>
  <span class='ivar'>@client</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="operation_time-instance_method">
  
    #<strong>operation_time</strong>  &#x21d2; <tt>BSON::Timestamp</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns The latest seen operation time for this session.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>BSON::Timestamp</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The latest seen operation time for this session.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


86
87
88</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 86</span>

<span class='kw'>def</span> <span class='id identifier rubyid_operation_time'>operation_time</span>
  <span class='ivar'>@operation_time</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="options-instance_method">
  
    #<strong>options</strong>  &#x21d2; <tt>Hash</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns The options for this session.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The options for this session.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


72
73
74</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 72</span>

<span class='kw'>def</span> <span class='id identifier rubyid_options'>options</span>
  <span class='ivar'>@options</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="pinned_server-instance_method">
  
    #<strong>pinned_server</strong>  &#x21d2; <tt><span class='object_link'><a href="Server.html" title="Mongo::Server (class)">Server</a></span> | nil</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Returns The server (which should be a mongos) that this session is pinned to, if any.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Server.html" title="Mongo::Server (class)">Server</a></span> | nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The server (which should be a mongos) that this session is pinned to, if any.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


206
207
208</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 206</span>

<span class='kw'>def</span> <span class='id identifier rubyid_pinned_server'>pinned_server</span>
  <span class='ivar'>@pinned_server</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="recovery_token=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="recovery_token-instance_method">
  
    #<strong>recovery_token</strong>  &#x21d2; <tt>BSON::Document | nil</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Returns Recovery token for the sharded transaction being executed on this session, if any.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>BSON::Document | nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Recovery token for the sharded transaction being executed on this session, if any.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


212
213
214</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 212</span>

<span class='kw'>def</span> <span class='id identifier rubyid_recovery_token'>recovery_token</span>
  <span class='ivar'>@recovery_token</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="abort_transaction-instance_method">
  
    #<strong>abort_transaction</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Abort the currently active transaction without making any changes to the database.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Abort the transaction.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_abort_transaction'>abort_transaction</span></code></pre>
    
  </div>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Error::InvalidTransactionOperation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If there is no active transaction.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 602</span>

<span class='kw'>def</span> <span class='id identifier rubyid_abort_transaction'>abort_transaction</span>
  <span class='id identifier rubyid_check_if_ended!'>check_if_ended!</span>
  <span class='id identifier rubyid_check_if_no_transaction!'>check_if_no_transaction!</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="#TRANSACTION_COMMITTED_STATE-constant" title="Mongo::Session::TRANSACTION_COMMITTED_STATE (constant)">TRANSACTION_COMMITTED_STATE</a></span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#initialize-instance_method" title="Mongo::Error::InvalidTransactionOperation#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_cannot_call_after_msg'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#cannot_call_after_msg-class_method" title="Mongo::Error::InvalidTransactionOperation.cannot_call_after_msg (method)">cannot_call_after_msg</a></span></span><span class='lparen'>(</span>
        <span class='symbol'>:commitTransaction</span><span class='comma'>,</span> <span class='symbol'>:abortTransaction</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#initialize-instance_method" title="Mongo::Error::InvalidTransactionOperation#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_cannot_call_twice_msg'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#cannot_call_twice_msg-class_method" title="Mongo::Error::InvalidTransactionOperation.cannot_call_twice_msg (method)">cannot_call_twice_msg</a></span></span><span class='lparen'>(</span><span class='symbol'>:abortTransaction</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_starting_transaction?'>starting_transaction?</span>
      <span class='id identifier rubyid_write_with_retry'>write_with_retry</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_options'>txn_options</span><span class='lbracket'>[</span><span class='symbol'>:write_concern</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='op'>|</span>
        <span class='const'><span class='object_link'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Operation/Command.html" title="Mongo::Operation::Command (class)">Command</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Operation/Specifiable.html#initialize-instance_method" title="Mongo::Operation::Specifiable#initialize (method)">new</a></span></span><span class='lparen'>(</span>
          <span class='label'>selector:</span> <span class='lbrace'>{</span> <span class='label'>abortTransaction:</span> <span class='int'>1</span> <span class='rbrace'>}</span><span class='comma'>,</span>
          <span class='label'>db_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
          <span class='label'>session:</span> <span class='kw'>self</span><span class='comma'>,</span>
          <span class='label'>txn_num:</span> <span class='id identifier rubyid_txn_num'>txn_num</span>
        <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='label'>client:</span> <span class='ivar'>@client</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span></span>
  <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span></span>
  <span class='kw'>rescue</span> <span class='const'>Exception</span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span></span>
    <span class='id identifier rubyid_raise'>raise</span>
  <span class='kw'>end</span>

  <span class='comment'># No official return value, but return true so that in interactive
</span>  <span class='comment'># use the method hints that it succeeded.
</span>  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_autocommit!-instance_method">
  
    #<strong>add_autocommit!</strong>(command)  &#x21d2; <tt>Hash</tt>, <tt>BSON::Document</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Add the autocommit field to a command document if applicable.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_add_autocommit!'>add_autocommit!</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='rparen'>)</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>, <tt>BSON::Document</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The command document.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


726
727
728
729
730</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 726</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_autocommit!'>add_autocommit!</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:autocommit</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_start_transaction!-instance_method">
  
    #<strong>add_start_transaction!</strong>(command)  &#x21d2; <tt>Hash</tt>, <tt>BSON::Document</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Add the startTransaction field to a command document if applicable.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_add_start_transaction!'>add_start_transaction!</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='rparen'>)</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>, <tt>BSON::Document</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The command document.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


741
742
743
744
745
746
747</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 741</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_start_transaction!'>add_start_transaction!</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_starting_transaction?'>starting_transaction?</span>
      <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:startTransaction</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_txn_num!-instance_method">
  
    #<strong>add_txn_num!</strong>(command)  &#x21d2; <tt>Hash</tt>, <tt>BSON::Document</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Add the transaction number to a command document if applicable.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_add_txn_num!'>add_txn_num!</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='rparen'>)</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>, <tt>BSON::Document</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The command document.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


758
759
760
761
762</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 758</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_txn_num!'>add_txn_num!</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:txnNumber</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Int64</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@server_session</span><span class='period'>.</span><span class='id identifier rubyid_txn_num'>txn_num</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_txn_opts!-instance_method">
  
    #<strong>add_txn_opts!</strong>(command, read)  &#x21d2; <tt>Hash</tt>, <tt>BSON::Document</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Add the transactions options if applicable.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_add_txn_opts!'>add_txn_opts!</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='rparen'>)</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>, <tt>BSON::Document</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The command document.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


773
774
775
776
777
778
779
780
781
782
783
784
785
786
787
788
789
790
791
792
793
794
795
796
797
798
799
800
801
802
803
804
805
806
807
808
809
810
811
812
813
814
815
816
817
818
819
820
821
822
823
824
825
826
827
828</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 773</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_txn_opts!'>add_txn_opts!</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='comma'>,</span> <span class='id identifier rubyid_read'>read</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='comment'># The read concern should be added to any command that starts a transaction.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_starting_transaction?'>starting_transaction?</span>      <span class='comment'># https://jira.mongodb.org/browse/SPEC-1161: transaction&#39;s
</span>      <span class='comment'># read concern overrides collection/database/client read concerns,
</span>      <span class='comment'># even if transaction&#39;s read concern is not set.
</span>      <span class='comment'># Read concern here is the one sent to the server and may
</span>      <span class='comment'># include afterClusterTime.
</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_rc'>rc</span> <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:readConcern</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_rc'>rc</span> <span class='op'>=</span> <span class='id identifier rubyid_rc'>rc</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
        <span class='id identifier rubyid_rc'>rc</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:level</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_txn_read_concern'>txn_read_concern</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_rc'>rc</span>
          <span class='id identifier rubyid_rc'>rc</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='id identifier rubyid_txn_read_concern'>txn_read_concern</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_rc'>rc</span> <span class='op'>=</span> <span class='id identifier rubyid_txn_read_concern'>txn_read_concern</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_rc'>rc</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_rc'>rc</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:readConcern</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:readConcern</span> <span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Options.html" title="Mongo::Options (module)">Options</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Options/Mapper.html" title="Mongo::Options::Mapper (module)">Mapper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_transform_values_to_strings'><span class='object_link'><a href="Options/Mapper.html#transform_values_to_strings-instance_method" title="Mongo::Options::Mapper#transform_values_to_strings (method)">transform_values_to_strings</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_rc'>rc</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># We need to send the read concern level as a string rather than a symbol.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:readConcern</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:readConcern</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Options.html" title="Mongo::Options (module)">Options</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Options/Mapper.html" title="Mongo::Options::Mapper (module)">Mapper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_transform_values_to_strings'><span class='object_link'><a href="Options/Mapper.html#transform_values_to_strings-instance_method" title="Mongo::Options::Mapper#transform_values_to_strings (method)">transform_values_to_strings</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:readConcern</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:commitTransaction</span><span class='rbracket'>]</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_max_time_ms'>max_time_ms</span> <span class='op'>=</span> <span class='id identifier rubyid_txn_options'>txn_options</span><span class='lbracket'>[</span><span class='symbol'>:max_commit_time_ms</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:maxTimeMS</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_max_time_ms'>max_time_ms</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># The write concern should be added to any abortTransaction or commitTransaction command.
</span>    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:abortTransaction</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:commitTransaction</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='ivar'>@already_committed</span>
        <span class='id identifier rubyid_wc'>wc</span> <span class='op'>=</span> <span class='const'>BSON</span><span class='op'>::</span><span class='const'>Document</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:writeConcern</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_txn_write_concern'>txn_write_concern</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_wc'>wc</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='label'>w:</span> <span class='symbol'>:majority</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_wc'>wc</span><span class='lbracket'>[</span><span class='symbol'>:wtimeout</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>10000</span>
        <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:writeConcern</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_wc'>wc</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_txn_write_concern'>txn_write_concern</span>
        <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:writeConcern</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='id identifier rubyid_txn_write_concern'>txn_write_concern</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># A non-numeric write concern w value needs to be sent as a string rather than a symbol.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:writeConcern</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:writeConcern</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:w</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:writeConcern</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:w</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Symbol.html" title="Symbol (class)">Symbol</a></span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:writeConcern</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:w</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:writeConcern</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:w</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="advance_operation_time-instance_method">
  
    #<strong>advance_operation_time</strong>(new_operation_time)  &#x21d2; <tt>BSON::Timestamp</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Advance the cached operation time for this session.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Advance the operation time.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_advance_operation_time'>advance_operation_time</span><span class='lparen'>(</span><span class='id identifier rubyid_timestamp'>timestamp</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>new_operation_time</span>
      
      
        <span class='type'>(<tt>BSON::Timestamp</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The new operation time.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>BSON::Timestamp</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The max operation time, considering the current and new times.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


942
943
944
945
946
947
948</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 942</span>

<span class='kw'>def</span> <span class='id identifier rubyid_advance_operation_time'>advance_operation_time</span><span class='lparen'>(</span><span class='id identifier rubyid_new_operation_time'>new_operation_time</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@operation_time</span>
    <span class='ivar'>@operation_time</span> <span class='op'>=</span> <span class='lbracket'>[</span> <span class='ivar'>@operation_time</span><span class='comma'>,</span> <span class='id identifier rubyid_new_operation_time'>new_operation_time</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_max'>max</span>
  <span class='kw'>else</span>
    <span class='ivar'>@operation_time</span> <span class='op'>=</span> <span class='id identifier rubyid_new_operation_time'>new_operation_time</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="cluster-instance_method">
  
    #<strong>cluster</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


79
80
81</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 79</span>

<span class='kw'>def</span> <span class='id identifier rubyid_cluster'>cluster</span>
  <span class='ivar'>@client</span><span class='period'>.</span><span class='id identifier rubyid_cluster'>cluster</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="commit_transaction-instance_method">
  
    #<strong>commit_transaction</strong>(options = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Commit the currently active transaction on the session.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Commits the transaction.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_commit_transaction'>commit_transaction</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>a customizable set of options</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <p class="tag_title">Options Hash (<tt>options</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:write_concern</span>
          <span class="type">(<tt>nil | <span class='object_link'><a href="WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">WriteConcern::Base</a></span></tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The write concern to use for this operation.</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Error::InvalidTransactionOperation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If there is no active transaction.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 534</span>

<span class='kw'>def</span> <span class='id identifier rubyid_commit_transaction'>commit_transaction</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_check_if_ended!'>check_if_ended!</span>
  <span class='id identifier rubyid_check_if_no_transaction!'>check_if_no_transaction!</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#initialize-instance_method" title="Mongo::Error::InvalidTransactionOperation#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_cannot_call_after_msg'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#cannot_call_after_msg-class_method" title="Mongo::Error::InvalidTransactionOperation.cannot_call_after_msg (method)">cannot_call_after_msg</a></span></span><span class='lparen'>(</span>
        <span class='symbol'>:abortTransaction</span><span class='comma'>,</span> <span class='symbol'>:commitTransaction</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_options'>options</span> <span class='op'>||=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

  <span class='kw'>begin</span>
    <span class='comment'># If commitTransaction is called twice, we need to run the same commit
</span>    <span class='comment'># operation again, so we revert the session to the previous state.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="#TRANSACTION_COMMITTED_STATE-constant" title="Mongo::Session::TRANSACTION_COMMITTED_STATE (constant)">TRANSACTION_COMMITTED_STATE</a></span></span><span class='rparen'>)</span>
      <span class='ivar'>@state</span> <span class='op'>=</span> <span class='ivar'>@last_commit_skipped</span> <span class='op'>?</span> <span class='const'><span class='object_link'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span></span> <span class='op'>:</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span></span>
      <span class='ivar'>@already_committed</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_starting_transaction?'>starting_transaction?</span>
      <span class='ivar'>@last_commit_skipped</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>else</span>
      <span class='ivar'>@last_commit_skipped</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='ivar'>@committing_transaction</span> <span class='op'>=</span> <span class='kw'>true</span>

      <span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:write_concern</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_txn_options'>txn_options</span><span class='lbracket'>[</span><span class='symbol'>:write_concern</span><span class='rbracket'>]</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_write_concern'>write_concern</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">Base</a></span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span></span><span class='period'>.</span><span class='id identifier rubyid_get'><span class='object_link'><a href="WriteConcern.html#get-instance_method" title="Mongo::WriteConcern#get (method)">get</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_write_concern'>write_concern</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_write_with_retry'>write_with_retry</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_write_concern'>write_concern</span><span class='comma'>,</span> <span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span> <span class='id identifier rubyid_is_retry'>is_retry</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_is_retry'>is_retry</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_write_concern'>write_concern</span>
            <span class='id identifier rubyid_wco'>wco</span> <span class='op'>=</span> <span class='id identifier rubyid_write_concern'>write_concern</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>w:</span> <span class='symbol'>:majority</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_wco'>wco</span><span class='lbracket'>[</span><span class='symbol'>:wtimeout</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>10000</span>
            <span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span></span><span class='period'>.</span><span class='id identifier rubyid_get'><span class='object_link'><a href="WriteConcern.html#get-instance_method" title="Mongo::WriteConcern#get (method)">get</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_wco'>wco</span><span class='rparen'>)</span>
          <span class='kw'>else</span>
            <span class='id identifier rubyid_write_concern'>write_concern</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span></span><span class='period'>.</span><span class='id identifier rubyid_get'><span class='object_link'><a href="WriteConcern.html#get-instance_method" title="Mongo::WriteConcern#get (method)">get</a></span></span><span class='lparen'>(</span><span class='label'>w:</span> <span class='symbol'>:majority</span><span class='comma'>,</span> <span class='label'>wtimeout:</span> <span class='int'>10000</span><span class='rparen'>)</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_spec'>spec</span> <span class='op'>=</span> <span class='lbrace'>{</span>
          <span class='label'>selector:</span> <span class='lbrace'>{</span> <span class='label'>commitTransaction:</span> <span class='int'>1</span> <span class='rbrace'>}</span><span class='comma'>,</span>
          <span class='label'>db_name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>admin</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
          <span class='label'>session:</span> <span class='kw'>self</span><span class='comma'>,</span>
          <span class='label'>txn_num:</span> <span class='id identifier rubyid_txn_num'>txn_num</span><span class='comma'>,</span>
          <span class='label'>write_concern:</span> <span class='id identifier rubyid_write_concern'>write_concern</span><span class='comma'>,</span>
        <span class='rbrace'>}</span>
        <span class='const'><span class='object_link'><a href="Operation.html" title="Mongo::Operation (module)">Operation</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Operation/Command.html" title="Mongo::Operation::Command (class)">Command</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Operation/Specifiable.html#initialize-instance_method" title="Mongo::Operation::Specifiable#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_spec'>spec</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_execute'>execute</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='label'>client:</span> <span class='ivar'>@client</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>ensure</span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_COMMITTED_STATE-constant" title="Mongo::Session::TRANSACTION_COMMITTED_STATE (constant)">TRANSACTION_COMMITTED_STATE</a></span></span>
    <span class='ivar'>@committing_transaction</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='comment'># No official return value, but return true so that in interactive
</span>  <span class='comment'># use the method hints that it succeeded.
</span>  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="committing_transaction?-instance_method">
  
    #<strong>committing_transaction?</strong>  &#x21d2; <tt>true | false</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Returns Whether the session is currently committing a transaction.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>true | false</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether the session is currently committing a transaction.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


665
666
667</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 665</span>

<span class='kw'>def</span> <span class='id identifier rubyid_committing_transaction?'>committing_transaction?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='ivar'>@committing_transaction</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="end_session-instance_method">
  
    #<strong>end_session</strong>  &#x21d2; <tt>nil</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>End this session.</p>

<p>If there is an in-progress transaction on this session, the transaction is aborted. The server session associated with this session is returned to the server session pool. Finally, this session is marked ended and is no longer usable.</p>

<p>If this session is already ended, this method does nothing.</p>

<p>Note that this method does not directly issue an endSessions command to this server, contrary to what its name might suggest.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_end_session'>end_session</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Always nil.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


297
298
299
300
301
302
303
304
305
306
307
308
309</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 297</span>

<span class='kw'>def</span> <span class='id identifier rubyid_end_session'>end_session</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_ended?'>ended?</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@client</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span></span><span class='rparen'>)</span>
      <span class='kw'>begin</span>
        <span class='id identifier rubyid_abort_transaction'>abort_transaction</span>
      <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/AuthError.html" title="Mongo::Error::AuthError (class)">AuthError</a></span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='ivar'>@client</span><span class='period'>.</span><span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_session_pool'>session_pool</span><span class='period'>.</span><span class='id identifier rubyid_checkin'>checkin</span><span class='lparen'>(</span><span class='ivar'>@server_session</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>ensure</span>
  <span class='ivar'>@server_session</span> <span class='op'>=</span> <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ended?-instance_method">
  
    #<strong>ended?</strong>  &#x21d2; <tt>true</tt>, <tt>false</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Whether this session has ended.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_ended?'>ended?</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>true</tt>, <tt>false</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether the session has ended.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


181
182
183</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 181</span>

<span class='kw'>def</span> <span class='id identifier rubyid_ended?'>ended?</span>
  <span class='ivar'>@server_session</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="explicit?-instance_method">
  
    #<strong>explicit?</strong>  &#x21d2; <tt>true</tt>, <tt>false</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Is this session an explicit one (i.e. user-created).</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Is the session explicit?</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_explicit?'>explicit?</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>true</tt>, <tt>false</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether this session is explicit.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.2</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


116
117
118</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 116</span>

<span class='kw'>def</span> <span class='id identifier rubyid_explicit?'>explicit?</span>
  <span class='op'>!</span><span class='id identifier rubyid_implicit?'>implicit?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="implicit?-instance_method">
  
    #<strong>implicit?</strong>  &#x21d2; <tt>true</tt>, <tt>false</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Is this session an implicit one (not user-created).</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Is the session implicit?</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_implicit?'>implicit?</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>true</tt>, <tt>false</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether this session is implicit.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.1</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


104
105
106</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 104</span>

<span class='kw'>def</span> <span class='id identifier rubyid_implicit?'>implicit?</span>
  <span class='ivar'>@implicit</span> <span class='op'>||=</span> <span class='op'>!</span><span class='op'>!</span><span class='lparen'>(</span><span class='ivar'>@options</span><span class='period'>.</span><span class='id identifier rubyid_key?'>key?</span><span class='lparen'>(</span><span class='symbol'>:implicit</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:implicit</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>true</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="in_transaction?-instance_method">
  
    #<strong>in_transaction?</strong>  &#x21d2; <tt>true | false</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Whether or not the session is currently in a transaction.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Is the session in a transaction?</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_in_transaction?'>in_transaction?</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>true | false</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether or not the session in a transaction.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


657
658
659</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 657</span>

<span class='kw'>def</span> <span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
  <span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="inspect-instance_method">
  
    #<strong>inspect</strong>  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get a formatted string for use in inspection.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Inspect the session object.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The session inspection.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


275
276
277</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 275</span>

<span class='kw'>def</span> <span class='id identifier rubyid_inspect'>inspect</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;Mongo::Session:0x</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_object_id'>object_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> session_id=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_session_id'>session_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> options=</span><span class='embexpr_beg'>#{</span><span class='ivar'>@options</span><span class='embexpr_end'>}</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="next_txn_num-instance_method">
  
    #<strong>next_txn_num</strong>  &#x21d2; <tt>Integer</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Increment and return the next transaction number.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Get the next transaction number.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_next_txn_num'>next_txn_num</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The next transaction number.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


959
960
961
962
963
964
965</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 959</span>

<span class='kw'>def</span> <span class='id identifier rubyid_next_txn_num'>next_txn_num</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_ended?'>ended?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SessionEnded.html" title="Mongo::Error::SessionEnded (class)">SessionEnded</a></span></span>
  <span class='kw'>end</span>

  <span class='ivar'>@server_session</span><span class='period'>.</span><span class='id identifier rubyid_next_txn_num'>next_txn_num</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="pin-instance_method">
  
    #<strong>pin</strong>(server)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Pins this session to the specified server, which should be a mongos.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>server</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Server.html" title="Mongo::Server (class)">Server</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The server to pin this session to.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


674
675
676
677
678
679
680
681
682
683
684</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 674</span>

<span class='kw'>def</span> <span class='id identifier rubyid_pin'>pin</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Cannot pin to a nil server</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='const'><span class='object_link'><a href="Lint.html" title="Mongo::Lint (module)">Lint</a></span></span><span class='period'>.</span><span class='id identifier rubyid_enabled?'><span class='object_link'><a href="Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span></span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_mongos?'>mongos?</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Attempted to pin the session to server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_summary'>summary</span><span class='embexpr_end'>}</span><span class='tstring_content'> which is not a mongos</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='ivar'>@pinned_server</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process-instance_method">
  
    #<strong>process</strong>(result)  &#x21d2; <tt><span class='object_link'><a href="Operation/Result.html" title="Mongo::Operation::Result (class)">Operation::Result</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Process a response from the server that used this session.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Process a response from the server.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_result'>result</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>result</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Operation/Result.html" title="Mongo::Operation::Result (class)">Operation::Result</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The result from the operation.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Operation/Result.html" title="Mongo::Operation::Result (class)">Operation::Result</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The result.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


914
915
916
917
918
919
920
921
922
923
924
925
926
927
928
929
930</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 914</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process'>process</span><span class='lparen'>(</span><span class='id identifier rubyid_result'>result</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_implicit?'>implicit?</span>
    <span class='id identifier rubyid_set_operation_time'>set_operation_time</span><span class='lparen'>(</span><span class='id identifier rubyid_result'>result</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_cluster_time_doc'>cluster_time_doc</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_cluster_time'>cluster_time</span>
      <span class='id identifier rubyid_advance_cluster_time'>advance_cluster_time</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster_time_doc'>cluster_time_doc</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='ivar'>@server_session</span><span class='period'>.</span><span class='id identifier rubyid_set_last_use!'>set_last_use!</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_reply'>reply</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_reply'>reply</span><span class='period'>.</span><span class='id identifier rubyid_documents'>documents</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_doc'>doc</span><span class='lbracket'>[</span><span class='symbol'>:recoveryToken</span><span class='rbracket'>]</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_recovery_token'>recovery_token</span> <span class='op'>=</span> <span class='id identifier rubyid_doc'>doc</span><span class='lbracket'>[</span><span class='symbol'>:recoveryToken</span><span class='rbracket'>]</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="retry_reads?-instance_method">
  
    #<strong>retry_reads?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Whether reads executed with this session can be retried according to the modern retryable reads specification.</p>

<p>If this method returns true, the modern retryable reads have been requested by the application. If the server selected for a read operation supports modern retryable reads, they will be used for that particular operation. If the server selected for a read operation does not support modern retryable reads, the read will not be retried.</p>

<p>If this method returns false, legacy retryable reads have been requested by the application. Legacy retryable read logic will be used regardless of server version of the server(s) that the client is connected to. The number of read retries is given by :max_read_retries client option, which is 1 by default and can be set to 0 to disable legacy read retries.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


136
137
138</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 136</span>

<span class='kw'>def</span> <span class='id identifier rubyid_retry_reads?'>retry_reads?</span>
  <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:retry_reads</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="retry_writes?-instance_method">
  
    #<strong>retry_writes?</strong>  &#x21d2; <tt>true</tt>, <tt>false</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Retryable writes are only available on server versions at least 3.6 and with sharded clusters or replica sets.</p>
</div>
  </div>


<p>Will writes executed with this session be retried.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Will writes be retried.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_retry_writes?'>retry_writes?</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>true</tt>, <tt>false</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If writes will be retried.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


151
152
153</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 151</span>

<span class='kw'>def</span> <span class='id identifier rubyid_retry_writes?'>retry_writes?</span>
  <span class='op'>!</span><span class='op'>!</span><span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:retry_writes</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_replica_set?'>replica_set?</span> <span class='op'>||</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_sharded?'>sharded?</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="session_id-instance_method">
  
    #<strong>session_id</strong>  &#x21d2; <tt>BSON::Document</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get the server session id of this session, if the session was not ended. If the session was ended, returns nil.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Get the session id.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_session_id'>session_id</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>BSON::Document</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The server session id.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


194
195
196
197
198
199
200</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 194</span>

<span class='kw'>def</span> <span class='id identifier rubyid_session_id'>session_id</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_ended?'>ended?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SessionEnded.html" title="Mongo::Error::SessionEnded (class)">SessionEnded</a></span></span>
  <span class='kw'>end</span>

  <span class='ivar'>@server_session</span><span class='period'>.</span><span class='id identifier rubyid_session_id'>session_id</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="start_transaction-instance_method">
  
    #<strong>start_transaction</strong>(options = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Places subsequent operations in this session into a new transaction.</p>

<p>Note that the transaction will not be started on the server until an operation is performed after start_transaction is called.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Start a new transaction</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_start_transaction'>start_transaction</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The options for the transaction being started.</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <p class="tag_title">Options Hash (<tt>options</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:max_commit_time_ms</span>
          <span class="type">(<tt>Integer</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The maximum amount of time to allow a single commitTransaction command to run, in milliseconds.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">read_concern</span>
          <span class="type">(<tt>Hash</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The read concern options hash, with the following optional keys:</p>
<ul><li>
<p><strong>:level</strong> – the read preference level as a symbol; valid values</p>

<pre class="code ruby"><code class="ruby">are *:local*, *:majority*, and *:snapshot*
</code></pre>
</li></ul>
</div>
          
        </li>
      
        <li>
          <span class="name">:write_concern</span>
          <span class="type">(<tt>Hash</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The write concern options. Can be :w =&gt; Integer|String, :fsync =&gt; Boolean, :j =&gt; Boolean.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:read</span>
          <span class="type">(<tt>Hash</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The read preference options. The hash may have the following items:</p>
<ul><li>
<p><strong>:mode</strong> – read preference specified as a symbol; the only valid value is <strong>:primary</strong>.</p>
</li></ul>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Error::InvalidTransactionOperation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If a transaction is already in progress or if the write concern is unacknowledged.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 479</span>

<span class='kw'>def</span> <span class='id identifier rubyid_start_transaction'>start_transaction</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>
    <span class='const'><span class='object_link'><a href="Lint.html" title="Mongo::Lint (module)">Lint</a></span></span><span class='period'>.</span><span class='id identifier rubyid_validate_read_concern_option'><span class='object_link'><a href="Lint.html#validate_read_concern_option-class_method" title="Mongo::Lint.validate_read_concern_option (method)">validate_read_concern_option</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:read_concern</span><span class='rbracket'>]</span><span class='rparen'>)</span>

<span class='embdoc_beg'>=begin
</span><span class='embdoc'>    # It would be handy to detect invalid read preferences here, but
</span><span class='embdoc'>    # some of the spec tests require later detection of invalid read prefs.
</span><span class='embdoc'>    # Maybe we can do this when lint mode is on.
</span><span class='embdoc'>    mode = options[:read] &amp;&amp; options[:read][:mode].to_s
</span><span class='embdoc'>    if mode &amp;&amp; mode != &#39;primary&#39;
</span><span class='embdoc'>      raise Mongo::Error::InvalidTransactionOperation.new(
</span><span class='embdoc'>        &quot;read preference in a transaction must be primary (requested: #{mode})&quot;
</span><span class='embdoc'>      )
</span><span class='embdoc'>    end
</span><span class='embdoc_end'>=end
</span>  <span class='kw'>end</span>

  <span class='id identifier rubyid_check_if_ended!'>check_if_ended!</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#initialize-instance_method" title="Mongo::Error::InvalidTransactionOperation#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#TRANSACTION_ALREADY_IN_PROGRESS-constant" title="Mongo::Error::InvalidTransactionOperation::TRANSACTION_ALREADY_IN_PROGRESS (constant)">TRANSACTION_ALREADY_IN_PROGRESS</a></span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_unpin'>unpin</span>

  <span class='id identifier rubyid_next_txn_num'>next_txn_num</span>
  <span class='ivar'>@txn_options</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:default_transaction_options</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_txn_write_concern'>txn_write_concern</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='const'><span class='object_link'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span></span><span class='period'>.</span><span class='id identifier rubyid_get'><span class='object_link'><a href="WriteConcern.html#get-instance_method" title="Mongo::WriteConcern#get (method)">get</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_txn_write_concern'>txn_write_concern</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_acknowledged?'>acknowledged?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#initialize-instance_method" title="Mongo::Error::InvalidTransactionOperation#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#UNACKNOWLEDGED_WRITE_CONCERN-constant" title="Mongo::Error::InvalidTransactionOperation::UNACKNOWLEDGED_WRITE_CONCERN (constant)">UNACKNOWLEDGED_WRITE_CONCERN</a></span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span></span>
  <span class='ivar'>@already_committed</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># This method has no explicit return value.
</span>  <span class='comment'># We could return nil here but true indicates to the user that the
</span>  <span class='comment'># operation succeeded. This is intended for interactive use.
</span>  <span class='comment'># Note that the return value is not documented.
</span>  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="starting_transaction?-instance_method">
  
    #<strong>starting_transaction?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


645
646
647</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 645</span>

<span class='kw'>def</span> <span class='id identifier rubyid_starting_transaction?'>starting_transaction?</span>
  <span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="suppress_read_write_concern!-instance_method">
  
    #<strong>suppress_read_write_concern!</strong>(command)  &#x21d2; <tt>Hash</tt>, <tt>BSON::Document</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Remove the read concern and/or write concern from the command if not applicable.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_suppress_read_write_concern!'>suppress_read_write_concern!</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='rparen'>)</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>, <tt>BSON::Document</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The command document.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


839
840
841
842
843
844
845
846</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 839</span>

<span class='kw'>def</span> <span class='id identifier rubyid_suppress_read_write_concern!'>suppress_read_write_concern!</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_in_transaction?'>in_transaction?</span>

    <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:readConcern</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_starting_transaction?'>starting_transaction?</span>
    <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:writeConcern</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:commitTransaction</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_c'>c</span><span class='lbracket'>[</span><span class='symbol'>:abortTransaction</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="txn_num-instance_method">
  
    #<strong>txn_num</strong>  &#x21d2; <tt>Integer</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get the current transaction number.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Get the current transaction number.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_txn_num'>txn_num</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The current transaction number.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


975
976
977
978
979
980
981</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 975</span>

<span class='kw'>def</span> <span class='id identifier rubyid_txn_num'>txn_num</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_ended?'>ended?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/SessionEnded.html" title="Mongo::Error::SessionEnded (class)">SessionEnded</a></span></span>
  <span class='kw'>end</span>

  <span class='ivar'>@server_session</span><span class='period'>.</span><span class='id identifier rubyid_txn_num'>txn_num</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="txn_options-instance_method">
  
    #<strong>txn_options</strong>  &#x21d2; <tt>Hash</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>on this session.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The options for the transaction currently being executed</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


92
93
94</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 92</span>

<span class='kw'>def</span> <span class='id identifier rubyid_txn_options'>txn_options</span>
  <span class='ivar'>@txn_options</span> <span class='kw'>or</span> <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>There is no active transaction</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="txn_read_preference-instance_method">
  
    #<strong>txn_read_preference</strong>  &#x21d2; <tt>Hash</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get the read preference the session will use in the currently active transaction.</p>

<p>This is a driver style hash with underscore keys.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Get the transaction&#39;s read preference</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_txn_read_preference'>txn_read_preference</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The read preference of the transaction.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


166
167
168
169
170
171</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 166</span>

<span class='kw'>def</span> <span class='id identifier rubyid_txn_read_preference'>txn_read_preference</span>
  <span class='id identifier rubyid_rp'>rp</span> <span class='op'>=</span> <span class='id identifier rubyid_txn_options'>txn_options</span><span class='lbracket'>[</span><span class='symbol'>:read</span><span class='rbracket'>]</span> <span class='op'>||</span>
    <span class='ivar'>@client</span><span class='period'>.</span><span class='id identifier rubyid_read_preference'>read_preference</span>
  <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Lint.html" title="Mongo::Lint (module)">Lint</a></span></span><span class='period'>.</span><span class='id identifier rubyid_validate_underscore_read_preference'><span class='object_link'><a href="Lint.html#validate_underscore_read_preference-class_method" title="Mongo::Lint.validate_underscore_read_preference (method)">validate_underscore_read_preference</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_rp'>rp</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_rp'>rp</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unpin-instance_method">
  
    #<strong>unpin</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Unpins this session from the pinned server, if the session was pinned.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


689
690
691</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 689</span>

<span class='kw'>def</span> <span class='id identifier rubyid_unpin'>unpin</span>
  <span class='ivar'>@pinned_server</span> <span class='op'>=</span> <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unpin_maybe-instance_method">
  
    #<strong>unpin_maybe</strong>(error)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Unpins this session from the pinned server, if the session was pinned and the specified exception instance and the session&#39;s transaction state require it to be unpinned.</p>

<p>The exception instance should already have all of the labels set on it (both client- and server-side generated ones).</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>error</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The exception instance to process.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


703
704
705
706
707
708
709
710
711
712
713
714
715</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 703</span>

<span class='kw'>def</span> <span class='id identifier rubyid_unpin_maybe'>unpin_maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_error'>error</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="" title="Mongo::Session (class)">Session</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="#NO_TRANSACTION_STATE-constant" title="Mongo::Session::NO_TRANSACTION_STATE (constant)">NO_TRANSACTION_STATE</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
    <span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_label?'>label?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TransientTransactionError</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>then</span>
    <span class='id identifier rubyid_unpin'>unpin</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_committing_transaction?'>committing_transaction?</span> <span class='op'>&amp;&amp;</span>
    <span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_label?'>label?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UnknownTransactionCommitResult</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>then</span>
    <span class='id identifier rubyid_unpin'>unpin</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_state!-instance_method">
  
    #<strong>update_state!</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Update the state of the session due to a (non-commit and non-abort) operation being run.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


875
876
877
878
879
880
881
882</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 875</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_state!'>update_state!</span>
  <span class='kw'>case</span> <span class='ivar'>@state</span>
  <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span></span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span></span>
  <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_COMMITTED_STATE-constant" title="Mongo::Session::TRANSACTION_COMMITTED_STATE (constant)">TRANSACTION_COMMITTED_STATE</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span></span>
    <span class='ivar'>@state</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="#NO_TRANSACTION_STATE-constant" title="Mongo::Session::NO_TRANSACTION_STATE (constant)">NO_TRANSACTION_STATE</a></span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="validate!-instance_method">
  
    #<strong>validate!</strong>(client)  &#x21d2; <tt><span class='object_link'><a href="" title="Mongo::Session (class)">Session</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Validate the session for use by the specified client.</p>

<p>The session must not be ended and must have been created by a client with the same cluster as the client that the session is to be used with.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>client</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Client.html" title="Mongo::Client (class)">Client</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The client the session is to be used with.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="Mongo::Session (class)">Session</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>self, if the session is valid.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Error/InvalidSession.html" title="Mongo::Error::InvalidSession (class)">Mongo::Error::InvalidSession</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Exception raised if the session is not valid.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.5.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


897
898
899
900
901</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 897</span>

<span class='kw'>def</span> <span class='id identifier rubyid_validate!'>validate!</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_check_matching_cluster!'>check_matching_cluster!</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_check_if_ended!'>check_if_ended!</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="validate_read_preference!-instance_method">
  
    #<strong>validate_read_preference!</strong>(command)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Ensure that the read preference of a command primary.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_validate_read_preference!'>validate_read_preference!</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='rparen'>)</span></code></pre>
    
  </div>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Mongo::Error::InvalidTransactionOperation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If the read preference of the command is not primary.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.6.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


858
859
860
861
862
863
864
865
866
867
868
869</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 858</span>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_read_preference!'>validate_read_preference!</span><span class='lparen'>(</span><span class='id identifier rubyid_command'>command</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_command'>command</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$readPreference</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_mode'>mode</span> <span class='op'>=</span> <span class='id identifier rubyid_command'>command</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$readPreference</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mode</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_command'>command</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$readPreference</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:mode</span><span class='rbracket'>]</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_mode'>mode</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_mode'>mode</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>primary</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Error/InvalidTransactionOperation.html#initialize-instance_method" title="Mongo::Error::InvalidTransactionOperation#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>read preference in a transaction must be primary (requested: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_mode'>mode</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
    <span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="with_transaction-instance_method">
  
    #<strong>with_transaction</strong>(options = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>with_transaction contains a loop, therefore the if with_transaction itself is placed in a loop, its block should not call next or break to control the outer loop because this will instead affect the loop in with_transaction. The driver will warn and abort the transaction if it detects this situation.</p>
</div>
  </div>


<p>Executes the provided block in a transaction, retrying as necessary.</p>

<p>Returns the return value of the block.</p>

<p>Exact number of retries and when they are performed are implementation details of the driver; the provided block should be idempotent, and should be prepared to be called more than once. The driver may retry the commit command within an active transaction or it may repeat the transaction and invoke the block again, depending on the error encountered if any. Note also that the retries may be executed against different servers.</p>

<p>Transactions cannot be nested - InvalidTransactionOperation will be raised if this method is called when the session already has an active transaction.</p>

<p>Exceptions raised by the block which are not derived from Mongo::Error stop processing, abort the transaction and are propagated out of with_transaction. Exceptions derived from Mongo::Error may be handled by with_transaction, resulting in retries of the process.</p>

<p>Currently, with_transaction will retry commits and block invocations until at least 120 seconds have passed since with_transaction started executing. This timeout is not configurable and may change in a future driver version.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Execute a statement in a transaction</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_with_transaction'>with_transaction</span><span class='lparen'>(</span><span class='label'>write_concern:</span> <span class='lbrace'>{</span><span class='label'>w:</span> <span class='symbol'>:majority</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_collection'>collection</span><span class='period'>.</span><span class='id identifier rubyid_update_one'>update_one</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='label'>id:</span> <span class='int'>3</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Inactive</span><span class='tstring_end'>&#39;</span></span><span class='rbrace'>}</span> <span class='rbrace'>}</span><span class='comma'>,</span>
                        <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span><span class='rparen'>)</span>

<span class='kw'>end</span></code></pre>
    
      
        <p class="example_title"><div class='inline'>
<p>Execute a statement in a transaction, limiting total time consumed</p>
</div></p>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="Timeout.html" title="Mongo::Timeout (module)">Timeout</a></span></span><span class='period'>.</span><span class='id identifier rubyid_timeout'><span class='object_link'><a href="Timeout.html#timeout-class_method" title="Mongo::Timeout.timeout (method)">timeout</a></span></span><span class='lparen'>(</span><span class='int'>5</span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_with_transaction'>with_transaction</span><span class='lparen'>(</span><span class='label'>write_concern:</span> <span class='lbrace'>{</span><span class='label'>w:</span> <span class='symbol'>:majority</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_collection'>collection</span><span class='period'>.</span><span class='id identifier rubyid_update_one'>update_one</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='label'>id:</span> <span class='int'>3</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>$set</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>status:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Inactive</span><span class='tstring_end'>&#39;</span></span><span class='rbrace'>}</span> <span class='rbrace'>}</span><span class='comma'>,</span>
                          <span class='label'>session:</span> <span class='id identifier rubyid_session'>session</span><span class='rparen'>)</span>

  <span class='kw'>end</span>
<span class='kw'>end</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The options for the transaction being started. These are the same options that start_transaction accepts.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">Error::InvalidTransactionOperation</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If a transaction is already in progress or if the write concern is unacknowledged.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.7.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/session.rb', line 365</span>

<span class='kw'>def</span> <span class='id identifier rubyid_with_transaction'>with_transaction</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># Non-configurable 120 second timeout for the entire operation
</span>  <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='int'>120</span>
  <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_commit_options'>commit_options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>
      <span class='id identifier rubyid_commit_options'>commit_options</span><span class='lbracket'>[</span><span class='symbol'>:write_concern</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:write_concern</span><span class='rbracket'>]</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_start_transaction'>start_transaction</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_rv'>rv</span> <span class='op'>=</span> <span class='kw'>yield</span> <span class='kw'>self</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="#STARTING_TRANSACTION_STATE-constant" title="Mongo::Session::STARTING_TRANSACTION_STATE (constant)">STARTING_TRANSACTION_STATE</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_IN_PROGRESS_STATE-constant" title="Mongo::Session::TRANSACTION_IN_PROGRESS_STATE (constant)">TRANSACTION_IN_PROGRESS_STATE</a></span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_abort_transaction'>abort_transaction</span>
        <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_deadline'>deadline</span>
        <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='id identifier rubyid_raise'>raise</span>
      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_label?'>label?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TransientTransactionError</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_raise'>raise</span>
    <span class='kw'>else</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_within_states?'>within_states?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="#TRANSACTION_ABORTED_STATE-constant" title="Mongo::Session::TRANSACTION_ABORTED_STATE (constant)">TRANSACTION_ABORTED_STATE</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="#NO_TRANSACTION_STATE-constant" title="Mongo::Session::NO_TRANSACTION_STATE (constant)">NO_TRANSACTION_STATE</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="#TRANSACTION_COMMITTED_STATE-constant" title="Mongo::Session::TRANSACTION_COMMITTED_STATE (constant)">TRANSACTION_COMMITTED_STATE</a></span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='kw'>return</span> <span class='id identifier rubyid_rv'>rv</span>
      <span class='kw'>end</span>

      <span class='kw'>begin</span>
        <span class='id identifier rubyid_commit_transaction'>commit_transaction</span><span class='lparen'>(</span><span class='id identifier rubyid_commit_options'>commit_options</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='kw'>return</span> <span class='id identifier rubyid_rv'>rv</span>
      <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_label?'>label?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UnknownTransactionCommitResult</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
          <span class='kw'>if</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>||</span>
            <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_max_time_ms_expired?'>max_time_ms_expired?</span>
          <span class='kw'>then</span>
            <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
            <span class='id identifier rubyid_raise'>raise</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_wc_options'>wc_options</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_v'>v</span> <span class='op'>=</span> <span class='id identifier rubyid_commit_options'>commit_options</span><span class='lbracket'>[</span><span class='symbol'>:write_concern</span><span class='rbracket'>]</span>
            <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="WriteConcern.html" title="Mongo::WriteConcern (module)">WriteConcern</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WriteConcern/Base.html" title="Mongo::WriteConcern::Base (class)">Base</a></span></span>
              <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span>
            <span class='kw'>when</span> <span class='kw'>nil</span>
              <span class='lbrace'>{</span><span class='rbrace'>}</span>
            <span class='kw'>else</span>
              <span class='id identifier rubyid_v'>v</span>
            <span class='kw'>end</span>
          <span class='id identifier rubyid_commit_options'>commit_options</span><span class='lbracket'>[</span><span class='symbol'>:write_concern</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_wc_options'>wc_options</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>w:</span> <span class='symbol'>:majority</span><span class='rparen'>)</span>
          <span class='kw'>retry</span>
        <span class='kw'>elsif</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_label?'>label?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TransientTransactionError</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
          <span class='kw'>if</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_deadline'>deadline</span>
            <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
            <span class='id identifier rubyid_raise'>raise</span>
          <span class='kw'>end</span>
          <span class='kw'>next</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
          <span class='id identifier rubyid_raise'>raise</span>
        <span class='kw'>end</span>
      <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/AuthError.html" title="Mongo::Error::AuthError (class)">AuthError</a></span></span>
        <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='id identifier rubyid_raise'>raise</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># No official return value, but return true so that in interactive
</span>  <span class='comment'># use the method hints that it succeeded.
</span>  <span class='kw'>true</span>
<span class='kw'>ensure</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_transaction_in_progress'>transaction_in_progress</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>with_transaction callback altered with_transaction loop, aborting transaction</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_abort_transaction'>abort_transaction</span>
    <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/OperationFailure.html" title="Mongo::Error::OperationFailure (class)">OperationFailure</a></span></span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Error/InvalidTransactionOperation.html" title="Mongo::Error::InvalidTransactionOperation (class)">InvalidTransactionOperation</a></span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Sun Apr 19 20:31:34 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.24 (ruby-2.7.0).
</div>

    </div>
  </body>
</html>
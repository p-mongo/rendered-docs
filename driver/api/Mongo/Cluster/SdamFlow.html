<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Mongo::Cluster::SdamFlow
  
    &mdash; mongo-2.15.0.alpha
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Mongo::Cluster::SdamFlow";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (S)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Cluster.html" title="Mongo::Cluster (class)">Cluster</a></span></span>
     &raquo; 
    <span class="title">SdamFlow</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Mongo::Cluster::SdamFlow
  
  
  <span class="private note title">Private</span>
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Mongo::Cluster::SdamFlow</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  <dl>
      <dt>Extended by:</dt>
      <dd>Forwardable</dd>
  </dl>
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/mongo/cluster/sdam_flow.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This class is part of a private API.</strong>
  You should avoid using this class if possible, as it may be removed or be changed in the future.
</p>

<p>Handles SDAM flow for a server description changed event.</p>

<p>Updates server descriptions, topology descriptions and publishes SDAM events.</p>

<p>SdamFlow is meant to be instantiated once for every server description changed event that needs to be processed.</p>


  </div>
</div>
<div class="tags">
  

</div>



  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#cluster-instance_method" title="#cluster (instance method)">#<strong>cluster</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#original_desc-instance_method" title="#original_desc (instance method)">#<strong>original_desc</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#previous_desc-instance_method" title="#previous_desc (instance method)">#<strong>previous_desc</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#topology-instance_method" title="#topology (instance method)">#<strong>topology</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>The topology stored in this attribute can change multiple times throughout a single sdam flow (e.g. unknown -&gt; RS no primary -&gt; RS with primary).</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#updated_desc-instance_method" title="#updated_desc (instance method)">#<strong>updated_desc</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_servers_from_desc-instance_method" title="#add_servers_from_desc (instance method)">#<strong>add_servers_from_desc</strong>(updated_desc)  &#x21d2; Array&lt;Server&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Adds all servers referenced in the given description (which is supposed to have come from a good primary) which are not already in the cluster, to the cluster.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#awaited%3F-instance_method" title="#awaited? (instance method)">#<strong>awaited?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#became_unknown%3F-instance_method" title="#became_unknown? (instance method)">#<strong>became_unknown?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Returns whether the server whose description this flow processed was not previously unknown, and is now.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_if_has_primary-instance_method" title="#check_if_has_primary (instance method)">#<strong>check_if_has_primary</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Checks if the cluster has a primary, and if not, transitions the topology to ReplicaSetNoPrimary.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#commit_changes-instance_method" title="#commit_changes (instance method)">#<strong>commit_changes</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Publishes server description changed events, updates topology on the cluster and publishes topology changed event, as needed based on operations performed during SDAM flow processing.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#disconnect_servers-instance_method" title="#disconnect_servers (instance method)">#<strong>disconnect_servers</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#do_remove-instance_method" title="#do_remove (instance method)">#<strong>do_remove</strong>(address_str)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Removes specified server from topology and warns if the topology ends up with an empty server list as a result.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(cluster, previous_desc, updated_desc, awaited: false)  &#x21d2; SdamFlow </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>A new instance of SdamFlow.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#publish_description_change_event-instance_method" title="#publish_description_change_event (instance method)">#<strong>publish_description_change_event</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#remove-instance_method" title="#remove (instance method)">#<strong>remove</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Removes the server whose description we are processing from the topology.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#remove_servers_not_in_desc-instance_method" title="#remove_servers_not_in_desc (instance method)">#<strong>remove_servers_not_in_desc</strong>(updated_desc)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Removes servers from the topology which are not present in the given server description (which is supposed to have come from a good primary).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#server_description_changed-instance_method" title="#server_description_changed (instance method)">#<strong>server_description_changed</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stale_primary%3F-instance_method" title="#stale_primary? (instance method)">#<strong>stale_primary?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Whether updated_desc is for a stale primary.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#start_pool_if_data_bearing-instance_method" title="#start_pool_if_data_bearing (instance method)">#<strong>start_pool_if_data_bearing</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>If the server being processed is identified as data bearing, creates the server&#39;s connection pool so it can start populating.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#topology_effectively_changed%3F-instance_method" title="#topology_effectively_changed? (instance method)">#<strong>topology_effectively_changed?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Returns whether topology meaningfully changed as a result of running SDAM flow.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_rs_from_primary-instance_method" title="#update_rs_from_primary (instance method)">#<strong>update_rs_from_primary</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Updates topology which must be a ReplicaSetWithPrimary with information from the primary&#39;s server description.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_rs_with_primary_from_member-instance_method" title="#update_rs_with_primary_from_member (instance method)">#<strong>update_rs_with_primary_from_member</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Updates a ReplicaSetWithPrimary topology from a non-primary member.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_rs_without_primary-instance_method" title="#update_rs_without_primary (instance method)">#<strong>update_rs_without_primary</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Updates a ReplicaSetNoPrimary topology from a non-primary member.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_server_descriptions-instance_method" title="#update_server_descriptions (instance method)">#<strong>update_server_descriptions</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Updates descriptions on all servers whose address matches updated_desc&#39;s address.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_unknown_with_standalone-instance_method" title="#update_unknown_with_standalone (instance method)">#<strong>update_unknown_with_standalone</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'>
<p>Transitions from unknown to single topology type, when a standalone server is discovered.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#verify_invariants-instance_method" title="#verify_invariants (instance method)">#<strong>verify_invariants</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  <span class="private note title">private</span>

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(cluster, previous_desc, updated_desc, awaited: false)  &#x21d2; <tt><span class='object_link'><a href="" title="Mongo::Cluster::SdamFlow (class)">SdamFlow</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Returns a new instance of SdamFlow.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


31
32
33
34
35
36
37
38</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 31</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_previous_desc'>previous_desc</span><span class='comma'>,</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='comma'>,</span> <span class='label'>awaited:</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='ivar'>@cluster</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'>cluster</span>
  <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_topology'>topology</span>
  <span class='ivar'>@original_desc</span> <span class='op'>=</span> <span class='ivar'>@previous_desc</span> <span class='op'>=</span> <span class='id identifier rubyid_previous_desc'>previous_desc</span>
  <span class='ivar'>@updated_desc</span> <span class='op'>=</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span>
  <span class='ivar'>@servers_to_disconnect</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='ivar'>@awaited</span> <span class='op'>=</span> <span class='op'>!</span><span class='op'>!</span><span class='id identifier rubyid_awaited'>awaited</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="cluster-instance_method">
  
    #<strong>cluster</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


40
41
42</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 40</span>

<span class='kw'>def</span> <span class='id identifier rubyid_cluster'>cluster</span>
  <span class='ivar'>@cluster</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="original_desc-instance_method">
  
    #<strong>original_desc</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


56
57
58</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 56</span>

<span class='kw'>def</span> <span class='id identifier rubyid_original_desc'>original_desc</span>
  <span class='ivar'>@original_desc</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="previous_desc-instance_method">
  
    #<strong>previous_desc</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


54
55
56</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 54</span>

<span class='kw'>def</span> <span class='id identifier rubyid_previous_desc'>previous_desc</span>
  <span class='ivar'>@previous_desc</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="topology-instance_method">
  
    #<strong>topology</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>The topology stored in this attribute can change multiple times throughout a single sdam flow (e.g. unknown -&gt; RS no primary -&gt; RS with primary). Events for topology change get sent at the end of flow processing, such that the above example only publishes an unknown -&gt; RS with primary event to the application.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'>
<p>Mongo::Cluster::Topology The current topology.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 52</span>

<span class='kw'>def</span> <span class='id identifier rubyid_topology'>topology</span>
  <span class='ivar'>@topology</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="updated_desc-instance_method">
  
    #<strong>updated_desc</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


55
56
57</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 55</span>

<span class='kw'>def</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span>
  <span class='ivar'>@updated_desc</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_servers_from_desc-instance_method">
  
    #<strong>add_servers_from_desc</strong>(updated_desc)  &#x21d2; <tt>Array&lt;<span class='object_link'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span>&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>Servers are added unmonitored. Monitoring must be started later</p>
</div>
  </div>


<p>Adds all servers referenced in the given description (which is supposed to have come from a good primary) which are not already in the cluster, to the cluster.</p>

<p>separately.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;<span class='object_link'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span>&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Servers actually added to the cluster. This is the set of servers on which monitoring should be started.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


360
361
362
363
364
365
366
367
368
369
370
371
372
373
374</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 360</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_servers_from_desc'>add_servers_from_desc</span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_added_servers'>added_servers</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_address_strs'>address_strs</span> <span class='op'>=</span> <span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:address</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:to_s</span><span class='rparen'>)</span>
  <span class='qwords_beg'>%w(</span><span class='tstring_content'>hosts</span><span class='words_sep'> </span><span class='tstring_content'>passives</span><span class='words_sep'> </span><span class='tstring_content'>arbiters</span><span class='tstring_end'>)</span></span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span>
    <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_m'>m</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_address_str'>address_str</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='id identifier rubyid_address_str'>address_str</span><span class='comma'>,</span> <span class='label'>monitor:</span> <span class='kw'>false</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_added_servers'>added_servers</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_server'>server</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_verify_invariants'>verify_invariants</span>

  <span class='id identifier rubyid_added_servers'>added_servers</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="awaited?-instance_method">
  
    #<strong>awaited?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


58
59
60</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 58</span>

<span class='kw'>def</span> <span class='id identifier rubyid_awaited?'>awaited?</span>
  <span class='ivar'>@awaited</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="became_unknown?-instance_method">
  
    #<strong>became_unknown?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Returns whether the server whose description this flow processed was not previously unknown, and is now. Used to decide, in particular, whether to clear the server&#39;s connection pool.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


585
586
587</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 585</span>

<span class='kw'>def</span> <span class='id identifier rubyid_became_unknown?'>became_unknown?</span>
  <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_unknown?'>unknown?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_original_desc'>original_desc</span><span class='period'>.</span><span class='id identifier rubyid_unknown?'>unknown?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_if_has_primary-instance_method">
  
    #<strong>check_if_has_primary</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Checks if the cluster has a primary, and if not, transitions the topology to ReplicaSetNoPrimary. Topology must be ReplicaSetWithPrimary when invoking this method.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


554
555
556
557
558
559
560
561
562
563
564
565
566
567</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 554</span>

<span class='kw'>def</span> <span class='id identifier rubyid_check_if_has_primary'>check_if_has_primary</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set?'>replica_set?</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>check_if_has_primary should only be called when topology is replica set, but it is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_sub'>sub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>.*::</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_primary'>primary</span> <span class='op'>=</span> <span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_detect'>detect</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='comment'># A primary with the wrong set name is not a primary
</span>    <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_primary?'>primary?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_description'>description</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span> <span class='op'>==</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
  <span class='kw'>end</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_primary'>primary</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/ReplicaSetNoPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetNoPrimary (class)">ReplicaSetNoPrimary</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Topology/Base.html#initialize-instance_method" title="Mongo::Cluster::Topology::Base#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="commit_changes-instance_method">
  
    #<strong>commit_changes</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Publishes server description changed events, updates topology on the cluster and publishes topology changed event, as needed based on operations performed during SDAM flow processing.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 478</span>

<span class='kw'>def</span> <span class='id identifier rubyid_commit_changes'>commit_changes</span>
  <span class='comment'># The application-visible sequence of events should be as follows:
</span>  <span class='comment'>#
</span>  <span class='comment'># 1. Description change for the server which we are processing;
</span>  <span class='comment'># 2. Topology change, if any;
</span>  <span class='comment'># 3. Description changes for other servers, if any.
</span>  <span class='comment'>#
</span>  <span class='comment'># The tricky part here is that the server description changes are
</span>  <span class='comment'># not all processed together.
</span>
  <span class='id identifier rubyid_publish_description_change_event'>publish_description_change_event</span>
  <span class='id identifier rubyid_start_pool_if_data_bearing'>start_pool_if_data_bearing</span>

  <span class='id identifier rubyid_topology_changed_event_published'>topology_changed_event_published</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_equal?'>equal?</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_topology'>topology</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='ivar'>@need_topology_changed_event</span>
    <span class='comment'># We are about to publish topology changed event.
</span>    <span class='comment'># Recreate the topology instance to get its server descriptions
</span>    <span class='comment'># up to date.
</span>    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='rparen'>)</span>
    <span class='comment'># This sends the SDAM event
</span>    <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_update_topology'>update_topology</span><span class='lparen'>(</span><span class='id identifier rubyid_topology'>topology</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_topology_changed_event_published'>topology_changed_event_published</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='ivar'>@need_topology_changed_event</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='comment'># If a server description changed, topology description change event
</span>  <span class='comment'># must be published with the previous and next topologies being of
</span>  <span class='comment'># the same type, unless we already published topology change event
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_topology_changed_event_published'>topology_changed_event_published</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_unknown?'>unknown?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_previous_desc'>previous_desc</span><span class='period'>.</span><span class='id identifier rubyid_unknown?'>unknown?</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_object_id'>object_id</span> <span class='op'>==</span> <span class='id identifier rubyid_previous_desc'>previous_desc</span><span class='period'>.</span><span class='id identifier rubyid_object_id'>object_id</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_topology_effectively_changed?'>topology_effectively_changed?</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># If we are here, there has been a change in the server descriptions
</span>  <span class='comment'># in our topology, but topology class has not changed.
</span>  <span class='comment'># Publish the topology changed event and recreate the topology to
</span>  <span class='comment'># get the new list of server descriptions into it.
</span>  <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='rparen'>)</span>
  <span class='comment'># This sends the SDAM event
</span>  <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_update_topology'>update_topology</span><span class='lparen'>(</span><span class='id identifier rubyid_topology'>topology</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="disconnect_servers-instance_method">
  
    #<strong>disconnect_servers</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


530
531
532
533
534
535
536
537</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 530</span>

<span class='kw'>def</span> <span class='id identifier rubyid_disconnect_servers'>disconnect_servers</span>
  <span class='kw'>while</span> <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='ivar'>@servers_to_disconnect</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_connected?'>connected?</span>
      <span class='comment'># Do not publish server closed event, as this was already done
</span>      <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_disconnect!'>disconnect!</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="do_remove-instance_method">
  
    #<strong>do_remove</strong>(address_str)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Removes specified server from topology and warns if the topology ends up with an empty server list as a result</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 408</span>

<span class='kw'>def</span> <span class='id identifier rubyid_do_remove'>do_remove</span><span class='lparen'>(</span><span class='id identifier rubyid_address_str'>address_str</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_servers'>servers</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_remove'>remove</span><span class='lparen'>(</span><span class='id identifier rubyid_address_str'>address_str</span><span class='comma'>,</span> <span class='label'>disconnect:</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_servers'>servers</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='comment'># We need to publish server closed event here, but we cannot close
</span>    <span class='comment'># the server because it could be the server owning the monitor in
</span>    <span class='comment'># whose thread this flow is presently executing, in which case closing
</span>    <span class='comment'># the server can terminate the thread and leave SDAM processing
</span>    <span class='comment'># incomplete. Thus we have to remove the server from the cluster,
</span>    <span class='comment'># publish the event, but do not call disconnect on the server until
</span>    <span class='comment'># the very end when all processing has completed.
</span>    <span class='id identifier rubyid_publish_sdam_event'>publish_sdam_event</span><span class='lparen'>(</span>
      <span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Monitoring.html#SERVER_CLOSED-constant" title="Mongo::Monitoring::SERVER_CLOSED (constant)">SERVER_CLOSED</a></span></span><span class='comma'>,</span>
      <span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Monitoring/Event/ServerClosed.html" title="Mongo::Monitoring::Event::ServerClosed (class)">ServerClosed</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Monitoring/Event/ServerClosed.html#initialize-instance_method" title="Mongo::Monitoring::Event::ServerClosed#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_topology'>topology</span><span class='rparen'>)</span>
    <span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='ivar'>@servers_to_disconnect</span> <span class='op'>+=</span> <span class='id identifier rubyid_servers'>servers</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Topology now has no servers - this is likely a misconfiguration of the cluster and/or the application</span><span class='tstring_end'>&quot;</span></span>
    <span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="publish_description_change_event-instance_method">
  
    #<strong>publish_description_change_event</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 431</span>

<span class='kw'>def</span> <span class='id identifier rubyid_publish_description_change_event'>publish_description_change_event</span>
  <span class='comment'># This method may be invoked when server description definitely changed
</span>  <span class='comment'># but prior to the topology getting updated. Therefore we check both
</span>  <span class='comment'># server description changes and overall topology changes. When this
</span>  <span class='comment'># method is called at the end of SDAM flow as part of &quot;commit changes&quot;
</span>  <span class='comment'># step, server description change is incorporated into the topology
</span>  <span class='comment'># change.
</span>  <span class='kw'>unless</span> <span class='ivar'>@server_description_changed</span> <span class='op'>||</span> <span class='id identifier rubyid_topology_effectively_changed?'>topology_effectively_changed?</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># updated_desc here may not be the description we received from
</span>  <span class='comment'># the server - in case of a stale primary, the server reported itself
</span>  <span class='comment'># as being a primary but updated_desc here will be unknown.
</span>
  <span class='comment'># We used to not notify on Unknown -&gt; Unknown server changes.
</span>  <span class='comment'># Technically these are valid state changes (or at least as valid as
</span>  <span class='comment'># other server description changes when the description has not
</span>  <span class='comment'># changed meaningfully but the events are still published).
</span>  <span class='comment'># The current version of the driver notifies on Unknown -&gt; Unknown
</span>  <span class='comment'># transitions.
</span>
  <span class='comment'># Avoid dispatching events when updated description is the same as
</span>  <span class='comment'># previous description. This allows this method to be called multiple
</span>  <span class='comment'># times in the flow when the events should be published, without
</span>  <span class='comment'># worrying about whether there are any unpublished changes.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_object_id'>object_id</span> <span class='op'>==</span> <span class='id identifier rubyid_previous_desc'>previous_desc</span><span class='period'>.</span><span class='id identifier rubyid_object_id'>object_id</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_publish_sdam_event'>publish_sdam_event</span><span class='lparen'>(</span>
    <span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Monitoring.html#SERVER_DESCRIPTION_CHANGED-constant" title="Mongo::Monitoring::SERVER_DESCRIPTION_CHANGED (constant)">SERVER_DESCRIPTION_CHANGED</a></span></span><span class='comma'>,</span>
    <span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Monitoring.html" title="Mongo::Monitoring (class)">Monitoring</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Monitoring/Event.html" title="Mongo::Monitoring::Event (module)">Event</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Monitoring/Event/ServerDescriptionChanged.html" title="Mongo::Monitoring::Event::ServerDescriptionChanged (class)">ServerDescriptionChanged</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Monitoring/Event/ServerDescriptionChanged.html#initialize-instance_method" title="Mongo::Monitoring::Event::ServerDescriptionChanged#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span>
      <span class='id identifier rubyid_topology'>topology</span><span class='comma'>,</span>
      <span class='id identifier rubyid_previous_desc'>previous_desc</span><span class='comma'>,</span>
      <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='comma'>,</span>
      <span class='label'>awaited:</span> <span class='id identifier rubyid_awaited?'>awaited?</span><span class='comma'>,</span>
    <span class='rparen'>)</span>
  <span class='rparen'>)</span>
  <span class='ivar'>@previous_desc</span> <span class='op'>=</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span>
  <span class='ivar'>@need_topology_changed_event</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="remove-instance_method">
  
    #<strong>remove</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Removes the server whose description we are processing from the topology.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 401</span>

<span class='kw'>def</span> <span class='id identifier rubyid_remove'>remove</span>
  <span class='id identifier rubyid_publish_description_change_event'>publish_description_change_event</span>
  <span class='id identifier rubyid_do_remove'>do_remove</span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="remove_servers_not_in_desc-instance_method">
  
    #<strong>remove_servers_not_in_desc</strong>(updated_desc)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Removes servers from the topology which are not present in the given server description (which is supposed to have come from a good primary).</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 379</span>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_servers_not_in_desc'>remove_servers_not_in_desc</span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_updated_desc_address_strs'>updated_desc_address_strs</span> <span class='op'>=</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>hosts</span><span class='words_sep'> </span><span class='tstring_content'>passives</span><span class='words_sep'> </span><span class='tstring_content'>arbiters</span><span class='tstring_end'>)</span></span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span>
    <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_m'>m</span><span class='rparen'>)</span>
  <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span>
  <span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_updated_desc_address_strs'>updated_desc_address_strs</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_address_str'>address_str</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_updated_host'>updated_host</span> <span class='op'>=</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_me'>me</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_me'>me</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_host'>updated_host</span>
        <span class='id identifier rubyid_updated_host'>updated_host</span> <span class='op'>+=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> (self-identified as </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_me'>me</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_address_str'>address_str</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it is not in hosts reported by primary </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_host'>updated_host</span><span class='embexpr_end'>}</span><span class='tstring_content'>. Reported hosts are: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
        <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_hosts'>hosts</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='rparen'>)</span>
      <span class='id identifier rubyid_do_remove'>do_remove</span><span class='lparen'>(</span><span class='id identifier rubyid_address_str'>address_str</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="server_description_changed-instance_method">
  
    #<strong>server_description_changed</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 93</span>

<span class='kw'>def</span> <span class='id identifier rubyid_server_description_changed'>server_description_changed</span>
  <span class='ivar'>@previous_server_descriptions</span> <span class='op'>=</span> <span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_description'>description</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_update_server_descriptions'>update_server_descriptions</span>
    <span class='comment'># All of the transitions require that server whose updated_desc we are
</span>    <span class='comment'># processing is still in the cluster (i.e., was not removed as a result
</span>    <span class='comment'># of processing another response, potentially concurrently).
</span>    <span class='comment'># If update_server_descriptions returned false we have no servers
</span>    <span class='comment'># in the topology for the description we are processing, stop.
</span>    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>case</span> <span class='id identifier rubyid_topology'>topology</span>
  <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/Single.html" title="Mongo::Cluster::Topology::Single (class)">Single</a></span></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span> <span class='op'>!=</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
        <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> has an incorrect replica set name &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;; expected &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
        <span class='rparen'>)</span>
        <span class='ivar'>@updated_desc</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Server/Description.html" title="Mongo::Server::Description (class)">Description</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Server/Description.html#initialize-instance_method" title="Mongo::Server::Description#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span>
          <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_average_round_trip_time'>average_round_trip_time</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_update_server_descriptions'>update_server_descriptions</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/Unknown.html" title="Mongo::Cluster::Topology::Unknown (class)">Unknown</a></span></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_standalone?'>standalone?</span>
      <span class='id identifier rubyid_update_unknown_with_standalone'>update_unknown_with_standalone</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_mongos?'>mongos?</span>
      <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/Sharded.html" title="Mongo::Cluster::Topology::Sharded (class)">Sharded</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Topology/Base.html#initialize-instance_method" title="Mongo::Cluster::Topology::Base#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_primary?'>primary?</span>
      <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Topology/Base.html#initialize-instance_method" title="Mongo::Cluster::Topology::Base#initialize (method)">new</a></span></span><span class='lparen'>(</span>
        <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>replica_set_name:</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='rparen'>)</span><span class='comma'>,</span>
        <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_update_rs_from_primary'>update_rs_from_primary</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_secondary?'>secondary?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_arbiter?'>arbiter?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_other?'>other?</span>
      <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/ReplicaSetNoPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetNoPrimary (class)">ReplicaSetNoPrimary</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Topology/Base.html#initialize-instance_method" title="Mongo::Cluster::Topology::Base#initialize (method)">new</a></span></span><span class='lparen'>(</span>
        <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>replica_set_name:</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='rparen'>)</span><span class='comma'>,</span>
        <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_update_rs_without_primary'>update_rs_without_primary</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/Sharded.html" title="Mongo::Cluster::Topology::Sharded (class)">Sharded</a></span></span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_unknown?'>unknown?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_mongos?'>mongos?</span>
      <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it is of the wrong type (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_server_type'>server_type</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='embexpr_end'>}</span><span class='tstring_content'>) - expected SHARDED</span><span class='tstring_end'>&quot;</span></span>
      <span class='rparen'>)</span>
      <span class='id identifier rubyid_remove'>remove</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_standalone?'>standalone?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_mongos?'>mongos?</span>
      <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it is of the wrong type (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_server_type'>server_type</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='embexpr_end'>}</span><span class='tstring_content'>) - expected a replica set member</span><span class='tstring_end'>&quot;</span></span>
      <span class='rparen'>)</span>
      <span class='id identifier rubyid_remove'>remove</span>
      <span class='id identifier rubyid_check_if_has_primary'>check_if_has_primary</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_primary?'>primary?</span>
      <span class='id identifier rubyid_update_rs_from_primary'>update_rs_from_primary</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_secondary?'>secondary?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_arbiter?'>arbiter?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_other?'>other?</span>
      <span class='id identifier rubyid_update_rs_with_primary_from_member'>update_rs_with_primary_from_member</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_check_if_has_primary'>check_if_has_primary</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/ReplicaSetNoPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetNoPrimary (class)">ReplicaSetNoPrimary</a></span></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_standalone?'>standalone?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_mongos?'>mongos?</span>
      <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it is of the wrong type (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_server_type'>server_type</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='embexpr_end'>}</span><span class='tstring_content'>) - expected a replica set member</span><span class='tstring_end'>&quot;</span></span>
      <span class='rparen'>)</span>
      <span class='id identifier rubyid_remove'>remove</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_primary?'>primary?</span>
      <span class='comment'># Here we change topology type to RS with primary, however
</span>      <span class='comment'># while processing updated_desc we may find that its RS name
</span>      <span class='comment'># does not match our existing RS name. For this reason
</span>      <span class='comment'># is is imperative to NOT pass updated_desc&#39;s RS name to
</span>      <span class='comment'># topology constructor here.
</span>      <span class='comment'># During processing we may remove the server whose updated_desc
</span>      <span class='comment'># we are be processing (e.g. the RS name mismatch case again),
</span>      <span class='comment'># in which case topoogy type will go back to RS without primary
</span>      <span class='comment'># in the check_if_has_primary step.
</span>      <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Topology/Base.html#initialize-instance_method" title="Mongo::Cluster::Topology::Base#initialize (method)">new</a></span></span><span class='lparen'>(</span>
        <span class='comment'># Do not pass updated_desc&#39;s RS name here
</span>        <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='comma'>,</span>
        <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_update_rs_from_primary'>update_rs_from_primary</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_secondary?'>secondary?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_arbiter?'>arbiter?</span> <span class='op'>||</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_other?'>other?</span>
      <span class='id identifier rubyid_update_rs_without_primary'>update_rs_without_primary</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unknown topology </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_verify_invariants'>verify_invariants</span>
  <span class='id identifier rubyid_commit_changes'>commit_changes</span>
  <span class='id identifier rubyid_disconnect_servers'>disconnect_servers</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stale_primary?-instance_method">
  
    #<strong>stale_primary?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Whether updated_desc is for a stale primary.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


570
571
572
573
574
575
576
577
578
579
580</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 570</span>

<span class='kw'>def</span> <span class='id identifier rubyid_stale_primary?'>stale_primary?</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_election_id'>election_id</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_set_version'>set_version</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_max_election_id'>max_election_id</span> <span class='op'>&amp;&amp;</span>
        <span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_set_version'>set_version</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>||</span>
            <span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_set_version'>set_version</span> <span class='op'>==</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>&amp;&amp;</span>
                <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_election_id'>election_id</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_max_election_id'>max_election_id</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="start_pool_if_data_bearing-instance_method">
  
    #<strong>start_pool_if_data_bearing</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>If the server being processed is identified as data bearing, creates the server&#39;s connection pool so it can start populating</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


541
542
543
544
545
546
547
548
549</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 541</span>

<span class='kw'>def</span> <span class='id identifier rubyid_start_pool_if_data_bearing'>start_pool_if_data_bearing</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_data_bearing?'>data_bearing?</span>

  <span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span> <span class='op'>==</span> <span class='ivar'>@updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span>
      <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_pool'>pool</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="topology_effectively_changed?-instance_method">
  
    #<strong>topology_effectively_changed?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Returns whether topology meaningfully changed as a result of running SDAM flow.</p>

<p>The spec defines topology equality through equality of topology types and server descriptions in each topology; this definition is not usable by us because our topology objects do not hold server descriptions and are instead “live”. Thus we have to store the full list of server descriptions at the beginning of SDAM flow and compare them to the current ones.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


598
599
600
601
602
603
604
605
606
607
608</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 598</span>

<span class='kw'>def</span> <span class='id identifier rubyid_topology_effectively_changed?'>topology_effectively_changed?</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_equal?'>equal?</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_topology'>topology</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>true</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_server_descriptions'>server_descriptions</span> <span class='op'>=</span> <span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_description'>description</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='ivar'>@previous_server_descriptions</span> <span class='op'>!=</span> <span class='id identifier rubyid_server_descriptions'>server_descriptions</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_rs_from_primary-instance_method">
  
    #<strong>update_rs_from_primary</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Updates topology which must be a ReplicaSetWithPrimary with information from the primary&#39;s server description.</p>

<p>This method does not change topology type to ReplicaSetWithPrimary - this needs to have been done prior to calling this method.</p>

<p>If the primary whose description is being processed is determined to be stale, this method will change the server description and topology type to unknown.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 212</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_rs_from_primary'>update_rs_from_primary</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Topology/Base.html#initialize-instance_method" title="Mongo::Cluster::Topology::Base#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>replica_set_name:</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it has an </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>incorrect replica set name &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;; </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>expected &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
    <span class='rparen'>)</span>
    <span class='id identifier rubyid_remove'>remove</span>
    <span class='id identifier rubyid_check_if_has_primary'>check_if_has_primary</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_stale_primary?'>stale_primary?</span>
    <span class='ivar'>@updated_desc</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Server/Description.html" title="Mongo::Server::Description (class)">Description</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Server/Description.html#initialize-instance_method" title="Mongo::Server::Description#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span>
      <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_average_round_trip_time'>average_round_trip_time</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_update_server_descriptions'>update_server_descriptions</span>
    <span class='id identifier rubyid_check_if_has_primary'>check_if_has_primary</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_max_election_id'>max_election_id</span> <span class='op'>=</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_new_max_election_id'>new_max_election_id</span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>=</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_new_max_set_version'>new_max_set_version</span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_max_election_id'>max_election_id</span> <span class='op'>!=</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_max_election_id'>max_election_id</span> <span class='op'>||</span>
    <span class='id identifier rubyid_max_set_version'>max_set_version</span> <span class='op'>!=</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_max_set_version'>max_set_version</span>
  <span class='kw'>then</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/ReplicaSetWithPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetWithPrimary (class)">ReplicaSetWithPrimary</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Topology/Base.html#initialize-instance_method" title="Mongo::Cluster::Topology::Base#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span>
        <span class='label'>max_election_id:</span> <span class='id identifier rubyid_max_election_id'>max_election_id</span><span class='comma'>,</span>
        <span class='label'>max_set_version:</span> <span class='id identifier rubyid_max_set_version'>max_set_version</span>
      <span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># At this point we have accepted the updated server description
</span>  <span class='comment'># and the topology (both are primary). Commit these changes so that
</span>  <span class='comment'># their respective SDAM events are published before SDAM events for
</span>  <span class='comment'># server additions/removals that follow
</span>  <span class='id identifier rubyid_publish_description_change_event'>publish_description_change_event</span>

  <span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_primary?'>primary?</span>
        <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_update_description'>update_description</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Server/Description.html" title="Mongo::Server::Description (class)">Description</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Server/Description.html#initialize-instance_method" title="Mongo::Server::Description#initialize (method)">new</a></span></span><span class='lparen'>(</span>
          <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_description'>description</span><span class='period'>.</span><span class='id identifier rubyid_average_round_trip_time'>average_round_trip_time</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_servers'>servers</span> <span class='op'>=</span> <span class='id identifier rubyid_add_servers_from_desc'>add_servers_from_desc</span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_remove_servers_not_in_desc'>remove_servers_not_in_desc</span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_check_if_has_primary'>check_if_has_primary</span>

  <span class='id identifier rubyid_servers'>servers</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_start_monitoring'>start_monitoring</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_rs_with_primary_from_member-instance_method">
  
    #<strong>update_rs_with_primary_from_member</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Updates a ReplicaSetWithPrimary topology from a non-primary member.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 277</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_rs_with_primary_from_member'>update_rs_with_primary_from_member</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it has an </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>incorrect replica set name (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>); </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>current set name is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='rparen'>)</span>
    <span class='id identifier rubyid_remove'>remove</span>
    <span class='id identifier rubyid_check_if_has_primary'>check_if_has_primary</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_me_mismatch?'>me_mismatch?</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>reported itself as </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_me'>me</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='rparen'>)</span>
    <span class='id identifier rubyid_remove'>remove</span>
    <span class='id identifier rubyid_check_if_has_primary'>check_if_has_primary</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_have_primary'>have_primary</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_primary?'>primary?</span>
      <span class='id identifier rubyid_have_primary'>have_primary</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_have_primary'>have_primary</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/ReplicaSetNoPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetNoPrimary (class)">ReplicaSetNoPrimary</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Topology/Base.html#initialize-instance_method" title="Mongo::Cluster::Topology::Base#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_rs_without_primary-instance_method">
  
    #<strong>update_rs_without_primary</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Updates a ReplicaSetNoPrimary topology from a non-primary member.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 314</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_rs_without_primary'>update_rs_without_primary</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/ReplicaSetNoPrimary.html" title="Mongo::Cluster::Topology::ReplicaSetNoPrimary (class)">ReplicaSetNoPrimary</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Topology/Base.html#initialize-instance_method" title="Mongo::Cluster::Topology::Base#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>replica_set_name:</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it has an </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>incorrect replica set name (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>); </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>current set name is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_replica_set_name'>replica_set_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='rparen'>)</span>
    <span class='id identifier rubyid_remove'>remove</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_publish_description_change_event'>publish_description_change_event</span>

  <span class='id identifier rubyid_servers'>servers</span> <span class='op'>=</span> <span class='id identifier rubyid_add_servers_from_desc'>add_servers_from_desc</span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_commit_changes'>commit_changes</span>

  <span class='id identifier rubyid_servers'>servers</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_start_monitoring'>start_monitoring</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_me_mismatch?'>me_mismatch?</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>reported itself as </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_me'>me</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='rparen'>)</span>
    <span class='id identifier rubyid_remove'>remove</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_server_descriptions-instance_method">
  
    #<strong>update_server_descriptions</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Updates descriptions on all servers whose address matches updated_desc&#39;s address.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 66</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_server_descriptions'>update_server_descriptions</span>
  <span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span> <span class='op'>==</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span>
      <span class='comment'># SDAM flow must be run when topology version in the new description
</span>      <span class='comment'># is equal to the current topology version, per the example in
</span>      <span class='comment'># https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#what-is-the-purpose-of-topologyversion
</span>      <span class='kw'>unless</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_topology_version_gte?'>topology_version_gte?</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_description'>description</span><span class='rparen'>)</span>
        <span class='kw'>return</span> <span class='kw'>false</span>
      <span class='kw'>end</span>

      <span class='ivar'>@server_description_changed</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_description'>description</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_desc'>updated_desc</span>

      <span class='comment'># Always update server description, so that fields that do not
</span>      <span class='comment'># affect description equality comparisons but are part of the
</span>      <span class='comment'># description are updated.
</span>      <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_update_description'>update_description</span><span class='lparen'>(</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_update_last_scan'>update_last_scan</span>

      <span class='comment'># If there was no content difference between descriptions, we
</span>      <span class='comment'># still need to run sdam flow, but if the flow produces no change
</span>      <span class='comment'># in topology we will omit sending events.
</span>      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_unknown_with_standalone-instance_method">
  
    #<strong>update_unknown_with_standalone</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>

<p>Transitions from unknown to single topology type, when a standalone server is discovered.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


191
192
193
194
195
196
197
198
199
200
201</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 191</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_unknown_with_standalone'>update_unknown_with_standalone</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_seeds'>seeds</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='ivar'>@topology</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Topology.html" title="Mongo::Cluster::Topology (module)">Topology</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Topology/Single.html" title="Mongo::Cluster::Topology::Single (class)">Single</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Topology/Base.html#initialize-instance_method" title="Mongo::Cluster::Topology::Base#initialize (method)">new</a></span></span><span class='lparen'>(</span>
      <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='comma'>,</span> <span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_monitoring'>monitoring</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_log_warn'>log_warn</span><span class='lparen'>(</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_updated_desc'>updated_desc</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'> because it is a standalone and we have multiple seeds (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_seeds'>seeds</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
    <span class='rparen'>)</span>
    <span class='id identifier rubyid_remove'>remove</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="verify_invariants-instance_method">
  
    #<strong>verify_invariants</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note private">
  <strong>This method is part of a private API.</strong>
  You should avoid using this method if possible, as it may be removed or be changed in the future.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


610
611
612
613
614
615
616
617
618</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/cluster/sdam_flow.rb', line 610</span>

<span class='kw'>def</span> <span class='id identifier rubyid_verify_invariants'>verify_invariants</span>
  <span class='kw'>if</span> <span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span></span><span class='period'>.</span><span class='id identifier rubyid_enabled?'><span class='object_link'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_single?'>single?</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_servers_list'>servers_list</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>1</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Trying to create a single topology with multiple servers: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_servers_list'>servers_list</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Wed May 12 17:19:14 2021 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.26 (ruby-2.7.2).
</div>

    </div>
  </body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Mongo::ServerSelector::Selectable
  
    &mdash; mongo-2.12.1
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Mongo::ServerSelector::Selectable";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (S)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span></span>
     &raquo; 
    <span class="title">Selectable</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Mongo::ServerSelector::Selectable
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  
  <dl>
    <dt>Included in:</dt>
    <dd><span class='object_link'><a href="Nearest.html" title="Mongo::ServerSelector::Nearest (class)">Nearest</a></span>, <span class='object_link'><a href="Primary.html" title="Mongo::ServerSelector::Primary (class)">Primary</a></span>, <span class='object_link'><a href="PrimaryPreferred.html" title="Mongo::ServerSelector::PrimaryPreferred (class)">PrimaryPreferred</a></span>, <span class='object_link'><a href="Secondary.html" title="Mongo::ServerSelector::Secondary (class)">Secondary</a></span>, <span class='object_link'><a href="SecondaryPreferred.html" title="Mongo::ServerSelector::SecondaryPreferred (class)">SecondaryPreferred</a></span></dd>
  </dl>
  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/mongo/server_selector/selectable.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Provides common behavior for filtering a list of servers by server mode or tag set.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.0.0</p>
</div>
      
    </li>
  
</ul>

</div>



  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#max_staleness-instance_method" title="#max_staleness (instance method)">#<strong>max_staleness</strong>  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Max_staleness The maximum replication lag, in seconds, that a secondary can suffer and still be eligible for a read.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#options-instance_method" title="#options (instance method)">#<strong>options</strong>  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Options The options.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#tag_sets-instance_method" title="#tag_sets (instance method)">#<strong>tag_sets</strong>  &#x21d2; Array </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Tag_sets The tag sets used to select servers.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#==-instance_method" title="#== (instance method)">#<strong>==</strong>(other)  &#x21d2; true, false </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Check equality of two server selector.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#candidates-instance_method" title="#candidates (instance method)">#<strong>candidates</strong>(cluster)  &#x21d2; Array&lt;Server&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get the potential candidates to select from the cluster.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(options = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Initialize the server selector.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#inspect-instance_method" title="#inspect (instance method)">#<strong>inspect</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Inspect the server selector.</p>
</div></span>
  
</li>

      
        <li class="public deprecated">
  <span class="summary_signature">
    
      <a href="#local_threshold-instance_method" title="#local_threshold (instance method)">#<strong>local_threshold</strong>  &#x21d2; Float </a>
    

    
  </span>
  
  
  
  
  
  <span class="deprecated note title">deprecated</span>
  

  
    <span class="summary_desc"><strong>Deprecated.</strong> <div class='inline'>
<p>This setting is now taken from the cluster options when a server is selected. Will be removed in 3.0.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#local_threshold_with_cluster-instance_method" title="#local_threshold_with_cluster (instance method)">#<strong>local_threshold_with_cluster</strong>(cluster)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#select_server-instance_method" title="#select_server (instance method)">#<strong>select_server</strong>(cluster, ping = nil, session = nil)  &#x21d2; Mongo::Server </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Select a server from the specified cluster, taking into account mongos pinning for the specified session.</p>
</div></span>
  
</li>

      
        <li class="public deprecated">
  <span class="summary_signature">
    
      <a href="#server_selection_timeout-instance_method" title="#server_selection_timeout (instance method)">#<strong>server_selection_timeout</strong>  &#x21d2; Float </a>
    

    
  </span>
  
  
  
  
  
  <span class="deprecated note title">deprecated</span>
  

  
    <span class="summary_desc"><strong>Deprecated.</strong> <div class='inline'>
<p>This setting is now taken from the cluster options when a server is selected. Will be removed in 3.0.</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="max_staleness-instance_method">
  
    #<strong>max_staleness</strong>  &#x21d2; <tt>Integer</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns max_staleness The maximum replication lag, in seconds, that a secondary can suffer and still be eligible for a read.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>max_staleness The maximum replication lag, in seconds, that a secondary can suffer and still be eligible for a read.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.4.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


65
66
67</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 65</span>

<span class='kw'>def</span> <span class='id identifier rubyid_max_staleness'>max_staleness</span>
  <span class='ivar'>@max_staleness</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="options-instance_method">
  
    #<strong>options</strong>  &#x21d2; <tt>Hash</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns options The options.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>options The options.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.0.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


56
57
58</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 56</span>

<span class='kw'>def</span> <span class='id identifier rubyid_options'>options</span>
  <span class='ivar'>@options</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="tag_sets-instance_method">
  
    #<strong>tag_sets</strong>  &#x21d2; <tt>Array</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns tag_sets The tag sets used to select servers.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>tag_sets The tag sets used to select servers.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.0.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


59
60
61</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 59</span>

<span class='kw'>def</span> <span class='id identifier rubyid_tag_sets'>tag_sets</span>
  <span class='ivar'>@tag_sets</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="==-instance_method">
  
    #<strong>==</strong>(other)  &#x21d2; <tt>true</tt>, <tt>false</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Check equality of two server selector.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Check server selector equality.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_preference'>preference</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>other</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The other preference.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>true</tt>, <tt>false</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether the objects are equal.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.0.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


77
78
79
80
81</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 77</span>

<span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>&amp;&amp;</span>
    <span class='id identifier rubyid_tag_sets'>tag_sets</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_tag_sets'>tag_sets</span> <span class='op'>&amp;&amp;</span>
      <span class='id identifier rubyid_max_staleness'>max_staleness</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_max_staleness'>max_staleness</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="candidates-instance_method">
  
    #<strong>candidates</strong>(cluster)  &#x21d2; <tt>Array&lt;<span class='object_link'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span>&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get the potential candidates to select from the cluster.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Get the server candidates.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_selectable'>selectable</span><span class='period'>.</span><span class='id identifier rubyid_candidates'>candidates</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>cluster</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Cluster.html" title="Mongo::Cluster (class)">Cluster</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The cluster.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;<span class='object_link'><a href="../Server.html" title="Mongo::Server (class)">Server</a></span>&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The candidate servers.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.4.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


300
301
302
303
304
305
306
307
308
309
310
311
312</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 300</span>

<span class='kw'>def</span> <span class='id identifier rubyid_candidates'>candidates</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_single?'>single?</span>
    <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_servers'>servers</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span> <span class='id identifier rubyid_validate_max_staleness_support!'>validate_max_staleness_support!</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_sharded?'>sharded?</span>
    <span class='id identifier rubyid_local_threshold'>local_threshold</span> <span class='op'>=</span> <span class='id identifier rubyid_local_threshold_with_cluster'>local_threshold_with_cluster</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_near_servers'>near_servers</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_servers'>servers</span><span class='comma'>,</span> <span class='id identifier rubyid_local_threshold'>local_threshold</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
      <span class='id identifier rubyid_validate_max_staleness_support!'>validate_max_staleness_support!</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_validate_max_staleness_value!'>validate_max_staleness_value!</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_unknown?'>unknown?</span>
    <span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_servers'>servers</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="initialize-instance_method">
  
    #<strong>initialize</strong>(options = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Initialize the server selector.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Initialize the selector.</p>
</div></p>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Secondary.html" title="Mongo::ServerSelector::Secondary (class)">Secondary</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='symbol'>:tag_sets</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>dc</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>nyc</span><span class='tstring_end'>&#39;</span></span><span class='rbrace'>}</span><span class='rbracket'>]</span><span class='rparen'>)</span></code></pre>
    
      
        <p class="example_title"><div class='inline'>
<p>Initialize the preference with no options.</p>
</div></p>
      
      <pre class="example code"><code><span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Secondary.html" title="Mongo::ServerSelector::Secondary (class)">Secondary</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The server preference options.</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <p class="tag_title">Options Hash (<tt>options</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:local_threshold</span>
          <span class="type">(<tt>Integer</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The local threshold boundary for nearest selection in seconds.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">max_staleness</span>
          <span class="type">(<tt>Integer</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The maximum replication lag, in seconds, that a secondary can suffer and still be eligible for a read. A value of -1 is treated identically to nil, which is to not have a maximum staleness.</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Error/InvalidServerPreference.html" title="Mongo::Error::InvalidServerPreference (class)">Error::InvalidServerPreference</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>If tag sets are specified but not allowed.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.0.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


44
45
46
47
48
49
50
51
52
53</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 44</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>?</span> <span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span> <span class='op'>:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:max_staleness</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='op'>-</span><span class='int'>1</span>
    <span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:max_staleness</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='ivar'>@options</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span>
  <span class='ivar'>@tag_sets</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:tag_sets</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span>
  <span class='ivar'>@max_staleness</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:max_staleness</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_validate!'>validate!</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="inspect-instance_method">
  
    #<strong>inspect</strong>  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Inspect the server selector.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Inspect the server selector.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_selector'>selector</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The inspection.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.2.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


91
92
93</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 91</span>

<span class='kw'>def</span> <span class='id identifier rubyid_inspect'>inspect</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#&lt;</span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>:0x</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_object_id'>object_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> tag_sets=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_tag_sets'>tag_sets</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> max_staleness=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_max_staleness'>max_staleness</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="local_threshold-instance_method">
  
    #<strong>local_threshold</strong>  &#x21d2; <tt>Float</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <div class="note deprecated"><strong>Deprecated.</strong> <div class='inline'>
<p>This setting is now taken from the cluster options when a server is selected. Will be removed in 3.0.</p>
</div></div>

<p>Get the local threshold boundary for nearest selection in seconds.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Get the local threshold.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_selector'>selector</span><span class='period'>.</span><span class='id identifier rubyid_local_threshold'>local_threshold</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The local threshold.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.0.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


286
287
288</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 286</span>

<span class='kw'>def</span> <span class='id identifier rubyid_local_threshold'>local_threshold</span>
  <span class='ivar'>@local_threshold</span> <span class='op'>||=</span> <span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:local_threshold</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='const'><span class='object_link'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../ServerSelector.html#LOCAL_THRESHOLD-constant" title="Mongo::ServerSelector::LOCAL_THRESHOLD (constant)">LOCAL_THRESHOLD</a></span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="local_threshold_with_cluster-instance_method">
  
    #<strong>local_threshold_with_cluster</strong>(cluster)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.0.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


271
272
273</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 271</span>

<span class='kw'>def</span> <span class='id identifier rubyid_local_threshold_with_cluster'>local_threshold_with_cluster</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:local_threshold</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:local_threshold</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='const'><span class='object_link'><a href="../ServerSelector.html#LOCAL_THRESHOLD-constant" title="Mongo::ServerSelector::LOCAL_THRESHOLD (constant)">LOCAL_THRESHOLD</a></span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="select_server-instance_method">
  
    #<strong>select_server</strong>(cluster, ping = nil, session = nil)  &#x21d2; <tt><span class='object_link'><a href="../Server.html" title="Mongo::Server (class)">Mongo::Server</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Select a server from the specified cluster, taking into account mongos pinning for the specified session.</p>

<p>If the session is given and has a pinned server, this server is the only server considered for selection. If the server is of type mongos, it is returned immediately; otherwise monitoring checks on this server are initiated to update its status, and if the server becomes a mongos within the server selection timeout, it is returned.</p>

<p>If no session is given or the session does not have a pinned server, normal server selection process is performed among all servers in the specified cluster matching the preference of this server selector object. Monitoring checks are initiated on servers in the cluster until a suitable server is found, up to the server selection timeout.</p>

<p>If a suitable server is not found within the server selection timeout, this method raises Error::NoServerAvailable.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>cluster</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Cluster.html" title="Mongo::Cluster (class)">Mongo::Cluster</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The cluster from which to select an eligible server.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>ping</span>
      
      
        <span class='type'>(<tt>true</tt>, <tt>false</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Whether to ping the server before selection. Deprecated and ignored.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>session</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Session.html" title="Mongo::Session (class)">Session</a></span> | nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Optional session to take into account for mongos pinning. Added in version 2.10.0.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Server.html" title="Mongo::Server (class)">Mongo::Server</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A server matching the server preference.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">Error::NoServerAvailable</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>No server was found matching the specified preference / pinning requirement in the server selection timeout.</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">Error::LintError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An unexpected condition was detected, and lint mode is enabled.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.0.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 129</span>

<span class='kw'>def</span> <span class='id identifier rubyid_select_server'>select_server</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_ping'>ping</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_server_selection_timeout'>server_selection_timeout</span> <span class='op'>=</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:server_selection_timeout</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='const'><span class='object_link'><a href="../ServerSelector.html#SERVER_SELECTION_TIMEOUT-constant" title="Mongo::ServerSelector::SERVER_SELECTION_TIMEOUT (constant)">SERVER_SELECTION_TIMEOUT</a></span></span>

  <span class='comment'># Special handling for zero timeout: if we have to select a server,
</span>  <span class='comment'># and the timeout is zero, fail immediately (since server selection
</span>  <span class='comment'># will take some non-zero amount of time in any case).
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_server_selection_timeout'>server_selection_timeout</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failing server selection due to zero timeout. </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> Requested </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> in cluster: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_summary'>summary</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Error/NoServerAvailable.html#initialize-instance_method" title="Mongo::Error::NoServerAvailable#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_server_selection_timeout'>server_selection_timeout</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_pinned_server'>pinned_server</span>
    <span class='kw'>if</span> <span class='const'><span class='object_link'><a href="../../Mongo.html" title="Mongo (module)">Mongo</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span></span><span class='period'>.</span><span class='id identifier rubyid_enabled?'><span class='object_link'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span></span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_sharded?'>sharded?</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Session has a pinned server in a non-sharded topology: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_topology'>topology</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_in_transaction?'>in_transaction?</span>
      <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_unpin'>unpin</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_pinned_server'>pinned_server</span>      <span class='comment'># Here we assume that a mongos stays in the topology indefinitely.
</span>      <span class='comment'># This will no longer be the case once SRV polling is implemented.
</span>

      <span class='kw'>unless</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_mongos?'>mongos?</span>
        <span class='kw'>while</span> <span class='lparen'>(</span><span class='id identifier rubyid_time_remaining'>time_remaining</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='op'>&gt;</span> <span class='int'>0</span>
          <span class='id identifier rubyid_wait_for_server_selection'>wait_for_server_selection</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_time_remaining'>time_remaining</span><span class='rparen'>)</span>
        <span class='kw'>end</span>

        <span class='kw'>unless</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_mongos?'>mongos?</span>
          <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The session being used is pinned to the server which is not a mongos: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_summary'>summary</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(after </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server_selection_timeout'>server_selection_timeout</span><span class='embexpr_end'>}</span><span class='tstring_content'> seconds)</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Error/NoServerAvailable.html#initialize-instance_method" title="Mongo::Error::NoServerAvailable#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>

      <span class='kw'>return</span> <span class='id identifier rubyid_server'>server</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_replica_set?'>replica_set?</span>
    <span class='id identifier rubyid_validate_max_staleness_value_early!'>validate_max_staleness_value_early!</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_addresses'>addresses</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='kw'>if</span> <span class='const'><span class='object_link'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span></span><span class='period'>.</span><span class='id identifier rubyid_enabled?'><span class='object_link'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span></span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_servers'>servers</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cluster has no addresses but has servers: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_servers'>servers</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:inspect</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cluster has no addresses, and therefore will never have a server</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Error/NoServerAvailable.html#initialize-instance_method" title="Mongo::Error::NoServerAvailable#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='embdoc_beg'>=begin Add this check in version 3.0.0
</span><span class='embdoc'>  unless cluster.connected?
</span><span class='embdoc'>    msg = &#39;Cluster is disconnected&#39;
</span><span class='embdoc'>    raise Error::NoServerAvailable.new(self, cluster, msg)
</span><span class='embdoc'>  end
</span><span class='embdoc_end'>=end
</span>  <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_servers'>servers</span> <span class='op'>=</span> <span class='id identifier rubyid_candidates'>candidates</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='const'><span class='object_link'><a href="../Lint.html" title="Mongo::Lint (module)">Lint</a></span></span><span class='period'>.</span><span class='id identifier rubyid_enabled?'><span class='object_link'><a href="../Lint.html#enabled%3F-class_method" title="Mongo::Lint.enabled? (method)">enabled?</a></span></span>
      <span class='id identifier rubyid_servers'>servers</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_server'>server</span><span class='op'>|</span>
        <span class='comment'># It is possible for a server to have a nil average RTT here
</span>        <span class='comment'># because the ARTT comes from description which may be updated
</span>        <span class='comment'># by a background thread while server selection is running.
</span>        <span class='comment'># Currently lint mode is not a public feature, if/when this
</span>        <span class='comment'># changes (https://jira.mongodb.org/browse/RUBY-1576) the
</span>        <span class='comment'># requirement for ARTT to be not nil would need to be removed.
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_average_round_trip_time'>average_round_trip_time</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error/LintError.html" title="Mongo::Error::LintError (class)">LintError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Server </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span><span class='embexpr_end'>}</span><span class='tstring_content'> has nil average rtt</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_servers'>servers</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_servers'>servers</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_compatible?'>compatible?</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error/UnsupportedFeatures.html" title="Mongo::Error::UnsupportedFeatures (class)">UnsupportedFeatures</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_topology'>topology</span><span class='period'>.</span><span class='id identifier rubyid_compatibility_error'>compatibility_error</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='kw'>end</span>

      <span class='comment'># This list of servers may be ordered in a specific way
</span>      <span class='comment'># by the selector (e.g. for secondary preferred, the first
</span>      <span class='comment'># server may be a secondary and the second server may be primary)
</span>      <span class='comment'># and we should take the first server here respecting the order
</span>      <span class='id identifier rubyid_server'>server</span> <span class='op'>=</span> <span class='id identifier rubyid_servers'>servers</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_starting_transaction?'>starting_transaction?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_sharded?'>sharded?</span>
        <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_pin'>pin</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='rparen'>)</span>
      <span class='kw'>end</span>

      <span class='kw'>return</span> <span class='id identifier rubyid_server'>server</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_scan!'>scan!</span><span class='lparen'>(</span><span class='kw'>false</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_time_remaining'>time_remaining</span> <span class='op'>=</span> <span class='id identifier rubyid_deadline'>deadline</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_time_remaining'>time_remaining</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_wait_for_server_selection'>wait_for_server_selection</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_time_remaining'>time_remaining</span><span class='rparen'>)</span>

      <span class='comment'># If we wait for server selection, perform another round of
</span>      <span class='comment'># attempting to locate a suitable server. Otherwise server selection
</span>      <span class='comment'># can raise NoServerAvailable message when the diagnostics
</span>      <span class='comment'># reports an available server of the requested type.
</span>    <span class='kw'>else</span>
      <span class='kw'>break</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> server is available in cluster: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cluster'>cluster</span><span class='period'>.</span><span class='id identifier rubyid_summary'>summary</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>with timeout=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_server_selection_timeout'>server_selection_timeout</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>LT=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_local_threshold_with_cluster'>local_threshold_with_cluster</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>+=</span> <span class='id identifier rubyid_server_selection_diagnostic_message'>server_selection_diagnostic_message</span><span class='lparen'>(</span><span class='id identifier rubyid_cluster'>cluster</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Error/NoServerAvailable.html#initialize-instance_method" title="Mongo::Error::NoServerAvailable#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_cluster'>cluster</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
<span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="../Error.html" title="Mongo::Error (class)">Error</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Error/NoServerAvailable.html" title="Mongo::Error::NoServerAvailable (class)">NoServerAvailable</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_in_transaction?'>in_transaction?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_committing_transaction?'>committing_transaction?</span>
    <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_add_label'>add_label</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TransientTransactionError</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_session'>session</span><span class='period'>.</span><span class='id identifier rubyid_committing_transaction?'>committing_transaction?</span>
    <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_add_label'>add_label</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UnknownTransactionCommitResult</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="server_selection_timeout-instance_method">
  
    #<strong>server_selection_timeout</strong>  &#x21d2; <tt>Float</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <div class="note deprecated"><strong>Deprecated.</strong> <div class='inline'>
<p>This setting is now taken from the cluster options when a server is selected. Will be removed in 3.0.</p>
</div></div>

<p>Get the timeout for server selection.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'>
<p>Get the server selection timeout, in seconds.</p>
</div></p>
      
      <pre class="example code"><code><span class='id identifier rubyid_selector'>selector</span><span class='period'>.</span><span class='id identifier rubyid_server_selection_timeout'>server_selection_timeout</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The timeout.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Since:</p>
<ul class="since">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>2.0.0</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


266
267
268
269</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/mongo/server_selector/selectable.rb', line 266</span>

<span class='kw'>def</span> <span class='id identifier rubyid_server_selection_timeout'>server_selection_timeout</span>
  <span class='ivar'>@server_selection_timeout</span> <span class='op'>||=</span>
    <span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:server_selection_timeout</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='const'><span class='object_link'><a href="../ServerSelector.html" title="Mongo::ServerSelector (module)">ServerSelector</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../ServerSelector.html#SERVER_SELECTION_TIMEOUT-constant" title="Mongo::ServerSelector::SERVER_SELECTION_TIMEOUT (constant)">SERVER_SELECTION_TIMEOUT</a></span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Wed May 27 15:05:30 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.24 (ruby-2.7.1).
</div>

    </div>
  </body>
</html>
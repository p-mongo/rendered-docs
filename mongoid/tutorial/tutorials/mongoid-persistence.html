<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
  <link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css' /><title>Persistence &mdash; Mongoid Manual upcoming</title><link rel="shortcut icon" href="https://media.mongodb.org/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index" />

  <meta name="release" content="upcoming"/>
  <meta name="version" content="master"/>
  <meta name="DC.Source" content="https://github.com/mongodb/docs-mongoid/blob/master/source/tutorials/mongoid-persistence.txt"/>
  <meta property="og:image" content="http://s3.amazonaws.com/info-mongodb-com/_com_assets/cms/mongodb-for-giant-ideas-bbab5c3cf8.png">
  <meta property="og:image:secure_url" content="https://webassets.mongodb.com/_com_assets/cms/mongodb-for-giant-ideas-bbab5c3cf8.png">
    <link rel="canonical" href="http://docs.mongodb.com/mongoid/tutorials/mongoid-persistence" />
  
   <link rel="stylesheet" href="../_static/mongodb-docs.css" type="text/css" />
   <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
   <link rel="stylesheet" href="../_static/css/navbar.min.css?t=nocache" type="text/css" />
    
    <script type="text/javascript" src="../_static/lib/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/lib/bootstrap.js"></script>
    <script type="text/javascript" src="../_static/lib/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/controller.js"></script>
      <link rel="search" type="application/opensearchdescription+xml" href="https://docs.mongodb.com/osd.xml" title="MongoDB Help"/>
<!-- <link rel="index" title="Index" href="../genindex.html" /> -->
<link rel="search" title="Search" href="../search.html" />
<link rel="top" title="Mongoid Manual" href="../index.html" />
<link rel="next" title="Queries" href="mongoid-queries.html" />
<link rel="prev" title="Documents" href="mongoid-documents.html" /><script type='text/javascript'>
   var gptadslots=[];
   var googletag = googletag || {};
   googletag.cmd = googletag.cmd || [];
   (function(){ var gads = document.createElement('script');
      gads.async = true; gads.type = 'text/javascript';
      var useSSL = 'https:' == document.location.protocol;
      gads.src = (useSSL ? 'https:' : 'http:') + '//www.googletagservices.com/tag/js/gpt.js';
      var node = document.getElementsByTagName('script')[0];
      node.parentNode.insertBefore(gads, node);
   })();
</script>

<script type="text/javascript">
   googletag.cmd.push(function() {

      var pathname = location.href;
      
      if ( (pathname.indexOf("auth") >= 0) || (pathname.indexOf("security") >= 0) ) {
         gptadslots[1]= googletag.defineSlot('/40039723/docs.mongodb.org/security', [[160,600],[243,202],[293,244]],'mongodb-docs-1').addService(googletag.pubads());
      } else if ( (pathname.indexOf("crud") >= 0) ||  (pathname.indexOf("query") >= 0) || (pathname.indexOf("insert") >= 0) || (pathname.indexOf("update") >= 0) || (pathname.indexOf("remove") >= 0) || (pathname.indexOf("delete") >= 0) || (pathname.indexOf("aggregation") >= 0) ) {
         gptadslots[1]= googletag.defineSlot('/40039723/docs.mongodb.org/crud', [[160,600],[243,202],[293,244]],'mongodb-docs-1').addService(googletag.pubads());
      } else if (pathname.indexOf("shard") >= 0) {
         gptadslots[1]= googletag.defineSlot('/40039723/docs.mongodb.org/sharding', [[160,600],[243,202],[293,244]],'mongodb-docs-1').addService(googletag.pubads());
      } else if (pathname.indexOf("replica") >= 0) {
         gptadslots[1]= googletag.defineSlot('/40039723/docs.mongodb.org/replication', [[160,600],[243,202],[293,244]],'mongodb-docs-1').addService(googletag.pubads());
      } else if (pathname.indexOf("model") >= 0) {
         gptadslots[1]= googletag.defineSlot('/40039723/docs.mongodb.org/data-modeling', [[160,600],[243,202],[293,244]],'mongodb-docs-1').addService(googletag.pubads());
      } else if (pathname.indexOf("administration") >= 0) {
         gptadslots[1]= googletag.defineSlot('/40039723/docs.mongodb.org/support', [[160,600],[243,202],[293,244]],'mongodb-docs-1').addService(googletag.pubads());
      } else if (pathname.indexOf("install-mongodb-on-windows") >= 0) {
         gptadslots[1]= googletag.defineSlot('/40039723/docs.mongodb.org/install-mongodb-on-windows', [160, 600], 'mongodb-docs-1').addService(googletag.pubads());
      } else if (pathname.indexOf("tutorial/getting-started") >= 0) {
         gptadslots[1]= googletag.defineSlot('/40039723/docs.mongodb.org/docs_server_gettingstarted', [160, 600], 'mongodb-docs-1').addService(googletag.pubads());
      } else {
         //Adslot 1 declaration
         gptadslots[1]= googletag.defineSlot('/40039723/docs.mongodb.org', [[160,600],[243,202],[293,244]],'mongodb-docs-1').addService(googletag.pubads());
      }
      googletag.pubads().enableSingleRequest();
      googletag.pubads().enableAsyncRendering();
      googletag.enableServices();
   });
</script></head>
<body data-project="mongoid" data-project-title="Mongoid Manual" data-branch="master" data-enable-marian=1>
  <!-- Google Tag Manager -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-GDFN"
                    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
  {'gtm.start':new Date().getTime(),event:'gtm.js'}
  );var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-GDFN');
  </script>
  <!-- End Google Tag Manager --><div class="content" >

   <div id="left-column">
         <aside id="sidebar" class="sidebar">
             
  <div class="sphinxsidebar" id="sphinxsidebar">
    <div id="sphinxsidebarwrapper" class="sphinxsidebarwrapper"><a href="javascript:void(0)" class="closeNav" id="closeNav">Close &times;</a>


<h3>
  <a class="index-link" href="../index.html">Mongoid Manual</a>
</h3>


    <div class="btn-group version-sidebar">
      <button type="button" class="version-button dropdown-toggle" data-toggle="dropdown">
        
        
        master (upcoming)<span class="caret"></span>
      </button>
      <ul class="dropdown-menu" role="menu">
        
          
          <li class="active">
          
            <a href="#" data-path="mongoid/current">
              
              master (upcoming)
            </a>
          </li>
        
          
          <li>
          
            <a class="version-selector" href="#" data-path="mongoid/7.1">
              
              Version 7.1 (current)
            </a>
          </li>
        
          
          <li>
          
            <a class="version-selector" href="#" data-path="mongoid/7.0">
              
              Version 7.0
            </a>
          </li>
        
          
          <li>
          
            <a class="version-selector" href="#" data-path="mongoid/6.4">
              
              Version 6.4
            </a>
          </li>
        
          
          <li>
          
            <a class="version-selector" href="#" data-path="mongoid/6.3">
              
              Version 6.3
            </a>
          </li>
        
          
          <li>
          
            <a class="version-selector" href="#" data-path="mongoid/6.2">
              
              Version 6.2
            </a>
          </li>
        
          
          <li>
          
            <a class="version-selector" href="#" data-path="mongoid/6.1">
              
              Version 6.1
            </a>
          </li>
        
          
          <li>
          
            <a class="version-selector" href="#" data-path="mongoid/5.2">
              
              Version 5.2
            </a>
          </li>
        
      </ul>
    </div>


<ul class="current"><li class="toctree-l1"><a class="reference internal" href="getting-started-sinatra.html">Getting Started (Sinatra)</a></li><li class="toctree-l1"><a class="reference internal" href="getting-started-rails.html">Getting Started (Rails)</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-installation.html">Installation</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-configuration.html">Configuration</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-documents.html">Documents</a></li><li class="toctree-l1 current"><a class="reference internal current" href="">Persistence</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-queries.html">Queries</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-relations.html">Associations</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-nested-attributes.html">Nested Attributes</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-callbacks.html">Callbacks</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-validation.html">Validation</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-indexes.html">Indexes</a></li><li class="toctree-l1"><a class="reference internal" href="sharding.html">Sharding</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-sessions.html">Sessions</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-transactions.html">Transactions</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-rails.html">Rails Integration</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-upgrade.html">Upgrading Mongoid</a></li><li class="toctree-l1"><a class="reference external" href="https://docs.mongodb.com/mongoid/7.0/api/">API</a></li></ul>


    </div>
  </div>
           
         </aside>

   </div>

    <div id="main-column" class="main-column">

    <span id="showNav" class="showNav">Navigation</span>

      
        <div class="document">
            <div class="documentwrapper"><div class="bodywrapper">
              <div class="body" data-pagename="tutorials/mongoid-persistence">

                
  <div class="bc">
    
      
    
    
  </div>
                
                  <div class="section" id="persistence">
<h1>Persistence<a class="headerlink" href="#persistence" title="Permalink to this headline">¶</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><a class="reference internal" href="#standard" id="id2">Standard</a></li>
<li><a class="reference internal" href="#atomic" id="id3">Atomic</a><ul>
<li><a class="reference internal" href="#atomic-operation-grouping" id="id4">Atomic Operation Grouping</a></li>
</ul>
</li>
<li><a class="reference internal" href="#persistence-context-attributes" id="id5">Persistence Context Attributes</a></li>
<li><a class="reference internal" href="#custom" id="id6">Custom</a><ul>
<li><a class="reference internal" href="#model-level-persistence-options" id="id7">Model-Level Persistence Options</a></li>
<li><a class="reference internal" href="#runtime-persistence-options" id="id8">Runtime Persistence Options</a></li>
<li><a class="reference internal" href="#client-and-collection-access" id="id9">Client and Collection Access</a></li>
<li><a class="reference internal" href="#capped-collections" id="id10">Capped Collections</a></li>
<li><a class="reference internal" href="#set-a-default-collation-on-a-collection" id="id11">Set a Default Collation on a Collection</a></li>
</ul>
</li>
</ul>
</div>
<p>Mongoid supports all expected CRUD operations for those familiar with other
Ruby mappers like Active Record or Data Mapper. What distinguishes Mongoid
from other mappers for MongoDB is that the general persistence operations
perform atomic updates on only the fields that have changed instead of
writing the entire document to the database each time.</p>
<p>The persistence sections will provide examples on what database operation is
performed when executing the documented command.</p>
<div class="section" id="standard">
<h2>Standard<a class="headerlink" href="#standard" title="Permalink to this headline">¶</a></h2>
<p>Mongoid’s standard persistence methods come in the form of common methods you
would find in other mapping frameworks. The following table shows all standard
operations with examples.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model.create!</span></code></p>
<p><em>Insert a document or multiple documents into the database, raising an
error if a validation or server error occurs.</em></p>
<p><em>Pass a hash of attributes to create one document with the specified
attributes, or an array of hashes to create multiple documents.
If a single hash is passed, the corresponding document is returned.
If an array of hashes is passed, an array of documents corresponding
to the hashes is returned.</em></p>
<p><em>If a block is given to</em> <code class="docutils literal notranslate"><span class="pre">create!</span></code> <em>, it will be invoked with each
document as the argument in turn prior to attempting to save that
document.</em></p>
<p class="last"><em>If there is a problem saving any of the documents, such as
a validation error or a server error, an exception is raised
and, consequently, none of the documents are returned.
However, if an array of hashes was passed and previous documents were
successfully saved, those documents will remain in the database.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Person</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span>
  <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">,</span>
  <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Heine&quot;</span>
<span class="p">)</span> <span class="c1"># =&gt; Person instance</span>

<span class="no">Person</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">[</span>
  <span class="p">{</span> <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">,</span> <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Heine&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Willy&quot;</span><span class="p">,</span> <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Brandt&quot;</span> <span class="p">}</span>
<span class="o">]</span><span class="p">)</span> <span class="c1"># =&gt; Array of two Person instances</span>

<span class="no">Person</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="o">|</span>
  <span class="n">doc</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="s2">&quot;Heine&quot;</span>
<span class="k">end</span> <span class="c1"># =&gt; Person instance</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model.create</span></code></p>
<p><em>Instantiate a document or multiple documents and, if validations pass,
insert them into the database.</em></p>
<p><code class="docutils literal notranslate"><span class="pre">create</span></code> <em>is similar to</em> <code class="docutils literal notranslate"><span class="pre">create!</span></code> <em>but does not raise
exceptions on validation errors. It still raises errors on server
errors, such as trying to insert a document with an</em> <code class="docutils literal notranslate"><span class="pre">_id</span></code> <em>that
already exists in the collection.</em></p>
<p class="last"><em>If any validation errors are encountered, the respective document
is not inserted but is returned along with documents that were inserted.
Use</em> <code class="docutils literal notranslate"><span class="pre">persisted?</span></code> <em>,</em> <code class="docutils literal notranslate"><span class="pre">new_record?</span></code> <em>or</em> <code class="docutils literal notranslate"><span class="pre">errors</span></code> <em>methods
to check which of the returned documents were inserted into the
database.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
  <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">,</span>
  <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Heine&quot;</span>
<span class="p">)</span> <span class="c1"># =&gt; Person instance</span>

<span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">[</span>
  <span class="p">{</span> <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">,</span> <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Heine&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Willy&quot;</span><span class="p">,</span> <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Brandt&quot;</span> <span class="p">}</span>
<span class="o">]</span><span class="p">)</span> <span class="c1"># =&gt; Array of two Person instances</span>

<span class="no">Person</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="o">|</span>
  <span class="n">doc</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="s2">&quot;Heine&quot;</span>
<span class="k">end</span> <span class="c1"># =&gt; Person instance</span>

<span class="k">class</span> <span class="nc">Post</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">validates_uniqueness_of</span> <span class="ss">:title</span>
<span class="k">end</span>

<span class="n">posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">[</span><span class="p">{</span><span class="ss">title</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">},</span> <span class="p">{</span><span class="ss">title</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">}</span><span class="o">]</span><span class="p">)</span>
<span class="c1"># =&gt; array of two Post instances</span>
<span class="n">posts</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span> <span class="n">post</span><span class="o">.</span><span class="n">persisted?</span> <span class="p">}</span> <span class="c1"># =&gt; [true, false]</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#save!</span></code></p>
<p><em>Save the changed attributes to the database atomically, or insert the document if
new. Raises an exception if validations fail or there is a server error.</em></p>
<p class="last"><em>Returns true if the changed attributes were saved, raises an exception otherwise.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">,</span>
  <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Heine&quot;</span>
<span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">save!</span>

<span class="n">person</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">&quot;Christian Johan&quot;</span>
<span class="n">person</span><span class="o">.</span><span class="n">save!</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#save</span></code></p>
<p><em>Save the changed attributes to the database atomically, or insert the document
if new.</em></p>
<p><em>Returns true if the changed attributes were saved. Returns false
if there were any validation errors. Raises an exception if
the document passed validation but there was a server error during
the save.</em></p>
<p class="last"><em>Pass</em> <code class="docutils literal notranslate"><span class="pre">validate:</span> <span class="pre">false</span></code> <em>option to bypass validations.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">,</span>
  <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Heine&quot;</span>
<span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">save</span>
<span class="n">person</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="ss">validate</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>

<span class="n">person</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">&quot;Christian Johan&quot;</span>
<span class="n">person</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#update_attributes</span></code></p>
<p class="last"><em>Update the document attributes in the database. Will return true if validation passed,
false if not.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span>
  <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Jean&quot;</span><span class="p">,</span>
  <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Zorg&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#update_attributes!</span></code></p>
<p class="last"><em>Update the document attributes in the database and raise an error if validation failed.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">update_attributes!</span><span class="p">(</span>
  <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Leo&quot;</span><span class="p">,</span>
  <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Tolstoy&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#update_attribute</span></code></p>
<p class="last"><em>Update a single attribute, bypassing validations.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">,</span> <span class="s2">&quot;Jean&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#upsert</span></code></p>
<p class="last"><em>Performs a MongoDB upsert on the document. If the document exists in the database,
it will get overwritten with the current attributes of the document in memory.
If the document does not exist in the database, it will be inserted. Note that
this only runs the</em> <code class="docutils literal notranslate"><span class="pre">{before|after|around}_upsert</span></code> <em>callbacks.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">,</span>
  <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Heine&quot;</span>
<span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">upsert</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#touch</span></code></p>
<p><em>Update the document’s updated_at timestamp, optionally with one extra
provided time field. This will cascade the touch to all</em>
<code class="docutils literal notranslate"><span class="pre">belongs_to</span></code> <em>associations of the document with the option set.
This operation skips validations and callbacks.</em></p>
<p class="last"><em>Attempting to touch a destroyed document will raise</em> <code class="docutils literal notranslate"><span class="pre">FrozenError</span></code>
* (as of Ruby 2.5,* <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> <em>on previous Ruby versions),
same as if attempting to update an attribute on a destroyed
document.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">touch</span>
<span class="n">person</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="ss">:audited_at</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#delete</span></code></p>
<p class="last"><em>Deletes the document from the database without running callbacks.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">delete</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#destroy</span></code></p>
<p class="last"><em>Deletes the document from the database while running destroy callbacks.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model.delete_all</span></code></p>
<p class="last"><em>Deletes all documents from the database without running any callbacks.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Person</span><span class="o">.</span><span class="n">delete_all</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model.destroy_all</span></code></p>
<p class="last"><em>Deletes all documents from the database while running callbacks. This is a
potentially expensive operation since all documents will be loaded into memory.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Person</span><span class="o">.</span><span class="n">destroy_all</span>
</pre></div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Mongoid provides the following persistence-related attributes:</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#new_record?</span></code></p>
<p class="last"><em>Returns</em> <code class="docutils literal notranslate"><span class="pre">true</span></code> <em>if the model instance has not yet been saved
to the database. Opposite of</em> <code class="docutils literal notranslate"><span class="pre">persisted?</span></code></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">,</span>
  <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Heine&quot;</span>
<span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">new_record?</span> <span class="c1"># =&gt; true</span>
<span class="n">person</span><span class="o">.</span><span class="n">save!</span>
<span class="n">person</span><span class="o">.</span><span class="n">new_record?</span> <span class="c1"># =&gt; false</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#persisted?</span></code></p>
<p class="last"><em>Returns</em> <code class="docutils literal notranslate"><span class="pre">true</span></code> <em>if the model instance has been saved
to the database. Opposite of</em> <code class="docutils literal notranslate"><span class="pre">new_record?</span></code></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="ss">first_name</span><span class="p">:</span> <span class="s2">&quot;Heinrich&quot;</span><span class="p">,</span>
  <span class="ss">last_name</span><span class="p">:</span> <span class="s2">&quot;Heine&quot;</span>
<span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">persisted?</span> <span class="c1"># =&gt; false</span>
<span class="n">person</span><span class="o">.</span><span class="n">save!</span>
<span class="n">person</span><span class="o">.</span><span class="n">persisted?</span> <span class="c1"># =&gt; true</span>
</pre></div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="atomic">
<h2>Atomic<a class="headerlink" href="#atomic" title="Permalink to this headline">¶</a></h2>
<p>Although Mongoid performs atomic operations under the covers by default,
there may be cases where you want to do this explicitly without persisting
other fields. Mongoid provides support for all of these operations as well.
When executing atomic operations via these methods, callbacks and validations
are not invoked.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#add_to_set</span></code></p>
<p class="last"><em>Performs an atomic $addToSet on the field.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">add_to_set</span><span class="p">(</span><span class="ss">aliases</span><span class="p">:</span> <span class="s2">&quot;Bond&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#bit</span></code></p>
<p class="last"><em>Performs an atomic $bit on the field.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">bit</span><span class="p">(</span><span class="ss">age</span><span class="p">:</span> <span class="p">{</span> <span class="ow">and</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="ow">or</span><span class="p">:</span> <span class="mi">12</span> <span class="p">})</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#inc</span></code></p>
<p class="last"><em>Performs an atomic $inc on the field.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="ss">age</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#pop</span></code></p>
<p class="last"><em>Performs an atomic $pop on the field.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="ss">aliases</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#pull</span></code></p>
<p class="last"><em>Performs an atomic $pull on the field.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="ss">aliases</span><span class="p">:</span> <span class="s2">&quot;Bond&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#pull_all</span></code></p>
<p class="last"><em>Performs an atomic $pullAll on the field.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">pull_all</span><span class="p">(</span><span class="ss">aliases</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;Bond&quot;</span><span class="p">,</span> <span class="s2">&quot;James&quot;</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#push</span></code></p>
<p class="last"><em>Performs an atomic $push on the field.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="ss">aliases</span><span class="p">:</span> <span class="o">[</span><span class="s2">&quot;007&quot;</span><span class="p">,</span><span class="s2">&quot;008&quot;</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#rename</span></code></p>
<p class="last"><em>Performs an atomic $rename on the field.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="ss">bday</span><span class="p">:</span> <span class="ss">:dob</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#set</span></code></p>
<p><em>Updates an attribute on the model instance and, if the instance
is already persisted, performs an atomic $set on the field, bypassing
validations.</em></p>
<p><code class="docutils literal notranslate"><span class="pre">set</span></code> <em>can also deeply set values on Hash fields.</em></p>
<p><code class="docutils literal notranslate"><span class="pre">set</span></code> <em>can also deeply set values on</em> <code class="docutils literal notranslate"><span class="pre">embeds_one</span></code> <em>associations.
If such an association’s document is nil, one will be created prior
to the update.</em></p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">set</span></code> <em>should not be used with</em> <code class="docutils literal notranslate"><span class="pre">has_one</span></code> <em>associations, as it
does not correctly work in such cases.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Ricky Bobby&quot;</span><span class="p">)</span>
<span class="n">person</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tyler Durden&quot;</span><span class="p">)</span> <span class="c1"># updates name in the database</span>


<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span>
<span class="n">person</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tyler Durden&quot;</span><span class="p">)</span> <span class="c1"># does not write to database</span>
<span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="c1"># =&gt; &quot;Tyler Durden&quot;</span>
<span class="n">person</span><span class="o">.</span><span class="n">persisted?</span> <span class="c1"># =&gt; true</span>


<span class="k">class</span> <span class="nc">Post</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:metadata</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span>
<span class="k">end</span>

<span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create!</span>
<span class="n">post</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;metadata.published_at&#39;</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
<span class="n">post</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="s1">&#39;published_at&#39;</span><span class="o">]</span> <span class="c1"># =&gt; Time instance</span>

<span class="n">post</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;metadata.approved.today&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">post</span><span class="o">.</span><span class="n">metadata</span><span class="o">[</span><span class="s1">&#39;approved&#39;</span><span class="o">]</span> <span class="c1"># =&gt; {&#39;today&#39; =&gt; true}</span>


<span class="k">class</span> <span class="nc">Flight</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">embeds_one</span> <span class="ss">:plan</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Plan</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">embedded_in</span> <span class="ss">:flight</span>

  <span class="n">field</span> <span class="ss">:route</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>

<span class="n">flight</span> <span class="o">=</span> <span class="no">Flight</span><span class="o">.</span><span class="n">create!</span>
<span class="n">flight</span><span class="o">.</span><span class="n">plan</span> <span class="c1"># =&gt; nil</span>
<span class="n">flight</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;plan.route&#39;</span><span class="p">,</span> <span class="s1">&#39;test route&#39;</span><span class="p">)</span>
<span class="n">flight</span><span class="o">.</span><span class="n">plan</span> <span class="c1"># =&gt; Plan instance</span>
<span class="n">flight</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">route</span> <span class="c1"># =&gt; &quot;test route&quot;</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Model#unset</span></code></p>
<p class="last"><em>Performs an atomic $unset on the field.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="atomic-operation-grouping">
<span id="id1"></span><h3>Atomic Operation Grouping<a class="headerlink" href="#atomic-operation-grouping" title="Permalink to this headline">¶</a></h3>
<p>Atomic operations may be grouped together using the <code class="docutils literal notranslate"><span class="pre">#atomically</span></code> method
on a document. All operations inside the block given to <code class="docutils literal notranslate"><span class="pre">#atomically</span></code>
are sent to the cluster in a single atomic command. For example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">atomically</span> <span class="k">do</span>
  <span class="n">person</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="ss">age</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">person</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Jake&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">#atomically</span></code> blocks may be nested. The default behavior is to write
changes performed by each block as soon as the block ends:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">atomically</span> <span class="k">do</span>
  <span class="n">person</span><span class="o">.</span><span class="n">atomically</span> <span class="k">do</span>
    <span class="n">person</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="ss">age</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">person</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Jake&#39;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">raise</span> <span class="s1">&#39;An exception&#39;</span>
  <span class="c1"># name and age changes are still persisted</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>This behavior can be changed by specifying the <code class="docutils literal notranslate"><span class="pre">join_context:</span> <span class="pre">true</span></code> option
to <code class="docutils literal notranslate"><span class="pre">#atomically</span></code>, or globally by setting the <code class="docutils literal notranslate"><span class="pre">join_contexts</span></code>
<a class="reference internal" href="mongoid-configuration.html#configuration-options"><span class="std std-ref">configuration option</span></a> to <code class="docutils literal notranslate"><span class="pre">true</span></code>. When
context joining is enabled, nested <code class="docutils literal notranslate"><span class="pre">#atomically</span></code> blocks are joined with
the outer blocks, and only the outermost block (or the first block where
<code class="docutils literal notranslate"><span class="pre">join_contexts</span></code> is false) actually writes changes to the cluster.
For example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span><span class="o">.</span><span class="n">atomically</span> <span class="k">do</span>
  <span class="n">person</span><span class="o">.</span><span class="n">atomically</span><span class="p">(</span><span class="ss">join_context</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">person</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="ss">age</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">person</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Jake&#39;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">raise</span> <span class="s1">&#39;An exception&#39;</span>
  <span class="c1"># name and age changes are not persisted</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>The context joining behavior can be enabled globally by default by setting
<code class="docutils literal notranslate"><span class="pre">join_context</span></code> option in Mongoid configuration. In this case specifying
<code class="docutils literal notranslate"><span class="pre">join_context:</span> <span class="pre">false</span></code> on an <code class="docutils literal notranslate"><span class="pre">#atomically</span></code> block can be used to
obtain the independent persistence context behavior.</p>
<p>If an exception is raised in an <code class="docutils literal notranslate"><span class="pre">#atomically</span></code> block which has not yet
persisted its changes to the cluster, any pending attribute changes on
Mongoid models are reverted. For example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Tom&#39;</span><span class="p">)</span>
<span class="k">begin</span>
  <span class="n">person</span><span class="o">.</span><span class="n">atomically</span> <span class="k">do</span>
    <span class="n">person</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="ss">age</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">person</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Jake&#39;</span><span class="p">)</span>
    <span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="c1"># =&gt; &#39;Jake&#39;</span>
    <span class="k">raise</span> <span class="s1">&#39;An exception&#39;</span>
  <span class="k">end</span>
<span class="k">rescue</span> <span class="no">Exception</span>
  <span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="c1"># =&gt; &#39;Tom&#39;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>Atomic operations described in this section apply to one document at a time,
therefore nesting <code class="docutils literal notranslate"><span class="pre">#atomically</span></code> blocks invoked on multiple documents does
not make changes to the different documents be persisted atomically together.
However, MongoDB offers <a class="reference internal" href="mongoid-transactions.html#transactions"><span class="std std-ref">multi-document transactions</span></a>
as of server version 4.0 which provide atomic persistence across multiple
documents.</p>
</div>
</div>
<div class="section" id="persistence-context-attributes">
<h2>Persistence Context Attributes<a class="headerlink" href="#persistence-context-attributes" title="Permalink to this headline">¶</a></h2>
<p>Mongoid provides <code class="docutils literal notranslate"><span class="pre">client_name</span></code>, <code class="docutils literal notranslate"><span class="pre">database_name</span></code> and <code class="docutils literal notranslate"><span class="pre">collection_name</span></code>
methods on model classes to determine the client, database and collection names
used for persistence:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">client_name</span>
<span class="c1"># =&gt; :default</span>

<span class="no">Band</span><span class="o">.</span><span class="n">database_name</span>
<span class="c1"># =&gt; &quot;mongoid&quot;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">collection_name</span>
<span class="c1"># =&gt; :bands</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="custom">
<h2>Custom<a class="headerlink" href="#custom" title="Permalink to this headline">¶</a></h2>
<p>There may be cases where you want to persist documents to different sources from their
defaults, or with different options from the default. Mongoid provides run-time support
for this as well as support on a per-model basis.</p>
<div class="section" id="model-level-persistence-options">
<h3>Model-Level Persistence Options<a class="headerlink" href="#model-level-persistence-options" title="Permalink to this headline">¶</a></h3>
<p>On a per-model basis, you can tell it to store in a custom collection name, a different
database, or a different client. The following example would store the Band class by
default into a collection named “artists” in the database named “music”, with the client “analytics”.</p>
<p>Note that the value supplied to the <code class="docutils literal notranslate"><span class="pre">client</span></code> option must be configured under <code class="docutils literal notranslate"><span class="pre">clients</span></code>
in your mongoid.yml.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">store_in</span> <span class="ss">collection</span><span class="p">:</span> <span class="s2">&quot;artists&quot;</span><span class="p">,</span> <span class="ss">database</span><span class="p">:</span> <span class="s2">&quot;music&quot;</span><span class="p">,</span> <span class="ss">client</span><span class="p">:</span> <span class="s2">&quot;analytics&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>If no <code class="docutils literal notranslate"><span class="pre">store_in</span></code> macro would have been provided, Mongoid would store the model in a
collection named “bands” in the default database in the default client.</p>
</div>
<div class="section" id="runtime-persistence-options">
<h3>Runtime Persistence Options<a class="headerlink" href="#runtime-persistence-options" title="Permalink to this headline">¶</a></h3>
<p>It is possible to change the client, database and collection, as well as
any of the MongoDB client options, used for persistence for a group of
operations by using the <code class="docutils literal notranslate"><span class="pre">with</span></code> method on a model class or instance:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">database</span><span class="p">:</span> <span class="s2">&quot;music-non-stop&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span>
  <span class="n">klass</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

  <span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">first</span>

  <span class="no">Band</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">collection</span><span class="p">:</span> <span class="s2">&quot;artists&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span>
  <span class="n">klass</span><span class="o">.</span><span class="n">delete_all</span>

  <span class="no">Band</span><span class="o">.</span><span class="n">delete_all</span>
<span class="k">end</span>

<span class="n">band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">client</span><span class="p">:</span> <span class="ss">:tertiary</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">band_object</span><span class="o">|</span>
  <span class="n">band_object</span><span class="o">.</span><span class="n">save!</span>

  <span class="n">band</span><span class="o">.</span><span class="n">save!</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">with</span></code> method creates a temporary persistence context and a MongoDB
client to be used for operations in the context. For the duration of the block,
the persistence context on the model class or instance that <code class="docutils literal notranslate"><span class="pre">with</span></code> was
called on is changed to the temporary persistence context. For convenience,
the model class or instance that <code class="docutils literal notranslate"><span class="pre">with</span></code> was called on is yielded to the
block.</p>
<p>The temporary persistence context applies to both queries and writes.</p>
<p>Care should be taken when performing persistence operations across different
persistence contexts. For example, if a document is saved in a temporary
persistence context, it may not exist in the default persistence context,
failing subsequent updates:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Scuba&quot;</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">collection</span><span class="p">:</span> <span class="s2">&quot;artists&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">band_object</span><span class="o">|</span>
  <span class="n">band_object</span><span class="o">.</span><span class="n">save!</span>
<span class="k">end</span>

<span class="c1"># This will not save - updates the collection &quot;bands&quot; which does not have</span>
<span class="c1"># the Scuba band</span>
<span class="n">band</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># This will update the document.</span>
<span class="n">band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">collection</span><span class="p">:</span> <span class="s2">&quot;artists&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">band_object</span><span class="o">|</span>
  <span class="n">band_object</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">1000</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>As of Mongoid 6.0, the <code class="docutils literal notranslate"><span class="pre">with</span></code> method must always be called with a block,
and the temporary persistence context exists only for the duration of the block.
This is because a new client is created under the covers with the options
passed to <code class="docutils literal notranslate"><span class="pre">with</span></code>. To ensure that this client is closed and its associated
resources are freed, the scope when this client could be used must be
well-defined.</p>
<div class="section" id="global-override">
<h4>Global Override<a class="headerlink" href="#global-override" title="Permalink to this headline">¶</a></h4>
<p>If you want to switch the persistence context for all operations at runtime, but don’t want
to be using with all over your code, Mongoid provides the ability to do this as the client
and database level globally. The methods for this are <code class="docutils literal notranslate"><span class="pre">Mongoid.override_client</span></code> and
<code class="docutils literal notranslate"><span class="pre">Mongoid.override_database</span></code>. A useful case for this are internationalized applications
that store information for different locales in different databases or clients, but the
schema in each remains the same.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BandsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:switch_database</span>
  <span class="n">after_filter</span> <span class="ss">:reset_database</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">switch_database</span>
    <span class="no">I18n</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:locale</span><span class="o">]</span> <span class="o">||</span> <span class="no">I18n</span><span class="o">.</span><span class="n">default_locale</span>
    <span class="no">Mongoid</span><span class="o">.</span><span class="n">override_database</span><span class="p">(</span><span class="s2">&quot;my_db_name_</span><span class="si">#{</span><span class="no">I18n</span><span class="o">.</span><span class="n">locale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">reset_database</span>
    <span class="no">Mongoid</span><span class="o">.</span><span class="n">override_database</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>In the above example, all persistence operations would be stored in the alternative
database for all remaining operations on this thread. This is why the after request
set the override back to nil - it ensures subsequent requests with no local params
use the default option.</p>
<p>Persistence context applies to both read and write operations. For example,
secondary reads can be performed as follows:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">read</span><span class="p">:</span> <span class="p">{</span><span class="ss">mode</span><span class="p">:</span> <span class="ss">:secondary</span><span class="p">})</span> <span class="k">do</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">count</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="client-and-collection-access">
<h3>Client and Collection Access<a class="headerlink" href="#client-and-collection-access" title="Permalink to this headline">¶</a></h3>
<p>If you want to drop down to the driver level to perform operations, you can grab
the Mongo client or collection from the model or document instance:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">mongo_client</span>
<span class="n">band</span><span class="o">.</span><span class="n">mongo_client</span>
<span class="no">Band</span><span class="o">.</span><span class="n">collection</span>
<span class="n">band</span><span class="o">.</span><span class="n">collection</span>
</pre></div>
</div>
</div>
<p>From here you also have the same runtime persistence options using the client’s <code class="docutils literal notranslate"><span class="pre">#with</span></code>:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">mongo_client</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">write</span><span class="p">:</span> <span class="p">{</span> <span class="ss">w</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span> <span class="ss">database</span><span class="p">:</span> <span class="s2">&quot;musik&quot;</span><span class="p">)</span>
<span class="n">client</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>You can also override the :read or :write options on the collection using the collections <code class="docutils literal notranslate"><span class="pre">#with</span></code>:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">collection_w_0</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">write</span><span class="p">:</span> <span class="p">{</span> <span class="ss">w</span><span class="p">:</span> <span class="mi">0</span> <span class="p">})</span>
<span class="n">collection_w_0</span><span class="o">[</span><span class="ss">:artists</span><span class="o">].</span><span class="n">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="capped-collections">
<h3>Capped Collections<a class="headerlink" href="#capped-collections" title="Permalink to this headline">¶</a></h3>
<p>Mongoid does not provide a mechanism for creating capped collections on the fly - you
will need to create these yourself one time up front either with the driver or via the
Mongo console.</p>
<p>To create a capped collection with the driver:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="ss">:capped</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">1024</span><span class="o">].</span><span class="n">create</span>
</pre></div>
</div>
</div>
<p>To create a capped collection from the Mongo console:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">capped</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">size</span><span class="o">:</span> <span class="mi">1024</span> <span class="p">});</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="set-a-default-collation-on-a-collection">
<h3>Set a Default Collation on a Collection<a class="headerlink" href="#set-a-default-collation-on-a-collection" title="Permalink to this headline">¶</a></h3>
<p>Mongoid does not provide a mechanism for creating a collection with a default collation.
Like capped collections, you will need to create the collection yourself one time, up-front,
either with the driver or via the Mongo console.</p>
<p>To create a collection with a default collation with the driver:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="ss">:collation</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:locale</span> <span class="o">=&gt;</span> <span class="s1">&#39;fr&#39;</span><span class="p">}</span><span class="o">].</span><span class="n">create</span>
</pre></div>
</div>
</div>
<p>To create a collection with a default collation from the Mongo console:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">collation</span><span class="o">:</span> <span class="p">{</span> <span class="nx">locale</span><span class="o">:</span> <span class="s1">&#39;fr&#39;</span> <span class="p">}</span> <span class="p">});</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

                
    <div id="btnv">
      <span class="btn-arrow-left">&larr; &nbsp;</span>
      <a class="btn-prev-text" href="mongoid-documents.html" title="Previous Section: Documents"><span>Documents</span></a>
      <a class="btn-next-text" href="mongoid-queries.html" title="Next Section: Queries"><span>Queries</span></a>
      <span class="btn-arrow-right">&nbsp;&rarr;</span>
    </div>
                  <div class="footer">
                    <div class="copyright">
                      <p>&copy; MongoDB, Inc 2008-present. MongoDB, Mongo, and the leaf logo are registered trademarks of MongoDB, Inc.</p>
                    </div>
                  </div>
              </div></div>
            </div>
        </div>
    </div>
    <div class="right-column">
      <div class="wrapper"> <div id='mongodb-docs-1'>
   <script type='text/javascript'>
      googletag.cmd.push(function() { googletag.display('mongodb-docs-1'); });
   </script>
</div>
            <div class="social">
               <a class="slack-icon" href="https://slackpass.io/mongo-db?jmp=docs" title="https://slackpass.io/mongo-db?jmp=docs"><i class="fab fa-slack" aria-hidden="true"></i></a>
               <a class="twitter-icon" href="https://twitter.com/MongoDB" title="https://twitter.com/MongoDB"><i class="fab fa-twitter-square"></i></a>
               <a class="youtube-icon" href="https://www.youtube.com/user/MongoDB" title="https://www.youtube.com/user/MongoDB"><i class="fab fa-youtube-square"></i></a>
               <a class="facebook-icon" href="https://www.facebook.com/mongodb" title="https://www.facebook.com/mongodb"><i class="fab fa-facebook-square"></i></a>
               <a class="stack-overflow-icon" href="https://stackoverflow.com/tags/mongodb/info" title="https://stackoverflow.com/tags/mongodb/info"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a>
            </div>
        

      </div>
    </div>
    
      <div id="rating-panel"></div>
    
    <div class="clearfix"></div>
  </div>
<div id="navbar" data-navprops='{"links": [{"url": "https://docs.mongodb.com/manual/","text": "Server"},{"url": "https://docs.mongodb.com/ecosystem/drivers/","text": "Drivers","active": true},{"url": "https://docs.mongodb.com/cloud/","text": "Cloud"},{"url": "https://docs.mongodb.com/tools/","text": "Tools"},{"url": "https://docs.mongodb.com/guides/","text": "Guides"}]}'></div>

  
    <script src="../_static/navbar.min.js"></script>
  

  

  <script type="text/javascript">
  // Bootstrap array of links that should trigger a full page reload
  window.docsExcludedNav = [];
  </script></body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
  <link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css' />
    <title>Queries</title><link rel="shortcut icon" href="https://media.mongodb.org/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index" />

  <meta name="release" content="upcoming"/>
  <meta name="version" content="master"/>
  <meta name="DC.Source" content="https://github.com/mongodb/docs-mongoid/blob/master/source/tutorials/mongoid-queries.txt"/>
  <meta property="og:image" content="http://s3.amazonaws.com/info-mongodb-com/_com_assets/cms/mongodb-for-giant-ideas-bbab5c3cf8.png">
  <meta property="og:image:secure_url" content="https://webassets.mongodb.com/_com_assets/cms/mongodb-for-giant-ideas-bbab5c3cf8.png">
    <link rel="canonical" href="https://docs.mongodb.com/mongoid/current/tutorials/mongoid-queries/" />
  
   <link rel="stylesheet" href="../_static/mongodb-docs.css" type="text/css" />
   <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
   <link rel="stylesheet" href="../_static/css/navbar.min.css?t=nocache" type="text/css" />
    
    <script type="text/javascript" src="../_static/lib/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/lib/bootstrap.js"></script>
    <script type="text/javascript" src="../_static/lib/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/controller.js"></script>
      <link rel="search" type="application/opensearchdescription+xml" href="https://docs.mongodb.com/osd.xml" title="MongoDB Help"/>
<link rel="search" title="Search" href="../search.html" />
<link rel="top" title="Mongoid Manual" href="../index.html" />
<link rel="next" title="Associations" href="mongoid-relations.html" />
<link rel="prev" title="Persistence" href="mongoid-persistence.html" /></head>
<body data-project="mongoid" data-project-title="Mongoid Manual" data-branch="master" data-enable-marian=1 data-eol="">
  <!-- Google Tag Manager -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-GDFN"
                    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
  {'gtm.start':new Date().getTime(),event:'gtm.js'}
  );var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-GDFN');
  </script>
  <!-- End Google Tag Manager -->
   <script>
     window.googleSearchCx = "014132741538533607290:xl0kbqanc9y"
     window.googleSearchPlaceholder = "Search Mongoid"
     window.googleSearchResultsUrl = "http://docs.mongodb.com/mongoid/master/search/"
   </script><div class="content" >

   <div id="left-column">
         <aside id="sidebar" class="sidebar">
             
  <div class="sphinxsidebar" id="sphinxsidebar">
    <div id="sphinxsidebarwrapper" class="sphinxsidebarwrapper"><a href="javascript:void(0)" class="closeNav" id="closeNav">Close &times;</a>


<h3>
  <a href="../index.html">Mongoid Manual</a>
</h3>


    <div class="btn-group version-sidebar">
      
        <button type="button" class="version-button dropdown-toggle" data-toggle="dropdown">
          
          
          master (upcoming)<span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
          
            
            <li class="active">
            
              <a href="#" data-path="mongoid/current">
                
                master (upcoming)
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="mongoid/7.2">
                
                Version 7.2 (current)
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="mongoid/7.1">
                
                Version 7.1
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="mongoid/7.0">
                
                Version 7.0
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="mongoid/6.4">
                
                Version 6.4
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="mongoid/6.3">
                
                Version 6.3
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="mongoid/6.2">
                
                Version 6.2
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="mongoid/6.1">
                
                Version 6.1
              </a>
            </li>
          
            
            <li>
            
              <a class="version-selector" href="#" data-path="mongoid/5.4">
                
                Version 5.4
              </a>
            </li>
          
        </ul>
      
    </div>


<ul class="current"><li class="toctree-l1"><a class="reference internal" href="getting-started-sinatra.html">Getting Started (Sinatra)</a></li><li class="toctree-l1"><a class="reference internal" href="getting-started-rails.html">Getting Started (Rails)</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-installation.html">Installation</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-configuration.html">Configuration</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-documents.html">Documents</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-persistence.html">Persistence</a></li><li class="toctree-l1 current"><a class="reference internal current" href="">Queries</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-relations.html">Associations</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-nested-attributes.html">Nested Attributes</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-callbacks.html">Callbacks</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-validation.html">Validation</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-indexes.html">Indexes</a></li><li class="toctree-l1"><a class="reference internal" href="sharding.html">Sharding</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-sessions.html">Sessions</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-transactions.html">Transactions</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-rails.html">Rails Integration</a></li><li class="toctree-l1"><a class="reference internal" href="mongoid-upgrade.html">Upgrading Mongoid</a></li><li class="toctree-l1"><a class="reference external" href="https://docs.mongodb.com/mongoid/master/api/">API</a></li><li class="toctree-l1"><a class="reference internal" href="../additional-resources.html">Additional Resources</a></li><li class="toctree-l1"><a class="reference internal" href="../ecosystem.html">Ecosystem</a></li></ul>
    </div>
  </div>
           
         </aside>

   </div>

    <div id="main-column" class="main-column">

    <span id="showNav" class="showNav">Navigation</span>

      
      
        <div class="document">
            <div class="documentwrapper"><div class="bodywrapper">
              <div class="body" data-pagename="tutorials/mongoid-queries">

                
  <div class="bc">
    
      
    
    
  </div>
                
                  <div class="section" id="queries">
<h1>Queries<a class="headerlink" href="#queries" title="Permalink to this headline">¶</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id13">Queries</a><ul>
<li><a class="reference internal" href="#condition-syntax" id="id14">Condition Syntax</a></li>
<li><a class="reference internal" href="#logical-operations" id="id15">Logical Operations</a></li>
<li><a class="reference internal" href="#incremental-query-construction" id="id16">Incremental Query Construction</a></li>
<li><a class="reference internal" href="#query-methods" id="id17">Query Methods</a></li>
<li><a class="reference internal" href="#projection" id="id18">Projection</a></li>
<li><a class="reference internal" href="#ordering" id="id19">Ordering</a></li>
<li><a class="reference internal" href="#query-cache" id="id20">Query Cache</a></li>
<li><a class="reference internal" href="#finding-by-id" id="id21">Finding By <code class="docutils literal notranslate"><span class="pre">_id</span></code></a></li>
<li><a class="reference internal" href="#id11" id="id22">Additional Query Methods</a></li>
<li><a class="reference internal" href="#eager-loading" id="id23">Eager Loading</a></li>
<li><a class="reference internal" href="#regular-expressions" id="id24">Regular Expressions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conditions-on-fields" id="id25">Conditions On Fields</a></li>
<li><a class="reference internal" href="#reloading" id="id26">Reloading</a></li>
<li><a class="reference internal" href="#queries-persistence" id="id27">Queries + Persistence</a></li>
<li><a class="reference internal" href="#scoping" id="id28">Scoping</a><ul>
<li><a class="reference internal" href="#named-scopes" id="id29">Named Scopes</a></li>
<li><a class="reference internal" href="#default-scopes" id="id30">Default Scopes</a></li>
<li><a class="reference internal" href="#class-methods" id="id31">Class Methods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#map-reduce" id="id32">Map/Reduce</a><ul>
<li><a class="reference internal" href="#execution" id="id33">Execution</a></li>
<li><a class="reference internal" href="#raw-results" id="id34">Raw Results</a></li>
<li><a class="reference internal" href="#statistics" id="id35">Statistics</a></li>
</ul>
</li>
<li><a class="reference internal" href="#text-search" id="id36">Text Search</a><ul>
<li><a class="reference internal" href="#defining-text-search-index" id="id37">Defining Text Search Index</a></li>
<li><a class="reference internal" href="#creating-text-index" id="id38">Creating Text Index</a></li>
<li><a class="reference internal" href="#querying-using-text-index" id="id39">Querying Using Text Index</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id1">
<h2>Queries<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Mongoid provides a rich query DSL inspired by ActiveRecord. A trivial query
looks as follows:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>A more complex query utilizing various Mongoid features could be as follows:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span>
  <span class="n">where</span><span class="p">(</span><span class="ss">:founded</span><span class="o">.</span><span class="n">gte</span> <span class="o">=&gt;</span> <span class="s2">&quot;1980-01-01&quot;</span><span class="p">)</span><span class="o">.</span>
  <span class="k">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;Tool&quot;</span><span class="p">,</span> <span class="s2">&quot;Deftones&quot;</span> <span class="o">]</span><span class="p">)</span><span class="o">.</span>
  <span class="n">union</span><span class="o">.</span>
  <span class="k">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;Melvins&quot;</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The query methods return <code class="docutils literal notranslate"><span class="pre">Mongoid::Criteria</span></code> objects, which are chainable
and lazily evaluated wrappers for MongoDB query language (MQL).
The queries are executed when their result sets are iterated. For example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Construct a Criteria object:</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Deftones&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;name&quot;=&gt;&quot;Deftones&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="c1"># Evaluate the query and get matching documents:</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Deftones&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1"># =&gt; [#&lt;Band _id: 5ebdeddfe1b83265a376a760, name: &quot;Deftones&quot;, description: nil&gt;]</span>
</pre></div>
</div>
</div>
<p>Methods like <code class="docutils literal notranslate"><span class="pre">first</span></code> and <code class="docutils literal notranslate"><span class="pre">last</span></code> return the individual documents immediately.
Otherwise, iterating a Criteria object with methods like <code class="docutils literal notranslate"><span class="pre">each</span></code> or <code class="docutils literal notranslate"><span class="pre">map</span></code>
retrieves the documents from the server. <code class="docutils literal notranslate"><span class="pre">to_a</span></code> can be used to force
execution of a query that returns an array of documents, literally converting
a Criteria object to an Array.</p>
<p>When a query method is called on a Criteria instance, the method returns a new
Criteria instance with the new conditions added to the existing conditions:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">scope</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:founded</span><span class="o">.</span><span class="n">gte</span> <span class="o">=&gt;</span> <span class="s2">&quot;1980-01-01&quot;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;{&quot;$gte&quot;=&gt;&quot;1980-01-01&quot;}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="n">scope</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:founded</span><span class="o">.</span><span class="n">lte</span> <span class="o">=&gt;</span> <span class="s2">&quot;2020-01-01&quot;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;{&quot;$gte&quot;=&gt;&quot;1980-01-01&quot;, &quot;$lte&quot;=&gt;&quot;2020-01-01&quot;}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="n">scope</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;{&quot;$gte&quot;=&gt;&quot;1980-01-01&quot;}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="condition-syntax">
<h3>Condition Syntax<a class="headerlink" href="#condition-syntax" title="Permalink to this headline">¶</a></h3>
<p>Mongoid supports three ways of specifying individual conditions:</p>
<ol class="arabic simple">
<li>Field syntax.</li>
<li>MQL syntax.</li>
<li>Symbol operator syntax.</li>
</ol>
<p>All syntaxes support querying embedded documents using the dot notation.
All syntaxes respect field types, if the field being queried is defined in the
model class, and field aliases.</p>
<p>The examples in this section use the following model definition:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:founded</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="n">field</span> <span class="ss">:m</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:member_count</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>

  <span class="n">embeds_one</span> <span class="ss">:manager</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manager</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">embedded_in</span> <span class="ss">:band</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="field-syntax">
<h4>Field Syntax<a class="headerlink" href="#field-syntax" title="Permalink to this headline">¶</a></h4>
<p>The simplest querying syntax utilizes the basic Ruby hashes. Keys can be
symbols or strings, and correspond to field names in MongoDB documents:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
<span class="c1">#   =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;name&quot;=&gt;&quot;Depeche Mode&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="c1"># Equivalent to:</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="mql-syntax">
<h4>MQL Syntax<a class="headerlink" href="#mql-syntax" title="Permalink to this headline">¶</a></h4>
<p>An MQL operator may be specified on any field using the hash syntax:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">founded</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span> <span class="o">=&gt;</span> <span class="mi">1980</span><span class="p">})</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;{&quot;$gt&quot;=&gt;1980}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="c1"># Equivalent to:</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;founded&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span> <span class="o">=&gt;</span> <span class="mi">1980</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="symbol-operator-syntax">
<h4>Symbol Operator Syntax<a class="headerlink" href="#symbol-operator-syntax" title="Permalink to this headline">¶</a></h4>
<p>MQL operators may be specified as methods on symbols for the respective field
name, as follows:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:founded</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">1980</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;{&quot;$gt&quot;=&gt;1980}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="embedded-documents">
<h4>Embedded Documents<a class="headerlink" href="#embedded-documents" title="Permalink to this headline">¶</a></h4>
<p>To match values of fields of embedded documents, use the dot notation:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;manager.name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;manager.name&quot;=&gt;&quot;Smith&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:&#39;manager.name&#39;</span><span class="o">.</span><span class="n">ne</span> <span class="o">=&gt;</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;manager.name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Smith&quot;}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Queries always return top-level model instances, even if all of the
conditions are referencing embedded documents.</p>
</div>
</div>
<div class="section" id="field-types">
<h4>Field Types<a class="headerlink" href="#field-types" title="Permalink to this headline">¶</a></h4>
<p>In order to query on a field, it is not necessary to add the field to
<a class="reference internal" href="mongoid-documents.html#fields"><span class="std std-ref">the model class definition</span></a>. However, if a field is defined in
the model class, the type of the field is taken into account when constructing
the query:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">2020</span><span class="p">)</span>
<span class="c1">#   =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;name&quot;=&gt;&quot;2020&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">founded</span><span class="p">:</span> <span class="mi">2020</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;2020}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="aliases">
<h4>Aliases<a class="headerlink" href="#aliases" title="Permalink to this headline">¶</a></h4>
<p>Queries take into account <a class="reference internal" href="mongoid-documents.html#storage-field-names"><span class="std std-ref">storage field names</span></a>
and <a class="reference internal" href="mongoid-documents.html#field-aliases"><span class="std std-ref">field aliases</span></a>:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>
<span class="c1">#   =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;n&quot;=&gt;&quot;Astral Projection&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
<p>Since <cite>id</cite> and <cite>_id</cite> fields are aliases, either one can be used for queries:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;5ebdeddfe1b83265a376a760&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;_id&quot;=&gt;BSON::ObjectId(&#39;5ebdeddfe1b83265a376a760&#39;)}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="logical-operations">
<span id="id2"></span><h3>Logical Operations<a class="headerlink" href="#logical-operations" title="Permalink to this headline">¶</a></h3>
<p>Mongoid supports <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code>, <code class="docutils literal notranslate"><span class="pre">nor</span></code> and <code class="docutils literal notranslate"><span class="pre">not</span></code> logical operations on
<code class="docutils literal notranslate"><span class="pre">Criteria</span></code> objects. These methods take one or more hash of conditions
or another <code class="docutils literal notranslate"><span class="pre">Criteria</span></code> object as their arguments, with <code class="docutils literal notranslate"><span class="pre">not</span></code> additionally
having an argument-free version.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># and with conditions</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust in Trance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>

<span class="c1"># or with scope</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust in Trance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">))</span>

<span class="c1"># not with conditions</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust in Trance&#39;</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>

<span class="c1"># argument-less not</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust in Trance&#39;</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For backwards compatibility with earlier Mongoid versions, all of the logical
operation methods also accept arrays of parameters, which will be flattened
to obtain the criteria. Passing arrays to logical operations is deprecated and
may be removed in a future version of Mongoid.</p>
<p>The following calls all produce the same query conditions:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Condition hashes passed to separate and invocations</span>
<span class="no">Band</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Multiple condition hashes in the same and invocation</span>
<span class="no">Band</span><span class="o">.</span><span class="n">and</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">},</span> <span class="p">{</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

<span class="c1"># Multiple condition hashes in an array - deprecated</span>
<span class="no">Band</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="o">[</span><span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">},</span> <span class="p">{</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span><span class="o">]</span><span class="p">)</span>

<span class="c1"># Condition hash in where and a scope</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">))</span>

<span class="c1"># Condition hash in and and a scope</span>
<span class="no">Band</span><span class="o">.</span><span class="n">and</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">},</span> <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">))</span>

<span class="c1"># Scope as an array element, nested arrays - deprecated</span>
<span class="no">Band</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="o">[</span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">),</span> <span class="o">[</span><span class="p">{</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span><span class="o">]]</span><span class="p">)</span>

<span class="c1"># All produce:</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;name&quot;=&gt;&quot;SUN Project&quot;, &quot;member_count&quot;=&gt;2}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="operator-combinations">
<h4>Operator Combinations<a class="headerlink" href="#operator-combinations" title="Permalink to this headline">¶</a></h4>
<p>As of Mongoid 7.1, logical operators (<code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code>, <code class="docutils literal notranslate"><span class="pre">nor</span></code> and <code class="docutils literal notranslate"><span class="pre">not</span></code>)
have been changed to have the the same semantics as <a class="reference external" href="https://guides.rubyonrails.org/active_record_querying.html">those of ActiveRecord</a>.
To obtain the semantics of <code class="docutils literal notranslate"><span class="pre">or</span></code> as it behaved in Mongoid 7.0 and earlier,
use <code class="docutils literal notranslate"><span class="pre">any_of</span></code> which is described below.</p>
<p>When conditions are specified on the same field multiple times, all
conditions are added to the criteria:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;&quot;1&quot;, &quot;$and&quot;=&gt;[{&quot;name&quot;=&gt;&quot;2&quot;}]}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;1&quot;}, {&quot;name&quot;=&gt;&quot;2&quot;}]}</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">any_of</span></code>, <code class="docutils literal notranslate"><span class="pre">nor</span></code> and <code class="docutils literal notranslate"><span class="pre">not</span></code> behave similarly, with <code class="docutils literal notranslate"><span class="pre">not</span></code> producing
different query shapes as described below.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code> and <code class="docutils literal notranslate"><span class="pre">nor</span></code> logical operators are used, they
operate on the criteria built up to that point and its argument.
<code class="docutils literal notranslate"><span class="pre">where</span></code> has the same meaning as <code class="docutils literal notranslate"><span class="pre">and</span></code>:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># or joins the two conditions</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Sun&quot;}, {&quot;label&quot;=&gt;&quot;Trust&quot;}]}</span>

<span class="c1"># or applies only to the first condition, the second condition is added</span>
<span class="c1"># to the top level as $and</span>
<span class="no">Band</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Sun&quot;}], &quot;label&quot;=&gt;&quot;Trust&quot;}</span>

<span class="c1"># Same as previous example - where and and are aliases</span>
<span class="no">Band</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Sun&quot;}], &quot;label&quot;=&gt;&quot;Trust&quot;}</span>

<span class="c1"># Same operator can be stacked any number of times</span>
<span class="no">Band</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Sun&quot;}, {&quot;label&quot;=&gt;&quot;Trust&quot;}]}</span>

<span class="c1"># The label: Foo condition is added to the top level as $and</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Sun&quot;}, {&quot;label&quot;=&gt;&quot;Trust&quot;}], &quot;label&quot;=&gt;&quot;Foo&quot;}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="and-behavior">
<h4><code class="docutils literal notranslate"><span class="pre">and</span></code> Behavior<a class="headerlink" href="#and-behavior" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">and</span></code> method will add new simple conditions to the top level of the
criteria, unless the receiving criteria already has a condition on the
respective fields, in which case the conditions will be combined with <code class="docutils literal notranslate"><span class="pre">$and</span></code>.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust in Trance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;label&quot;=&gt;&quot;Trust in Trance Records&quot;, &quot;name&quot;=&gt;&quot;Astral Projection&quot;}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;/Best/, &quot;$and&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Astral Projection&quot;}]}</span>
</pre></div>
</div>
</div>
<p>As of Mongoid 7.1, specifying multiple criteria on the same field with <code class="docutils literal notranslate"><span class="pre">and</span></code>
combines all criteria so specified, whereas in previous versions of Mongoid
conditions on a field sometimes replaced previously specified conditions on
the same field, depending on which form of <code class="docutils literal notranslate"><span class="pre">and</span></code> was used.</p>
</div>
<div class="section" id="or-nor-behavior">
<h4><code class="docutils literal notranslate"><span class="pre">or</span></code>/<code class="docutils literal notranslate"><span class="pre">nor</span></code> Behavior<a class="headerlink" href="#or-nor-behavior" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">or</span></code> and <code class="docutils literal notranslate"><span class="pre">nor</span></code> produce <code class="docutils literal notranslate"><span class="pre">$or</span></code> and <code class="docutils literal notranslate"><span class="pre">$nor</span></code> MongoDB operators, respectively,
using the receiver and all of the arguments as operands. For example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;/Best/}, {&quot;name&quot;=&gt;&quot;Astral Projection&quot;}]}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span>
  <span class="ow">or</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="sr">/Records/</span><span class="p">))</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;/Best/, &quot;$and&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Astral Projection&quot;}]}, {&quot;label&quot;=&gt;/Records/}], &quot;label&quot;=&gt;&quot;Trust&quot;}</span>
</pre></div>
</div>
</div>
<p>If the only condition on the receiver is another <code class="docutils literal notranslate"><span class="pre">or</span></code>/<code class="docutils literal notranslate"><span class="pre">nor</span></code>, the new
conditions are added to the existing list:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span>
  <span class="ow">or</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="sr">/Records/</span><span class="p">))</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;/Best/}, {&quot;name&quot;=&gt;&quot;Astral Projection&quot;}, {&quot;label&quot;=&gt;/Records/}]}</span>
</pre></div>
</div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">any_of</span></code> to add a disjunction to a Criteria object while maintaining
all of the conditions built up so far as they are.</p>
</div>
<div class="section" id="any-of-behavior">
<span id="any-of"></span><h4><code class="docutils literal notranslate"><span class="pre">any_of</span></code> Behavior<a class="headerlink" href="#any-of-behavior" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">any_of</span></code> adds a disjunction built from its arguments to the existing
conditions in the criteria. For example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="sr">/Trust/</span><span class="p">)</span><span class="o">.</span><span class="n">any_of</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">},</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">})</span>
<span class="c1"># =&gt; {&quot;label&quot;=&gt;/Trust/, &quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Astral Projection&quot;}, {&quot;name&quot;=&gt;/Best/}]}</span>
</pre></div>
</div>
</div>
<p>The conditions are hoisted to the top level if possible:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="sr">/Trust/</span><span class="p">)</span><span class="o">.</span><span class="n">any_of</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">})</span>
<span class="c1"># =&gt; {&quot;label&quot;=&gt;/Trust/, &quot;name&quot;=&gt;&quot;Astral Projection&quot;}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="not-behavior">
<h4><code class="docutils literal notranslate"><span class="pre">not</span></code> Behavior<a class="headerlink" href="#not-behavior" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">not</span></code> method can be called without arguments, in which case it will negate
the next condition that is specified. <code class="docutils literal notranslate"><span class="pre">not</span></code> can also be called with one
or more hash conditions or <code class="docutils literal notranslate"><span class="pre">Criteria</span></code> objects, which will all be negated and
added to the criteria.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># not negates subsequent where</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Best&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Best&quot;}}</span>

<span class="c1"># The second where is added as $and</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Best&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="sr">/Records/</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Best&quot;}, &quot;label&quot;=&gt;/Records/}</span>

<span class="c1"># not negates its argument</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Best&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Best&quot;}}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">$not</span></code> in MongoDB server cannot be used with a string argument.
Mongoid uses <code class="docutils literal notranslate"><span class="pre">$ne</span></code> operator to achieve such a negation:</p>
<div class="last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># String negation - uses $ne</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Best&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Best&quot;}}</span>

<span class="c1"># Regexp negation - uses $not</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$not&quot;=&gt;/Best/}}</span>
</pre></div>
</div>
</div>
</div>
<p>Similarly to <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">not</span></code> will negate individual conditions for simple
field criteria. For complex conditions and when a field already has a condition
defined on it, since MongoDB server only supports the <code class="docutils literal notranslate"><span class="pre">$not</span></code> operator on
a per-field basis rather than globally, Mongoid emulates <code class="docutils literal notranslate"><span class="pre">$not</span></code> by using
an <code class="docutils literal notranslate"><span class="pre">{'$and'</span> <span class="pre">=&gt;</span> <span class="pre">[{'$nor'</span> <span class="pre">=&gt;</span> <span class="pre">...}]}</span></code> construct:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simple condition</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$not&quot;=&gt;/Best/}}</span>

<span class="c1"># Complex conditions</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;/Best/, &quot;$and&quot;=&gt;[{&quot;$nor&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Astral Projection&quot;}]}]}</span>

<span class="c1"># Symbol operator syntax</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">:name</span><span class="o">.</span><span class="n">ne</span> <span class="o">=&gt;</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;$and&quot;=&gt;[{&quot;$nor&quot;=&gt;[{&quot;name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Astral Projection&quot;}}]}]}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
<p>If using <code class="docutils literal notranslate"><span class="pre">not</span></code> with arrays or regular expressions, please note the
caveats/limitations of <code class="docutils literal notranslate"><span class="pre">$not</span></code> <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/query/not/">stated in the MongoDB server documentation</a>.</p>
</div>
</div>
<div class="section" id="incremental-query-construction">
<h3>Incremental Query Construction<a class="headerlink" href="#incremental-query-construction" title="Permalink to this headline">¶</a></h3>
<p>By default, when conditions are added to a query, Mongoid considers each
condition complete and independent from any other conditions potentially
present in the query. For example, calling <code class="docutils literal notranslate"><span class="pre">in</span></code> twice adds two separate
<code class="docutils literal notranslate"><span class="pre">$in</span></code> conditions:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;a&quot;</span><span class="o">]</span><span class="p">},</span> <span class="s2">&quot;$and&quot;</span><span class="o">=&gt;[</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span><span class="o">]</span><span class="p">}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<p>Some operator methods support building the condition incrementally. In this
case, when an condition on a field which uses one of the supported operators
is being added, if there already is a condition on the same field using the
same operator, the operator expressions are combined according to the
specified <em>merge strategy</em>.</p>
<div class="section" id="merge-strategies">
<span id="id3"></span><h4>Merge Strategies<a class="headerlink" href="#merge-strategies" title="Permalink to this headline">¶</a></h4>
<p>Mongoid provides three merge strategies:</p>
<ul class="simple">
<li><strong>Override</strong>: the new operator instance replaces any existing conditions on
the same field using the same operator.</li>
<li><strong>Intersect</strong>: if there already is a condition using the same operator on the
same field, the values of the existing condition are intersected with the
values of the new condition and the result is stored as the operator value.</li>
<li><strong>Union</strong>: if there already is a condition using the same operator on the
same field, the values of the new condition are aded to the values of the
exsting condition and the result is stored as the operator value.</li>
</ul>
<p>The following snippet demonstrates all of the strategies, using <code class="docutils literal notranslate"><span class="pre">in</span></code> as the
example operator:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">override</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">intersect</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<p>The strategy is requested by calling <code class="docutils literal notranslate"><span class="pre">override</span></code>, <code class="docutils literal notranslate"><span class="pre">intersect</span></code> or <code class="docutils literal notranslate"><span class="pre">union</span></code>
on a <code class="docutils literal notranslate"><span class="pre">Criteria</span></code> instance. The requested strategy applies to the next
condition method called on the query. If the next condition method called does
not support merge strategies, the strategy is reset, as shown in the following
example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;a&quot;</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;$ne&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;c&quot;</span><span class="p">},</span> <span class="s2">&quot;$and&quot;</span><span class="o">=&gt;[</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span><span class="o">]</span><span class="p">}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">ne</span></code> does not support merge strategies, the <code class="docutils literal notranslate"><span class="pre">union</span></code> strategy was
ignored and reset and when <code class="docutils literal notranslate"><span class="pre">in</span></code> was invoked the second time there was no
strategy active.</p>
</div>
<div class="section" id="supported-operator-methods">
<h4>Supported Operator Methods<a class="headerlink" href="#supported-operator-methods" title="Permalink to this headline">¶</a></h4>
<p>The following operator methods support merge strategies:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">all</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">in</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">nin</span></code></li>
</ul>
<p>The set of methods may be expanded in future releases of Mongoid. For
future compatibility, only invoke a strategy method when the next method call
is an operator that supports merge strategies.</p>
<p>Note that the merge strategies are currently only applied when conditions are
added through the designated methods. In the following example merge strategy
is not applied because the second condition is added via <code class="docutils literal notranslate"><span class="pre">where</span></code>, not via
<code class="docutils literal notranslate"><span class="pre">in</span></code>:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="ss">foo</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">foo</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$in&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;b&#39;</span><span class="p">})</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;a&quot;</span><span class="o">]</span><span class="p">},</span> <span class="s2">&quot;$and&quot;</span><span class="o">=&gt;[</span><span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;b&quot;</span><span class="p">}}</span><span class="o">]</span><span class="p">}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<p>This behavior may change in a future release of Mongoid and should not be
relied upon.</p>
<p>In contrast, it does not matter how the existing query was built when a
merge strategy-supporting operator method is invoked. In the following
example, the first condition was added through <code class="docutils literal notranslate"><span class="pre">where</span></code> but the strategy
mechanism still applies:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">foo</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$in&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">})</span><span class="o">.</span><span class="n">union</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="ss">foo</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="operator-value-expansion">
<h4>Operator Value Expansion<a class="headerlink" href="#operator-value-expansion" title="Permalink to this headline">¶</a></h4>
<p>Operator methods that support merge strategies all take <code class="docutils literal notranslate"><span class="pre">Array</span></code> as their value
type. Mongoid expands <code class="docutils literal notranslate"><span class="pre">Array</span></code>-compatible types, such as a <code class="docutils literal notranslate"><span class="pre">Range</span></code>,
when they are used with these operator methods:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="ss">year</span><span class="p">:</span> <span class="mi">1950</span><span class="o">..</span><span class="mi">1960</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="mi">1950</span><span class="p">,</span> <span class="mi">1951</span><span class="p">,</span> <span class="mi">1952</span><span class="p">,</span> <span class="mi">1953</span><span class="p">,</span> <span class="mi">1954</span><span class="p">,</span> <span class="mi">1955</span><span class="p">,</span> <span class="mi">1956</span><span class="p">,</span> <span class="mi">1957</span><span class="p">,</span> <span class="mi">1958</span><span class="p">,</span> <span class="mi">1959</span><span class="p">,</span> <span class="mi">1960</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<p>Additionally, Mongoid has historically wrapped non-<code class="docutils literal notranslate"><span class="pre">Array</span></code> values in arrays,
as the following example demonstrates:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="ss">year</span><span class="p">:</span> <span class="mi">1950</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="mi">1950</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<p>This wrapping behavior is deprecated and should not be relied on. It may be
removed in a future release of Mongoid.</p>
</div>
</div>
<div class="section" id="query-methods">
<h3>Query Methods<a class="headerlink" href="#query-methods" title="Permalink to this headline">¶</a></h3>
<div class="section" id="elem-match">
<h4>elem_match<a class="headerlink" href="#elem-match" title="Permalink to this headline">¶</a></h4>
<p>This matcher finds documents with array fields where one of the array values
matches all of the conditions. For example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:tours</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span>
<span class="k">end</span>

<span class="n">aerosmith</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Aerosmith&#39;</span><span class="p">,</span> <span class="ss">tours</span><span class="p">:</span> <span class="o">[</span>
  <span class="p">{</span><span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;London&#39;</span><span class="p">,</span> <span class="ss">year</span><span class="p">:</span> <span class="mi">1995</span><span class="p">},</span>
  <span class="p">{</span><span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="ss">year</span><span class="p">:</span> <span class="mi">1999</span><span class="p">},</span>
<span class="o">]</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">elem_match</span><span class="p">(</span><span class="ss">tours</span><span class="p">:</span> <span class="p">{</span><span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;London&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">to_a</span> <span class="c1"># =&gt; [aerosmith]</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">elem_match</span></code> also works with embedded associations:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">embeds_many</span> <span class="ss">:tours</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tour</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:city</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:year</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="n">embedded_in</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="n">dm</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Depeche Mode&#39;</span><span class="p">)</span>
<span class="n">aerosmith</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Aerosmith&#39;</span><span class="p">)</span>
<span class="no">Tour</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">band</span><span class="p">:</span> <span class="n">aerosmith</span><span class="p">,</span> <span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;London&#39;</span><span class="p">,</span> <span class="ss">year</span><span class="p">:</span> <span class="mi">1995</span><span class="p">)</span>
<span class="no">Tour</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">band</span><span class="p">:</span> <span class="n">aerosmith</span><span class="p">,</span> <span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="ss">year</span><span class="p">:</span> <span class="mi">1999</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">elem_match</span><span class="p">(</span><span class="ss">tours</span><span class="p">:</span> <span class="p">{</span><span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;London&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">to_a</span> <span class="c1"># =&gt; [aerosmith]</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">elem_match</span></code> does not work with non-embedded associations because MongoDB
does not have joins - the conditions would be added to the collection
that is the source of a non-embedded association rather than the collection
of the association’s target.</p>
<p><code class="docutils literal notranslate"><span class="pre">elem_match</span></code> can also be used with recursively embedded associations,
as the following example shows:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Tag</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">recursively_embeds_many</span>
<span class="k">end</span>

<span class="n">root</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">)</span>
<span class="n">sub1</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;sub1&#39;</span><span class="p">,</span> <span class="ss">child_tags</span><span class="p">:</span> <span class="o">[</span><span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;subsub1&#39;</span><span class="p">)</span><span class="o">]</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">child_tags</span> <span class="o">&lt;&lt;</span> <span class="n">sub1</span>
<span class="n">root</span><span class="o">.</span><span class="n">child_tags</span> <span class="o">&lt;&lt;</span> <span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;sub2&#39;</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">save!</span>

<span class="no">Tag</span><span class="o">.</span><span class="n">elem_match</span><span class="p">(</span><span class="ss">child_tags</span><span class="p">:</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;sub1&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">to_a</span> <span class="c1"># =&gt; [root]</span>

<span class="n">root</span><span class="o">.</span><span class="n">child_tags</span><span class="o">.</span><span class="n">elem_match</span><span class="p">(</span><span class="ss">child_tags</span><span class="p">:</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;subsub1&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">to_a</span> <span class="c1"># =&gt; [sub1]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="projection">
<span id="id4"></span><h3>Projection<a class="headerlink" href="#projection" title="Permalink to this headline">¶</a></h3>
<div class="section" id="only">
<span id="id5"></span><h4><code class="docutils literal notranslate"><span class="pre">only</span></code><a class="headerlink" href="#only" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">only</span></code> method retrieves only the specified fields from the database. This
operation is sometimes called “projection”.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>

  <span class="n">embeds_many</span> <span class="ss">:tours</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tour</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:city</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:year</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>

  <span class="n">embedded_in</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</pre></div>
</div>
</div>
<p>Attempting to reference attributes which have not been loaded results in
<code class="docutils literal notranslate"><span class="pre">ActiveModel::MissingAttributeError</span></code>.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span><span class="o">.</span><span class="n">label</span>
<span class="c1"># ActiveModel::MissingAttributeError (Missing attribute: &#39;label&#39;.)</span>
</pre></div>
</div>
</div>
<p>Even though Mongoid currently allows writing to attributes that have not
been loaded, such writes will not be persisted
(<a class="reference external" href="https://jira.mongodb.org/browse/MONGOID-4701">MONGOID-4701</a>) and
should therefore be avoided.</p>
<p><code class="docutils literal notranslate"><span class="pre">only</span></code> can also be used with embedded associations:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s1">&#39;tours.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
<span class="c1"># =&gt; #&lt;Band _id: 5c59afb1026d7c034dba46ac, name: &quot;Aerosmith&quot;&gt;</span>

<span class="n">band</span><span class="o">.</span><span class="n">tours</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; #&lt;Tour _id: 5c59afdf026d7c034dba46af, city: nil, year: 1995&gt;</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Server versions 4.2 and lower allowed projecting both an association and
the association’s fields in the same query, as follows:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:tours</span><span class="p">,</span> <span class="s1">&#39;tours.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</pre></div>
</div>
</div>
<p>The most recent projection specification overrided the earlier one.
For example, the above query was equivalent to:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s1">&#39;tours.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</pre></div>
</div>
</div>
<p class="last">Server versions 4.4 and higher prohibit specifying an association and its
fields in projection in the same query.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">only</span></code> can be specified with referenced associations (has_one, has_many,
has_and_belongs_to_many) but is currently ignored for referenced associations -
all fields of referenced associations will be loaded
(<a class="reference external" href="https://jira.mongodb.org/browse/MONGOID-4704">MONGOID-4704</a>).</p>
<p>Note that if a document has <code class="docutils literal notranslate"><span class="pre">has_one</span></code> or <code class="docutils literal notranslate"><span class="pre">has_and_belongs_to_many</span></code> associations,
the fields with foreign keys must be included in the list of attributes
loaded with <code class="docutils literal notranslate"><span class="pre">only</span></code> for those associations to be loaded. For example:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:managers</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manager</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:bands</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">managers</span> <span class="o">&lt;&lt;</span> <span class="no">Manager</span><span class="o">.</span><span class="n">new</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">managers</span>
<span class="c1"># =&gt; []</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:manager_ids</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">managers</span>
<span class="c1"># =&gt; [#&lt;Manager _id: 5c5dc2f0026d7c1730969843, band_ids: [BSON::ObjectId(&#39;5c5dc2f0026d7c1730969842&#39;)]&gt;]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="without">
<span id="id6"></span><h4><code class="docutils literal notranslate"><span class="pre">without</span></code><a class="headerlink" href="#without" title="Permalink to this headline">¶</a></h4>
<p>The opposite of <code class="docutils literal notranslate"><span class="pre">only</span></code>, <code class="docutils literal notranslate"><span class="pre">without</span></code> causes the specified fields to be omitted:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">without</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:fields=&gt;{&quot;name&quot;=&gt;0}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
<p>Because Mongoid requires the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field for various operations, it (as well
as its <code class="docutils literal notranslate"><span class="pre">id</span></code> alias) cannot be omitted via <code class="docutils literal notranslate"><span class="pre">without</span></code>:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">without</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:fields=&gt;{&quot;name&quot;=&gt;0}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">without</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:_id</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:fields=&gt;{&quot;name&quot;=&gt;0}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ordering">
<h3>Ordering<a class="headerlink" href="#ordering" title="Permalink to this headline">¶</a></h3>
<p>Mongoid provides the <code class="docutils literal notranslate"><span class="pre">order</span></code> method on <code class="docutils literal notranslate"><span class="pre">Criteria</span></code> objects and its alias,
<code class="docutils literal notranslate"><span class="pre">order_by</span></code>, to specify the ordering of documents. These methods take a
hash indicating which fields to order the documents by, and whether to use
ascending or descending order for each field.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:sort=&gt;{&quot;name&quot;=&gt;1}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:sort=&gt;{&quot;name&quot;=&gt;-1, &quot;description&quot;=&gt;1}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="s1">&#39;asc&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:sort=&gt;{&quot;name&quot;=&gt;-1, &quot;description&quot;=&gt;1}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</div>
<p>The direction may be specified as integers <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">-1</span></code> for ascending
and descending, respectively, or as symbols <code class="docutils literal notranslate"><span class="pre">:asc</span></code> and <code class="docutils literal notranslate"><span class="pre">:desc</span></code>, or as
strings <code class="docutils literal notranslate"><span class="pre">&quot;asc&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;desc&quot;</span></code>.</p>
<p>Alternatively, <code class="docutils literal notranslate"><span class="pre">order</span></code> accepts an array of two-element arrays specifying
the ordering. Field names and directions may be strings or symbols.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="o">]]</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">[[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:desc</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:description</span><span class="p">,</span> <span class="ss">:asc</span><span class="o">]]</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Another way of providing the order is to use <code class="docutils literal notranslate"><span class="pre">#asc</span></code> and <code class="docutils literal notranslate"><span class="pre">#desc</span></code> methods
on symbols, as follows:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:name</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span> <span class="ss">:description</span><span class="o">.</span><span class="n">asc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The arguments can be provided as a string using SQL syntax:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;name desc, description asc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, there are <code class="docutils literal notranslate"><span class="pre">asc</span></code> and <code class="docutils literal notranslate"><span class="pre">desc</span></code> methods that can be used instead of
<code class="docutils literal notranslate"><span class="pre">order</span></code>/<code class="docutils literal notranslate"><span class="pre">order_by</span></code>:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">asc</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{</span><span class="ss">:sort</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="o">=&gt;-</span><span class="mi">1</span><span class="p">}}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">order</span></code> calls can be chained, in which case the oldest calls define the
most significant criteria and the newest calls define the least significant
ones (since in Ruby hashes maintain the order of their keys):</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;name desc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;description asc&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{</span><span class="ss">:sort</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">}}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<p>This can sometimes lead to surprising results if there are scopes, including
the default scope, that use <code class="docutils literal notranslate"><span class="pre">order</span></code>/<code class="docutils literal notranslate"><span class="pre">order_by</span></code>. For example, in the
following snippet bands are ordered by name first because the order in the
default scope takes precedence over the order given in the query, due to
the default scope being evaluated first:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:year</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="ss">:asc</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">year</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{</span><span class="ss">:sort</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="o">=&gt;-</span><span class="mi">1</span><span class="p">}}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="query-cache">
<span id="id7"></span><h3>Query Cache<a class="headerlink" href="#query-cache" title="Permalink to this headline">¶</a></h3>
<p>When the query cache is enabled, Mongoid will cache results for MongoDB queries
when the entire result set is returned in a single batch (1000 documents by
default).</p>
<p>Each thread has its own query cache.</p>
<p>When the query cache is enabled, performing most write operations (insert,
update, replace or delete) clears the cache of the thread issuing the write.</p>
<p>To enable the query cache manually for a code segment, use:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongoid</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">cache</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>The query cache can also be explicitly enabled and disabled, although it is
recommended to use the block form described above:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongoid</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># ...</span>

<span class="no">Mongoid</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span>
</pre></div>
</div>
</div>
<p>Mongoid also provides a <a class="reference internal" href="mongoid-configuration.html#query-cache-middleware"><span class="std std-ref">Rack middleware</span></a>
to enable the query cache automatically for each web request.</p>
<div class="section" id="the-improved-driver-query-cache">
<h4>The Improved Driver Query Cache<a class="headerlink" href="#the-improved-driver-query-cache" title="Permalink to this headline">¶</a></h4>
<p>The Mongoid query cache has been reimplemented in version 2.14.0 of the MongoDB
Ruby Driver. The driver query cache is more correct and more effective, and it
is recmomended that you upgrade to version 2.14.0 of the Ruby driver or newer.</p>
<p>For the purposes of this tutorial, the Mongoid query cache will be called “the
legacy query cache”, and the driver query cache will be referred to as “the
driver query cache.”</p>
<p>With driver versions 2.14.0 or newer, Mongoid will use the driver query cache
instead of the legacy query cache. When used with older versions of the driver
(that do not implement the query cache) Mongoid will fall back on the legacy
query cache.</p>
<p>Mongoid will retain the interface (described above) for enabling and disabling
the query cache. When using driver versions 2.14.0 or newer, this interface
will affect the driver query cache.</p>
<p>Read more about the Ruby driver query cache
<a class="reference external" href="https://docs.mongodb.com/ruby-driver/current/tutorials/query-cache/">in the driver documentation</a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>The legacy Mongoid query cache has been deprecated in favor of the query cache
implemented in version 2.14.0 of the MongoDB Ruby driver. While the legacy
query cache will continue to function, the driver query cache is
more correct and more effective. If you plan on using the query cache, it is
recommended that you upgrade to Ruby driver version 2.14.0 or newer.</p>
<p class="last">Read more about the Ruby driver query cache
<a class="reference external" href="https://docs.mongodb.com/ruby-driver/current/tutorials/query-cache/">in the driver documentation</a>.</p>
</div>
</div>
<div class="section" id="legacy-query-cache-limitations">
<h4>Legacy Query Cache Limitations<a class="headerlink" href="#legacy-query-cache-limitations" title="Permalink to this headline">¶</a></h4>
<p>The following is a list of limitations of the legacy query cache:</p>
<ul class="simple">
<li>The legacy query cache does not cache query results that exceed the batch size.
The default batch size is 1000 documents.</li>
<li>The legacy query cache does not take into account read preference or read concern
when deciding whether to return cached results. When performing the same
query with a different read preference or read concern with the query cache
enabled, incorrect results may be returned.</li>
<li>Bulk writes, as well as <code class="docutils literal notranslate"><span class="pre">$out</span></code> and <code class="docutils literal notranslate"><span class="pre">$merge</span></code> aggregation pipeline stages
do not invalidate the query cache. Cached results may be stale after performing
any of these operations.</li>
<li>Aggregation results are not cached.</li>
</ul>
</div>
<div class="section" id="a-note-on-using-first">
<h4>A Note on using <code class="docutils literal notranslate"><span class="pre">#first</span></code><a class="headerlink" href="#a-note-on-using-first" title="Permalink to this headline">¶</a></h4>
<p>Calling the <code class="docutils literal notranslate"><span class="pre">first</span></code> method on a model class imposes an ascending sort by
the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field on the underlying query. This may produce unexpected behavior
with query caching.</p>
<p>For example, when calling <code class="docutils literal notranslate"><span class="pre">all</span></code> on a model class and then <code class="docutils literal notranslate"><span class="pre">first</span></code>,
one would expect the second query to use the cached results from the first.
However, because of the sort imposed on the second query, both methods
will query the database and separately cache their results.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1">#=&gt; Queries the database and caches the results</span>

<span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="c1">#=&gt; Queries the database again because of the sort</span>
</pre></div>
</div>
</div>
<p>To use the cached results, call <code class="docutils literal notranslate"><span class="pre">all.to_a.first</span></code> on the model class.</p>
</div>
<div class="section" id="system-collections-and-the-query-cache">
<h4>System Collections and the Query Cache<a class="headerlink" href="#system-collections-and-the-query-cache" title="Permalink to this headline">¶</a></h4>
<p>MongoDB stores system information in collections that use the <code class="docutils literal notranslate"><span class="pre">database.system.*</span></code>
namespace pattern. These are called system collections.</p>
<p>Data in system collections can change due to activity not triggered by the
application (such as internal server processes) and as a result of a variety of
database commands issued by the application. Because of the difficulty of
determining when the cached results for system collections should be expired,
queries on system collections bypass the query cache.</p>
<p>Neither the legacy query cache nor the driver query cache will cache query
results from system collections.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1">#=&gt; Queries the database and caches the results</span>

<span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">first</span>
<span class="c1">#=&gt; Returns the first cached result</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="finding-by-id">
<span id="additional-query-methods"></span><h3>Finding By <code class="docutils literal notranslate"><span class="pre">_id</span></code><a class="headerlink" href="#finding-by-id" title="Permalink to this headline">¶</a></h3>
<p>Mongoid provides the <code class="docutils literal notranslate"><span class="pre">find</span></code> method on <code class="docutils literal notranslate"><span class="pre">Criteria</span></code> objects to find documents
by their <code class="docutils literal notranslate"><span class="pre">_id</span></code> values:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Band _id: 5f0e41d92c97a64a26aabd10, name: &quot;Juno Reactor&quot;&gt;</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">find</span></code> method performs type conversion, if necessary, of the argument
to the type declared in the model being queried for the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field.
By default, the <code class="docutils literal notranslate"><span class="pre">_id</span></code> type is <code class="docutils literal notranslate"><span class="pre">BSON::ObjectId</span></code>, thus the query above
is equivalent to:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="no">BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">))</span>
<span class="c1"># =&gt; #&lt;Band _id: 5f0e41d92c97a64a26aabd10, name: &quot;Juno Reactor&quot;&gt;</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When querying collections directly using the driver, type conversion is not
automatically performed:</p>
</div>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">_id</span><span class="p">:</span> <span class="no">BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; {&quot;_id&quot;=&gt;BSON::ObjectId(&#39;5f0e41d92c97a64a26aabd10&#39;), &quot;name&quot;=&gt;&quot;Juno Reactor&quot;}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">_id</span><span class="p">:</span> <span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; nil</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">find</span></code> method can accept multiple arguments, or an array of arguments.
In either case each of the arguments or array elements is taken to be an <code class="docutils literal notranslate"><span class="pre">_id</span></code>
value, and documents with all of the specified <code class="docutils literal notranslate"><span class="pre">_id</span></code> values are returned in
an array:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">,</span> <span class="s1">&#39;5f0e41b02c97a64a26aabd0e&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; [#&lt;Band _id: 5f0e41b02c97a64a26aabd0e, name: &quot;SUN Project&quot;, description: nil, likes: nil&gt;,</span>
  <span class="c1">#&lt;Band _id: 5f0e41d92c97a64a26aabd10, name: &quot;Juno Reactor&quot;, description: nil, likes: nil&gt;]</span>

<span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">,</span> <span class="s1">&#39;5f0e41b02c97a64a26aabd0e&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="c1"># =&gt; [#&lt;Band _id: 5f0e41b02c97a64a26aabd0e, name: &quot;SUN Project&quot;, description: nil, likes: nil&gt;,</span>
  <span class="c1">#&lt;Band _id: 5f0e41d92c97a64a26aabd10, name: &quot;Juno Reactor&quot;, description: nil, likes: nil&gt;]</span>
</pre></div>
</div>
</div>
<p>If the same <code class="docutils literal notranslate"><span class="pre">_id</span></code> value is given more than once, the corresponding document
is only returned once:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;5f0e41b02c97a64a26aabd0e&#39;</span><span class="p">,</span> <span class="s1">&#39;5f0e41b02c97a64a26aabd0e&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; [#&lt;Band _id: 5f0e41b02c97a64a26aabd0e, name: &quot;SUN Project&quot;, description: nil, likes: nil&gt;]</span>
</pre></div>
</div>
</div>
<p>The documents returned are <em>not</em> ordered, and may be returned in a different
order from the order of provided <code class="docutils literal notranslate"><span class="pre">_id</span></code> values, as illustrated in the above
examples.</p>
<p>If any of the <code class="docutils literal notranslate"><span class="pre">_id</span></code> values are not found in the database, the behavior of
<code class="docutils literal notranslate"><span class="pre">find</span></code> depends on the value of the <code class="docutils literal notranslate"><span class="pre">raise_not_found_error</span></code> configuration
option. If the option is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">find</span></code> raises
<code class="docutils literal notranslate"><span class="pre">Mongoid::Errors::DocumentNotFound</span></code> if any of the <code class="docutils literal notranslate"><span class="pre">_id``s</span> <span class="pre">are</span> <span class="pre">not</span> <span class="pre">found.</span>
<span class="pre">If</span> <span class="pre">the</span> <span class="pre">option</span> <span class="pre">is</span> <span class="pre">set</span> <span class="pre">to</span> <span class="pre">``false</span></code> and <code class="docutils literal notranslate"><span class="pre">find</span></code> is given a single <code class="docutils literal notranslate"><span class="pre">_id</span></code> to
find and there is no matching document, <code class="docutils literal notranslate"><span class="pre">find</span></code> returns <code class="docutils literal notranslate"><span class="pre">nil</span></code>. If the
option is set to <code class="docutils literal notranslate"><span class="pre">false</span></code> and <code class="docutils literal notranslate"><span class="pre">find</span></code> is given an array of <a href="#id9"><span class="problematic" id="id10">``</span></a>_id``s to find
and some are not found, the return value is an array of documents that were
found (which could be empty if no documents were found at all).</p>
</div>
<div class="section" id="id11">
<h3>Additional Query Methods<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>Mongoid also has some helpful methods on criteria.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#count</span></code></p>
<p><em>Get the total number of documents matching a filter, or the total
number of documents in a collection. Note this will always hit
the database for the count.</em></p>
<p class="last"><em>As of Mongoid 7.2, the</em> <code class="docutils literal notranslate"><span class="pre">count</span></code> <em>method uses the</em>
<code class="docutils literal notranslate"><span class="pre">count_documents</span></code> <em>driver helper to obtain the accurate count.
previously the</em> <code class="docutils literal notranslate"><span class="pre">count</span></code> <em>driver helper was used which used
collection metadata and was thus not necessarily accurate (but
may have returned the result faster). Use</em> <code class="docutils literal notranslate"><span class="pre">estimated_count</span></code>
<em>method to obtain an approximate number of documents in the collection
quickly.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">count</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#estimated_count</span></code></p>
<p class="last"><em>Get an approximate number of documents in the collection using the
collection metadta. The</em> <code class="docutils literal notranslate"><span class="pre">estimated_count</span></code> <em>method does not accept
query conditions; if any are given, it will raise</em>
<code class="docutils literal notranslate"><span class="pre">Mongoid::Errors::InvalidEstimatedCountCriteria</span></code>.
<em>If a model defines a default scope,</em> <code class="docutils literal notranslate"><span class="pre">estimated_count</span></code> <em>must be
called on the unscoped model</em>.</p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">count</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>

<span class="k">class</span> <span class="nc">Contract</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Contract</span><span class="o">.</span><span class="n">estimated_count</span>
<span class="c1"># =&gt; raises Mongoid::Errors::InvalidEstimatedCountCriteria</span>

<span class="no">Contract</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">estimated_count</span>
<span class="c1"># =&gt; 0</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#distinct</span></code></p>
<p class="last"><em>Get a list of distinct values for a single field. Note this will always hit
the database for the distinct values.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:fans</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">100000</span><span class="p">)</span><span class="o">.</span>
  <span class="n">distinct</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#each</span></code></p>
<p class="last"><em>Iterate over all matching documents in the criteria.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">band</span><span class="o">.</span><span class="n">name</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#exists?</span></code></p>
<p class="last"><em>Determine if any matching documents exist. Will return true if there
are 1 or more.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">exists?</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists?</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#find_by</span></code></p>
<p class="last"><em>Find a document by the provided attributes. If not found,
raise an error or return nil depending on the value of the</em>
<code class="docutils literal notranslate"><span class="pre">raise_not_found_error</span></code> <em>configuration option.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="n">band</span><span class="o">.</span><span class="n">impressions</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#find_or_create_by</span></code></p>
<p class="last"><em>Find a document by the provided attributes, and if not found
create and return a newly persisted one. Note that attributes provided in the arguments to
this method will override any set in ``create_with``</em>.</p>
</td>
<td><div class="first button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">find_or_create_by</span></code> can be used on any scope, but in this case
the criteria given by the scope and by <code class="docutils literal notranslate"><span class="pre">find_or_create_by</span></code> are
combined. The following creates three bands:</p>
<div class="last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Aerosmith&quot;</span><span class="p">)</span>
<span class="c1"># creates Aerosmith again because there is no band whose name</span>
<span class="c1"># is Photek and Aerosmith at the same time</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Aerosmith&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#find_or_initialize_by</span></code></p>
<p class="last"><em>Find a document by the provided attributes, and if not found
return a new one.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#first|last</span></code></p>
<p class="last"><em>Finds a single document given the provided criteria. This automatically adds a sort on id.
Opt out of adding the id sort with the {id_sort: :none} option.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:members</span><span class="o">.</span><span class="n">with_size</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:members</span><span class="o">.</span><span class="n">with_size</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#first_or_create</span></code></p>
<p class="last"><em>Find the first document by the provided attributes, and if not found
create and return a newly persisted one.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#first_or_create!</span></code></p>
<p class="last"><em>Find the first document by the provided attributes, and if not found
create and return a newly persisted one using</em> <code class="docutils literal notranslate"><span class="pre">create!</span></code>.</p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create!</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#first_or_initialize</span></code></p>
<p class="last"><em>Find the first document by the provided attributes, and if not found
return a new one.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_initialize</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#for_js</span></code></p>
<p class="last"><em>Find documents for a provided JavaScript expression, optionally with
the specified variables added to the evaluation scope. The scope
argument is supported in MongoDB 4.2 and lower.</em>
<em>In MongoDB 3.6 and higher, prefer</em> <a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/query/expr/">$expr</a> <em>over</em> <code class="docutils literal notranslate"><span class="pre">for_js</span></code>.</p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># All MongoDB versions</span>
<span class="no">Band</span><span class="o">.</span><span class="n">for_js</span><span class="p">(</span><span class="s2">&quot;this.name = &#39;Tool&#39;&quot;</span><span class="p">)</span>

<span class="c1"># MongoDB 4.2 and lower</span>
<span class="no">Band</span><span class="o">.</span><span class="n">for_js</span><span class="p">(</span><span class="s2">&quot;this.name = param&quot;</span><span class="p">,</span> <span class="ss">param</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#length|size</span></code></p>
<p class="last"><em>Same as count but caches subsequent calls to the database</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">length</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;FKA Twigs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#pluck</span></code></p>
<p class="last"><em>Get all the values for the provided field.
Returns nil for unset fields and for non-existent fields.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="eager-loading">
<h3>Eager Loading<a class="headerlink" href="#eager-loading" title="Permalink to this headline">¶</a></h3>
<p>Mongoid provides a facility to eager load documents
from associations to prevent the n+1 issue when
iterating over documents with association access. Eager loading is supported on
all associations with the exception of polymorphic <code class="docutils literal notranslate"><span class="pre">belongs_to</span></code>
associations.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">has_many</span> <span class="ss">:albums</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:albums</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">band</span><span class="o">.</span><span class="n">albums</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">name</span> <span class="c1"># Does not hit the database again.</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="regular-expressions">
<h3>Regular Expressions<a class="headerlink" href="#regular-expressions" title="Permalink to this headline">¶</a></h3>
<p>MongoDB, and Mongoid, allow querying documents by regular expressions.</p>
<p>Given the following model definitions:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun Project&#39;</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;Sun</span><span class="se">\n</span><span class="s2">Project&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>… we can query using simple Ruby regular expressions in a natural way:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/project/i</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; #&lt;Band _id: 5dc9f7d5ce4ef34893354323, name: &quot;Sun Project&quot;, description: &quot;Sun\nProject&quot;&gt;</span>
</pre></div>
</div>
</div>
<p>It is also possible to query using PCRE syntax by constructing
<code class="docutils literal notranslate"><span class="pre">BSON::Regexp::Raw</span></code> objects explicitly:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="sr">/\AProject/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; #&lt;Band _id: 5dc9f7d5ce4ef34893354323, name: &quot;Sun Project&quot;, description: &quot;Sun\nProject&quot;&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="no">BSON</span><span class="o">::</span><span class="no">Regexp</span><span class="o">::</span><span class="no">Raw</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;^Project&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; nil</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="no">BSON</span><span class="o">::</span><span class="no">Regexp</span><span class="o">::</span><span class="no">Raw</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;^Project&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; #&lt;Band _id: 5dc9f7d5ce4ef34893354323, name: &quot;Sun Project&quot;, description: &quot;Sun\nProject&quot;&gt;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="conditions-on-fields">
<h2>Conditions On Fields<a class="headerlink" href="#conditions-on-fields" title="Permalink to this headline">¶</a></h2>
<p>When a condition uses a field defined in the model, the value being specified
in the condition is converted according to the rules of the field, if any.
For example, consider the following model definition that contains a <code class="docutils literal notranslate"><span class="pre">Time</span></code>
field, a <code class="docutils literal notranslate"><span class="pre">Date</span></code> field and an implicit <code class="docutils literal notranslate"><span class="pre">Object</span></code> field, and also
intentionally does not define a field called <code class="docutils literal notranslate"><span class="pre">deregistered_at</span></code>:</p>
<blockquote>
<div><div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Voter</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:born_on</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Date</span>
  <span class="n">field</span> <span class="ss">:registered_at</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Time</span>
  <span class="n">field</span> <span class="ss">:voted_at</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div></blockquote>
<p>Queries on <code class="docutils literal notranslate"><span class="pre">born_on</span></code> and <code class="docutils literal notranslate"><span class="pre">registered_at</span></code> fields using <code class="docutils literal notranslate"><span class="pre">Date</span></code> and <code class="docutils literal notranslate"><span class="pre">Time</span></code>
values, respectively, are straightforward:</p>
<blockquote>
<div><div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">born_on</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;born_on&quot;=&gt;2020-12-18 00:00:00 UTC}</span>

<span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">registered_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;registered_at&quot;=&gt;2020-12-19 04:33:36.939788067 UTC}</span>
</pre></div>
</div>
</div>
</div></blockquote>
<p>But, note the differences in behavior when providing a <code class="docutils literal notranslate"><span class="pre">Date</span></code> instance
in all possible scenarios:</p>
<blockquote>
<div><div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">born_on</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;born_on&quot;=&gt;2020-12-18 00:00:00 UTC}</span>

<span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">registered_at</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;registered_at&quot;=&gt;2020-12-18 00:00:00 -0500}</span>

<span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">voted_at</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;voted_at&quot;=&gt;Fri, 18 Dec 2020}</span>

<span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">deregistered_at</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;deregistered_at&quot;=&gt;2020-12-18 00:00:00 UTC}</span>
</pre></div>
</div>
</div>
</div></blockquote>
<p>When using the <code class="docutils literal notranslate"><span class="pre">registered_at</span></code> field which is of type <code class="docutils literal notranslate"><span class="pre">Time</span></code>, the date
was interpreted to be in local time (as per the <a class="reference internal" href="mongoid-configuration.html#time-zones"><span class="std std-ref">configured time zone</span></a>). When using the <code class="docutils literal notranslate"><span class="pre">born_on</span></code> field which is of type <code class="docutils literal notranslate"><span class="pre">Date</span></code>,
the date was interpreted to be in UTC. When using the <code class="docutils literal notranslate"><span class="pre">voted_at</span></code> field
which was defined without a type (hence implicitly as an <code class="docutils literal notranslate"><span class="pre">Object</span></code>),
the date was used unmodified in the constructed query. When using a
nonexistent field <code class="docutils literal notranslate"><span class="pre">deregistered_at</span></code> the date was interpreted to be in UTC
and converted to a time, matching the behavior of querying a <code class="docutils literal notranslate"><span class="pre">Date</span></code> field.</p>
</div>
<div class="section" id="reloading">
<h2>Reloading<a class="headerlink" href="#reloading" title="Permalink to this headline">¶</a></h2>
<p>Use the <code class="docutils literal notranslate"><span class="pre">reload</span></code> method to fetch the most recent version of a document from
the database:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">..</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">reload</span>
</pre></div>
</div>
</div>
<p>If the model has a <a class="reference internal" href="sharding.html#shard-keys"><span class="std std-ref">shard key</span></a> defined, the shard key value
is included in the reloading query.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">reload</span></code> also works when the document has not been persisted, in which case
it performs a query using the <code class="docutils literal notranslate"><span class="pre">id</span></code> value (and shard key value, if a shard
key is defined):</p>
<div class="last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">existing</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Photek&#39;</span><span class="p">)</span>

<span class="c1"># Unsaved document</span>
<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">existing</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">reload</span>
<span class="n">band</span><span class="o">.</span><span class="n">name</span>
<span class="c1"># =&gt; &quot;Photek&quot;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="queries-persistence">
<h2>Queries + Persistence<a class="headerlink" href="#queries-persistence" title="Permalink to this headline">¶</a></h2>
<p>Mongoid supports persistence operations off of criteria
in a light capacity for when you want to expressively perform multi
document inserts, updates, and deletion.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#create</span></code></p>
<p class="last"><em>Create a newly persisted document.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#create!</span></code></p>
<p class="last"><em>Create a newly persisted document and raise an exception on validation failure.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">create!</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#build|new</span></code></p>
<p class="last"><em>Create a new (unsaved) document.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">build</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">new</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#update</span></code></p>
<p class="last"><em>Update attributes of the first matching document.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#update_all</span></code></p>
<p class="last"><em>Update attributes of all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">update_all</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#add_to_set</span></code></p>
<p class="last"><em>Perform an $addToSet on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to_set</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#bit</span></code></p>
<p class="last"><em>Perform a $bit on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bit</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="p">{</span> <span class="ow">and</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="ow">or</span><span class="p">:</span> <span class="mi">4</span> <span class="p">})</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#inc</span></code></p>
<p class="last"><em>Perform an $inc on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#pop</span></code></p>
<p class="last"><em>Perform a $pop on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#pull</span></code></p>
<p class="last"><em>Perform a $pull on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#pull_all</span></code></p>
<p class="last"><em>Perform a $pullAll on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span>
  <span class="n">pull_all</span><span class="p">(</span><span class="ss">:members</span><span class="p">,</span> <span class="o">[</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">,</span> <span class="s2">&quot;Danny&quot;</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#push</span></code></p>
<p class="last"><em>Perform a $push on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#push_all</span></code></p>
<p class="last"><em>Perform a $push with $each on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span>
  <span class="n">push_all</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">,</span> <span class="s2">&quot;Danny&quot;</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#rename</span></code></p>
<p class="last"><em>Perform a $rename on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="ss">:title</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#set</span></code></p>
<p class="last"><em>Perform a $set on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#unset</span></code></p>
<p class="last"><em>Perform a $unset on all matching documents.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="ss">:likes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#delete</span></code></p>
<p class="last"><em>Deletes all matching documents in the database.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span>
</pre></div>
</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><code class="docutils literal notranslate"><span class="pre">Criteria#destroy</span></code></p>
<p class="last"><em>Deletes all matching documents in the database while running callbacks for all.
This loads all documents into memory and can be an expensive operation.</em></p>
</td>
<td><div class="first last button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="scoping">
<h2>Scoping<a class="headerlink" href="#scoping" title="Permalink to this headline">¶</a></h2>
<p>Scopes provide a convenient way to reuse common criteria with more
business domain style syntax.</p>
<div class="section" id="named-scopes">
<h3>Named Scopes<a class="headerlink" href="#named-scopes" title="Permalink to this headline">¶</a></h3>
<p>Named scopes are simply criteria defined at class load that are referenced
by a provided name. Just like normal criteria, they are lazy and chainable.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:country</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:genres</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span>

  <span class="n">scope</span> <span class="ss">:english</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">country</span><span class="p">:</span> <span class="s2">&quot;England&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:rock</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">:genres</span><span class="o">.</span><span class="n">in</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;rock&quot;</span> <span class="o">]</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">english</span><span class="o">.</span><span class="n">rock</span> <span class="c1"># Get the English rock bands.</span>
</pre></div>
</div>
</div>
<p>Named scopes can take procs and blocks for accepting parameters or
extending functionality.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:country</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="n">scope</span> <span class="ss">:named</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">){</span> <span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="k">def</span> <span class="nf">deutsch</span>
        <span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="o">|</span>
          <span class="n">scope</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Deutschland&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">named</span><span class="p">(</span><span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span> <span class="c1"># Find Depeche Mode.</span>
<span class="no">Band</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">deutsch</span> <span class="c1"># Find active German bands.</span>
</pre></div>
</div>
</div>
<p>By default, Mongoid allows defining a scope that would shadow an existing
class method, as the following example shows:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Product</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">fresh</span>
    <span class="kp">true</span>
  <span class="k">end</span>

  <span class="n">scope</span> <span class="ss">:fresh</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">fresh</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>To have Mongoid raise an error when a scope would overwrite an existing class
method, set the <code class="docutils literal notranslate"><span class="pre">scope_overwrite_exception</span></code> <a class="reference internal" href="mongoid-configuration.html#configuration-options"><span class="std std-ref">configuration option</span></a> to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
</div>
<div class="section" id="default-scopes">
<h3>Default Scopes<a class="headerlink" href="#default-scopes" title="Permalink to this headline">¶</a></h3>
<p>Default scopes can be useful when you find yourself applying the same
criteria to most queries, and wish to specify these criteria as the default.
Default scopes are procs that return criteria objects.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="c1"># All bands here are active.</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>Specifying a default scope also initializes the fields of new models to
the values given in the default scope, if the values are simple literals:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span>
  <span class="n">field</span> <span class="ss">:num_tours</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">num_tours</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">})</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># active is set, num_tours is not set</span>
<span class="no">Band</span><span class="o">.</span><span class="n">new</span> <span class="c1"># =&gt; #&lt;Band _id: 5c3f7452ce4ef378295ca5f5, name: nil, active: true, num_tours: nil&gt;</span>
</pre></div>
</div>
</div>
<p>Note that if a default value is provided both in the field definition and
in the default scope, the value in the default scope takes precedence:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">new</span> <span class="c1"># =&gt; #&lt;Band _id: 5c3f74ddce4ef3791abbb088, name: nil, active: false&gt;</span>
</pre></div>
</div>
</div>
<p>Because a default scope initializes fields in new models as just described,
defining a default scope with a dotted key and a simple literal value is
not possible:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">&#39;tags.foo&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">create!</span> <span class="c1"># exception: BSON::String::IllegalKey (&#39;tags.foo&#39; is an illegal key in MongoDB. Keys may not start with &#39;$&#39; or contain a &#39;.&#39;.)</span>
</pre></div>
</div>
</div>
<p>A workaround is to define the default scope as a complex query:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">&#39;tags.foo&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;$eq&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">tags</span><span class="p">:</span> <span class="p">{</span><span class="ss">hello</span><span class="p">:</span> <span class="s1">&#39;world&#39;</span><span class="p">})</span>
<span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">tags</span><span class="p">:</span> <span class="p">{</span><span class="ss">foo</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
<span class="no">Band</span><span class="o">.</span><span class="n">count</span> <span class="c1"># =&gt; 1</span>
</pre></div>
</div>
</div>
<p>You can tell Mongoid not to apply the default scope by using
<code class="docutils literal notranslate"><span class="pre">unscoped</span></code>, which can be inline or take a block.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span> <span class="k">do</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>You can also tell Mongoid to explicitly apply the default scope
again later to always ensure it’s there.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">scoped</span>
</pre></div>
</div>
</div>
<p>If you are using a default scope on a model that is part of an association,
you must reload the association to have scoping reapplied.
This is important to note if you change a value of a document in the association
that would affect its visibility within the scoped association.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Label</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_many</span> <span class="ss">:bands</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">embedded_in</span> <span class="ss">:label</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">label</span><span class="o">.</span><span class="n">bands</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">bands</span> <span class="c1"># [ band ]</span>
<span class="n">band</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:active</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">bands</span> <span class="c1"># [ band ] Must reload.</span>
<span class="n">label</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">bands</span> <span class="c1"># []</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="class-methods">
<h3>Class Methods<a class="headerlink" href="#class-methods" title="Permalink to this headline">¶</a></h3>
<p>Class methods on models that return criteria objects are also
treated like scopes, and can be chained as well.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">active</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">active</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="map-reduce">
<h2>Map/Reduce<a class="headerlink" href="#map-reduce" title="Permalink to this headline">¶</a></h2>
<p>Mongoid provides a DSL around MongoDB’s map/reduce framework, for performing
custom map/reduce jobs or simple aggregations.</p>
<div class="section" id="execution">
<h3>Execution<a class="headerlink" href="#execution" title="Permalink to this headline">¶</a></h3>
<p>You can tell Mongoid off the class or a criteria to perform a map/reduce
by calling <code class="docutils literal notranslate"><span class="pre">map_reduce</span></code> and providing map and reduce javascript
functions.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">map</span> <span class="o">=</span> <span class="sx">%Q{</span>
<span class="sx">  function() {</span>
<span class="sx">    emit(this.name, { likes: this.likes });</span>
<span class="sx">  }</span>
<span class="sx">}</span>

<span class="n">reduce</span> <span class="o">=</span> <span class="sx">%Q{</span>
<span class="sx">  function(key, values) {</span>
<span class="sx">    var result = { likes: 0 };</span>
<span class="sx">    values.forEach(function(value) {</span>
<span class="sx">      result.likes += value.likes;</span>
<span class="sx">    });</span>
<span class="sx">    return result;</span>
<span class="sx">  }</span>
<span class="sx">}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">map_reduce</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">reduce</span><span class="p">)</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="ss">inline</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Just like criteria, map/reduce calls are lazily evaluated. So nothing will
hit the database until you iterate over the results, or make a call on the
wrapper that would need to force a database hit.</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">map_reduce</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">reduce</span><span class="p">)</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="ss">replace</span><span class="p">:</span> <span class="s2">&quot;mr-results&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">document</span> <span class="c1"># { &quot;_id&quot; =&gt; &quot;Tool&quot;, &quot;value&quot; =&gt; { &quot;likes&quot; =&gt; 200 }}</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>The only required thing you provide along with a map/reduce is where to
output the results. If you do not provide this an error will be raised.
Valid options to <code class="docutils literal notranslate"><span class="pre">#out</span></code> are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">inline:</span> <span class="pre">1</span></code>: Don’t store the output in a collection.</li>
<li><code class="docutils literal notranslate"><span class="pre">replace:</span> <span class="pre">&quot;name&quot;</span></code>: Store in a collection with the
provided name, and overwrite any documents that exist in it.</li>
<li><code class="docutils literal notranslate"><span class="pre">merge:</span> <span class="pre">&quot;name&quot;</span></code>: Store in a collection with the
provided name, and merge the results with the existing documents.</li>
<li><code class="docutils literal notranslate"><span class="pre">reduce:</span> <span class="pre">&quot;name&quot;</span></code>: Store in a collection with the
provided name, and reduce all existing results in that collection.</li>
</ul>
</div>
<div class="section" id="raw-results">
<h3>Raw Results<a class="headerlink" href="#raw-results" title="Permalink to this headline">¶</a></h3>
<p>Results of Map/Reduce execution can be retrieved via the <code class="docutils literal notranslate"><span class="pre">execute</span></code> method
or its aliases <code class="docutils literal notranslate"><span class="pre">raw</span></code> and <code class="docutils literal notranslate"><span class="pre">results</span></code>:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">mr</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">map_reduce</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">reduce</span><span class="p">)</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="ss">inline</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">mr</span><span class="o">.</span><span class="n">execute</span>
<span class="c1"># =&gt; {&quot;results&quot;=&gt;[{&quot;_id&quot;=&gt;&quot;Tool&quot;, &quot;value&quot;=&gt;{&quot;likes&quot;=&gt;200.0}}],</span>
      <span class="s2">&quot;timeMillis&quot;</span><span class="o">=&gt;</span><span class="mi">14</span><span class="p">,</span>
      <span class="s2">&quot;counts&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;emit&quot;</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;reduce&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">},</span>
      <span class="s2">&quot;ok&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;$clusterTime&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;clusterTime&quot;</span><span class="o">=&gt;</span><span class="c1">#&lt;BSON::Timestamp:0x00005633c2c2ad20 @seconds=1590105400, @increment=1&gt;, &quot;signature&quot;=&gt;{&quot;hash&quot;=&gt;&lt;BSON::Binary:0x12240 type=generic data=0x0000000000000000...&gt;, &quot;keyId&quot;=&gt;0}},</span>
      <span class="s2">&quot;operationTime&quot;</span><span class="o">=&gt;</span><span class="c1">#&lt;BSON::Timestamp:0x00005633c2c2aaf0 @seconds=1590105400, @increment=1&gt;}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="statistics">
<h3>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h3>
<p>MongoDB servers 4.2 and lower provide Map/Reduce execution statistics. As of
MongoDB 4.4, Map/Reduce is implemented via the aggregation pipeline and
statistics described in this section are not available.</p>
<p>The following methods are provided on the <code class="docutils literal notranslate"><span class="pre">MapReduce</span></code> object:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">counts</span></code>: Number of documents read, emitted, reduced and output through
the pipeline.</li>
<li><code class="docutils literal notranslate"><span class="pre">input</span></code>, <code class="docutils literal notranslate"><span class="pre">emitted</span></code>, <code class="docutils literal notranslate"><span class="pre">reduced</span></code>, <code class="docutils literal notranslate"><span class="pre">output</span></code>: individual count methods.
Note that <code class="docutils literal notranslate"><span class="pre">emitted</span></code> and <code class="docutils literal notranslate"><span class="pre">reduced</span></code> methods are named differently from
hash keys in <code class="docutils literal notranslate"><span class="pre">counts</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">time</span></code>: The time, in milliseconds, that Map/Reduce pipeline took to execute.</li>
</ul>
<p>The following code illustrates retrieving the statistics:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">mr</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">map_reduce</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">reduce</span><span class="p">)</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="ss">inline</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">mr</span><span class="o">.</span><span class="n">counts</span>
<span class="c1"># =&gt; {&quot;input&quot;=&gt;4, &quot;emit&quot;=&gt;4, &quot;reduce&quot;=&gt;1, &quot;output&quot;=&gt;1}</span>

<span class="n">mr</span><span class="o">.</span><span class="n">input</span>
<span class="c1"># =&gt; 4</span>

<span class="n">mr</span><span class="o">.</span><span class="n">emitted</span>
<span class="c1"># =&gt; 4</span>

<span class="n">mr</span><span class="o">.</span><span class="n">reduced</span>
<span class="c1"># =&gt; 1</span>

<span class="n">mr</span><span class="o">.</span><span class="n">output</span>
<span class="c1"># =&gt; 1</span>

<span class="n">mr</span><span class="o">.</span><span class="n">time</span>
<span class="c1"># =&gt; 14</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Each statistics method invocation re-executes the Map/Reduce pipeline.
The results of execution are not stored by Mongoid. Consider using the
<code class="docutils literal notranslate"><span class="pre">execute</span></code> method to retrieve the raw results and obtaining the statistics
from the raw results if multiple statistics are desired.</p>
</div>
</div>
</div>
<div class="section" id="text-search">
<span id="id12"></span><h2>Text Search<a class="headerlink" href="#text-search" title="Permalink to this headline">¶</a></h2>
<p>MongoDB provides <a class="reference external" href="https://docs.mongodb.com/manual/core/index-text/">text indexes</a>
to support text search queries on string content. Text indexes
can include any field whose value is a string or an array of
string elements.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">MongoDB Atlas also provides
<a class="reference external" href="https://docs.atlas.mongodb.com/atlas-search/">Atlas Search</a>
which is a more powerful and flexible text search solution.
The rest of this section discusses text indexes and not Atlas Search.</p>
</div>
<p>To perform text search with Mongoid, follow these steps:</p>
<ol class="arabic simple">
<li>Define a text index on a model.</li>
<li>Create the text index on the server.</li>
<li>Build a text search query.</li>
</ol>
<div class="section" id="defining-text-search-index">
<h3>Defining Text Search Index<a class="headerlink" href="#defining-text-search-index" title="Permalink to this headline">¶</a></h3>
<p>Index definition through Mongoid is described in detail on the <a class="reference external" href="mongoid-indexes">indexes</a> page. Text search indexes are described in detail
under <a class="reference external" href="https://docs.mongodb.com/manual/core/index-text/">text indexes</a>
in the MongoDB manual. Below is an example definition of a Band model with
a text index utilizing the description field:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>

  <span class="n">index</span> <span class="ss">description</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>Note that the index type (<code class="docutils literal notranslate"><span class="pre">text</span></code>) must be given as a string, not as a symbol.</p>
</div>
<div class="section" id="creating-text-index">
<h3>Creating Text Index<a class="headerlink" href="#creating-text-index" title="Permalink to this headline">¶</a></h3>
<p>To create the index, invoke the <code class="docutils literal notranslate"><span class="pre">db:mongoid:create_indexes</span></code> Rake task:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="ss">mongoid</span><span class="p">:</span><span class="n">create_indexes</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="querying-using-text-index">
<h3>Querying Using Text Index<a class="headerlink" href="#querying-using-text-index" title="Permalink to this headline">¶</a></h3>
<p>To find bands whose description contains “ounces” or its variations, use the
<a class="reference external" href="https://docs.mongodb.com/manual/reference/operator/query/text/#op._S_text">$text operator</a>:</p>
<div class="button-code-block">
<div class="button-row">
<a class="code-button--copy code-button" role="button">
copy</a>
</div>
<div class="copyable-code-block highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;$text&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;$search&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ounces&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1"># =&gt; [#&lt;Band _id: 5d5341b3ce4ef35d5016746d, name: &quot;foo&quot;, description: &quot;ounce&quot;&gt;]</span>
</pre></div>
</div>
</div>
<p>Note that the description contains the word “ounce” even though the search
query was “ounces”.</p>
<p>Note also that when performing text search, the name of the field is not
explicitly specified - <code class="docutils literal notranslate"><span class="pre">$text</span></code> operator searches all fields indexed with
the text index.</p>
</div>
</div>
</div>

                
    <div id="btnv">
      <span class="btn-arrow-left">&larr; &nbsp;</span>
      <a class="btn-prev-text" href="mongoid-persistence.html" title="Previous Section: Persistence"><span>Persistence</span></a>
      <a class="btn-next-text" href="mongoid-relations.html" title="Next Section: Associations"><span>Associations</span></a>
      <span class="btn-arrow-right">&nbsp;&rarr;</span>
    </div>
                  <div class="footer">
                    <div class="copyright">
                      <p>&copy; MongoDB, Inc 2008-present. MongoDB, Mongo, and the leaf logo are registered trademarks of MongoDB, Inc.</p>
                    </div>
                  </div>
              </div></div>
            </div>
        </div>
    </div>
    <div class="right-column">
      <div class="wrapper"> 
            <div class="social">
               <a class="slack-icon" href="https://slackpass.io/mongo-db?jmp=docs" title="https://slackpass.io/mongo-db?jmp=docs"><i class="fab fa-slack" aria-hidden="true"></i></a>
               <a class="twitter-icon" href="https://twitter.com/MongoDB" title="https://twitter.com/MongoDB"><i class="fab fa-twitter-square"></i></a>
               <a class="youtube-icon" href="https://www.youtube.com/user/MongoDB" title="https://www.youtube.com/user/MongoDB"><i class="fab fa-youtube-square"></i></a>
               <a class="facebook-icon" href="https://www.facebook.com/mongodb" title="https://www.facebook.com/mongodb"><i class="fab fa-facebook-square"></i></a>
               <a class="stack-overflow-icon" href="https://stackoverflow.com/tags/mongodb/info" title="https://stackoverflow.com/tags/mongodb/info"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a>
            </div>
        

      </div>
    </div>
    
    <div class="clearfix"></div>
  </div><div id="navbar" data-navprops='{"links": [{"url": "https://docs.mongodb.com/manual/","text": "Server"},{"url": "https://docs.mongodb.com/ecosystem/drivers/","text": "Drivers"},{"url": "https://docs.mongodb.com/cloud/","text": "Cloud"},{"url": "https://docs.mongodb.com/tools/","text": "Tools"},{"url": "https://docs.mongodb.com/guides/","text": "Guides","active": true}]}'></div>

  <script src="../_static/navbar.min.js"></script>

  

  <script type="text/javascript">
  // Bootstrap array of links that should trigger a full page reload
  window.docsExcludedNav = [];
  </script></body>
</html>

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Queries &#8212; Mongoid  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Text Search" href="text-search.html" />
    <link rel="prev" title="CRUD Operations" href="crud.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Mongoid  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../installation-configuration.html">
   Installation &amp; Configuration
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../installation.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="compatibility.html">
     Compatibility
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="configuration.html">
     Configuration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="rails-integration.html">
     Rails Integration
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorials.html">
   Tutorials
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/getting-started-sinatra.html">
     Getting Started (Sinatra)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/getting-started-rails.html">
     Getting Started (Rails)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/documents.html">
     Documents
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/common-errors.html">
     Common Errors
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../schema-configuration.html">
   Schema Configuration
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="fields.html">
     Field Definition
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="inheritance.html">
     Inheritance
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="associations.html">
     Associations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="validation.html">
     Validation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="collection-configuration.html">
     Collection Configuration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="indexes.html">
     Index Management
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sharding.html">
     Sharding Configuration
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../working-with-data.html">
   Working With Data
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="crud.html">
     CRUD Operations
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Queries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="text-search.html">
     Text Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="aggregation.html">
     Aggregation Pipeline
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="map-reduce.html">
     Map/Reduce
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="persistence-configuration.html">
     Persistence Configuration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="nested-attributes.html">
     Nested Attributes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="callbacks.html">
     Callbacks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sessions.html">
     Sessions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="transactions.html">
     Transactions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://mongodb.com/docs/mongoid/master/api/">
   API
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../release-notes.html">
   Release Notes
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-8.0.html">
     Mongoid 8.0
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.4.html">
     Mongoid 7.4
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.3.html">
     Mongoid 7.3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.2.html">
     Mongoid 7.2
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.1.html">
     Mongoid 7.1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.0.html">
     Mongoid 7.0
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-6.html">
     Mongoid 6
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-5.html">
     Mongoid 5
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../additional-resources.html">
   Additional Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ecosystem.html">
   Ecosystem
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/reference/queries.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.txt</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#condition-syntax">
   Condition Syntax
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#field-syntax">
     Field Syntax
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mql-syntax">
     MQL Syntax
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#symbol-operator-syntax">
     Symbol Operator Syntax
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#embedded-documents">
   Embedded Documents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#field-types">
   Field Types
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aliases">
   Aliases
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logical-operations">
   Logical Operations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#operator-combinations">
     Operator Combinations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#and-behavior">
     <code class="docutils literal notranslate">
      <span class="pre">
       and
      </span>
     </code>
     Behavior
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#any-of-behavior">
     <code class="docutils literal notranslate">
      <span class="pre">
       any_of
      </span>
     </code>
     Behavior
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#not-behavior">
     <code class="docutils literal notranslate">
      <span class="pre">
       not
      </span>
     </code>
     Behavior
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#incremental-query-construction">
   Incremental Query Construction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#merge-strategies">
     Merge Strategies
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supported-operator-methods">
     Supported Operator Methods
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#operator-value-expansion">
     Operator Value Expansion
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#query-methods">
   Query Methods
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#elem-match">
     elem_match
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#projection">
   Projection
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#only">
     <code class="docutils literal notranslate">
      <span class="pre">
       only
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#without">
     <code class="docutils literal notranslate">
      <span class="pre">
       without
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ordering">
   Ordering
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pagination">
   Pagination
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#limit">
     <code class="docutils literal notranslate">
      <span class="pre">
       limit
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#skip">
     <code class="docutils literal notranslate">
      <span class="pre">
       skip
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#batch-size">
     <code class="docutils literal notranslate">
      <span class="pre">
       batch_size
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#finding-by-id">
   Finding By
   <code class="docutils literal notranslate">
    <span class="pre">
     _id
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#additional-query-methods">
   Additional Query Methods
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#eager-loading">
   Eager Loading
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regular-expressions">
   Regular Expressions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conditions-on-fields">
   Conditions On Fields
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scoping">
   Scoping
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#named-scopes">
     Named Scopes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#default-scopes">
     Default Scopes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#runtime-default-scope-override">
     Runtime Default Scope Override
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#class-methods">
     Class Methods
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#queries-persistence">
   Queries + Persistence
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#query-cache">
   Query Cache
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enabling-query-cache">
     Enabling Query Cache
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enabling-query-cache-via-middleware">
     Enabling Query Cache Via Middleware
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enabling-query-cache-manually">
     Enabling Query Cache Manually
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#query-cache-shared-with-driver">
     Query Cache Shared With Driver
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#caching-the-result-of-first">
     Caching the Result of
     <code class="docutils literal notranslate">
      <span class="pre">
       #first
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#legacy-query-cache-limitations">
     Legacy Query Cache Limitations
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Queries</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#condition-syntax">
   Condition Syntax
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#field-syntax">
     Field Syntax
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mql-syntax">
     MQL Syntax
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#symbol-operator-syntax">
     Symbol Operator Syntax
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#embedded-documents">
   Embedded Documents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#field-types">
   Field Types
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aliases">
   Aliases
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logical-operations">
   Logical Operations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#operator-combinations">
     Operator Combinations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#and-behavior">
     <code class="docutils literal notranslate">
      <span class="pre">
       and
      </span>
     </code>
     Behavior
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#any-of-behavior">
     <code class="docutils literal notranslate">
      <span class="pre">
       any_of
      </span>
     </code>
     Behavior
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#not-behavior">
     <code class="docutils literal notranslate">
      <span class="pre">
       not
      </span>
     </code>
     Behavior
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#incremental-query-construction">
   Incremental Query Construction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#merge-strategies">
     Merge Strategies
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supported-operator-methods">
     Supported Operator Methods
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#operator-value-expansion">
     Operator Value Expansion
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#query-methods">
   Query Methods
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#elem-match">
     elem_match
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#projection">
   Projection
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#only">
     <code class="docutils literal notranslate">
      <span class="pre">
       only
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#without">
     <code class="docutils literal notranslate">
      <span class="pre">
       without
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ordering">
   Ordering
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pagination">
   Pagination
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#limit">
     <code class="docutils literal notranslate">
      <span class="pre">
       limit
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#skip">
     <code class="docutils literal notranslate">
      <span class="pre">
       skip
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#batch-size">
     <code class="docutils literal notranslate">
      <span class="pre">
       batch_size
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#finding-by-id">
   Finding By
   <code class="docutils literal notranslate">
    <span class="pre">
     _id
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#additional-query-methods">
   Additional Query Methods
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#eager-loading">
   Eager Loading
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regular-expressions">
   Regular Expressions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conditions-on-fields">
   Conditions On Fields
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scoping">
   Scoping
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#named-scopes">
     Named Scopes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#default-scopes">
     Default Scopes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#runtime-default-scope-override">
     Runtime Default Scope Override
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#class-methods">
     Class Methods
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#queries-persistence">
   Queries + Persistence
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#query-cache">
   Query Cache
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enabling-query-cache">
     Enabling Query Cache
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enabling-query-cache-via-middleware">
     Enabling Query Cache Via Middleware
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enabling-query-cache-manually">
     Enabling Query Cache Manually
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#query-cache-shared-with-driver">
     Query Cache Shared With Driver
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#caching-the-result-of-first">
     Caching the Result of
     <code class="docutils literal notranslate">
      <span class="pre">
       #first
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#legacy-query-cache-limitations">
     Legacy Query Cache Limitations
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="queries">
<h1>Queries<a class="headerlink" href="#queries" title="Permalink to this headline">#</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><p><a class="reference internal" href="#condition-syntax" id="id18">Condition Syntax</a></p>
<ul>
<li><p><a class="reference internal" href="#field-syntax" id="id19">Field Syntax</a></p></li>
<li><p><a class="reference internal" href="#mql-syntax" id="id20">MQL Syntax</a></p></li>
<li><p><a class="reference internal" href="#symbol-operator-syntax" id="id21">Symbol Operator Syntax</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#embedded-documents" id="id22">Embedded Documents</a></p></li>
<li><p><a class="reference internal" href="#field-types" id="id23">Field Types</a></p></li>
<li><p><a class="reference internal" href="#aliases" id="id24">Aliases</a></p></li>
<li><p><a class="reference internal" href="#logical-operations" id="id25">Logical Operations</a></p>
<ul>
<li><p><a class="reference internal" href="#operator-combinations" id="id26">Operator Combinations</a></p></li>
<li><p><a class="reference internal" href="#and-behavior" id="id27"><code class="docutils literal notranslate"><span class="pre">and</span></code> Behavior</a></p></li>
<li><p><a class="reference internal" href="#any-of-behavior" id="id28"><code class="docutils literal notranslate"><span class="pre">any_of</span></code> Behavior</a></p></li>
<li><p><a class="reference internal" href="#not-behavior" id="id29"><code class="docutils literal notranslate"><span class="pre">not</span></code> Behavior</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#incremental-query-construction" id="id30">Incremental Query Construction</a></p>
<ul>
<li><p><a class="reference internal" href="#merge-strategies" id="id31">Merge Strategies</a></p></li>
<li><p><a class="reference internal" href="#supported-operator-methods" id="id32">Supported Operator Methods</a></p></li>
<li><p><a class="reference internal" href="#operator-value-expansion" id="id33">Operator Value Expansion</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#query-methods" id="id34">Query Methods</a></p>
<ul>
<li><p><a class="reference internal" href="#elem-match" id="id35">elem_match</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#projection" id="id36">Projection</a></p>
<ul>
<li><p><a class="reference internal" href="#only" id="id37"><code class="docutils literal notranslate"><span class="pre">only</span></code></a></p></li>
<li><p><a class="reference internal" href="#without" id="id38"><code class="docutils literal notranslate"><span class="pre">without</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ordering" id="id39">Ordering</a></p></li>
<li><p><a class="reference internal" href="#pagination" id="id40">Pagination</a></p>
<ul>
<li><p><a class="reference internal" href="#limit" id="id41"><code class="docutils literal notranslate"><span class="pre">limit</span></code></a></p></li>
<li><p><a class="reference internal" href="#skip" id="id42"><code class="docutils literal notranslate"><span class="pre">skip</span></code></a></p></li>
<li><p><a class="reference internal" href="#batch-size" id="id43"><code class="docutils literal notranslate"><span class="pre">batch_size</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#finding-by-id" id="id44">Finding By <code class="docutils literal notranslate"><span class="pre">_id</span></code></a></p></li>
<li><p><a class="reference internal" href="#additional-query-methods" id="id45">Additional Query Methods</a></p></li>
<li><p><a class="reference internal" href="#eager-loading" id="id46">Eager Loading</a></p></li>
<li><p><a class="reference internal" href="#regular-expressions" id="id47">Regular Expressions</a></p></li>
<li><p><a class="reference internal" href="#conditions-on-fields" id="id48">Conditions On Fields</a></p></li>
<li><p><a class="reference internal" href="#scoping" id="id49">Scoping</a></p>
<ul>
<li><p><a class="reference internal" href="#named-scopes" id="id50">Named Scopes</a></p></li>
<li><p><a class="reference internal" href="#default-scopes" id="id51">Default Scopes</a></p></li>
<li><p><a class="reference internal" href="#runtime-default-scope-override" id="id52">Runtime Default Scope Override</a></p></li>
<li><p><a class="reference internal" href="#class-methods" id="id53">Class Methods</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#queries-persistence" id="id54">Queries + Persistence</a></p></li>
<li><p><a class="reference internal" href="#query-cache" id="id55">Query Cache</a></p>
<ul>
<li><p><a class="reference internal" href="#enabling-query-cache" id="id56">Enabling Query Cache</a></p></li>
<li><p><a class="reference internal" href="#enabling-query-cache-via-middleware" id="id57">Enabling Query Cache Via Middleware</a></p></li>
<li><p><a class="reference internal" href="#enabling-query-cache-manually" id="id58">Enabling Query Cache Manually</a></p></li>
<li><p><a class="reference internal" href="#query-cache-shared-with-driver" id="id59">Query Cache Shared With Driver</a></p></li>
<li><p><a class="reference internal" href="#caching-the-result-of-first" id="id60">Caching the Result of <code class="docutils literal notranslate"><span class="pre">#first</span></code></a></p></li>
<li><p><a class="reference internal" href="#legacy-query-cache-limitations" id="id61">Legacy Query Cache Limitations</a></p></li>
</ul>
</li>
</ul>
</div>
<p>Mongoid provides a rich query DSL inspired by ActiveRecord. A trivial query
looks as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>A more complex query utilizing various Mongoid features could be as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span>
  <span class="n">where</span><span class="p">(</span><span class="ss">:founded</span><span class="o">.</span><span class="n">gte</span> <span class="o">=&gt;</span> <span class="s2">&quot;1980-01-01&quot;</span><span class="p">)</span><span class="o">.</span>
  <span class="k">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;Tool&quot;</span><span class="p">,</span> <span class="s2">&quot;Deftones&quot;</span> <span class="o">]</span><span class="p">)</span><span class="o">.</span>
  <span class="n">union</span><span class="o">.</span>
  <span class="k">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;Melvins&quot;</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
<p>The query methods return <code class="docutils literal notranslate"><span class="pre">Mongoid::Criteria</span></code> objects, which are chainable
and lazily evaluated wrappers for MongoDB query language (MQL).
The queries are executed when their result sets are iterated. For example:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Construct a Criteria object:</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Deftones&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;name&quot;=&gt;&quot;Deftones&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="c1"># Evaluate the query and get matching documents:</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Deftones&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1"># =&gt; [#&lt;Band _id: 5ebdeddfe1b83265a376a760, name: &quot;Deftones&quot;, description: nil&gt;]</span>
</pre></div>
</div>
<p>Methods like <code class="docutils literal notranslate"><span class="pre">first</span></code> and <code class="docutils literal notranslate"><span class="pre">last</span></code> return the individual documents immediately.
Otherwise, iterating a Criteria object with methods like <code class="docutils literal notranslate"><span class="pre">each</span></code> or <code class="docutils literal notranslate"><span class="pre">map</span></code>
retrieves the documents from the server. <code class="docutils literal notranslate"><span class="pre">to_a</span></code> can be used to force
execution of a query that returns an array of documents, literally converting
a Criteria object to an Array.</p>
<p>When a query method is called on a Criteria instance, the method returns a new
Criteria instance with the new conditions added to the existing conditions:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">scope</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:founded</span><span class="o">.</span><span class="n">gte</span> <span class="o">=&gt;</span> <span class="s2">&quot;1980-01-01&quot;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;{&quot;$gte&quot;=&gt;&quot;1980-01-01&quot;}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="n">scope</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:founded</span><span class="o">.</span><span class="n">lte</span> <span class="o">=&gt;</span> <span class="s2">&quot;2020-01-01&quot;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;{&quot;$gte&quot;=&gt;&quot;1980-01-01&quot;, &quot;$lte&quot;=&gt;&quot;2020-01-01&quot;}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="n">scope</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;{&quot;$gte&quot;=&gt;&quot;1980-01-01&quot;}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
<section id="condition-syntax">
<h2>Condition Syntax<a class="headerlink" href="#condition-syntax" title="Permalink to this headline">#</a></h2>
<p>Mongoid supports three ways of specifying individual conditions:</p>
<ol class="arabic simple">
<li><p>Field syntax.</p></li>
<li><p>MQL syntax.</p></li>
<li><p>Symbol operator syntax.</p></li>
</ol>
<p>All syntaxes support querying embedded documents using the dot notation.
All syntaxes respect field types, if the field being queried is defined in the
model class, and field aliases.</p>
<p>The examples in this section use the following model definition:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:founded</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="n">field</span> <span class="ss">:m</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:member_count</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>

  <span class="n">embeds_one</span> <span class="ss">:manager</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manager</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">embedded_in</span> <span class="ss">:band</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>
</pre></div>
</div>
<section id="field-syntax">
<h3>Field Syntax<a class="headerlink" href="#field-syntax" title="Permalink to this headline">#</a></h3>
<p>The simplest querying syntax utilizes the basic Ruby hashes. Keys can be
symbols or strings, and correspond to field names in MongoDB documents:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
<span class="c1">#   =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;name&quot;=&gt;&quot;Depeche Mode&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="c1"># Equivalent to:</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="mql-syntax">
<h3>MQL Syntax<a class="headerlink" href="#mql-syntax" title="Permalink to this headline">#</a></h3>
<p>An MQL operator may be specified on any field using the hash syntax:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">founded</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span> <span class="o">=&gt;</span> <span class="mi">1980</span><span class="p">})</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;{&quot;$gt&quot;=&gt;1980}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="c1"># Equivalent to:</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;founded&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span> <span class="o">=&gt;</span> <span class="mi">1980</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="symbol-operator-syntax">
<h3>Symbol Operator Syntax<a class="headerlink" href="#symbol-operator-syntax" title="Permalink to this headline">#</a></h3>
<p>MQL operators may be specified as methods on symbols for the respective field
name, as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:founded</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">1980</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;{&quot;$gt&quot;=&gt;1980}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="embedded-documents">
<h2>Embedded Documents<a class="headerlink" href="#embedded-documents" title="Permalink to this headline">#</a></h2>
<p>To match values of fields of embedded documents, use the dot notation:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;manager.name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;manager.name&quot;=&gt;&quot;Smith&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:&#39;manager.name&#39;</span><span class="o">.</span><span class="n">ne</span> <span class="o">=&gt;</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;manager.name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Smith&quot;}}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Queries always return top-level model instances, even if all of the
conditions are referencing embedded documents.</p>
</div>
</section>
<section id="field-types">
<h2>Field Types<a class="headerlink" href="#field-types" title="Permalink to this headline">#</a></h2>
<p>In order to query on a field, it is not necessary to add the field to
<a class="reference internal" href="fields.html#fields"><span class="std std-ref">the model class definition</span></a>. However, if a field is defined in
the model class, the type of the field is taken into account when constructing
the query:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">2020</span><span class="p">)</span>
<span class="c1">#   =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;name&quot;=&gt;&quot;2020&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">founded</span><span class="p">:</span> <span class="mi">2020</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;founded&quot;=&gt;2020}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</section>
<section id="aliases">
<h2>Aliases<a class="headerlink" href="#aliases" title="Permalink to this headline">#</a></h2>
<p>Queries take into account <a class="reference internal" href="fields.html#storage-field-names"><span class="std std-ref">storage field names</span></a>
and <a class="reference internal" href="fields.html#field-aliases"><span class="std std-ref">field aliases</span></a>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>
<span class="c1">#   =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;n&quot;=&gt;&quot;Astral Projection&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
<p>Since <cite>id</cite> and <cite>_id</cite> fields are aliases, either one can be used for queries:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;5ebdeddfe1b83265a376a760&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;_id&quot;=&gt;BSON::ObjectId(&#39;5ebdeddfe1b83265a376a760&#39;)}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</section>
<section id="logical-operations">
<span id="id1"></span><h2>Logical Operations<a class="headerlink" href="#logical-operations" title="Permalink to this headline">#</a></h2>
<p>Mongoid supports <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code>, <code class="docutils literal notranslate"><span class="pre">nor</span></code> and <code class="docutils literal notranslate"><span class="pre">not</span></code> logical operations on
<code class="docutils literal notranslate"><span class="pre">Criteria</span></code> objects. These methods take one or more hash of conditions
or another <code class="docutils literal notranslate"><span class="pre">Criteria</span></code> object as their arguments, with <code class="docutils literal notranslate"><span class="pre">not</span></code> additionally
having an argument-free version.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># and with conditions</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust in Trance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>

<span class="c1"># or with scope</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust in Trance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">))</span>

<span class="c1"># not with conditions</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust in Trance&#39;</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>

<span class="c1"># argument-less not</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust in Trance&#39;</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>For backwards compatibility with earlier Mongoid versions, all of the logical
operation methods also accept arrays of parameters, which will be flattened
to obtain the criteria. Passing arrays to logical operations is deprecated and
may be removed in a future version of Mongoid.</p>
<p>The following calls all produce the same query conditions:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Condition hashes passed to separate and invocations</span>
<span class="no">Band</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Multiple condition hashes in the same and invocation</span>
<span class="no">Band</span><span class="o">.</span><span class="n">and</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">},</span> <span class="p">{</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

<span class="c1"># Multiple condition hashes in an array - deprecated</span>
<span class="no">Band</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="o">[</span><span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">},</span> <span class="p">{</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span><span class="o">]</span><span class="p">)</span>

<span class="c1"># Condition hash in where and a scope</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">))</span>

<span class="c1"># Condition hash in and and a scope</span>
<span class="no">Band</span><span class="o">.</span><span class="n">and</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">},</span> <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">))</span>

<span class="c1"># Scope as an array element, nested arrays - deprecated</span>
<span class="no">Band</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="o">[</span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;SUN Project&#39;</span><span class="p">),</span> <span class="o">[</span><span class="p">{</span><span class="ss">member_count</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span><span class="o">]]</span><span class="p">)</span>

<span class="c1"># All produce:</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;name&quot;=&gt;&quot;SUN Project&quot;, &quot;member_count&quot;=&gt;2}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
<section id="operator-combinations">
<h3>Operator Combinations<a class="headerlink" href="#operator-combinations" title="Permalink to this headline">#</a></h3>
<p>As of Mongoid 7.1, logical operators (<code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code>, <code class="docutils literal notranslate"><span class="pre">nor</span></code> and <code class="docutils literal notranslate"><span class="pre">not</span></code>)
have been changed to have the the same semantics as <a class="reference external" href="https://guides.rubyonrails.org/active_record_querying.html">those of ActiveRecord</a>.
To obtain the semantics of <code class="docutils literal notranslate"><span class="pre">or</span></code> as it behaved in Mongoid 7.0 and earlier,
use <code class="docutils literal notranslate"><span class="pre">any_of</span></code> which is described below.</p>
<p>When conditions are specified on the same field multiple times, all
conditions are added to the criteria:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;&quot;1&quot;, &quot;$and&quot;=&gt;[{&quot;name&quot;=&gt;&quot;2&quot;}]}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;1&quot;}, {&quot;name&quot;=&gt;&quot;2&quot;}]}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">any_of</span></code>, <code class="docutils literal notranslate"><span class="pre">nor</span></code> and <code class="docutils literal notranslate"><span class="pre">not</span></code> behave similarly, with <code class="docutils literal notranslate"><span class="pre">not</span></code> producing
different query shapes as described below.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code> and <code class="docutils literal notranslate"><span class="pre">nor</span></code> logical operators are used, they
operate on the criteria built up to that point and its argument.
<code class="docutils literal notranslate"><span class="pre">where</span></code> has the same meaning as <code class="docutils literal notranslate"><span class="pre">and</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># or joins the two conditions</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Sun&quot;}, {&quot;label&quot;=&gt;&quot;Trust&quot;}]}</span>

<span class="c1"># or applies only to the first condition, the second condition is added</span>
<span class="c1"># to the top level as $and</span>
<span class="no">Band</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Sun&quot;}], &quot;label&quot;=&gt;&quot;Trust&quot;}</span>

<span class="c1"># Same as previous example - where and and are aliases</span>
<span class="no">Band</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Sun&quot;}], &quot;label&quot;=&gt;&quot;Trust&quot;}</span>

<span class="c1"># Same operator can be stacked any number of times</span>
<span class="no">Band</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Sun&quot;}, {&quot;label&quot;=&gt;&quot;Trust&quot;}]}</span>

<span class="c1"># The label: Foo condition is added to the top level as $and</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Sun&quot;}, {&quot;label&quot;=&gt;&quot;Trust&quot;}], &quot;label&quot;=&gt;&quot;Foo&quot;}</span>
</pre></div>
</div>
</section>
<section id="and-behavior">
<h3><code class="docutils literal notranslate"><span class="pre">and</span></code> Behavior<a class="headerlink" href="#and-behavior" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">and</span></code> method will add new simple conditions to the top level of the
criteria, unless the receiving criteria already has a condition on the
respective fields, in which case the conditions will be combined with <code class="docutils literal notranslate"><span class="pre">$and</span></code>.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust in Trance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;label&quot;=&gt;&quot;Trust in Trance Records&quot;, &quot;name&quot;=&gt;&quot;Astral Projection&quot;}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;/Best/, &quot;$and&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Astral Projection&quot;}]}</span>
</pre></div>
</div>
<p>As of Mongoid 7.1, specifying multiple criteria on the same field with <code class="docutils literal notranslate"><span class="pre">and</span></code>
combines all criteria so specified, whereas in previous versions of Mongoid
conditions on a field sometimes replaced previously specified conditions on
the same field, depending on which form of <code class="docutils literal notranslate"><span class="pre">and</span></code> was used.</p>
<p><code class="docutils literal notranslate"><span class="pre">or</span></code>/<code class="docutils literal notranslate"><span class="pre">nor</span></code> Behavior
_-</p>
<p><code class="docutils literal notranslate"><span class="pre">or</span></code> and <code class="docutils literal notranslate"><span class="pre">nor</span></code> produce <code class="docutils literal notranslate"><span class="pre">$or</span></code> and <code class="docutils literal notranslate"><span class="pre">$nor</span></code> MongoDB operators, respectively,
using the receiver and all of the arguments as operands. For example:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;/Best/}, {&quot;name&quot;=&gt;&quot;Astral Projection&quot;}]}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span>
  <span class="ow">or</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="sr">/Records/</span><span class="p">))</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s1">&#39;Trust&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;/Best/, &quot;$and&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Astral Projection&quot;}]}, {&quot;label&quot;=&gt;/Records/}], &quot;label&quot;=&gt;&quot;Trust&quot;}</span>
</pre></div>
</div>
<p>If the only condition on the receiver is another <code class="docutils literal notranslate"><span class="pre">or</span></code>/<code class="docutils literal notranslate"><span class="pre">nor</span></code>, the new
conditions are added to the existing list:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span>
  <span class="ow">or</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="sr">/Records/</span><span class="p">))</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;/Best/}, {&quot;name&quot;=&gt;&quot;Astral Projection&quot;}, {&quot;label&quot;=&gt;/Records/}]}</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">any_of</span></code> to add a disjunction to a Criteria object while maintaining
all of the conditions built up so far as they are.</p>
</section>
<section id="any-of-behavior">
<span id="any-of"></span><h3><code class="docutils literal notranslate"><span class="pre">any_of</span></code> Behavior<a class="headerlink" href="#any-of-behavior" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">any_of</span></code> adds a disjunction built from its arguments to the existing
conditions in the criteria. For example:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="sr">/Trust/</span><span class="p">)</span><span class="o">.</span><span class="n">any_of</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">},</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">})</span>
<span class="c1"># =&gt; {&quot;label&quot;=&gt;/Trust/, &quot;$or&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Astral Projection&quot;}, {&quot;name&quot;=&gt;/Best/}]}</span>
</pre></div>
</div>
<p>The conditions are hoisted to the top level if possible:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="sr">/Trust/</span><span class="p">)</span><span class="o">.</span><span class="n">any_of</span><span class="p">({</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">})</span>
<span class="c1"># =&gt; {&quot;label&quot;=&gt;/Trust/, &quot;name&quot;=&gt;&quot;Astral Projection&quot;}</span>
</pre></div>
</div>
</section>
<section id="not-behavior">
<h3><code class="docutils literal notranslate"><span class="pre">not</span></code> Behavior<a class="headerlink" href="#not-behavior" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">not</span></code> method can be called without arguments, in which case it will negate
the next condition that is specified. <code class="docutils literal notranslate"><span class="pre">not</span></code> can also be called with one
or more hash conditions or <code class="docutils literal notranslate"><span class="pre">Criteria</span></code> objects, which will all be negated and
added to the criteria.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># not negates subsequent where</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Best&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Best&quot;}}</span>

<span class="c1"># The second where is added as $and</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Best&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="sr">/Records/</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Best&quot;}, &quot;label&quot;=&gt;/Records/}</span>

<span class="c1"># not negates its argument</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Best&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Best&quot;}}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">$not</span></code> in MongoDB server cannot be used with a string argument.
Mongoid uses <code class="docutils literal notranslate"><span class="pre">$ne</span></code> operator to achieve such a negation:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># String negation - uses $ne</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Best&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Best&quot;}}</span>

<span class="c1"># Regexp negation - uses $not</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$not&quot;=&gt;/Best/}}</span>
</pre></div>
</div>
</div>
<p>Similarly to <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">not</span></code> will negate individual conditions for simple
field criteria. For complex conditions and when a field already has a condition
defined on it, since MongoDB server only supports the <code class="docutils literal notranslate"><span class="pre">$not</span></code> operator on
a per-field basis rather than globally, Mongoid emulates <code class="docutils literal notranslate"><span class="pre">$not</span></code> by using
an <code class="docutils literal notranslate"><span class="pre">{'$and'</span> <span class="pre">=&gt;</span> <span class="pre">[{'$nor'</span> <span class="pre">=&gt;</span> <span class="pre">...}]}</span></code> construct:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simple condition</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;{&quot;$not&quot;=&gt;/Best/}}</span>

<span class="c1"># Complex conditions</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/Best/</span><span class="p">)</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;name&quot;=&gt;/Best/, &quot;$and&quot;=&gt;[{&quot;$nor&quot;=&gt;[{&quot;name&quot;=&gt;&quot;Astral Projection&quot;}]}]}</span>

<span class="c1"># Symbol operator syntax</span>
<span class="no">Band</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">:name</span><span class="o">.</span><span class="n">ne</span> <span class="o">=&gt;</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;$and&quot;=&gt;[{&quot;$nor&quot;=&gt;[{&quot;name&quot;=&gt;{&quot;$ne&quot;=&gt;&quot;Astral Projection&quot;}}]}]}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
<p>If using <code class="docutils literal notranslate"><span class="pre">not</span></code> with arrays or regular expressions, please note the
caveats/limitations of <code class="docutils literal notranslate"><span class="pre">$not</span></code> <a class="reference external" href="https://mongodb.com/docs/manual/reference/operator/query/not/">stated in the MongoDB server documentation</a>.</p>
</section>
</section>
<section id="incremental-query-construction">
<h2>Incremental Query Construction<a class="headerlink" href="#incremental-query-construction" title="Permalink to this headline">#</a></h2>
<p>By default, when conditions are added to a query, Mongoid considers each
condition complete and independent from any other conditions potentially
present in the query. For example, calling <code class="docutils literal notranslate"><span class="pre">in</span></code> twice adds two separate
<code class="docutils literal notranslate"><span class="pre">$in</span></code> conditions:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;a&quot;</span><span class="o">]</span><span class="p">},</span> <span class="s2">&quot;$and&quot;</span><span class="o">=&gt;[</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span><span class="o">]</span><span class="p">}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Some operator methods support building the condition incrementally. In this
case, when an condition on a field which uses one of the supported operators
is being added, if there already is a condition on the same field using the
same operator, the operator expressions are combined according to the
specified <em>merge strategy</em>.</p>
<section id="merge-strategies">
<span id="id2"></span><h3>Merge Strategies<a class="headerlink" href="#merge-strategies" title="Permalink to this headline">#</a></h3>
<p>Mongoid provides three merge strategies:</p>
<ul class="simple">
<li><p><strong>Override</strong>: the new operator instance replaces any existing conditions on
the same field using the same operator.</p></li>
<li><p><strong>Intersect</strong>: if there already is a condition using the same operator on the
same field, the values of the existing condition are intersected with the
values of the new condition and the result is stored as the operator value.</p></li>
<li><p><strong>Union</strong>: if there already is a condition using the same operator on the
same field, the values of the new condition are added to the values of the
existing condition and the result is stored as the operator value.</p></li>
</ul>
<p>The following snippet demonstrates all of the strategies, using <code class="docutils literal notranslate"><span class="pre">in</span></code> as the
example operator:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">override</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">intersect</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The strategy is requested by calling <code class="docutils literal notranslate"><span class="pre">override</span></code>, <code class="docutils literal notranslate"><span class="pre">intersect</span></code> or <code class="docutils literal notranslate"><span class="pre">union</span></code>
on a <code class="docutils literal notranslate"><span class="pre">Criteria</span></code> instance. The requested strategy applies to the next
condition method called on the query. If the next condition method called does
not support merge strategies, the strategy is reset, as shown in the following
example:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;a&quot;</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;$ne&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;c&quot;</span><span class="p">},</span> <span class="s2">&quot;$and&quot;</span><span class="o">=&gt;[</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span><span class="o">]</span><span class="p">}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">ne</span></code> does not support merge strategies, the <code class="docutils literal notranslate"><span class="pre">union</span></code> strategy was
ignored and reset and when <code class="docutils literal notranslate"><span class="pre">in</span></code> was invoked the second time there was no
strategy active.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Merge strategies currently assume the previous condition(s) have been added
to the top level of the query, however this is not always the case
(conditions may be nested under an <code class="docutils literal notranslate"><span class="pre">$and</span></code> clause). Using merge strategies
with complex criteria may cause incorrect queries to be constructed.
This misbehavior is <a class="reference external" href="https://jira.mongodb.org/browse/MONGOID-5350">intended to be fixed in the future</a>.</p>
</div>
</section>
<section id="supported-operator-methods">
<h3>Supported Operator Methods<a class="headerlink" href="#supported-operator-methods" title="Permalink to this headline">#</a></h3>
<p>The following operator methods support merge strategies:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">all</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">in</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nin</span></code></p></li>
</ul>
<p>The set of methods may be expanded in future releases of Mongoid. For
future compatibility, only invoke a strategy method when the next method call
is an operator that supports merge strategies.</p>
<p>Note that the merge strategies are currently only applied when conditions are
added through the designated methods. In the following example merge strategy
is not applied because the second condition is added via <code class="docutils literal notranslate"><span class="pre">where</span></code>, not via
<code class="docutils literal notranslate"><span class="pre">in</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="ss">foo</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">foo</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$in&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;b&#39;</span><span class="p">})</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;a&quot;</span><span class="o">]</span><span class="p">},</span> <span class="s2">&quot;$and&quot;</span><span class="o">=&gt;[</span><span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;b&quot;</span><span class="p">}}</span><span class="o">]</span><span class="p">}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This behavior may change in a future release of Mongoid and should not be
relied upon.</p>
<p>In contrast, it does not matter how the existing query was built when a
merge strategy-supporting operator method is invoked. In the following
example, the first condition was added through <code class="docutils literal notranslate"><span class="pre">where</span></code> but the strategy
mechanism still applies:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">foo</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$in&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span><span class="o">]</span><span class="p">})</span><span class="o">.</span><span class="n">union</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="ss">foo</span><span class="p">:</span> <span class="o">[</span><span class="s1">&#39;b&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="operator-value-expansion">
<h3>Operator Value Expansion<a class="headerlink" href="#operator-value-expansion" title="Permalink to this headline">#</a></h3>
<p>Operator methods that support merge strategies all take <code class="docutils literal notranslate"><span class="pre">Array</span></code> as their value
type. Mongoid expands <code class="docutils literal notranslate"><span class="pre">Array</span></code>-compatible types, such as a <code class="docutils literal notranslate"><span class="pre">Range</span></code>,
when they are used with these operator methods:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="ss">year</span><span class="p">:</span> <span class="mi">1950</span><span class="o">..</span><span class="mi">1960</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="mi">1950</span><span class="p">,</span> <span class="mi">1951</span><span class="p">,</span> <span class="mi">1952</span><span class="p">,</span> <span class="mi">1953</span><span class="p">,</span> <span class="mi">1954</span><span class="p">,</span> <span class="mi">1955</span><span class="p">,</span> <span class="mi">1956</span><span class="p">,</span> <span class="mi">1957</span><span class="p">,</span> <span class="mi">1958</span><span class="p">,</span> <span class="mi">1959</span><span class="p">,</span> <span class="mi">1960</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Additionally, Mongoid has historically wrapped non-<code class="docutils literal notranslate"><span class="pre">Array</span></code> values in arrays,
as the following example demonstrates:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">in</span><span class="p">(</span><span class="ss">year</span><span class="p">:</span> <span class="mi">1950</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">=&gt;[</span><span class="mi">1950</span><span class="o">]</span><span class="p">}}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This wrapping behavior is deprecated and should not be relied on. It may be
removed in a future release of Mongoid.</p>
</section>
</section>
<section id="query-methods">
<h2>Query Methods<a class="headerlink" href="#query-methods" title="Permalink to this headline">#</a></h2>
<section id="elem-match">
<h3>elem_match<a class="headerlink" href="#elem-match" title="Permalink to this headline">#</a></h3>
<p>This matcher finds documents with array fields where one of the array values
matches all of the conditions. For example:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:tours</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span>
<span class="k">end</span>

<span class="n">aerosmith</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Aerosmith&#39;</span><span class="p">,</span> <span class="ss">tours</span><span class="p">:</span> <span class="o">[</span>
  <span class="p">{</span><span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;London&#39;</span><span class="p">,</span> <span class="ss">year</span><span class="p">:</span> <span class="mi">1995</span><span class="p">},</span>
  <span class="p">{</span><span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="ss">year</span><span class="p">:</span> <span class="mi">1999</span><span class="p">},</span>
<span class="o">]</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">elem_match</span><span class="p">(</span><span class="ss">tours</span><span class="p">:</span> <span class="p">{</span><span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;London&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">to_a</span> <span class="c1"># =&gt; [aerosmith]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">elem_match</span></code> also works with embedded associations:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">embeds_many</span> <span class="ss">:tours</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tour</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:city</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:year</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="n">embedded_in</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="n">dm</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Depeche Mode&#39;</span><span class="p">)</span>
<span class="n">aerosmith</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Aerosmith&#39;</span><span class="p">)</span>
<span class="no">Tour</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">band</span><span class="p">:</span> <span class="n">aerosmith</span><span class="p">,</span> <span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;London&#39;</span><span class="p">,</span> <span class="ss">year</span><span class="p">:</span> <span class="mi">1995</span><span class="p">)</span>
<span class="no">Tour</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">band</span><span class="p">:</span> <span class="n">aerosmith</span><span class="p">,</span> <span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="ss">year</span><span class="p">:</span> <span class="mi">1999</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">elem_match</span><span class="p">(</span><span class="ss">tours</span><span class="p">:</span> <span class="p">{</span><span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;London&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">to_a</span> <span class="c1"># =&gt; [aerosmith]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">elem_match</span></code> does not work with non-embedded associations because MongoDB
does not have joins - the conditions would be added to the collection
that is the source of a non-embedded association rather than the collection
of the associations target.</p>
<p><code class="docutils literal notranslate"><span class="pre">elem_match</span></code> can also be used with recursively embedded associations,
as the following example shows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Tag</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">recursively_embeds_many</span>
<span class="k">end</span>

<span class="n">root</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">)</span>
<span class="n">sub1</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;sub1&#39;</span><span class="p">,</span> <span class="ss">child_tags</span><span class="p">:</span> <span class="o">[</span><span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;subsub1&#39;</span><span class="p">)</span><span class="o">]</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">child_tags</span> <span class="o">&lt;&lt;</span> <span class="n">sub1</span>
<span class="n">root</span><span class="o">.</span><span class="n">child_tags</span> <span class="o">&lt;&lt;</span> <span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;sub2&#39;</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">save!</span>

<span class="no">Tag</span><span class="o">.</span><span class="n">elem_match</span><span class="p">(</span><span class="ss">child_tags</span><span class="p">:</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;sub1&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">to_a</span> <span class="c1"># =&gt; [root]</span>

<span class="n">root</span><span class="o">.</span><span class="n">child_tags</span><span class="o">.</span><span class="n">elem_match</span><span class="p">(</span><span class="ss">child_tags</span><span class="p">:</span> <span class="p">{</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;subsub1&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">to_a</span> <span class="c1"># =&gt; [sub1]</span>
</pre></div>
</div>
</section>
</section>
<section id="projection">
<span id="id3"></span><h2>Projection<a class="headerlink" href="#projection" title="Permalink to this headline">#</a></h2>
<p>Mongoid provides two projection operators: <code class="docutils literal notranslate"><span class="pre">only</span></code> and <code class="docutils literal notranslate"><span class="pre">without</span></code>.</p>
<section id="only">
<span id="id4"></span><h3><code class="docutils literal notranslate"><span class="pre">only</span></code><a class="headerlink" href="#only" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">only</span></code> method retrieves only the specified fields from the database. This
operation is sometimes called projection.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>

  <span class="n">embeds_many</span> <span class="ss">:tours</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tour</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:city</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:year</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>

  <span class="n">embedded_in</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</pre></div>
</div>
<p>Attempting to reference attributes which have not been loaded results in
<code class="docutils literal notranslate"><span class="pre">ActiveModel::MissingAttributeError</span></code>.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span><span class="o">.</span><span class="n">label</span>
<span class="c1"># ActiveModel::MissingAttributeError (Missing attribute: &#39;label&#39;.)</span>
</pre></div>
</div>
<p>Even though Mongoid currently allows writing to attributes that have not
been loaded, such writes will not be persisted
(<a class="reference external" href="https://jira.mongodb.org/browse/MONGOID-4701">MONGOID-4701</a>) and
should therefore be avoided.</p>
<p><code class="docutils literal notranslate"><span class="pre">only</span></code> can also be used with embedded associations:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s1">&#39;tours.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
<span class="c1"># =&gt; #&lt;Band _id: 5c59afb1026d7c034dba46ac, name: &quot;Aerosmith&quot;&gt;</span>

<span class="n">band</span><span class="o">.</span><span class="n">tours</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; #&lt;Tour _id: 5c59afdf026d7c034dba46af, city: nil, year: 1995&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Server versions 4.2 and lower allowed projecting both an association and
the associations fields in the same query, as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:tours</span><span class="p">,</span> <span class="s1">&#39;tours.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</pre></div>
</div>
<p>The most recent projection specification overrides the earlier one.
For example, the above query was equivalent to:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s1">&#39;tours.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</pre></div>
</div>
<p>Server versions 4.4 and higher prohibit specifying an association and its
fields in projection in the same query.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">only</span></code> can be specified with referenced associations (has_one, has_many,
has_and_belongs_to_many) but is currently ignored for referenced associations -
all fields of referenced associations will be loaded
(<a class="reference external" href="https://jira.mongodb.org/browse/MONGOID-4704">MONGOID-4704</a>).</p>
<p>Note that if a document has <code class="docutils literal notranslate"><span class="pre">has_one</span></code> or <code class="docutils literal notranslate"><span class="pre">has_and_belongs_to_many</span></code> associations,
the fields with foreign keys must be included in the list of attributes
loaded with <code class="docutils literal notranslate"><span class="pre">only</span></code> for those associations to be loaded. For example:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:managers</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manager</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:bands</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">managers</span> <span class="o">&lt;&lt;</span> <span class="no">Manager</span><span class="o">.</span><span class="n">new</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">managers</span>
<span class="c1"># =&gt; []</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:manager_ids</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">managers</span>
<span class="c1"># =&gt; [#&lt;Manager _id: 5c5dc2f0026d7c1730969843, band_ids: [BSON::ObjectId(&#39;5c5dc2f0026d7c1730969842&#39;)]&gt;]</span>
</pre></div>
</div>
</section>
<section id="without">
<span id="id5"></span><h3><code class="docutils literal notranslate"><span class="pre">without</span></code><a class="headerlink" href="#without" title="Permalink to this headline">#</a></h3>
<p>The opposite of <code class="docutils literal notranslate"><span class="pre">only</span></code>, <code class="docutils literal notranslate"><span class="pre">without</span></code> causes the specified fields to be omitted:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">without</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:fields=&gt;{&quot;name&quot;=&gt;0}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
<p>Because Mongoid requires the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field for various operations, it (as well
as its <code class="docutils literal notranslate"><span class="pre">id</span></code> alias) cannot be omitted via <code class="docutils literal notranslate"><span class="pre">without</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">without</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:fields=&gt;{&quot;name&quot;=&gt;0}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">without</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:_id</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:fields=&gt;{&quot;name&quot;=&gt;0}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="ordering">
<span id="id6"></span><h2>Ordering<a class="headerlink" href="#ordering" title="Permalink to this headline">#</a></h2>
<p>Mongoid provides the <code class="docutils literal notranslate"><span class="pre">order</span></code> method on <code class="docutils literal notranslate"><span class="pre">Criteria</span></code> objects and its alias,
<code class="docutils literal notranslate"><span class="pre">order_by</span></code>, to specify the ordering of documents. These methods take a
hash indicating which fields to order the documents by, and whether to use
ascending or descending order for each field.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:sort=&gt;{&quot;name&quot;=&gt;1}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:sort=&gt;{&quot;name&quot;=&gt;-1, &quot;description&quot;=&gt;1}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="s1">&#39;asc&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:sort=&gt;{&quot;name&quot;=&gt;-1, &quot;description&quot;=&gt;1}}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
<p>The direction may be specified as integers <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">-1</span></code> for ascending
and descending, respectively, or as symbols <code class="docutils literal notranslate"><span class="pre">:asc</span></code> and <code class="docutils literal notranslate"><span class="pre">:desc</span></code>, or as
strings <code class="docutils literal notranslate"><span class="pre">&quot;asc&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;desc&quot;</span></code>.</p>
<p>Alternatively, <code class="docutils literal notranslate"><span class="pre">order</span></code> accepts an array of two-element arrays specifying
the ordering. Field names and directions may be strings or symbols.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="o">]]</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="o">[[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:desc</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:description</span><span class="p">,</span> <span class="ss">:asc</span><span class="o">]]</span><span class="p">)</span>
</pre></div>
</div>
<p>Another way of providing the order is to use <code class="docutils literal notranslate"><span class="pre">#asc</span></code> and <code class="docutils literal notranslate"><span class="pre">#desc</span></code> methods
on symbols, as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">:name</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span> <span class="ss">:description</span><span class="o">.</span><span class="n">asc</span><span class="p">)</span>
</pre></div>
</div>
<p>The arguments can be provided as a string using SQL syntax:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;name desc, description asc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, there are <code class="docutils literal notranslate"><span class="pre">asc</span></code> and <code class="docutils literal notranslate"><span class="pre">desc</span></code> methods that can be used instead of
<code class="docutils literal notranslate"><span class="pre">order</span></code>/<code class="docutils literal notranslate"><span class="pre">order_by</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">asc</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{</span><span class="ss">:sort</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="o">=&gt;-</span><span class="mi">1</span><span class="p">}}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">order</span></code> calls can be chained, in which case the oldest calls define the
most significant criteria and the newest calls define the least significant
ones (since in Ruby hashes maintain the order of their keys):</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;name desc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;description asc&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{</span><span class="ss">:sort</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">}}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This can sometimes lead to surprising results if there are scopes, including
the default scope, that use <code class="docutils literal notranslate"><span class="pre">order</span></code>/<code class="docutils literal notranslate"><span class="pre">order_by</span></code>. For example, in the
following snippet bands are ordered by name first because the order in the
default scope takes precedence over the order given in the query, due to
the default scope being evaluated first:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:year</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="ss">:asc</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="ss">year</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Mongoid::Criteria</span>
  <span class="ss">selector</span><span class="p">:</span> <span class="p">{}</span>
  <span class="ss">options</span><span class="p">:</span>  <span class="p">{</span><span class="ss">:sort</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="o">=&gt;-</span><span class="mi">1</span><span class="p">}}</span>
  <span class="ss">class</span><span class="p">:</span>    <span class="no">Band</span>
  <span class="ss">embedded</span><span class="p">:</span> <span class="kp">false</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="pagination">
<h2>Pagination<a class="headerlink" href="#pagination" title="Permalink to this headline">#</a></h2>
<p>Mongoid provides the pagination operators <code class="docutils literal notranslate"><span class="pre">limit</span></code>, <code class="docutils literal notranslate"><span class="pre">skip</span></code>, and <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> on <code class="docutils literal notranslate"><span class="pre">Criteria</span></code>.</p>
<section id="limit">
<span id="id7"></span><h3><code class="docutils literal notranslate"><span class="pre">limit</span></code><a class="headerlink" href="#limit" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">limit</span></code> sets the total number of documents to be returned by a query:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:limit=&gt;5}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</section>
<section id="skip">
<span id="id8"></span><h3><code class="docutils literal notranslate"><span class="pre">skip</span></code><a class="headerlink" href="#skip" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">skip</span></code> (alias: <code class="docutils literal notranslate"><span class="pre">offset</span></code>) sets the number of query results to skip
before returning documents. The <code class="docutils literal notranslate"><span class="pre">limit</span></code> value, if specified, will be applied
after documents are skipped. When performing pagination, <code class="docutils literal notranslate"><span class="pre">skip</span></code> is recommended
to be combined with <a class="reference internal" href="#ordering"><span class="std std-ref">ordering</span></a> to ensure consistent results.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:skip=&gt;10}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</section>
<section id="batch-size">
<span id="id9"></span><h3><code class="docutils literal notranslate"><span class="pre">batch_size</span></code><a class="headerlink" href="#batch-size" title="Permalink to this headline">#</a></h3>
<p>When executing large queries, or when iterating over query results with an enumerator method such as
<code class="docutils literal notranslate"><span class="pre">Criteria#each</span></code>, Mongoid automatically uses the <a class="reference external" href="https://mongodb.com/docs/manual/reference/command/getMore/">MongoDB getMore command</a> to load results in batches.
The default <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> is 1000, however you may set it explicitly:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">batch_size</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {}</span>
<span class="c1">#   options:  {:batch_size=&gt;500}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="finding-by-id">
<h2>Finding By <code class="docutils literal notranslate"><span class="pre">_id</span></code><a class="headerlink" href="#finding-by-id" title="Permalink to this headline">#</a></h2>
<p>Mongoid provides the <code class="docutils literal notranslate"><span class="pre">find</span></code> method on <code class="docutils literal notranslate"><span class="pre">Criteria</span></code> objects to find documents
by their <code class="docutils literal notranslate"><span class="pre">_id</span></code> values:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Band _id: 5f0e41d92c97a64a26aabd10, name: &quot;Juno Reactor&quot;&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">find</span></code> method performs type conversion, if necessary, of the argument
to the type declared in the model being queried for the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field.
By default, the <code class="docutils literal notranslate"><span class="pre">_id</span></code> type is <code class="docutils literal notranslate"><span class="pre">BSON::ObjectId</span></code>, thus the query above
is equivalent to:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="no">BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">))</span>
<span class="c1"># =&gt; #&lt;Band _id: 5f0e41d92c97a64a26aabd10, name: &quot;Juno Reactor&quot;&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When querying collections directly using the driver, type conversion is not
automatically performed:</p>
</div>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">_id</span><span class="p">:</span> <span class="no">BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; {&quot;_id&quot;=&gt;BSON::ObjectId(&#39;5f0e41d92c97a64a26aabd10&#39;), &quot;name&quot;=&gt;&quot;Juno Reactor&quot;}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">_id</span><span class="p">:</span> <span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; nil</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">find</span></code> method can accept multiple arguments, or an array of arguments.
In either case each of the arguments or array elements is taken to be an <code class="docutils literal notranslate"><span class="pre">_id</span></code>
value, and documents with all of the specified <code class="docutils literal notranslate"><span class="pre">_id</span></code> values are returned in
an array:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">,</span> <span class="s1">&#39;5f0e41b02c97a64a26aabd0e&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; [#&lt;Band _id: 5f0e41b02c97a64a26aabd0e, name: &quot;SUN Project&quot;, description: nil, likes: nil&gt;,</span>
  <span class="c1">#&lt;Band _id: 5f0e41d92c97a64a26aabd10, name: &quot;Juno Reactor&quot;, description: nil, likes: nil&gt;]</span>

<span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">[</span><span class="s1">&#39;5f0e41d92c97a64a26aabd10&#39;</span><span class="p">,</span> <span class="s1">&#39;5f0e41b02c97a64a26aabd0e&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="c1"># =&gt; [#&lt;Band _id: 5f0e41b02c97a64a26aabd0e, name: &quot;SUN Project&quot;, description: nil, likes: nil&gt;,</span>
  <span class="c1">#&lt;Band _id: 5f0e41d92c97a64a26aabd10, name: &quot;Juno Reactor&quot;, description: nil, likes: nil&gt;]</span>
</pre></div>
</div>
<p>If the same <code class="docutils literal notranslate"><span class="pre">_id</span></code> value is given more than once, the corresponding document
is only returned once:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;5f0e41b02c97a64a26aabd0e&#39;</span><span class="p">,</span> <span class="s1">&#39;5f0e41b02c97a64a26aabd0e&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; [#&lt;Band _id: 5f0e41b02c97a64a26aabd0e, name: &quot;SUN Project&quot;, description: nil, likes: nil&gt;]</span>
</pre></div>
</div>
<p>The documents returned are <em>not</em> ordered, and may be returned in a different
order from the order of provided <code class="docutils literal notranslate"><span class="pre">_id</span></code> values, as illustrated in the above
examples.</p>
<p>If any of the <code class="docutils literal notranslate"><span class="pre">_id</span></code> values are not found in the database, the behavior of
<code class="docutils literal notranslate"><span class="pre">find</span></code> depends on the value of the <code class="docutils literal notranslate"><span class="pre">raise_not_found_error</span></code> configuration
option. If the option is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, <code class="docutils literal notranslate"><span class="pre">find</span></code> raises
<code class="docutils literal notranslate"><span class="pre">Mongoid::Errors::DocumentNotFound</span></code> if any of the <code class="docutils literal notranslate"><span class="pre">_id``s</span> <span class="pre">are</span> <span class="pre">not</span> <span class="pre">found.</span>
<span class="pre">If</span> <span class="pre">the</span> <span class="pre">option</span> <span class="pre">is</span> <span class="pre">set</span> <span class="pre">to</span> <span class="pre">``false</span></code> and <code class="docutils literal notranslate"><span class="pre">find</span></code> is given a single <code class="docutils literal notranslate"><span class="pre">_id</span></code> to
find and there is no matching document, <code class="docutils literal notranslate"><span class="pre">find</span></code> returns <code class="docutils literal notranslate"><span class="pre">nil</span></code>. If the
option is set to <code class="docutils literal notranslate"><span class="pre">false</span></code> and <code class="docutils literal notranslate"><span class="pre">find</span></code> is given an array of ids to find
and some are not found, the return value is an array of documents that were
found (which could be empty if no documents were found at all).</p>
</section>
<section id="additional-query-methods">
<span id="id10"></span><h2>Additional Query Methods<a class="headerlink" href="#additional-query-methods" title="Permalink to this headline">#</a></h2>
<p>Mongoid also has some helpful methods on criteria.</p>
<table class="colwidths-given table">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Example</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#count</span></code></p>
<p><em>Get the total number of documents matching a filter, or the total
number of documents in a collection. Note this will always hit
the database for the count.</em></p>
<p><em>As of Mongoid 7.2, the</em> <code class="docutils literal notranslate"><span class="pre">count</span></code> <em>method uses the</em>
<code class="docutils literal notranslate"><span class="pre">count_documents</span></code> <em>driver helper to obtain the accurate count.
previously the</em> <code class="docutils literal notranslate"><span class="pre">count</span></code> <em>driver helper was used which used
collection metadata and was thus not necessarily accurate (but
may have returned the result faster). Use</em> <code class="docutils literal notranslate"><span class="pre">estimated_count</span></code>
<em>method to obtain an approximate number of documents in the collection
quickly.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">count</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#estimated_count</span></code></p>
<p><em>Get an approximate number of documents in the collection using the
collection metadata. The</em> <code class="docutils literal notranslate"><span class="pre">estimated_count</span></code> <em>method does not accept
query conditions; if any are given, it will raise</em>
<code class="docutils literal notranslate"><span class="pre">Mongoid::Errors::InvalidEstimatedCountCriteria</span></code>.
<em>If a model defines a default scope,</em> <code class="docutils literal notranslate"><span class="pre">estimated_count</span></code> <em>must be
called on the unscoped model</em>.</p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">count</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>

<span class="k">class</span> <span class="nc">Contract</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Contract</span><span class="o">.</span><span class="n">estimated_count</span>
<span class="c1"># =&gt; raises Mongoid::Errors::InvalidEstimatedCountCriteria</span>

<span class="no">Contract</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">estimated_count</span>
<span class="c1"># =&gt; 0</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#distinct</span></code></p>
<p><em>Get a list of distinct values for a single field. Note this will always hit
the database for the distinct values.</em></p>
<p><em>This method accepts the dot notation, thus permitting referencing
fields in embedded associations.</em></p>
<p><em>This method respects :ref:`field aliases &lt;field-aliases&gt;`,
including those defined in embedded documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:fans</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">100000</span><span class="p">)</span><span class="o">.</span>
  <span class="n">distinct</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;cities.name&#39;</span><span class="p">)</span>

<span class="c1"># Assuming an aliased field:</span>
<span class="k">class</span> <span class="nc">Manager</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embedded_in</span> <span class="ss">:band</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:n</span>
<span class="k">end</span>

<span class="c1"># Expands out to &quot;managers.name&quot; in the query:</span>
<span class="no">Band</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;managers.n&#39;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#each</span></code></p>
<p><em>Iterate over all matching documents in the criteria.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">band</span><span class="o">.</span><span class="n">name</span>
<span class="k">end</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#exists?</span></code></p>
<p><em>Determine if any matching documents exist. Will return true if there
are 1 or more.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">exists?</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists?</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#find_by</span></code></p>
<p><em>Find a document by the provided attributes. If not found,
raise an error or return nil depending on the value of the</em>
<code class="docutils literal notranslate"><span class="pre">raise_not_found_error</span></code> <em>configuration option.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="n">band</span><span class="o">.</span><span class="n">impressions</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">end</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#find_or_create_by</span></code></p>
<p><em>Find a document by the provided attributes, and if not found
create and return a newly persisted one. Note that attributes provided in the arguments to
this method will override any set in ``create_with``</em>.</p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">find_or_create_by</span></code> can be used on any scope, but in this case
the criteria given by the scope and by <code class="docutils literal notranslate"><span class="pre">find_or_create_by</span></code> are
combined. The following creates three bands:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Aerosmith&quot;</span><span class="p">)</span>
<span class="c1"># creates Aerosmith again because there is no band whose name</span>
<span class="c1"># is Photek and Aerosmith at the same time</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Aerosmith&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#find_or_initialize_by</span></code></p>
<p><em>Find a document by the provided attributes, and if not found
return a new one.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#first|last</span></code></p>
<p><em>Finds a single document given the provided criteria. This automatically adds a sort on id.
Opt out of adding the id sort with the {id_sort: :none} option.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:members</span><span class="o">.</span><span class="n">with_size</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:members</span><span class="o">.</span><span class="n">with_size</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#first_or_create</span></code></p>
<p><em>Find the first document by the provided attributes, and if not found
create and return a newly persisted one.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#first_or_create!</span></code></p>
<p><em>Find the first document by the provided attributes, and if not found
create and return a newly persisted one using</em> <code class="docutils literal notranslate"><span class="pre">create!</span></code>.</p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create!</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#first_or_initialize</span></code></p>
<p><em>Find the first document by the provided attributes, and if not found
return a new one.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_initialize</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#for_js</span></code></p>
<p><em>Find documents for a provided JavaScript expression, optionally with
the specified variables added to the evaluation scope. The scope
argument is supported in MongoDB 4.2 and lower.</em>
<em>In MongoDB 3.6 and higher, prefer</em> <a href="#id11"><span class="problematic" id="id12">:manual:`$expr
&lt;/reference/operator/query/expr/&gt;`</span></a> <em>over</em> <code class="docutils literal notranslate"><span class="pre">for_js</span></code>.</p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># All MongoDB versions</span>
<span class="no">Band</span><span class="o">.</span><span class="n">for_js</span><span class="p">(</span><span class="s2">&quot;this.name = &#39;Tool&#39;&quot;</span><span class="p">)</span>

<span class="c1"># MongoDB 4.2 and lower</span>
<span class="no">Band</span><span class="o">.</span><span class="n">for_js</span><span class="p">(</span><span class="s2">&quot;this.name = param&quot;</span><span class="p">,</span> <span class="ss">param</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#length|size</span></code></p>
<p><em>Same as count but caches subsequent calls to the database</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">length</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;FKA Twigs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#pluck</span></code></p>
<p><em>Get all the values for the provided field.
Returns nil for unset fields and for non-existent fields.</em></p>
<p><em>This method accepts the dot notation, thus permitting referencing
fields in embedded associations.</em></p>
<p><em>This method respects :ref:`field aliases &lt;field-aliases&gt;`,
including those defined in embedded documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;cities.name&#39;</span><span class="p">)</span>

<span class="c1"># Using the earlier definition of Manager,</span>
<span class="c1"># expands out to &quot;managers.name&quot; in the query:</span>
<span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;managers.n&#39;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#take</span></code></p>
<p><em>Get a list of n documents from the database or just one if no parameter
is provided.</em></p>
<p><em>This method does not apply a sort to the documents, so it can return
different document(s) than #first and #last.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">take</span>
<span class="no">Band</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#take!</span></code></p>
<p><em>Get a document from the database or raise an error if none exist.</em></p>
<p><em>This method does not apply a sort to the documents, so it can return
different document(s) than #first and #last.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">take!</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#tally</span></code></p>
<p><em>Get a mapping of values to counts for the provided field.</em></p>
<p><em>This method accepts the dot notation, thus permitting referencing
fields in embedded associations.</em></p>
<p><em>This method respects :ref:`field aliases &lt;field-aliases&gt;`,
including those defined in embedded documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tally</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tally</span><span class="p">(</span><span class="s1">&#39;cities.name&#39;</span><span class="p">)</span>

<span class="c1"># Using the earlier definition of Manager,</span>
<span class="c1"># expands out to &quot;managers.name&quot; in the query:</span>
<span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tally</span><span class="p">(</span><span class="s1">&#39;managers.n&#39;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="eager-loading">
<h2>Eager Loading<a class="headerlink" href="#eager-loading" title="Permalink to this headline">#</a></h2>
<p>Mongoid provides a facility to eager load documents
from associations to prevent the n+1 issue when
iterating over documents with association access. Eager loading is supported on
all associations with the exception of polymorphic <code class="docutils literal notranslate"><span class="pre">belongs_to</span></code>
associations.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">has_many</span> <span class="ss">:albums</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:albums</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">band</span><span class="o">.</span><span class="n">albums</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">name</span> <span class="c1"># Does not hit the database again.</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="regular-expressions">
<h2>Regular Expressions<a class="headerlink" href="#regular-expressions" title="Permalink to this headline">#</a></h2>
<p>MongoDB, and Mongoid, allow querying documents by regular expressions.</p>
<p>Given the following model definitions:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Sun Project&#39;</span><span class="p">,</span> <span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;Sun</span><span class="se">\n</span><span class="s2">Project&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p> we can query using simple Ruby regular expressions in a natural way:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="sr">/project/i</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; #&lt;Band _id: 5dc9f7d5ce4ef34893354323, name: &quot;Sun Project&quot;, description: &quot;Sun\nProject&quot;&gt;</span>
</pre></div>
</div>
<p>It is also possible to query using PCRE syntax by constructing
<code class="docutils literal notranslate"><span class="pre">BSON::Regexp::Raw</span></code> objects explicitly:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="sr">/\AProject/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; #&lt;Band _id: 5dc9f7d5ce4ef34893354323, name: &quot;Sun Project&quot;, description: &quot;Sun\nProject&quot;&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="no">BSON</span><span class="o">::</span><span class="no">Regexp</span><span class="o">::</span><span class="no">Raw</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;^Project&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; nil</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="no">BSON</span><span class="o">::</span><span class="no">Regexp</span><span class="o">::</span><span class="no">Raw</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;^Project&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; #&lt;Band _id: 5dc9f7d5ce4ef34893354323, name: &quot;Sun Project&quot;, description: &quot;Sun\nProject&quot;&gt;</span>
</pre></div>
</div>
</section>
<section id="conditions-on-fields">
<h2>Conditions On Fields<a class="headerlink" href="#conditions-on-fields" title="Permalink to this headline">#</a></h2>
<p>When a condition uses a field defined in the model, the value being specified
in the condition is converted according to the rules of the field, if any.
For example, consider the following model definition that contains a <code class="docutils literal notranslate"><span class="pre">Time</span></code>
field, a <code class="docutils literal notranslate"><span class="pre">Date</span></code> field and an implicit <code class="docutils literal notranslate"><span class="pre">Object</span></code> field, and also
intentionally does not define a field called <code class="docutils literal notranslate"><span class="pre">deregistered_at</span></code>:</p>
<blockquote>
<div><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Voter</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:born_on</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Date</span>
  <span class="n">field</span> <span class="ss">:registered_at</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Time</span>
  <span class="n">field</span> <span class="ss">:voted_at</span>
<span class="k">end</span>
</pre></div>
</div>
</div></blockquote>
<p>Queries on <code class="docutils literal notranslate"><span class="pre">born_on</span></code> and <code class="docutils literal notranslate"><span class="pre">registered_at</span></code> fields using <code class="docutils literal notranslate"><span class="pre">Date</span></code> and <code class="docutils literal notranslate"><span class="pre">Time</span></code>
values, respectively, are straightforward:</p>
<blockquote>
<div><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">born_on</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;born_on&quot;=&gt;2020-12-18 00:00:00 UTC}</span>

<span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">registered_at</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;registered_at&quot;=&gt;2020-12-19 04:33:36.939788067 UTC}</span>
</pre></div>
</div>
</div></blockquote>
<p>But, note the differences in behavior when providing a <code class="docutils literal notranslate"><span class="pre">Date</span></code> instance
in all possible scenarios:</p>
<blockquote>
<div><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">born_on</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;born_on&quot;=&gt;2020-12-18 00:00:00 UTC}</span>

<span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">registered_at</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;registered_at&quot;=&gt;2020-12-18 00:00:00 -0500}</span>

<span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">voted_at</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;voted_at&quot;=&gt;Fri, 18 Dec 2020}</span>

<span class="no">Voter</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">deregistered_at</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">selector</span>
<span class="c1"># =&gt; {&quot;deregistered_at&quot;=&gt;2020-12-18 00:00:00 UTC}</span>
</pre></div>
</div>
</div></blockquote>
<p>When using the <code class="docutils literal notranslate"><span class="pre">registered_at</span></code> field which is of type <code class="docutils literal notranslate"><span class="pre">Time</span></code>, the date
was interpreted to be in local time (as per the <a class="reference internal" href="configuration.html#time-zones"><span class="std std-ref">configured time zone</span></a>). When using the <code class="docutils literal notranslate"><span class="pre">born_on</span></code> field which is of type <code class="docutils literal notranslate"><span class="pre">Date</span></code>,
the date was interpreted to be in UTC. When using the <code class="docutils literal notranslate"><span class="pre">voted_at</span></code> field
which was defined without a type (hence implicitly as an <code class="docutils literal notranslate"><span class="pre">Object</span></code>),
the date was used unmodified in the constructed query. When using a
nonexistent field <code class="docutils literal notranslate"><span class="pre">deregistered_at</span></code> the date was interpreted to be in UTC
and converted to a time, matching the behavior of querying a <code class="docutils literal notranslate"><span class="pre">Date</span></code> field.</p>
</section>
<section id="scoping">
<h2>Scoping<a class="headerlink" href="#scoping" title="Permalink to this headline">#</a></h2>
<p>Scopes provide a convenient way to reuse common criteria with more
business domain style syntax.</p>
<section id="named-scopes">
<span id="id13"></span><h3>Named Scopes<a class="headerlink" href="#named-scopes" title="Permalink to this headline">#</a></h3>
<p>Named scopes are simply criteria defined at class load that are referenced
by a provided name. Just like normal criteria, they are lazy and chainable.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:country</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:genres</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span>

  <span class="n">scope</span> <span class="ss">:english</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">country</span><span class="p">:</span> <span class="s2">&quot;England&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:rock</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">:genres</span><span class="o">.</span><span class="n">in</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;rock&quot;</span> <span class="o">]</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">english</span><span class="o">.</span><span class="n">rock</span> <span class="c1"># Get the English rock bands.</span>
</pre></div>
</div>
<p>Named scopes can take procs and blocks for accepting parameters or
extending functionality.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:country</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="n">scope</span> <span class="ss">:named</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">){</span> <span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="k">def</span> <span class="nf">deutsch</span>
        <span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="o">|</span>
          <span class="n">scope</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Deutschland&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">named</span><span class="p">(</span><span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span> <span class="c1"># Find Depeche Mode.</span>
<span class="no">Band</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">deutsch</span> <span class="c1"># Find active German bands.</span>
</pre></div>
</div>
<p>By default, Mongoid allows defining a scope that would shadow an existing
class method, as the following example shows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Product</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">fresh</span>
    <span class="kp">true</span>
  <span class="k">end</span>

  <span class="n">scope</span> <span class="ss">:fresh</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">fresh</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>To have Mongoid raise an error when a scope would overwrite an existing class
method, set the <code class="docutils literal notranslate"><span class="pre">scope_overwrite_exception</span></code> <a class="reference internal" href="configuration.html#configuration-options"><span class="std std-ref">configuration option</span></a> to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
</section>
<section id="default-scopes">
<h3>Default Scopes<a class="headerlink" href="#default-scopes" title="Permalink to this headline">#</a></h3>
<p>Default scopes can be useful when you find yourself applying the same
criteria to most queries, and wish to specify these criteria as the default.
Default scopes are procs that return criteria objects.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="c1"># All bands here are active.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Specifying a default scope also initializes the fields of new models to
the values given in the default scope, if the values are simple literals:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span>
  <span class="n">field</span> <span class="ss">:num_tours</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">num_tours</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">})</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># active is set, num_tours is not set</span>
<span class="no">Band</span><span class="o">.</span><span class="n">new</span> <span class="c1"># =&gt; #&lt;Band _id: 5c3f7452ce4ef378295ca5f5, name: nil, active: true, num_tours: nil&gt;</span>
</pre></div>
</div>
<p>Note that if a default value is provided both in the field definition and
in the default scope, the value in the default scope takes precedence:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">new</span> <span class="c1"># =&gt; #&lt;Band _id: 5c3f74ddce4ef3791abbb088, name: nil, active: false&gt;</span>
</pre></div>
</div>
<p>Because a default scope initializes fields in new models as just described,
defining a default scope with a dotted key and a simple literal value is
not possible:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">&#39;tags.foo&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">create!</span> <span class="c1"># exception: BSON::String::IllegalKey (&#39;tags.foo&#39; is an illegal key in MongoDB. Keys may not start with &#39;$&#39; or contain a &#39;.&#39;.)</span>
</pre></div>
</div>
<p>A workaround is to define the default scope as a complex query:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">&#39;tags.foo&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;$eq&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">tags</span><span class="p">:</span> <span class="p">{</span><span class="ss">hello</span><span class="p">:</span> <span class="s1">&#39;world&#39;</span><span class="p">})</span>
<span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">tags</span><span class="p">:</span> <span class="p">{</span><span class="ss">foo</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
<span class="no">Band</span><span class="o">.</span><span class="n">count</span> <span class="c1"># =&gt; 1</span>
</pre></div>
</div>
<p>You can tell Mongoid not to apply the default scope by using
<code class="docutils literal notranslate"><span class="pre">unscoped</span></code>, which can be inline or take a block.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span> <span class="k">do</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You can also tell Mongoid to explicitly apply the default scope
again later to always ensure its there.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">scoped</span>
</pre></div>
</div>
<p>If you are using a default scope on a model that is part of an association,
you must reload the association to have scoping reapplied.
This is important to note if you change a value of a document in the association
that would affect its visibility within the scoped association.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Label</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_many</span> <span class="ss">:bands</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">embedded_in</span> <span class="ss">:label</span>
  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">label</span><span class="o">.</span><span class="n">bands</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">bands</span> <span class="c1"># [ band ]</span>
<span class="n">band</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:active</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">bands</span> <span class="c1"># [ band ] Must reload.</span>
<span class="n">label</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">bands</span> <span class="c1"># []</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>After the default scope is applied, it is no longer distinguished from
other query conditions. This can lead to surprising behavior when using
<code class="docutils literal notranslate"><span class="pre">or</span></code> and <code class="docutils literal notranslate"><span class="pre">nor</span></code> operators in particular:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span>
  <span class="n">field</span> <span class="ss">:active</span>
  <span class="n">field</span> <span class="ss">:touring</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Infected Mushroom&#39;</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;active&quot;=&gt;true, &quot;name&quot;=&gt;&quot;Infected Mushroom&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Infected Mushroom&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="ss">touring</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;$or&quot;=&gt;[{&quot;active&quot;=&gt;true, &quot;name&quot;=&gt;&quot;Infected Mushroom&quot;}, {&quot;touring&quot;=&gt;true}]}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>

<span class="no">Band</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="ss">touring</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;$or&quot;=&gt;[{&quot;active&quot;=&gt;true}, {&quot;touring&quot;=&gt;true}]}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
<p>In the last example, you might expect the two conditions
(<code class="docutils literal notranslate"><span class="pre">active:</span> <span class="pre">true</span></code> and <code class="docutils literal notranslate"><span class="pre">touring:</span> <span class="pre">true</span></code>) to be combined with an <code class="docutils literal notranslate"><span class="pre">$and</span></code>,
but because the <code class="docutils literal notranslate"><span class="pre">Band</span></code> class already has the scope applied to it,
it becomes one of the disjunction branches of the <code class="docutils literal notranslate"><span class="pre">or</span></code>.</p>
</div>
</section>
<section id="runtime-default-scope-override">
<h3>Runtime Default Scope Override<a class="headerlink" href="#runtime-default-scope-override" title="Permalink to this headline">#</a></h3>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">with_scope</span></code> method to change the default scope in a block
at runtime:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:country</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:genres</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span>

  <span class="n">scope</span> <span class="ss">:english</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">country</span><span class="p">:</span> <span class="s2">&quot;England&quot;</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">criteria</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">with_scope</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">english</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">all</span>
<span class="k">end</span>

<span class="n">criteria</span>
<span class="c1"># =&gt;</span>
<span class="c1"># #&lt;Mongoid::Criteria</span>
<span class="c1">#   selector: {&quot;country&quot;=&gt;&quot;England&quot;}</span>
<span class="c1">#   options:  {}</span>
<span class="c1">#   class:    Band</span>
<span class="c1">#   embedded: false&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If with_scope calls are nested, when the nested with_scope block completes
Mongoid 7 sets the current scope to nil instead of the parent scope.
Mongoid 8 will set the current scope to the correct parent scope.
To get Mongoid 8 behavior in Mongoid 7.4 and higher, set the
<code class="docutils literal notranslate"><span class="pre">Mongoid.broken_scoping</span></code> global option to false.</p>
</div>
</section>
<section id="class-methods">
<h3>Class Methods<a class="headerlink" href="#class-methods" title="Permalink to this headline">#</a></h3>
<p>Class methods on models that return criteria objects are also
treated like scopes, and can be chained as well.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">active</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">active</span>
</pre></div>
</div>
</section>
</section>
<section id="queries-persistence">
<h2>Queries + Persistence<a class="headerlink" href="#queries-persistence" title="Permalink to this headline">#</a></h2>
<p>Mongoid supports persistence operations off of criteria
in a light capacity for when you want to expressively perform multi
document inserts, updates, and deletion.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Criteria ordering and pagination conditions, including <code class="docutils literal notranslate"><span class="pre">order</span></code>, <code class="docutils literal notranslate"><span class="pre">limit</span></code>,
<code class="docutils literal notranslate"><span class="pre">offset</span></code>, and <code class="docutils literal notranslate"><span class="pre">batch_size</span></code>, will be ignored on the following operations.</p>
</div>
<table class="colwidths-given table">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Example</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#create</span></code></p>
<p><em>Create a newly persisted document.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#create!</span></code></p>
<p><em>Create a newly persisted document and raise an exception on validation failure.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">create!</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#build|new</span></code></p>
<p><em>Create a new (unsaved) document.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">build</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">new</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#update</span></code></p>
<p><em>Update attributes of the first matching document.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#update_all</span></code></p>
<p><em>Update attributes of all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">update_all</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#add_to_set</span></code></p>
<p><em>Perform an $addToSet on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to_set</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#bit</span></code></p>
<p><em>Perform a $bit on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bit</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="p">{</span> <span class="ow">and</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="ow">or</span><span class="p">:</span> <span class="mi">4</span> <span class="p">})</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#inc</span></code></p>
<p><em>Perform an $inc on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#pop</span></code></p>
<p><em>Perform a $pop on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#pull</span></code></p>
<p><em>Perform a $pull on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#pull_all</span></code></p>
<p><em>Perform a $pullAll on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span>
  <span class="n">pull_all</span><span class="p">(</span><span class="ss">:members</span><span class="p">,</span> <span class="o">[</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">,</span> <span class="s2">&quot;Danny&quot;</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#push</span></code></p>
<p><em>Perform a $push on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#push_all</span></code></p>
<p><em>Perform a $push with $each on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span>
  <span class="n">push_all</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">,</span> <span class="s2">&quot;Danny&quot;</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#rename</span></code></p>
<p><em>Perform a $rename on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="ss">:title</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#set</span></code></p>
<p><em>Perform a $set on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#unset</span></code></p>
<p><em>Perform a $unset on all matching documents.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="ss">:likes</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#delete</span></code></p>
<p><em>Deletes all matching documents in the database.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Criteria#destroy</span></code></p>
<p><em>Deletes all matching documents in the database while running callbacks for all.
This loads all documents into memory and can be an expensive operation.</em></p>
</td>
<td><div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="query-cache">
<span id="id14"></span><h2>Query Cache<a class="headerlink" href="#query-cache" title="Permalink to this headline">#</a></h2>
<p>Mongoid and the underlying Ruby MongoDB driver provide query caching
functionality. When enabled, the query cache saves the results of
previously executed find and aggregation queries and reuses them in
the future instead of performing the queries again, thus increasing
application performance and reducing database load.</p>
<p>The query cache has historically been provided by Mongoid but as of driver
version 2.14.0, the query cache implementation has been moved into the driver.
When Mongoid is used with driver version 2.14.0 or later, Mongoid delegates
all work to the drivers query cache implementation. When Mongoid is used
with driver versions 2.13.x and earlier, Mongoid utilizes its own, legacy,
query cache implementation.</p>
<p>Please review the <a class="reference external" href="https://mongodb.com/docs/ruby-driver/current/reference/query-cache/">driver query cache documentation</a>
for details about the drivers query cache behavior.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The legacy query cache implementation that Mongoid uses when it detects
driver version 2.13.x and earlier has a number of limitations and
known issues, some of which are severe. If you wish to use the query cache,
it is strongly recommended to use driver 2.14.0 or later. The limitations
of the legacy Mongoid query cache are <a class="reference internal" href="#legacy-query-cache-limitations"><span class="std std-ref">described below</span></a>.</p>
</div>
<p>The rest of this section assumes that driver 2.14.0 or later is being used and
Mongoid delegates to the drivers query cache.</p>
<section id="enabling-query-cache">
<h3>Enabling Query Cache<a class="headerlink" href="#enabling-query-cache" title="Permalink to this headline">#</a></h3>
<p>The query cache may be enabled by using the drivers namespace or Mongoids
namespace.</p>
</section>
<section id="enabling-query-cache-via-middleware">
<span id="id15"></span><h3>Enabling Query Cache Via Middleware<a class="headerlink" href="#enabling-query-cache-via-middleware" title="Permalink to this headline">#</a></h3>
<p>Applications that utilize a Rack-based web framework (Rails, etc.) can
take advantage of the Rack middleware provided by Mongoid to automatically
enable the query cache for each web request, and clear the query cache after
each request completes. Please see the <a class="reference internal" href="configuration.html#query-cache-middleware"><span class="std std-ref">Query Cache Rack Middleware</span></a> section on the configuration page for instructions.</p>
<p>Note that the Query Cache Middleware does not apply to code executed
outside web requests.</p>
</section>
<section id="enabling-query-cache-manually">
<span id="id16"></span><h3>Enabling Query Cache Manually<a class="headerlink" href="#enabling-query-cache-manually" title="Permalink to this headline">#</a></h3>
<p>To enable the Query Cache manually for a code segment, use:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongoid</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">cache</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The Query Cache can also be explicitly enabled and disabled, although we
recommend to use the block form described above:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongoid</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># ...</span>

<span class="no">Mongoid</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span>
</pre></div>
</div>
<p>Alternatively, you can reference the drivers query cache module directly:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">cache</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

<span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>

<span class="no">Mongo</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div>
</div>
</section>
<section id="query-cache-shared-with-driver">
<h3>Query Cache Shared With Driver<a class="headerlink" href="#query-cache-shared-with-driver" title="Permalink to this headline">#</a></h3>
<p>When Mongoid delegates to the drivers query cache, the same cache is used
by both Mongoid and the driver. For example, the following two queries
are implemented via the same server query and only the first of them
would be sent to the server:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongoid</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">cache</span> <span class="k">do</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="ss">_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Similarly, write operations that clear the cache would do so when the read
is performed by the driver and write by Mongoid, or vice versa:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Mongoid</span><span class="o">::</span><span class="no">QueryCache</span><span class="o">.</span><span class="n">cache</span> <span class="k">do</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({})</span>
  <span class="c1"># Queries again</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="caching-the-result-of-first">
<span id="query-cache-first-method"></span><h3>Caching the Result of <code class="docutils literal notranslate"><span class="pre">#first</span></code><a class="headerlink" href="#caching-the-result-of-first" title="Permalink to this headline">#</a></h3>
<p>Calling the <code class="docutils literal notranslate"><span class="pre">first</span></code> method on a model class imposes an ascending sort by
the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field on the underlying query. This may produce unexpected behavior
with query caching.</p>
<p>For example, when calling <code class="docutils literal notranslate"><span class="pre">all</span></code> on a model class and then <code class="docutils literal notranslate"><span class="pre">first</span></code>,
one would expect the second query to use the cached results from the first.
However, because of the sort imposed on the second query, both methods
will query the database and separately cache their results.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1">#=&gt; Queries the database and caches the results</span>

<span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="c1">#=&gt; Queries the database again because of the sort</span>
</pre></div>
</div>
<p>To use the cached results, call <code class="docutils literal notranslate"><span class="pre">all.to_a.first</span></code> on the model class.</p>
</section>
<section id="legacy-query-cache-limitations">
<span id="id17"></span><h3>Legacy Query Cache Limitations<a class="headerlink" href="#legacy-query-cache-limitations" title="Permalink to this headline">#</a></h3>
<p>When Mongoid uses its legacy query cache due to driver version being older
than 2.14.0, the following limitations apply:</p>
<ul class="simple">
<li><p>The query cache does not cache query results that exceed the batch size.
The default batch size is 1000 documents (refer to <a class="reference internal" href="#batch-size"><span class="std std-ref">batch_size</span></a>.)</p></li>
<li><p>The query cache does not take into account read preference or read concern
when deciding whether to return cached results. When performing the same
query with a different read preference or read concern with the query cache
enabled, incorrect results may be returned.</p></li>
<li><p>Bulk writes, as well as <code class="docutils literal notranslate"><span class="pre">$out</span></code> and <code class="docutils literal notranslate"><span class="pre">$merge</span></code> aggregation pipeline stages
do not invalidate the query cache. Cached results may be stale after performing
any of these operations.</p></li>
<li><p>Aggregation results are not cached.</p></li>
</ul>
</section>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="crud.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">CRUD Operations</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="text-search.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Text Search</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
      &copy; Copyright 2021, MongoDB.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>
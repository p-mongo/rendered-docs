
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Associations &#8212; Mongoid  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Validation" href="validation.html" />
    <link rel="prev" title="Inheritance" href="inheritance.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Mongoid  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../installation-configuration.html">
   Installation &amp; Configuration
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../installation.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="compatibility.html">
     Compatibility
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="configuration.html">
     Configuration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="rails-integration.html">
     Rails Integration
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorials.html">
   Tutorials
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/getting-started-sinatra.html">
     Getting Started (Sinatra)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/getting-started-rails.html">
     Getting Started (Rails)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/documents.html">
     Documents
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/common-errors.html">
     Common Errors
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../schema-configuration.html">
   Schema Configuration
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="fields.html">
     Field Definition
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="inheritance.html">
     Inheritance
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Associations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="validation.html">
     Validation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="collection-configuration.html">
     Collection Configuration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="indexes.html">
     Index Management
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sharding.html">
     Sharding Configuration
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../working-with-data.html">
   Working With Data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="crud.html">
     CRUD Operations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="queries.html">
     Queries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="text-search.html">
     Text Search
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="aggregation.html">
     Aggregation Pipeline
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="map-reduce.html">
     Map/Reduce
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="persistence-configuration.html">
     Persistence Configuration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="nested-attributes.html">
     Nested Attributes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="callbacks.html">
     Callbacks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sessions.html">
     Sessions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="transactions.html">
     Transactions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://mongodb.com/docs/mongoid/master/api/">
   API
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../release-notes.html">
   Release Notes
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-8.1.html">
     Mongoid 8.1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-8.0.html">
     Mongoid 8.0
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.5.html">
     Mongoid 7.5
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.4.html">
     Mongoid 7.4
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.3.html">
     Mongoid 7.3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.2.html">
     Mongoid 7.2
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.1.html">
     Mongoid 7.1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-7.0.html">
     Mongoid 7.0
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-6.html">
     Mongoid 6
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release-notes/mongoid-5.html">
     Mongoid 5
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../contributing.html">
   Contributing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../contributing/code-documentation.html">
     Code Documentation
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../additional-resources.html">
   Additional Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ecosystem.html">
   Ecosystem
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/reference/associations.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.txt</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#referenced-associations">
   Referenced Associations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#has-one">
     Has One
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#has-many">
     Has Many
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#queries">
       Queries
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#any">
         <code class="docutils literal notranslate">
          <span class="pre">
           any?
          </span>
         </code>
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#exists">
         <code class="docutils literal notranslate">
          <span class="pre">
           exists?
          </span>
         </code>
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#belongs-to">
     Belongs To
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#has-and-belongs-to-many">
     Has And Belongs To Many
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#querying-referenced-associations">
     Querying Referenced Associations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#embedded-associations">
   Embedded Associations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#embeds-one">
     Embeds One
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#defining">
       Defining
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#storage">
       Storage
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#embeds-many">
     Embeds Many
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Defining
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Storage
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#recursive-embedding">
     Recursive Embedding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#referencing-vs-embedding">
     Referencing Vs Embedding
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#setting-stale-values-on-referenced-associations">
       Setting Stale Values on Referenced Associations
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#querying-embedded-associations">
     Querying Embedded Associations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#querying-loaded-associations">
       Querying Loaded Associations
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#embedded-matching-vs-server-behavior">
       Embedded Matching Vs Server Behavior
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#omitting-id-fields">
     Omitting
     <code class="docutils literal notranslate">
      <span class="pre">
       _id
      </span>
     </code>
     Fields
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deleting">
     Deleting
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#clear">
       <code class="docutils literal notranslate">
        <span class="pre">
         clear
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#delete-all">
       <code class="docutils literal notranslate">
        <span class="pre">
         delete_all
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#destroy-all">
       <code class="docutils literal notranslate">
        <span class="pre">
         destroy_all
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#common-behavior">
   Common Behavior
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extensions">
     Extensions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-association-names">
     Custom Association Names
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-primary-foreign-keys">
     Custom Primary &amp; Foreign Keys
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-scopes">
     Custom Scopes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validations">
     Validations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#polymorphism">
     Polymorphism
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cascading-callbacks">
     Cascading Callbacks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dependent-behavior">
     Dependent Behavior
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#autosaving">
     Autosaving
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#existence-predicates">
     Existence Predicates
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#autobuilding">
     Autobuilding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#touching">
     Touching
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-counter-cache-option">
     The counter_cache Option
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#association-proxies">
     Association Proxies
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#association-metadata">
   Association Metadata
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#attributes">
     Attributes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-association-object">
     The Association Object
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Associations</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#referenced-associations">
   Referenced Associations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#has-one">
     Has One
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#has-many">
     Has Many
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#queries">
       Queries
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#any">
         <code class="docutils literal notranslate">
          <span class="pre">
           any?
          </span>
         </code>
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#exists">
         <code class="docutils literal notranslate">
          <span class="pre">
           exists?
          </span>
         </code>
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#belongs-to">
     Belongs To
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#has-and-belongs-to-many">
     Has And Belongs To Many
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#querying-referenced-associations">
     Querying Referenced Associations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#embedded-associations">
   Embedded Associations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#embeds-one">
     Embeds One
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#defining">
       Defining
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#storage">
       Storage
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#embeds-many">
     Embeds Many
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Defining
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Storage
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#recursive-embedding">
     Recursive Embedding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#referencing-vs-embedding">
     Referencing Vs Embedding
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#setting-stale-values-on-referenced-associations">
       Setting Stale Values on Referenced Associations
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#querying-embedded-associations">
     Querying Embedded Associations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#querying-loaded-associations">
       Querying Loaded Associations
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#embedded-matching-vs-server-behavior">
       Embedded Matching Vs Server Behavior
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#omitting-id-fields">
     Omitting
     <code class="docutils literal notranslate">
      <span class="pre">
       _id
      </span>
     </code>
     Fields
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deleting">
     Deleting
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#clear">
       <code class="docutils literal notranslate">
        <span class="pre">
         clear
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#delete-all">
       <code class="docutils literal notranslate">
        <span class="pre">
         delete_all
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#destroy-all">
       <code class="docutils literal notranslate">
        <span class="pre">
         destroy_all
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#common-behavior">
   Common Behavior
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extensions">
     Extensions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-association-names">
     Custom Association Names
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-primary-foreign-keys">
     Custom Primary &amp; Foreign Keys
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-scopes">
     Custom Scopes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validations">
     Validations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#polymorphism">
     Polymorphism
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cascading-callbacks">
     Cascading Callbacks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dependent-behavior">
     Dependent Behavior
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#autosaving">
     Autosaving
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#existence-predicates">
     Existence Predicates
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#autobuilding">
     Autobuilding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#touching">
     Touching
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-counter-cache-option">
     The counter_cache Option
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#association-proxies">
     Association Proxies
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#association-metadata">
   Association Metadata
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#attributes">
     Attributes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-association-object">
     The Association Object
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="associations">
<h1>Associations<a class="headerlink" href="#associations" title="Permalink to this headline">#</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><p><a class="reference internal" href="#referenced-associations" id="id36">Referenced Associations</a></p>
<ul>
<li><p><a class="reference internal" href="#has-one" id="id37">Has One</a></p></li>
<li><p><a class="reference internal" href="#has-many" id="id38">Has Many</a></p></li>
<li><p><a class="reference internal" href="#belongs-to" id="id39">Belongs To</a></p></li>
<li><p><a class="reference internal" href="#has-and-belongs-to-many" id="id40">Has And Belongs To Many</a></p></li>
<li><p><a class="reference internal" href="#querying-referenced-associations" id="id41">Querying Referenced Associations</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#embedded-associations" id="id42">Embedded Associations</a></p>
<ul>
<li><p><a class="reference internal" href="#embeds-one" id="id43">Embeds One</a></p></li>
<li><p><a class="reference internal" href="#embeds-many" id="id44">Embeds Many</a></p></li>
<li><p><a class="reference internal" href="#recursive-embedding" id="id45">Recursive Embedding</a></p></li>
<li><p><a class="reference internal" href="#referencing-vs-embedding" id="id46">Referencing Vs Embedding</a></p></li>
<li><p><a class="reference internal" href="#querying-embedded-associations" id="id47">Querying Embedded Associations</a></p></li>
<li><p><a class="reference internal" href="#omitting-id-fields" id="id48">Omitting <code class="docutils literal notranslate"><span class="pre">_id</span></code> Fields</a></p></li>
<li><p><a class="reference internal" href="#deleting" id="id49">Deleting</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#common-behavior" id="id50">Common Behavior</a></p>
<ul>
<li><p><a class="reference internal" href="#extensions" id="id51">Extensions</a></p></li>
<li><p><a class="reference internal" href="#custom-association-names" id="id52">Custom Association Names</a></p></li>
<li><p><a class="reference internal" href="#custom-primary-foreign-keys" id="id53">Custom Primary &amp; Foreign Keys</a></p></li>
<li><p><a class="reference internal" href="#custom-scopes" id="id54">Custom Scopes</a></p></li>
<li><p><a class="reference internal" href="#validations" id="id55">Validations</a></p></li>
<li><p><a class="reference internal" href="#polymorphism" id="id56">Polymorphism</a></p></li>
<li><p><a class="reference internal" href="#cascading-callbacks" id="id57">Cascading Callbacks</a></p></li>
<li><p><a class="reference internal" href="#dependent-behavior" id="id58">Dependent Behavior</a></p></li>
<li><p><a class="reference internal" href="#autosaving" id="id59">Autosaving</a></p></li>
<li><p><a class="reference internal" href="#existence-predicates" id="id60">Existence Predicates</a></p></li>
<li><p><a class="reference internal" href="#autobuilding" id="id61">Autobuilding</a></p></li>
<li><p><a class="reference internal" href="#touching" id="id62">Touching</a></p></li>
<li><p><a class="reference internal" href="#the-counter-cache-option" id="id63">The counter_cache Option</a></p></li>
<li><p><a class="reference internal" href="#association-proxies" id="id64">Association Proxies</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#association-metadata" id="id65">Association Metadata</a></p>
<ul>
<li><p><a class="reference internal" href="#attributes" id="id66">Attributes</a></p></li>
<li><p><a class="reference internal" href="#the-association-object" id="id67">The Association Object</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="referenced-associations">
<h2>Referenced Associations<a class="headerlink" href="#referenced-associations" title="Permalink to this headline">#</a></h2>
<p>Mongoid supports the <code class="docutils literal notranslate"><span class="pre">has_one</span></code>, <code class="docutils literal notranslate"><span class="pre">has_many</span></code>, <code class="docutils literal notranslate"><span class="pre">belongs_to</span></code> and
<code class="docutils literal notranslate"><span class="pre">has_and_belongs_to_many</span></code> associations familiar to ActiveRecord users.</p>
<section id="has-one">
<h3>Has One<a class="headerlink" href="#has-one" title="Permalink to this headline">#</a></h3>
<p>Use the <code class="docutils literal notranslate"><span class="pre">has_one</span></code> macro to declare that the parent has a child stored in
a separate collection. The child is optional by default:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_one</span> <span class="ss">:studio</span>
<span class="k">end</span>
</pre></div>
</div>
<p>When using <code class="docutils literal notranslate"><span class="pre">has_one</span></code>, the child model must use <code class="docutils literal notranslate"><span class="pre">belongs_to</span></code> to declare the
association with the parent:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Studio</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Given the above definitions, every child document contains a reference to
its respective parent document:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">studio</span><span class="p">:</span> <span class="no">Studio</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Band _id: 600114fa48966848ad5bd392, &gt;</span>

<span class="n">band</span><span class="o">.</span><span class="n">studio</span>
<span class="c1"># =&gt; #&lt;Studio _id: 600114fa48966848ad5bd391, band_id: BSON::ObjectId(&#39;600114fa48966848ad5bd392&#39;)&gt;</span>
</pre></div>
</div>
<p>Use validations to require that the child is present:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_one</span> <span class="ss">:studio</span>

  <span class="n">validates_presence_of</span> <span class="ss">:studio</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="has-many">
<h3>Has Many<a class="headerlink" href="#has-many" title="Permalink to this headline">#</a></h3>
<p>Use the <code class="docutils literal notranslate"><span class="pre">has_many</span></code> association to declare that the parent has zero or more
children stored in a separate collection:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_many</span> <span class="ss">:members</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Like with <code class="docutils literal notranslate"><span class="pre">has_one</span></code>, the child model must use <code class="docutils literal notranslate"><span class="pre">belongs_to</span></code> to declare the
association with the parent:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Member</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Also as with <code class="docutils literal notranslate"><span class="pre">has_one</span></code>, the child documents contain references to their
respective parents:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="o">[</span><span class="no">Member</span><span class="o">.</span><span class="n">new</span><span class="o">]</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Band _id: 6001166d4896684910b8d1c5, &gt;</span>

<span class="n">band</span><span class="o">.</span><span class="n">members</span>
<span class="c1"># =&gt; [#&lt;Member _id: 6001166d4896684910b8d1c6, band_id: BSON::ObjectId(&#39;6001166d4896684910b8d1c5&#39;)&gt;]</span>
</pre></div>
</div>
<p>Use validations to require that at least one child is present:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_many</span> <span class="ss">:members</span>

  <span class="n">validates_presence_of</span> <span class="ss">:members</span>
<span class="k">end</span>
</pre></div>
</div>
<section id="queries">
<h4>Queries<a class="headerlink" href="#queries" title="Permalink to this headline">#</a></h4>
<section id="any">
<span id="has-many-any"></span><h5><code class="docutils literal notranslate"><span class="pre">any?</span></code><a class="headerlink" href="#any" title="Permalink to this headline">#</a></h5>
<p>Use the <code class="docutils literal notranslate"><span class="pre">any?</span></code> method on the association to efficiently determine whether
the association contains any documents, without retrieving the entire set
of documents from the database:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">any?</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">any?</span></code> also implements the <a class="reference external" href="https://ruby-doc.org/core/Enumerable.html#method-i-any-3F">Enumerable#any? API</a>, allowing
filtering with a block:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">member</span><span class="o">|</span> <span class="n">member</span><span class="o">.</span><span class="n">instrument</span> <span class="o">==</span> <span class="s1">&#39;piano&#39;</span> <span class="p">}</span>
</pre></div>
</div>
<p>… or by a class name which can be useful for polymorphic associations:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Drummer</span> <span class="o">&lt;</span> <span class="no">Member</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">any?</span><span class="p">(</span><span class="no">Drummer</span><span class="p">)</span>
</pre></div>
</div>
<p>If the association is already loaded, <code class="docutils literal notranslate"><span class="pre">any?</span></code> inspects the loaded
documents and does not query the database:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># Queries the database</span>
<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">any?</span>

<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">to_a</span>

<span class="c1"># Does not query the database</span>
<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">any?</span>
</pre></div>
</div>
<p>Note that simply calling <code class="docutils literal notranslate"><span class="pre">any?</span></code> would <em>not</em> load the association
(since <code class="docutils literal notranslate"><span class="pre">any?</span></code> only retrieves the _id field of the first matching document).</p>
</section>
<section id="exists">
<h5><code class="docutils literal notranslate"><span class="pre">exists?</span></code><a class="headerlink" href="#exists" title="Permalink to this headline">#</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">exists?</span></code> method on the association determines whether there are
any <em>persisted</em> documents in the association. Unlike the <code class="docutils literal notranslate"><span class="pre">any?</span></code> method:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">exists?</span></code> always queries the database, even if the association is already
loaded.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exists?</span></code> does not consider non-persisted documents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exists?</span></code> does not allow filtering in the application like <code class="docutils literal notranslate"><span class="pre">any?</span></code> does,
and does not take any arguments.</p></li>
</ul>
<p>The following example illustrates the difference between <code class="docutils literal notranslate"><span class="pre">exists?</span></code> and
<code class="docutils literal notranslate"><span class="pre">any?</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span>
<span class="c1"># Member is not persisted.</span>
<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">build</span>

<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">any?</span>
<span class="c1"># =&gt; true</span>
<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">exists?</span>
<span class="c1"># =&gt; false</span>

<span class="c1"># Persist the member.</span>
<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:save!</span><span class="p">)</span>

<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">any?</span>
<span class="c1"># =&gt; true</span>
<span class="n">band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">exists?</span>
<span class="c1"># =&gt; true</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="belongs-to">
<h3>Belongs To<a class="headerlink" href="#belongs-to" title="Permalink to this headline">#</a></h3>
<p>Use the <code class="docutils literal notranslate"><span class="pre">belongs_to</span></code> macro to associate a child with a parent stored in a
separate collection. The <code class="docutils literal notranslate"><span class="pre">_id</span></code> of the parent (if a parent is associated)
is stored in the child.</p>
<p>By default, if a <code class="docutils literal notranslate"><span class="pre">belongs_to</span></code> association is defined on a model, it must be
provided a value for a model instance to be saved. Use the <code class="docutils literal notranslate"><span class="pre">optional:</span> <span class="pre">true`</span></code>
option to make the instances persistable without specifying the parent:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_one</span> <span class="ss">:studio</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Studio</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:band</span><span class="p">,</span> <span class="ss">optional</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">studio</span> <span class="o">=</span> <span class="no">Studio</span><span class="o">.</span><span class="n">create!</span>
<span class="c1"># =&gt; #&lt;Studio _id: 600118184896684987aa884f, band_id: nil&gt;</span>
</pre></div>
</div>
<p>To change the default behavior of <code class="docutils literal notranslate"><span class="pre">belongs_to</span></code> associations to not require
their respective parents globally, set the <code class="docutils literal notranslate"><span class="pre">belongs_to_required_by_default</span></code>
<a class="reference internal" href="configuration.html#configuration-options"><span class="std std-ref">configuration option</span></a> to <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>Although <code class="docutils literal notranslate"><span class="pre">has_one</span></code> and <code class="docutils literal notranslate"><span class="pre">has_many</span></code> associations require the
corresponding <code class="docutils literal notranslate"><span class="pre">belongs_to</span></code> association to be defined on the child,
<code class="docutils literal notranslate"><span class="pre">belongs_to</span></code> may also be used without a corresponding <code class="docutils literal notranslate"><span class="pre">has_one</span></code> or
<code class="docutils literal notranslate"><span class="pre">has_many</span></code> macro. In this case the child is not accessible from the parent
but the parent is accessible from the child:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Studio</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>
</pre></div>
</div>
<p>For clarity it is possible to add the <code class="docutils literal notranslate"><span class="pre">inverse_of:</span> <span class="pre">nil</span></code> option in cases when
the parent does not define the association:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Studio</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:band</span><span class="p">,</span> <span class="ss">inverse_of</span><span class="p">:</span> <span class="kp">nil</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="has-and-belongs-to-many">
<h3>Has And Belongs To Many<a class="headerlink" href="#has-and-belongs-to-many" title="Permalink to this headline">#</a></h3>
<p>Use the <code class="docutils literal notranslate"><span class="pre">has_and_belongs_to_many</span></code> macro to declare a many-to-many
association:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:tags</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tag</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:bands</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Both model instances store a list of ids of the associated models, if any:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">tags</span><span class="p">:</span> <span class="o">[</span><span class="no">Tag</span><span class="o">.</span><span class="n">create!</span><span class="o">]</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Band _id: 60011d554896684b8b910a2a, tag_ids: [BSON::ObjectId(&#39;60011d554896684b8b910a29&#39;)]&gt;</span>

<span class="n">band</span><span class="o">.</span><span class="n">tags</span>
<span class="c1"># =&gt; [#&lt;Tag _id: 60011d554896684b8b910a29, band_ids: [BSON::ObjectId(&#39;60011d554896684b8b910a2a&#39;)]&gt;]</span>
</pre></div>
</div>
<p>You can create a one-sided <code class="docutils literal notranslate"><span class="pre">has_and_belongs_to_many</span></code> association to store
the ids only in one document using the <code class="docutils literal notranslate"><span class="pre">inverse_of:</span> <span class="pre">nil</span></code> option:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">inverse_of</span><span class="p">:</span> <span class="kp">nil</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tag</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">tags</span><span class="p">:</span> <span class="o">[</span><span class="no">Tag</span><span class="o">.</span><span class="n">create!</span><span class="o">]</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Band _id: 60011dbc4896684bbbaa9255, tag_ids: [BSON::ObjectId(&#39;60011dbc4896684bbbaa9254&#39;)]&gt;</span>

<span class="n">band</span><span class="o">.</span><span class="n">tags</span>
<span class="c1"># =&gt; [#&lt;Tag _id: 60011dbc4896684bbbaa9254, &gt;]</span>
</pre></div>
</div>
<p>A one-sided <code class="docutils literal notranslate"><span class="pre">has_and_belongs_to_many</span></code> association is, naturally, only
usable from the model where it is defined.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Given two models, A and B where A <code class="docutils literal notranslate"><span class="pre">has_and_belongs_to_many</span></code> B,
when adding a document of type B to the HABTM association on a document of
type A, Mongoid will not update the <code class="docutils literal notranslate"><span class="pre">updated_at</span></code> field for the document of
type A, but will update the <code class="docutils literal notranslate"><span class="pre">updated_at</span></code> field for the document of type B.</p>
</div>
</section>
<section id="querying-referenced-associations">
<h3>Querying Referenced Associations<a class="headerlink" href="#querying-referenced-associations" title="Permalink to this headline">#</a></h3>
<p>In most cases, efficient queries across referenced associations (and in general
involving data or conditions or multiple collections) are performed using
the aggregation pipeline. Mongoid helpers for constructing aggregation pipeline
queries are described in the <a class="reference internal" href="aggregation.html#aggregation-pipeline"><span class="std std-ref">aggregation pipeline</span></a>
section.</p>
<p>For simple queries, the use of aggregation pipeline may be avoided and
associations may be queried directly. When querying associations directly,
all conditions must be on that association’s collection only (which typically
means association in question and any associations embedded in it).</p>
<p>For example, given the following models:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_many</span> <span class="ss">:tours</span>
  <span class="n">has_many</span> <span class="ss">:awards</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tour</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:band</span>

  <span class="n">field</span> <span class="ss">:year</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Award</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:band</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>
</pre></div>
</div>
<p>One could retrieve all bands that have toured since 2000 as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band_ids</span> <span class="o">=</span> <span class="no">Tour</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">year</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">})</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:band_id</span><span class="p">)</span>
<span class="n">bands</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">band_ids</span><span class="p">)</span>
</pre></div>
</div>
<p>The conditions on <code class="docutils literal notranslate"><span class="pre">Tour</span></code> can be arbitrarily complex, but they must all
be on the same <code class="docutils literal notranslate"><span class="pre">Tour</span></code> document (or documents embedded in <code class="docutils literal notranslate"><span class="pre">Tour</span></code>).</p>
<p>To find awards for bands that have toured since 2000:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band_ids</span> <span class="o">=</span> <span class="no">Tour</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">year</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">})</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:band_id</span><span class="p">)</span>
<span class="n">awards</span> <span class="o">=</span> <span class="no">Award</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">band_id</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$in&#39;</span> <span class="o">=&gt;</span> <span class="n">band_ids</span><span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<section id="embedded-associations">
<h2>Embedded Associations<a class="headerlink" href="#embedded-associations" title="Permalink to this headline">#</a></h2>
<p>Thanks to MongoDB’s document model, Mongoid also offers embedded associations
which allow documents of different types to be stored hierarchically
in the same collection. Embedded associations are defined using
<code class="docutils literal notranslate"><span class="pre">embeds_one</span></code>, <code class="docutils literal notranslate"><span class="pre">embeds_many</span></code> and <code class="docutils literal notranslate"><span class="pre">embedded_in</span></code> macros, plus
<code class="docutils literal notranslate"><span class="pre">recursively_embeds_one</span></code> and <code class="docutils literal notranslate"><span class="pre">recursively_embeds_many</span></code> for recursive
embedding.</p>
<section id="embeds-one">
<h3>Embeds One<a class="headerlink" href="#embeds-one" title="Permalink to this headline">#</a></h3>
<p>One to one associations where the children are embedded in the parent
document are defined using Mongoid’s <code class="docutils literal notranslate"><span class="pre">embeds_one</span></code> and <code class="docutils literal notranslate"><span class="pre">embedded_in</span></code> macros.</p>
<section id="defining">
<h4>Defining<a class="headerlink" href="#defining" title="Permalink to this headline">#</a></h4>
<p>The parent document of the association should use the <code class="docutils literal notranslate"><span class="pre">embeds_one</span></code> macro to
indicate is has one embedded child, where the document that is embedded uses
<code class="docutils literal notranslate"><span class="pre">embedded_in</span></code>. Definitions are required on both sides to the association
in order for it to work properly.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_one</span> <span class="ss">:label</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Label</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">embedded_in</span> <span class="ss">:band</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="storage">
<h4>Storage<a class="headerlink" href="#storage" title="Permalink to this headline">#</a></h4>
<p>Documents that are embedded using the <code class="docutils literal notranslate"><span class="pre">embeds_one</span></code> macro are stored as a
hash inside the parent in the parent’s database collection.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">&quot;4d3ed089fb60ab534684b7e9&quot;</span><span class="p">),</span>
  <span class="s2">&quot;label&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">&quot;4d3ed089fb60ab534684b7e0&quot;</span><span class="p">),</span>
    <span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can optionally tell Mongoid to store the embedded document in a different
attribute other than the name, by providing the <code class="docutils literal notranslate"><span class="pre">:store_as</span></code> option.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_one</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">store_as</span><span class="p">:</span> <span class="s2">&quot;lab&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
</section>
<section id="embeds-many">
<h3>Embeds Many<a class="headerlink" href="#embeds-many" title="Permalink to this headline">#</a></h3>
<p>One to many relationships where the children are embedded in the parent
document are defined using Mongoid’s <code class="docutils literal notranslate"><span class="pre">embeds_many</span></code> and <code class="docutils literal notranslate"><span class="pre">embedded_in</span></code> macros.</p>
<section id="id1">
<h4>Defining<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h4>
<p>The parent document of the association should use the <code class="docutils literal notranslate"><span class="pre">embeds_many</span></code> macro
to indicate it has many embedded children, where the document that is
embedded uses <code class="docutils literal notranslate"><span class="pre">embedded_in</span></code>. Definitions are required on both sides of
the association in order for it to work properly.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_many</span> <span class="ss">:albums</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">embedded_in</span> <span class="ss">:band</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="id2">
<h4>Storage<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h4>
<p>Documents that are embedded using the <code class="docutils literal notranslate"><span class="pre">embeds_many</span></code> macro are stored as
an array of hashes inside the parent in the parent’s database collection.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">&quot;4d3ed089fb60ab534684b7e9&quot;</span><span class="p">),</span>
  <span class="s2">&quot;albums&quot;</span> <span class="p">:</span> <span class="o">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="no">ObjectId</span><span class="p">(</span><span class="s2">&quot;4d3ed089fb60ab534684b7e0&quot;</span><span class="p">),</span>
      <span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;Violator&quot;</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="o">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can optionally tell Mongoid to store the embedded document in a different
attribute other than the name, by providing the <code class="docutils literal notranslate"><span class="pre">:store_as</span></code> option.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_many</span> <span class="ss">:albums</span><span class="p">,</span> <span class="ss">store_as</span><span class="p">:</span> <span class="s2">&quot;albs&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
</section>
<section id="recursive-embedding">
<h3>Recursive Embedding<a class="headerlink" href="#recursive-embedding" title="Permalink to this headline">#</a></h3>
<p>A document can recursively embed itself using <code class="docutils literal notranslate"><span class="pre">recursively_embeds_one</span></code> or
<code class="docutils literal notranslate"><span class="pre">recursively_embeds_many</span></code>, which provides accessors for the parent and
children via <code class="docutils literal notranslate"><span class="pre">parent_</span></code> and <code class="docutils literal notranslate"><span class="pre">child_</span></code> methods.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Tag</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">recursively_embeds_many</span>
<span class="k">end</span>

<span class="n">root</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;programming&quot;</span><span class="p">)</span>
<span class="n">child_one</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">child_tags</span><span class="o">.</span><span class="n">build</span>
<span class="n">child_two</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">child_tags</span><span class="o">.</span><span class="n">build</span>

<span class="n">root</span><span class="o">.</span><span class="n">child_tags</span> <span class="c1"># [ child_one, child_two ]</span>
<span class="n">child_one</span><span class="o">.</span><span class="n">parent_tag</span> <span class="c1"># [ root ]</span>
<span class="n">child_two</span><span class="o">.</span><span class="n">parent_tag</span> <span class="c1"># [ root ]</span>

<span class="k">class</span> <span class="nc">Node</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">recursively_embeds_one</span>
<span class="k">end</span>

<span class="n">root</span> <span class="o">=</span> <span class="no">Node</span><span class="o">.</span><span class="n">new</span>
<span class="n">child</span> <span class="o">=</span> <span class="no">Node</span><span class="o">.</span><span class="n">new</span>
<span class="n">root</span><span class="o">.</span><span class="n">child_node</span> <span class="o">=</span> <span class="n">child</span>

<span class="n">root</span><span class="o">.</span><span class="n">child_node</span> <span class="c1"># child</span>
<span class="n">child</span><span class="o">.</span><span class="n">parent_node</span> <span class="c1"># root</span>
</pre></div>
</div>
</section>
<section id="referencing-vs-embedding">
<h3>Referencing Vs Embedding<a class="headerlink" href="#referencing-vs-embedding" title="Permalink to this headline">#</a></h3>
<p>While a complete discussion of referencing vs embedding is beyond the scope
of this tutorial, here are some high level considerations for choosing
one over the other.</p>
<p>When an association is embedded, both parent and child documents are stored
in the same collection. This permits efficient persistence and retrieval
when both are used/needed. For example, if the navigation bar on a web site
shows attributes of a user that are stored in documents themselves, it is
often a good idea to use embedded associations.</p>
<p>Using embedded associations allows using MongoDB tools like the
<a class="reference external" href="https://mongodb.com/docs/manual/core/aggregation-pipeline/">aggregation pipeline</a> to query
these documents in a powerful way.</p>
<p>Because embedded documents are stored as part of their parent top-level
documents, it is not possible to persist an embedded document by itself,
nor is it possible to retrieve embedded documents directly. However,
embedded documents can still be efficiently queried and retrieved with the
help of MongoDB projection operation:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:started_on</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Date</span>
  <span class="n">embeds_one</span> <span class="ss">:label</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Label</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">embedded_in</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="c1"># Retrieve labels for bands started in the last year.</span>
<span class="c1">#</span>
<span class="c1"># Sends a find query like this:</span>
<span class="c1"># {&quot;find&quot;=&gt;&quot;bands&quot;,</span>
<span class="c1">#  &quot;filter&quot;=&gt;{&quot;started_on&quot;=&gt;{&quot;$gt&quot;=&gt;2018-07-01 00:00:00 UTC}},</span>
<span class="c1">#  &quot;projection&quot;=&gt;{&quot;_id&quot;=&gt;1, &quot;label&quot;=&gt;1}}</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">started_on</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">1</span><span class="o">.</span><span class="n">year</span><span class="p">})</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:label</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:label</span><span class="p">)</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">uniq</span>
</pre></div>
</div>
<section id="setting-stale-values-on-referenced-associations">
<h4>Setting Stale Values on Referenced Associations<a class="headerlink" href="#setting-stale-values-on-referenced-associations" title="Permalink to this headline">#</a></h4>
<p>Setting a stale value to a referenced association can sometimes result in
a <code class="docutils literal notranslate"><span class="pre">nil</span></code> value being persisted to the database. Take the following case:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Post</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_one</span> <span class="ss">:comment</span><span class="p">,</span> <span class="ss">inverse_of</span><span class="p">:</span> <span class="ss">:post</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">inverse_of</span><span class="p">:</span> <span class="ss">:comment</span><span class="p">,</span> <span class="ss">optional</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">post</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment1</span>
<span class="n">post</span><span class="o">.</span><span class="n">reload</span>
</pre></div>
</div>
<p>At this point, <code class="docutils literal notranslate"><span class="pre">post.comment</span></code> is set to <code class="docutils literal notranslate"><span class="pre">comment1</span></code>, however since a reload
happened, <code class="docutils literal notranslate"><span class="pre">post.comment</span></code> does not refer to the same object as <code class="docutils literal notranslate"><span class="pre">comment1</span></code>.
Meaning, updating one object does not implicitly update the other. This matters
for the next operation:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">post</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment2</span>
<span class="n">post</span><span class="o">.</span><span class="n">reload</span>
</pre></div>
</div>
<p>Now, <code class="docutils literal notranslate"><span class="pre">post.comment</span></code> is set to <code class="docutils literal notranslate"><span class="pre">comment2</span></code>, and the <code class="docutils literal notranslate"><span class="pre">post_id</span></code> of the old
comment is set to <code class="docutils literal notranslate"><span class="pre">nil</span></code>. However, the value that was assigned to
<code class="docutils literal notranslate"><span class="pre">post.comment</span></code> did not refer to the same object as <code class="docutils literal notranslate"><span class="pre">comment1</span></code>, therefore,
while the old value of <code class="docutils literal notranslate"><span class="pre">post.comment</span></code> was updated to have a <code class="docutils literal notranslate"><span class="pre">nil</span></code>
<code class="docutils literal notranslate"><span class="pre">post_id</span></code>, <code class="docutils literal notranslate"><span class="pre">comment1</span></code> still has the <code class="docutils literal notranslate"><span class="pre">post_id</span></code> set.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">post</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment1</span>
<span class="n">post</span><span class="o">.</span><span class="n">reload</span>
</pre></div>
</div>
<p>Finally, this last assignment attempts to set the <code class="docutils literal notranslate"><span class="pre">post_id</span></code> on <code class="docutils literal notranslate"><span class="pre">comment1</span></code>,
which should be <code class="docutils literal notranslate"><span class="pre">nil</span></code> at this point, but is set to the old <code class="docutils literal notranslate"><span class="pre">post_id</span></code>.
During this operation, the <code class="docutils literal notranslate"><span class="pre">post_id</span></code> is cleared from <code class="docutils literal notranslate"><span class="pre">comment2</span></code>, and the
new <code class="docutils literal notranslate"><span class="pre">post_id</span></code> is set on <code class="docutils literal notranslate"><span class="pre">comment1</span></code>. However, since the <code class="docutils literal notranslate"><span class="pre">post_id</span></code> was
already set on <code class="docutils literal notranslate"><span class="pre">comment1</span></code>, nothing is persisted, and we end up with both
comments having a <code class="docutils literal notranslate"><span class="pre">nil</span></code> <code class="docutils literal notranslate"><span class="pre">post_id</span></code>. At this point, running <code class="docutils literal notranslate"><span class="pre">post.comment</span></code>
returns <code class="docutils literal notranslate"><span class="pre">nil</span></code>.</p>
</section>
</section>
<section id="querying-embedded-associations">
<h3>Querying Embedded Associations<a class="headerlink" href="#querying-embedded-associations" title="Permalink to this headline">#</a></h3>
<p>When querying top-level documents, conditions can be specified on documents
in embedded associations using the dot notation. For example, given the
following models:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_many</span> <span class="ss">:tours</span>
  <span class="n">embeds_many</span> <span class="ss">:awards</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Tour</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embedded_in</span> <span class="ss">:band</span>
  <span class="n">field</span> <span class="ss">:year</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Award</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embedded_in</span> <span class="ss">:band</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
<span class="k">end</span>
</pre></div>
</div>
<p>To retrieve bands based on tour attributes, use the dot notation as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get all bands that have toured since 2000</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;tours.year&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">})</span>
</pre></div>
</div>
<p>To retrieve only documents of embedded associations, without retrieving
top-level documents, use the <code class="docutils literal notranslate"><span class="pre">pluck</span></code> projection method:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get awards for bands that have toured since 2000</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;tours.year&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">})</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:awards</span><span class="p">)</span>
</pre></div>
</div>
<section id="querying-loaded-associations">
<span id="embedded-matching"></span><h4>Querying Loaded Associations<a class="headerlink" href="#querying-loaded-associations" title="Permalink to this headline">#</a></h4>
<p>Mongoid query methods can be used on embedded associations of documents which
are already loaded in the application. This mechanism is sometimes called
“embedded matching” or “embedded document matching” and it is implemented
entirely in Mongoid - the queries are NOT sent to the server.</p>
<p>Embedded matching is supported for most general-purpose query operators. It
is not implemented for <a class="reference internal" href="text-search.html#text-search"><span class="std std-ref">text search</span></a>, <a href="#id3"><span class="problematic" id="id4">:manual:`geospatial query
operators &lt;/reference/operator/query-geospatial/&gt;`</span></a>,
operators that execute JavaScript code (<a href="#id5"><span class="problematic" id="id6">:manual:`$where &lt;/reference/operator/query/where/&gt;`</span></a>)
and operators that are implemented via other server functionality such as
<a href="#id7"><span class="problematic" id="id8">:manual:`$expr &lt;https://mongodb.com/docs/manual/reference/operator/query/expr/&gt;`</span></a>
and <a href="#id9"><span class="problematic" id="id10">:manual:`$jsonSchema &lt;https://mongodb.com/docs/manual/reference/operator/query/jsonSchema/&gt;`</span></a>.</p>
<p>The following operators are supported:</p>
<ul class="simple">
<li><p><a href="#id11"><span class="problematic" id="id12">:manual:`Bitwise operators &lt;/reference/operator/query-bitwise/&gt;`</span></a></p></li>
<li><p><a href="#id13"><span class="problematic" id="id14">:manual:`Comparison operators &lt;/reference/operator/query-comparison/&gt;`</span></a></p></li>
<li><p><a href="#id15"><span class="problematic" id="id16">:manual:`Logical operators &lt;/reference/operator/query-logical/&gt;`</span></a></p></li>
<li><p><a href="#id17"><span class="problematic" id="id18">:manual:`$comment &lt;/reference/operator/query/comment/&gt;`</span></a></p></li>
<li><p><a href="#id19"><span class="problematic" id="id20">:manual:`$exists &lt;/reference/operator/query/exists/&gt;`</span></a></p></li>
<li><p><a href="#id21"><span class="problematic" id="id22">:manual:`$mod &lt;/reference/operator/query/mod/&gt;`</span></a></p></li>
<li><p><a href="#id23"><span class="problematic" id="id24">:manual:`$type &lt;/reference/operator/query/type/&gt;`</span></a></p></li>
<li><p><a href="#id25"><span class="problematic" id="id26">:manual:`$regex &lt;/reference/operator/query/regex/&gt;`</span></a> (<code class="docutils literal notranslate"><span class="pre">$options</span></code> field
is only supported when the <code class="docutils literal notranslate"><span class="pre">$regex</span></code> argument is a string)</p></li>
<li><p><a href="#id27"><span class="problematic" id="id28">:manual:`Array query operators &lt;/reference/operator/query-array/&gt;`</span></a></p></li>
</ul>
<p>For example, using the model definitions just given, we could query
tours on a loaded band:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Astral Projection&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="n">tours</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">tours</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">year</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span> <span class="o">=&gt;</span> <span class="mi">2000</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="embedded-matching-vs-server-behavior">
<h4>Embedded Matching Vs Server Behavior<a class="headerlink" href="#embedded-matching-vs-server-behavior" title="Permalink to this headline">#</a></h4>
<p>Mongoid aims to provide the same semantics when performing embedded matching
as those of MongoDB server. This means, for example, when the server only
accepts arguments of particular types for a particular operator, Mongoid
would also only accept arguments of the corresponding types.</p>
<p>The following deviations are known:</p>
<ul>
<li><p>Mongoid embedded matchers, because they are implemented on the client side,
behave the same regardless of the server version that backs the application.
As such, it is possible for Mongoid to deviate from server behavior if
the server itself behaves differently in different versions. All operators are implemented in
Mongoid regardless of backing deployment’s server version.</p>
<p>As of this writing, the known cases of such deviation are:</p>
<blockquote>
<div><ul class="simple">
<li><p>3.2 and earlier servers not validating <code class="docutils literal notranslate"><span class="pre">$size</span></code> arguments as strictly as newer versions do.</p></li>
<li><p>4.0 and earlier servers not validating <code class="docutils literal notranslate"><span class="pre">$type</span></code> arguments as strictly as newer versions
do (allowing invalid arguments like 0, for example).</p></li>
<li><p>3.2 and earlier servers not supporting <code class="docutils literal notranslate"><span class="pre">Decimal128</span></code> for <code class="docutils literal notranslate"><span class="pre">$type</span></code>, as well as allowing invalid
arguments such as negative numbers (smaller than -1) and numbers that are greater than 19
(not including 127, the argument for the <code class="docutils literal notranslate"><span class="pre">MaxKey</span></code> type).</p></li>
<li><p>3.4 and earlier servers not supporting arrays for <code class="docutils literal notranslate"><span class="pre">$type</span></code>.</p></li>
<li><p>3.0 and earlier servers not supporting bitwise operators.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Mongoid DSL expands <code class="docutils literal notranslate"><span class="pre">Range</span></code> arguments to hashes with <code class="docutils literal notranslate"><span class="pre">$gte</span></code> and <code class="docutils literal notranslate"><span class="pre">$lte</span></code>
conditions. <a class="reference external" href="https://jira.mongodb.org/browse/MONGOID-4908">In some cases</a>
this creates bogus queries. Embedded matchers raise the <code class="docutils literal notranslate"><span class="pre">InvalidQuery</span></code>
exception in these cases. The operators that are known to be affected are
<code class="docutils literal notranslate"><span class="pre">$elemMatch</span></code>, <code class="docutils literal notranslate"><span class="pre">$eq</span></code>, <code class="docutils literal notranslate"><span class="pre">$gt</span></code>, <code class="docutils literal notranslate"><span class="pre">$gte</span></code>, <code class="docutils literal notranslate"><span class="pre">$lt</span></code>, <code class="docutils literal notranslate"><span class="pre">$lte</span></code> and <code class="docutils literal notranslate"><span class="pre">$ne</span></code>.</p></li>
<li><p>When performing embedded matching with <code class="docutils literal notranslate"><span class="pre">$regex</span></code>, <a class="reference external" href="https://jira.mongodb.org/browse/MONGOID-4936">it is not currently
possible</a> to specify a
regular expression object as the pattern and also provide options.</p></li>
</ul>
<p>In general, Mongoid adopts the behavior of current server versions and validates more strictly.</p>
</section>
</section>
<section id="omitting-id-fields">
<span id="omit-id"></span><h3>Omitting <code class="docutils literal notranslate"><span class="pre">_id</span></code> Fields<a class="headerlink" href="#omitting-id-fields" title="Permalink to this headline">#</a></h3>
<p>By default, Mongoid adds an <code class="docutils literal notranslate"><span class="pre">_id</span></code> field to each embedded document. This
permits easy referencing of and operations on the embedded documents.</p>
<p>These <code class="docutils literal notranslate"><span class="pre">_id</span></code> fields may be omitted to save storage space. To do so,
<a class="reference internal" href="fields.html#custom-id"><span class="std std-ref">override the _id field definition in the child documents</span></a>
and remove the default value:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Order</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">embeds_many</span> <span class="ss">:line_items</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">LineItem</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">embedded_in</span> <span class="ss">:order</span>

  <span class="n">field</span> <span class="ss">:_id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Object</span>
<span class="k">end</span>
</pre></div>
</div>
<p>In the current version of Mongoid the field definition is required, but
without a default value specified no value will be stored in the database.
A future version of Mongoid may allow removing previously defined fields.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Removing the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field means that embedded documents must be identified
by their content attribute values during queries, updates and deletes.</p>
</div>
</section>
<section id="deleting">
<h3>Deleting<a class="headerlink" href="#deleting" title="Permalink to this headline">#</a></h3>
<p>Mongoid provides three methods for deleting children from <code class="docutils literal notranslate"><span class="pre">embeds_many</span></code>
associations: <code class="docutils literal notranslate"><span class="pre">clear</span></code>, <code class="docutils literal notranslate"><span class="pre">destroy_all</span></code> and <code class="docutils literal notranslate"><span class="pre">delete_all</span></code>.</p>
<section id="clear">
<h4><code class="docutils literal notranslate"><span class="pre">clear</span></code><a class="headerlink" href="#clear" title="Permalink to this headline">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">clear</span></code> method uses the <a href="#id29"><span class="problematic" id="id30">:manual:`$unset operator
&lt;/reference/operator/update/unset&gt;`</span></a> to remove the entire association from the
host document. It does not run destroy callbacks on the documents being removed,
acting like <code class="docutils literal notranslate"><span class="pre">delete_all</span></code> in this regard:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">tours</span><span class="o">.</span><span class="n">clear</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">clear</span></code> is called on an association in an unsaved host document, it will
still try to remove the association from the database based on the host
document’s <code class="docutils literal notranslate"><span class="pre">_id</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">tours</span> <span class="o">&lt;&lt;</span> <span class="no">Tour</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">unsaved_band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">band</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">tours</span><span class="p">:</span> <span class="o">[</span><span class="no">Tour</span><span class="o">.</span><span class="n">new</span><span class="o">]</span><span class="p">)</span>
<span class="c1"># Removes all tours from the persisted band due to _id match.</span>
<span class="n">unsaved_band</span><span class="o">.</span><span class="n">tours</span><span class="o">.</span><span class="n">clear</span>

<span class="n">band</span><span class="o">.</span><span class="n">tours</span>
<span class="c1"># =&gt; []</span>
</pre></div>
</div>
</section>
<section id="delete-all">
<h4><code class="docutils literal notranslate"><span class="pre">delete_all</span></code><a class="headerlink" href="#delete-all" title="Permalink to this headline">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">delete_all</span></code> method removes the documents that are in the association
using the <a href="#id31"><span class="problematic" id="id32">:manual:`$pullAll operator &lt;/reference/operator/update/pullAll&gt;`</span></a>.
Unlike <code class="docutils literal notranslate"><span class="pre">clear</span></code>, <code class="docutils literal notranslate"><span class="pre">delete_all</span></code>:</p>
<ul class="simple">
<li><p>Loads the association, if it wasn’t yet loaded;</p></li>
<li><p>Only removes the documents that exist in the application.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">delete_all</span></code> does not run destroy callbacks on the documents being removed.</p>
<p>Example:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">tours</span><span class="o">.</span><span class="n">delete_all</span>
</pre></div>
</div>
</section>
<section id="destroy-all">
<h4><code class="docutils literal notranslate"><span class="pre">destroy_all</span></code><a class="headerlink" href="#destroy-all" title="Permalink to this headline">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">delete_all</span></code> method removes the documents that are in the association
using the <a href="#id33"><span class="problematic" id="id34">:manual:`$pullAll operator &lt;/reference/operator/update/pullAll&gt;`</span></a>
while running the destroy callbacks. Like <code class="docutils literal notranslate"><span class="pre">delete_all</span></code>, <code class="docutils literal notranslate"><span class="pre">destroy_all</span></code>
loads the entire association if it wasn’t yet loaded and it only removes
documents that exist in the application:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">band</span><span class="o">.</span><span class="n">tours</span><span class="o">.</span><span class="n">destroy_all</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="common-behavior">
<h2>Common Behavior<a class="headerlink" href="#common-behavior" title="Permalink to this headline">#</a></h2>
<section id="extensions">
<h3>Extensions<a class="headerlink" href="#extensions" title="Permalink to this headline">#</a></h3>
<p>All associations can have extensions, which provides a way to add application specific
functionality to the association. They are defined by providing a block to the association definition.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_many</span> <span class="ss">:addresses</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">find_by_country</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
      <span class="n">where</span><span class="p">(</span><span class="ss">country</span><span class="p">:</span> <span class="n">country</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">chinese</span>
      <span class="n">_target</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span> <span class="n">address</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s2">&quot;China&quot;</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">find_by_country</span><span class="p">(</span><span class="s2">&quot;Mongolia&quot;</span><span class="p">)</span> <span class="c1"># returns address</span>
<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">chinese</span> <span class="c1"># returns [ address ]</span>
</pre></div>
</div>
</section>
<section id="custom-association-names">
<h3>Custom Association Names<a class="headerlink" href="#custom-association-names" title="Permalink to this headline">#</a></h3>
<p>You can name your associations whatever you like, but if the class cannot be inferred by
Mongoid from the name, and neither can the opposite side you’ll want to provide the
macro with some additional options to tell Mongoid how to hook them up.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Car</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_one</span> <span class="ss">:engine</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Motor&quot;</span><span class="p">,</span> <span class="ss">inverse_of</span><span class="p">:</span> <span class="ss">:machine</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Motor</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embedded_in</span> <span class="ss">:machine</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Car&quot;</span><span class="p">,</span> <span class="ss">inverse_of</span><span class="p">:</span> <span class="ss">:engine</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="custom-primary-foreign-keys">
<h3>Custom Primary &amp; Foreign Keys<a class="headerlink" href="#custom-primary-foreign-keys" title="Permalink to this headline">#</a></h3>
<p>The fields used when looking up associations can be explicitly specified.
The default is to use <code class="docutils literal notranslate"><span class="pre">id</span></code> on the “parent” association and <code class="docutils literal notranslate"><span class="pre">#{association_name}_id</span></code>
on the “child” association, for example with a has_many/belongs_to:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Company</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">has_many</span> <span class="ss">:emails</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Email</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">belongs_to</span> <span class="ss">:company</span>
<span class="k">end</span>

<span class="n">company</span> <span class="o">=</span> <span class="no">Company</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="c1"># looks up emails where emails.company_id == company.id</span>
<span class="n">company</span><span class="o">.</span><span class="n">emails</span>
</pre></div>
</div>
<p>Specify a different <code class="docutils literal notranslate"><span class="pre">primary_key</span></code> to change the field name on the “parent”
association and <code class="docutils literal notranslate"><span class="pre">foreign_key</span></code> to change the field name on the “child”
association:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Company</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:c</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">has_many</span> <span class="ss">:emails</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="s1">&#39;c_ref&#39;</span><span class="p">,</span> <span class="ss">primary_key</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Email</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="c1"># This definition of c_ref is automatically generated by Mongoid:</span>
  <span class="c1"># field :c_ref, type: Object</span>
  <span class="c1"># But the type can also be specified:</span>
  <span class="n">field</span> <span class="ss">:c_ref</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">belongs_to</span> <span class="ss">:company</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="s1">&#39;c_ref&#39;</span><span class="p">,</span> <span class="ss">primary_key</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span>
<span class="k">end</span>

<span class="n">company</span> <span class="o">=</span> <span class="no">Company</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="c1"># looks up emails where emails.c_ref == company.c</span>
<span class="n">company</span><span class="o">.</span><span class="n">emails</span>
</pre></div>
</div>
<p>With a has_and_belongs_to_many association, since the data is stored on both
sides of the association, there are 4 fields configurable when the association
is defined:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">:primary_key</span></code> is the field on the remote model that contains the value
by which the remote model is looked up.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:foreign_key</span></code> is the field on the local model which stores the
<code class="docutils literal notranslate"><span class="pre">:primary_key</span></code> values.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:inverse_primary_key</span></code> is the field on the local model that the remote
model uses to look up the local model documents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:inverse_foreign_key</span></code> is the field on the remote model storing the
values in <code class="docutils literal notranslate"><span class="pre">:inverse_primary_key</span></code>.</p></li>
</ul>
<p>An example might make this more clear:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Company</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:c_id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="n">field</span> <span class="ss">:e_ids</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:employees</span><span class="p">,</span>
    <span class="ss">primary_key</span><span class="p">:</span> <span class="ss">:e_id</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:e_ids</span><span class="p">,</span>
    <span class="ss">inverse_primary_key</span><span class="p">:</span> <span class="ss">:c_id</span><span class="p">,</span> <span class="ss">inverse_foreign_key</span><span class="p">:</span> <span class="ss">:c_ids</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Employee</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:e_id</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span>
  <span class="n">field</span> <span class="ss">:c_ids</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span>

  <span class="n">has_and_belongs_to_many</span> <span class="ss">:companies</span><span class="p">,</span>
    <span class="ss">primary_key</span><span class="p">:</span> <span class="ss">:c_id</span><span class="p">,</span> <span class="ss">foreign_key</span><span class="p">:</span> <span class="ss">:c_ids</span><span class="p">,</span>
    <span class="ss">inverse_primary_key</span><span class="p">:</span> <span class="ss">:e_id</span><span class="p">,</span> <span class="ss">inverse_foreign_key</span><span class="p">:</span> <span class="ss">:e_ids</span>
<span class="k">end</span>

<span class="n">company</span> <span class="o">=</span> <span class="no">Company</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">c_id</span><span class="p">:</span> <span class="mi">123</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Company _id: 5c565ece026d7c461d8a9d4e, c_id: 123, e_ids: nil&gt;</span>

<span class="n">employee</span> <span class="o">=</span> <span class="no">Employee</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">e_id</span><span class="p">:</span> <span class="mi">456</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Employee _id: 5c565ee8026d7c461d8a9d4f, e_id: 456, c_ids: nil&gt;</span>

<span class="n">company</span><span class="o">.</span><span class="n">employees</span> <span class="o">&lt;&lt;</span> <span class="n">employee</span>

<span class="n">company</span>
<span class="c1"># =&gt; #&lt;Company _id: 5c565ece026d7c461d8a9d4e, c_id: 123, e_ids: [456]&gt;</span>

<span class="n">employee</span>
<span class="c1"># =&gt; #&lt;Employee _id: 5c5883ce026d7c4b9e244c0c, e_id: 456, c_ids: [123]&gt;</span>
</pre></div>
</div>
<p>Note that just like with the default <code class="docutils literal notranslate"><span class="pre">#{association_name}_id</span></code> field,
Mongoid automatically adds a field for the custom foreign key <code class="docutils literal notranslate"><span class="pre">c_ref</span></code> to
the model. However, since Mongoid doesn’t know what type of data should be
allowed in the field, the field is created with a type of Object. It is a
good idea to explicitly define the field with the appropriate type.</p>
</section>
<section id="custom-scopes">
<span id="association-scope"></span><h3>Custom Scopes<a class="headerlink" href="#custom-scopes" title="Permalink to this headline">#</a></h3>
<p>You may set a specific scope on an association using the <code class="docutils literal notranslate"><span class="pre">:scope</span></code> parameter.
The scope is an additional filter that restricts which objects are considered
to be a part of the association - a scoped association will return only
documents which satisfy the scope condition.. The scope may be either:</p>
<ul class="simple">
<li><p>a <code class="docutils literal notranslate"><span class="pre">Proc</span></code> with arity zero, or</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">Symbol</span></code> which references a <a class="reference internal" href="queries.html#named-scopes"><span class="std std-ref">named scope</span></a> on the
associated model.</p></li>
</ul>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Trainer</span>
  <span class="n">has_many</span> <span class="ss">:pets</span><span class="p">,</span> <span class="ss">scope</span><span class="p">:</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">species</span><span class="p">:</span> <span class="s1">&#39;dog&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">has_many</span> <span class="ss">:toys</span><span class="p">,</span> <span class="ss">scope</span><span class="p">:</span> <span class="ss">:rubber</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Pet</span>
  <span class="n">belongs_to</span> <span class="ss">:trainer</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Toy</span>
  <span class="n">scope</span> <span class="ss">:rubber</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">material</span><span class="p">:</span> <span class="s1">&#39;rubber&#39;</span><span class="p">)</span>
  <span class="n">belongs_to</span> <span class="ss">:trainer</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is possible to add documents that do not satisfy an association’s scope
to that association. In this case, such documents will appear associated
in memory, and will be saved to the database, but will not be present when
the association is queried in the future. For example:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="no">Trainer</span><span class="o">.</span><span class="n">create!</span>
<span class="n">dog</span> <span class="o">=</span> <span class="no">Pet</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">trainer</span><span class="p">:</span> <span class="n">trainer</span><span class="p">,</span> <span class="ss">species</span><span class="p">:</span> <span class="s1">&#39;dog&#39;</span><span class="p">)</span>
<span class="n">cat</span> <span class="o">=</span> <span class="no">Pet</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">trainer</span><span class="p">:</span> <span class="n">trainer</span><span class="p">,</span> <span class="ss">species</span><span class="p">:</span> <span class="s1">&#39;cat&#39;</span><span class="p">)</span>

<span class="n">trainer</span><span class="o">.</span><span class="n">pets</span> <span class="c1">#=&gt; [dog, cat]</span>

<span class="n">trainer</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">pets</span> <span class="c1">#=&gt; [dog]</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Mongoid’s syntax for scoped association differs from that of ActiveRecord.
Mongoid uses the <code class="docutils literal notranslate"><span class="pre">:scope</span></code> keyword argument for consistency with other
association options, whereas in ActiveRecord the scope is a positional
argument.</p>
</div>
</section>
<section id="validations">
<h3>Validations<a class="headerlink" href="#validations" title="Permalink to this headline">#</a></h3>
<p>It is important to note that by default, Mongoid will validate the children of any
association that are loaded into memory via a <code class="docutils literal notranslate"><span class="pre">validates_associated</span></code>. The associations that
this applies to are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">embeds_many</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">embeds_one</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">has_many</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">has_one</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">has_and_belongs_to_many</span></code></p></li>
</ul>
<p>If you do not want this behavior, you may turn it off when defining the association.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">embeds_many</span> <span class="ss">:addresses</span><span class="p">,</span> <span class="ss">validate</span><span class="p">:</span> <span class="kp">false</span>
  <span class="n">has_many</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">validate</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="polymorphism">
<h3>Polymorphism<a class="headerlink" href="#polymorphism" title="Permalink to this headline">#</a></h3>
<p>One to one and one to many associations support polymorphism, which is
having a single association potentially contain objects of different classes.
For example, we could model an organization in which departments and teams
have managers as follows:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Department</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_one</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:unit</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Team</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_one</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:unit</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manager</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:unit</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">dept</span> <span class="o">=</span> <span class="no">Department</span><span class="o">.</span><span class="n">create!</span>
<span class="n">team</span> <span class="o">=</span> <span class="no">Team</span><span class="o">.</span><span class="n">create!</span>

<span class="n">alice</span> <span class="o">=</span> <span class="no">Manager</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">unit</span><span class="p">:</span> <span class="n">dept</span><span class="p">)</span>
<span class="n">alice</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="n">dept</span>
<span class="c1"># =&gt; true</span>
<span class="n">dept</span><span class="o">.</span><span class="n">manager</span> <span class="o">==</span> <span class="n">alice</span>
<span class="c1"># =&gt; true</span>
</pre></div>
</div>
<p>To provide another example, suppose we want to track price history for
products and bundles. This can be achieved via an embedded one to many
polymorphic association:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Product</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:bundles</span>

  <span class="n">embeds_many</span> <span class="ss">:prices</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:item</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Bundle</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:products</span>

  <span class="n">embeds_many</span> <span class="ss">:prices</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:item</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Price</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">embedded_in</span> <span class="ss">:item</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">pants</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Pants&#39;</span><span class="p">,</span>
  <span class="ss">prices</span><span class="p">:</span> <span class="o">[</span><span class="no">Price</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="no">Price</span><span class="o">.</span><span class="n">new</span><span class="o">]</span><span class="p">)</span>
<span class="n">costume</span> <span class="o">=</span> <span class="no">Bundle</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Costume&#39;</span><span class="p">,</span> <span class="ss">products</span><span class="p">:</span> <span class="o">[</span><span class="n">pants</span><span class="o">]</span><span class="p">,</span>
  <span class="ss">prices</span><span class="p">:</span> <span class="o">[</span><span class="no">Price</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="no">Price</span><span class="o">.</span><span class="n">new</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
<p>To define a polymorphic association, specify the <code class="docutils literal notranslate"><span class="pre">polymorphic:</span> <span class="pre">true</span></code> option
on the child association and add the <code class="docutils literal notranslate"><span class="pre">as:</span> <span class="pre">:association_name</span></code> option to the
parent association.</p>
<p>Note that Mongoid currently supports polymorphism only in one direction - from
the child to the parent. For example, polymorphism cannot be used to specify
that a bundle may contain other bundles or products:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Bundle</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="c1"># Does not work:</span>
  <span class="n">has_many</span> <span class="ss">:items</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">has_and_belongs_to_many</span></code> associations do not support polymorphism.</p>
</section>
<section id="cascading-callbacks">
<h3>Cascading Callbacks<a class="headerlink" href="#cascading-callbacks" title="Permalink to this headline">#</a></h3>
<p>If you want the embedded document callbacks to fire when calling a persistence
operation on its parent, you will need to provide the cascade callbacks option
to the association.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span> <span class="k">class</span> <span class="nc">Band</span>
   <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
   <span class="n">embeds_many</span> <span class="ss">:albums</span><span class="p">,</span> <span class="ss">cascade_callbacks</span><span class="p">:</span> <span class="kp">true</span>
   <span class="n">embeds_one</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">cascade_callbacks</span><span class="p">:</span> <span class="kp">true</span>
 <span class="k">end</span>

<span class="n">band</span><span class="o">.</span><span class="n">save</span> <span class="c1"># Fires all save callbacks on the band, albums, and label.</span>
</pre></div>
</div>
</section>
<section id="dependent-behavior">
<span id="id35"></span><h3>Dependent Behavior<a class="headerlink" href="#dependent-behavior" title="Permalink to this headline">#</a></h3>
<p>You can provide dependent options to referenced associations to instruct Mongoid
how to handle situations where one side of the association is deleted, or is attempted
to be deleted. The options are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">:delete_all</span></code>: Delete the child document(s) without running any of the model callbacks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:destroy</span></code>: Destroy the child document(s) and run all of the model callbacks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:nullify</span></code>: Set the foreign key field of the child document to nil. The child may become orphaned if it is ordinarily only referenced via the parent.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:restrict_with_exception</span></code>: <code class="docutils literal notranslate"><span class="pre">raise</span></code> an error if the child is not empty.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">:restrict_with_error</span></code>: Cancel operation and return false if the child is not empty.</p></li>
</ul>
<p>If no <code class="docutils literal notranslate"><span class="pre">:dependent</span></code> option is provided, deleting the parent document leaves the child document unmodified
(in other words, the child document continues to reference the now deleted parent document via the foreign key field).
The child may become orphaned if it is ordinarily only referenced via the parent.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">has_many</span> <span class="ss">:albums</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:delete_all</span>
  <span class="n">belongs_to</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:nullify</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Label</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">has_many</span> <span class="ss">:bands</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:restrict_with_exception</span>
<span class="k">end</span>

<span class="n">label</span> <span class="o">=</span> <span class="no">Label</span><span class="o">.</span><span class="n">first</span>
<span class="n">label</span><span class="o">.</span><span class="n">bands</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="no">Band</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">delete</span> <span class="c1"># Raises an error since bands is not empty.</span>

<span class="no">Band</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">delete</span> <span class="c1"># Will delete all associated albums.</span>
</pre></div>
</div>
</section>
<section id="autosaving">
<h3>Autosaving<a class="headerlink" href="#autosaving" title="Permalink to this headline">#</a></h3>
<p>One core difference between Mongoid and ActiveRecord is that Mongoid does not
automatically save associated documents for referenced (i.e., non-embedded)
associations when the parent is saved, for performance reasons.</p>
<p>If autosaving is not used, it is possible to create dangling references
to non-existent documents via associations:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_many</span> <span class="ss">:albums</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">new</span>
<span class="n">album</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">band</span><span class="p">:</span> <span class="n">band</span><span class="p">)</span>

<span class="c1"># The band is not persisted at this point.</span>

<span class="n">album</span><span class="o">.</span><span class="n">reload</span>

<span class="n">album</span><span class="o">.</span><span class="n">band_id</span>
<span class="c1"># =&gt; BSON::ObjectId(&#39;6257699753aefe153121a3d5&#39;)</span>

<span class="c1"># Band does not exist.</span>
<span class="n">album</span><span class="o">.</span><span class="n">band</span>
<span class="c1"># =&gt; nil</span>
</pre></div>
</div>
<p>To make referenced associations save automatically when the parent is saved,
add the <code class="docutils literal notranslate"><span class="pre">:autosave</span></code> option to the association:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">has_many</span> <span class="ss">:albums</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">belongs_to</span> <span class="ss">:band</span><span class="p">,</span> <span class="ss">autosave</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">new</span>
<span class="n">album</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">band</span><span class="p">:</span> <span class="n">band</span><span class="p">)</span>

<span class="c1"># The band is persisted at this point.</span>

<span class="n">album</span><span class="o">.</span><span class="n">reload</span>

<span class="n">album</span><span class="o">.</span><span class="n">band_id</span>
<span class="c1"># =&gt; BSON::ObjectId(&#39;62576b4b53aefe178b65b8e3&#39;)</span>

<span class="n">album</span><span class="o">.</span><span class="n">band</span>
<span class="c1"># =&gt; #&lt;Band _id: 62576b4b53aefe178b65b8e3, &gt;</span>
</pre></div>
</div>
<p>The autosaving functionality is automatically added to an association when
using <code class="docutils literal notranslate"><span class="pre">accepts_nested_attributes_for</span></code>, so that the application does not
need to track which associations were modified when processing a form
submission.</p>
<p>Embedded associations always autosave, because they are stored as part of the
parent document.</p>
<p>Some operations on associations always save the parent and the child documents
as part of the operation, regardless of whether autosaving is enabled.
A non-exhaustive list of these operations is as follows:</p>
<ul>
<li><p>Assignment to the association:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Saves the band and the album.</span>
<span class="n">band</span><span class="o">.</span><span class="n">albums</span> <span class="o">=</span> <span class="o">[</span><span class="no">Album</span><span class="o">.</span><span class="n">new</span><span class="o">]</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">push</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">band</span><span class="o">.</span><span class="n">albums</span> <span class="o">&lt;&lt;</span> <span class="no">Album</span><span class="o">.</span><span class="n">new</span>
<span class="n">band</span><span class="o">.</span><span class="n">albums</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="no">Album</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="existence-predicates">
<h3>Existence Predicates<a class="headerlink" href="#existence-predicates" title="Permalink to this headline">#</a></h3>
<p>All associations have existence predicates on them in the form of <code class="docutils literal notranslate"><span class="pre">name?</span></code> and <code class="docutils literal notranslate"><span class="pre">has_name?</span></code>
to check if the association is blank.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_one</span> <span class="ss">:label</span>
  <span class="n">embeds_many</span> <span class="ss">:albums</span>
<span class="k">end</span>

<span class="n">band</span><span class="o">.</span><span class="n">label?</span>
<span class="n">band</span><span class="o">.</span><span class="n">has_label?</span>
<span class="n">band</span><span class="o">.</span><span class="n">albums?</span>
<span class="n">band</span><span class="o">.</span><span class="n">has_albums?</span>
</pre></div>
</div>
</section>
<section id="autobuilding">
<h3>Autobuilding<a class="headerlink" href="#autobuilding" title="Permalink to this headline">#</a></h3>
<p>One to one associations (<code class="docutils literal notranslate"><span class="pre">embeds_one</span></code>, <code class="docutils literal notranslate"><span class="pre">has_one</span></code>) have an autobuild option which tells
Mongoid to instantiate a new document when the association is accessed and it is <code class="docutils literal notranslate"><span class="pre">nil</span></code>.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_one</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">autobuild</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">has_one</span> <span class="ss">:producer</span><span class="p">,</span> <span class="ss">autobuild</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">new</span>
<span class="n">band</span><span class="o">.</span><span class="n">label</span> <span class="c1"># Returns a new empty label.</span>
<span class="n">band</span><span class="o">.</span><span class="n">producer</span> <span class="c1"># Returns a new empty producer.</span>
</pre></div>
</div>
</section>
<section id="touching">
<h3>Touching<a class="headerlink" href="#touching" title="Permalink to this headline">#</a></h3>
<p>Any <code class="docutils literal notranslate"><span class="pre">belongs_to</span></code> association can take an optional <code class="docutils literal notranslate"><span class="pre">:touch</span></code> option which
will cause the parent document be touched whenever the child document is
touched:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">belongs_to</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">touch</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="n">band</span><span class="o">.</span><span class="n">touch</span> <span class="c1"># Calls touch on the parent label.</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">:touch</span></code> can also take a string or symbol argument specifying a field to
be touched on the parent association in addition to updated_at:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Label</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Timestamps</span>
  <span class="n">field</span> <span class="ss">:bands_updated_at</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Time</span>
  <span class="n">has_many</span> <span class="ss">:bands</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">belongs_to</span> <span class="ss">:label</span><span class="p">,</span> <span class="ss">touch</span><span class="p">:</span> <span class="ss">:bands_updated_at</span>
<span class="k">end</span>

<span class="n">label</span> <span class="o">=</span> <span class="no">Label</span><span class="o">.</span><span class="n">create!</span>
<span class="n">band</span> <span class="o">=</span> <span class="no">Band</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="n">label</span><span class="p">)</span>

<span class="n">band</span><span class="o">.</span><span class="n">touch</span> <span class="c1"># Updates updated_at and bands_updated_at on the label.</span>
</pre></div>
</div>
<p>When an embedded document is touched, its parents are recursively touched
through the composition root (because all of the parents are necessarily saved
when the embedded document is saved). The <code class="docutils literal notranslate"><span class="pre">:touch</span></code> attribute therefore is
unnecessary on <code class="docutils literal notranslate"><span class="pre">embedded_in</span></code> associations.</p>
<p>Mongoid currently <a class="reference external" href="https://jira.mongodb.org/browse/MONGOID-5014">does not support specifying an additional field to be
touched on an embedded_in association</a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">:touch</span></code> should not be set to <code class="docutils literal notranslate"><span class="pre">false</span></code> on an <code class="docutils literal notranslate"><span class="pre">embedded_in</span></code> association,
since composition hierarchy is always updated upon a touch of an embedded
document. This is currently not enforced but enforcement is <a class="reference external" href="https://jira.mongodb.org/browse/MONGOID-5016">intended in the
future</a>.</p>
</section>
<section id="the-counter-cache-option">
<h3>The counter_cache Option<a class="headerlink" href="#the-counter-cache-option" title="Permalink to this headline">#</a></h3>
<p>As with ActiveRecord, the <code class="docutils literal notranslate"><span class="pre">:counter_cache</span></code> option can be used on an association
to make finding the number of belonging objects more efficient. Also similar
to ActiveRecord, you must take into account that there will be an extra
attribute on the associated model. This means that with Mongoid,
you need to include <code class="docutils literal notranslate"><span class="pre">Mongoid::Attributes::Dynamic</span></code> on the associated model.
For example:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Order</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">belongs_to</span> <span class="ss">:customer</span><span class="p">,</span> <span class="ss">counter_cache</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Customer</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Attributes</span><span class="o">::</span><span class="no">Dynamic</span>
  <span class="n">has_many</span> <span class="ss">:orders</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="association-proxies">
<h3>Association Proxies<a class="headerlink" href="#association-proxies" title="Permalink to this headline">#</a></h3>
<p>Associations employ transparent proxies to the target objects. This can
cause surprising behavior in some situations.</p>
<p>The method visibility may be lost when methods on association targets are
accessed, depending on the association:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Order</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">belongs_to</span> <span class="ss">:customer</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">internal_status</span>
    <span class="s1">&#39;new&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Customer</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">has_many</span> <span class="ss">:orders</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">internal_id</span>
    <span class="mi">42</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="o">.</span><span class="n">new</span>
<span class="n">customer</span> <span class="o">=</span> <span class="no">Customer</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">orders</span><span class="p">:</span> <span class="o">[</span><span class="n">order</span><span class="o">]</span><span class="p">)</span>

<span class="c1"># has_many does not permit calling private methods on the target</span>
<span class="n">customer</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">internal_status</span>
<span class="c1"># NoMethodError (private method `internal_status&#39; called for #&lt;Order:0x000055af2ec46c50&gt;)</span>

<span class="c1"># belongs_to permits calling private methods on the target</span>
<span class="n">order</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">internal_id</span>
<span class="c1"># =&gt; 42</span>
</pre></div>
</div>
</section>
</section>
<section id="association-metadata">
<h2>Association Metadata<a class="headerlink" href="#association-metadata" title="Permalink to this headline">#</a></h2>
<p>All associations in Mongoid contain metadata that holds information about the association in
question, and is a valuable tool for third party developers to use to extend Mongoid.</p>
<p>You can access the association metadata of the association in a few different ways.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the metadata for a named association from the class or document.</span>
<span class="no">Model</span><span class="o">.</span><span class="n">reflect_on_association</span><span class="p">(</span><span class="ss">:association_name</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">reflect_on_association</span><span class="p">(</span><span class="ss">:association_name</span><span class="p">)</span>

<span class="c1"># Get the metadata with a specific association itself on a specific</span>
<span class="c1"># document.</span>
<span class="n">model</span><span class="o">.</span><span class="n">associations</span><span class="o">[</span><span class="ss">:association_name</span><span class="o">]</span>
</pre></div>
</div>
<section id="attributes">
<h3>Attributes<a class="headerlink" href="#attributes" title="Permalink to this headline">#</a></h3>
<p>All associations contain a <code class="docutils literal notranslate"><span class="pre">_target</span></code>, which is the proxied document or documents, a <code class="docutils literal notranslate"><span class="pre">_base</span></code>
which is the document the association hangs off, and <code class="docutils literal notranslate"><span class="pre">_association</span></code> which provides information
about the association.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_many</span> <span class="ss">:addresses</span>
<span class="k">end</span>

<span class="n">person</span><span class="o">.</span><span class="n">addresses</span> <span class="o">=</span> <span class="o">[</span> <span class="n">address</span> <span class="o">]</span>
<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">_target</span> <span class="c1"># returns [ address ]</span>
<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">_base</span> <span class="c1"># returns person</span>
<span class="n">person</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">_association</span> <span class="c1"># returns the association metadata</span>
</pre></div>
</div>
</section>
<section id="the-association-object">
<h3>The Association Object<a class="headerlink" href="#the-association-object" title="Permalink to this headline">#</a></h3>
<p>The association object itself contains more information than one might know what to do
with, and is useful for developers of extensions to Mongoid.</p>
<table class="colwidths-given table">
<colgroup>
<col style="width: 33%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#as</span></code></p></td>
<td><p>Returns the name of the parent to a polymorphic child.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#as?</span></code></p></td>
<td><p>Returns whether or not an as option exists.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#autobuilding?</span></code></p></td>
<td><p>Returns whether or not the association is autobuilding.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#autosaving?</span></code></p></td>
<td><p>Returns whether or not the association is autosaving.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#cascading_callbacks?</span></code></p></td>
<td><p>Returns whether the association has callbacks cascaded down from the parent.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#class_name</span></code></p></td>
<td><p>Returns the class name of the proxied document.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#cyclic?</span></code></p></td>
<td><p>Returns whether the association is a cyclic association.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#dependent</span></code></p></td>
<td><p>Returns the association’s dependent option.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#destructive?</span></code></p></td>
<td><p>Returns true if the association has a dependent delete or destroy.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#embedded?</span></code></p></td>
<td><p>Returns whether the association is embedded in another document.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#forced_nil_inverse?</span></code></p></td>
<td><p>Returns whether the association has a nil inverse defined.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#foreign_key</span></code></p></td>
<td><p>Returns the name of the foreign key field.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#foreign_key_check</span></code></p></td>
<td><p>Returns the name of the foreign key field dirty check method.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#foreign_key_setter</span></code></p></td>
<td><p>Returns the name of the foreign key field setter.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#indexed?</span></code></p></td>
<td><p>Returns whether the foreign key is auto indexed.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#inverses</span></code></p></td>
<td><p>Returns the names of all inverse association.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#inverse</span></code></p></td>
<td><p>Returns the name of a single inverse association.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#inverse_class_name</span></code></p></td>
<td><p>Returns the class name of the association on the inverse side.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#inverse_foreign_key</span></code></p></td>
<td><p>Returns the name of the foreign key field on the inverse side.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#inverse_klass</span></code></p></td>
<td><p>Returns the class of the association on the inverse side.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#inverse_association</span></code></p></td>
<td><p>Returns the metadata of the association on the inverse side.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#inverse_of</span></code></p></td>
<td><p>Returns the explicitly defined name of the inverse association.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#inverse_setter</span></code></p></td>
<td><p>Returns the name of the method used to set the inverse.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#inverse_type</span></code></p></td>
<td><p>Returns the name for the polymorphic type field of the inverse.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#inverse_type_setter</span></code></p></td>
<td><p>Returns the name for the polymorphic type field setter of the inverse.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#key</span></code></p></td>
<td><p>Returns the name of the field in the attributes hash to use to get the association.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#klass</span></code></p></td>
<td><p>Returns the class of the proxied documents in the association.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#name</span></code></p></td>
<td><p>Returns the association name.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#options</span></code></p></td>
<td><p>Returns self, for API compatibility with ActiveRecord.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#order</span></code></p></td>
<td><p>Returns the custom sorting options on the association.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#polymorphic?</span></code></p></td>
<td><p>Returns whether the association is polymorphic.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#setter</span></code></p></td>
<td><p>Returns the name of the field to set the association.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#store_as</span></code></p></td>
<td><p>Returns the name of the attribute to store an embedded association in.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#touchable?</span></code></p></td>
<td><p>Returns whether or not the association has a touch option.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#type</span></code></p></td>
<td><p>Returns the name of the field to get the polymorphic type.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Association#type_setter</span></code></p></td>
<td><p>Returns the name of the field to set the polymorphic type.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Association#validate?</span></code></p></td>
<td><p>Returns whether the association has an associated validation.</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="inheritance.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Inheritance</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="validation.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Validation</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
      &copy; Copyright 2021, MongoDB.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>